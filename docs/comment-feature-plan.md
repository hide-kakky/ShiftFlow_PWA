# コメント機能改善 計画書（一覧・詳細の気付き向上）

## 目的
- コメントが付いたこと・未読コメントがあることをユーザーがすぐ分かるようにし、コメント機能を“生きた”状態にする。

## 背景 / 課題
- 現状はコメントの存在が視覚的に弱く、投稿されても気付かれずに埋もれてしまう。
- 一覧でのソートが投稿時刻寄りのため、後から付いたコメントが最新でも上位に上がらない場合がある。

## 対応方針
- 一覧カードにコメント件数バッジを表示（タスクの期限超過/依頼バッジと同じ `badge-soft` 系で統一）。
- 未読コメントがある場合はバッジを強調（`badge-comment-new`）し、タイトル付近で視認性を高める。
- 並び順は「ピン留め優先 → 最終活動時刻（lastCommentAt > updatedAt > createdAt）降順」で新着コメントを上に。
- 詳細モーダルでは新着コメントに短時間のハイライトを付与し、描画後に最新コメントへスクロール。

## スコープ / 非スコープ
- スコープ: コメントバッジ表示、未読強調、ソートの最終活動時刻化、UI ハイライト。
- 非スコープ: 通知配信（プッシュ/メール）、メンション通知の新規実装。必要なら後続タスクで扱う。

## 実装ステップ案
1. バックエンド: `getMessages`/`getMessageById` で `commentCount`、`lastCommentAt`、`hasNewComment` を返すよう拡張。`fetchMessageComments` で `createdAtMs` を含める。
2. フロント（一覧）: `renderMessageCard` にコメントバッジを追加し、`hasNewComment` で強調。描画前に `lastActivity` でソート。
3. フロント（詳細）: コメント描画時に新着をハイライトし、描画後に最新コメントへスクロール。
4. スタイル: `badge-soft` 系に `badge-comment` / `badge-comment-new` を追加（ライト/ダーク両対応）。
5. 確認: コメント投稿→一覧バッジ更新、新着強調の解消、ダーク/ライトの視認性、未読フィルタとの両立。

## 検証項目
- コメント投稿直後に一覧のコメント件数バッジが更新される。
- 未読コメントがあると `badge-comment-new` で強調され、詳細閲覧後は解消される。
- 並び順が最終活動時刻で更新され、新着コメントを含むカードが上に来る。
- ダーク/ライトでバッジのコントラストが十分。

## ロールバック方針（実装後の想定）
- 直近コミットを `git revert <commit>` で戻す。
- フロントを巻き戻す場合は `APP_VERSION` も同時に元の値へ戻して再デプロイ。
