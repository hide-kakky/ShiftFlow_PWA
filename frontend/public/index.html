<!DOCTYPE html>
<html data-theme="light">
  <head>
    <!-- ===== Base PWA metadata and viewport configuration ===== -->
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#517cb2" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ShiftFlow" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <!-- ===== External UI stylesheets ===== -->
    <link
      href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined"
      rel="stylesheet"
    />
    <!-- Google Sign-In スクリプトは不要なため削除 -->
    <!-- ===== Service worker registration and cache refresh messaging ===== -->
    <script>
      window.addEventListener('load', function () {
        if (!('serviceWorker' in navigator)) {
          return;
        }
        navigator.serviceWorker.register('/sw.js').catch(function (error) {
          console.warn('Service worker registration failed:', error);
        });
        navigator.serviceWorker.addEventListener('message', function (event) {
          if (!event || !event.data || event.data.type !== 'API_CACHE_UPDATED') {
            return;
          }
          var handler = window.__SHIFT_FLOW_TRIGGER_REFRESH__;
          if (typeof handler === 'function') {
            try {
              handler(event.data);
            } catch (err) {
              console.warn('API cache update handling failed:', err);
            }
          }
        });
      });
    </script>
    <!-- ===== Runtime configuration endpoint (Cloudflare Functions) ===== -->
    <script src="/config"></script>
    <!-- ===== Google Identity Services (One Tap / FedCM support) ===== -->
    <!-- TODO: manifest 動的補完スクリプトと静的 manifest の整合性を確認 -->
    <!-- ===== Initial bootstrap payload rendered by backend ===== -->
    <script id="shiftflow-bootstrap" type="application/json">
      {
        "userInfo": {
          "name": "ゲストユーザー",
          "email": "",
          "imageUrl": "/icons/icon-192.png",
          "theme": "light"
        },
        "users": [],
        "folders": [],
        "myTasks": {
          "tasks": [],
          "meta": {}
        },
        "isManager": false
      }
    </script>
    <!-- ===== Merge bootstrap payload defaults and expose globals ===== -->
    <script>
      (function () {
        var defaults = {
          userInfo: {
            name: 'ゲストユーザー',
            email: '',
            imageUrl: '/icons/icon-192.png',
            theme: 'light',
          },
          users: [],
          folders: [],
          myTasks: { tasks: [], meta: {} },
          isManager: false,
        };
        var el = document.getElementById('shiftflow-bootstrap');
        var parsed = {};
        if (el) {
          try {
            parsed = JSON.parse(el.textContent || el.innerText || '{}') || {};
          } catch (err) {
            console.warn('Failed to parse bootstrap payload:', err);
          }
        }
        var merged = Object.assign({}, defaults, parsed);
        merged.userInfo = Object.assign({}, defaults.userInfo, parsed.userInfo || {});
        window.__SHIFT_FLOW_BOOTSTRAP__ = merged;
        window.userInfo = merged.userInfo;
        window.users = Array.isArray(merged.users) ? merged.users : [];
        window.folders = Array.isArray(merged.folders) ? merged.folders : [];
        window.initialTasks = merged.myTasks || defaults.myTasks;
        window.isManager = !!merged.isManager;
      })();
    </script>

    <!-- ===== Theme helpers for syncing CSS custom properties ===== -->
    <script>
      (function () {
        var themeMeta = {
          light: { statusBar: 'default' },
          dark: { statusBar: 'black-translucent' },
        };
        function readCSSVariable(name) {
          try {
            var styles = window.getComputedStyle(document.documentElement);
            var value = styles ? styles.getPropertyValue(name) : '';
            return typeof value === 'string' ? value.trim() : '';
          } catch (err) {
            return '';
          }
        }
        function computeSurfaceColor(theme) {
          var fallback = theme === 'dark' ? '#050b18' : '#f2f4f9';
          return readCSSVariable('--surface') || fallback;
        }
        function computePrimaryColor(theme) {
          var fallback = theme === 'dark' ? '#4b67b3' : '#517cb2';
          return readCSSVariable('--primary') || fallback;
        }
        window.__SHIFT_FLOW_THEME_META__ = themeMeta;
        window.__SHIFT_FLOW_GET_SURFACE__ = computeSurfaceColor;
        window.__SHIFT_FLOW_GET_PRIMARY__ = computePrimaryColor;
        window.__SHIFT_FLOW_SYNC_THEME_META__ = function (theme) {
          var resolvedTheme = theme === 'dark' ? 'dark' : 'light';
          var metaTheme = document.querySelector('meta[name="theme-color"]');
          var primaryColor = computePrimaryColor(resolvedTheme);
          if (metaTheme && primaryColor) {
            metaTheme.setAttribute('content', primaryColor);
          }
          var appleStatus = document.querySelector(
            'meta[name="apple-mobile-web-app-status-bar-style"]'
          );
          var statusBar =
            (themeMeta[resolvedTheme] && themeMeta[resolvedTheme].statusBar) ||
            (resolvedTheme === 'dark' ? 'black-translucent' : 'default');
          if (appleStatus && statusBar) {
            appleStatus.setAttribute('content', statusBar);
          }
        };

        var bootstrap = window.__SHIFT_FLOW_BOOTSTRAP__ || {};
        var pref = (bootstrap.userInfo && bootstrap.userInfo.theme) || bootstrap.theme || 'light';
        var media = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
        var resolved = pref === 'system' && media ? (media.matches ? 'dark' : 'light') : pref;
        document.documentElement.setAttribute('data-theme', resolved);
        document.documentElement.dataset.themePref = pref;
        window.__SHIFT_FLOW_SYNC_THEME_META__(resolved);
      })();
    </script>

    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* ===== Light theme design tokens and global variables ===== */
      :root {
        color-scheme: light;
        --primary: #517cb2;
        --primary-700: #35567f;
        --surface: #f2f4f9;
        --card: #ffffff;
        --card-border: #e8edf5;
        --card-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
        --text-900: #0f172a;
        --text-700: #1e293b;
        --muted: #64748b;
        --on-primary: #ffffff;
        --warn: #f5a524;
        --fab: #e85d6a;
        --fab-shadow: 0 14px 28px rgba(232, 93, 106, 0.35);
        --dropdown-shadow: 0 10px 28px rgba(0, 0, 0, 0.2);
        --footer-h: 72px;
        --footer-extra: 18px;
        --header-h: 48px;
        --fade: 220ms;
        --body-bg: linear-gradient(
            180deg,
            rgba(81, 124, 178, 0.32) 0%,
            rgba(81, 124, 178, 0.12) 46%,
            rgba(255, 255, 255, 0) 85%
          ),
          linear-gradient(130deg, rgba(94, 122, 184, 0.22) 0%, rgba(255, 255, 255, 0) 68%),
          var(--surface);
        --task-card-bg: linear-gradient(0deg, rgba(81, 124, 178, 0.1), rgba(81, 124, 178, 0.1)),
          var(--card);
        --msg-card-unread-bg: linear-gradient(
            0deg,
            rgba(255, 245, 225, 0.95),
            rgba(255, 245, 225, 0.95)
          ),
          var(--card);
        --badge-bg: #e53935;
        --topbar-hover-bg: rgba(255, 255, 255, 0.12);
        --topbar-active-bg: #ffffff;
        --topbar-active-fg: var(--primary);
        --footer-bg: var(--primary);
        --footer-indicator: #ffffff;
        --footer-shadow: 0 -8px 20px rgba(81, 124, 178, 0.18);
        --skeleton-1: #cfdaf0;
        --skeleton-2: #e6edfb;
        --input-bg: #ffffff;
        --input-border: #ced4da;
        --assignee-border: #e8edf5;
        --assignee-bg: #ffffff;
        --assignee-divider: #e6ebf5;
        --badge-counter-bg: #e7f0ff;
        --badge-counter-fg: #1d4ed8;
        --attach-meta: #64748b;
        --divider: rgba(15, 23, 42, 0.08);
        --focus-ring: rgba(81, 124, 178, 0.25);
        --tab-hover-bg: rgba(81, 124, 178, 0.12);
        --tab-active-bg: #ffffff;
        --tab-active-text: var(--primary);
        --priority-high-bg: rgba(229, 57, 53, 0.12);
        --priority-high-text: #b91c1c;
        --priority-middle-bg: rgba(81, 124, 178, 0.14);
        --priority-middle-text: var(--primary-700);
        --priority-low-bg: rgba(16, 185, 129, 0.14);
        --priority-low-text: #166534;
        --alert-info-bg: rgba(81, 124, 178, 0.12);
        --alert-info-border: rgba(81, 124, 178, 0.25);
        --alert-info-text: var(--text-900);
        --app-font: 'Zen Kaku Gothic New', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        font-family: var(--app-font);
      }
      /* ===== Dark theme overrides ===== */
      :root[data-theme='dark'] {
        color-scheme: dark;
        --primary: #4b67b3;
        --primary-700: #394f8f;
        --surface: #081326;
        --card: #111d36;
        --card-border: rgba(90, 122, 196, 0.32);
        --card-shadow: 0 28px 46px rgba(5, 12, 28, 0.68);
        --text-900: #e6edff;
        --text-700: #c6d4ff;
        --muted: #8fa2cf;
        --on-primary: #f6f8ff;
        --warn: #f5a524;
        --fab: #f16fa2;
        --fab-shadow: 0 18px 36px rgba(241, 111, 162, 0.4);
        --dropdown-shadow: 0 24px 48px rgba(4, 10, 26, 0.75);
        --body-bg: linear-gradient(
            180deg,
            rgba(75, 118, 195, 0.38) 0%,
            rgba(38, 58, 120, 0.3) 54%,
            rgba(8, 19, 38, 0.92) 100%
          ),
          linear-gradient(140deg, rgba(66, 103, 185, 0.26) 0%, rgba(8, 19, 38, 0) 72%), #050b18;
        --task-card-bg: linear-gradient(0deg, rgba(90, 130, 210, 0.18), rgba(90, 130, 210, 0.12)),
          var(--card);
        --msg-card-unread-bg: linear-gradient(
            0deg,
            rgba(255, 196, 119, 0.2),
            rgba(255, 196, 119, 0.12)
          ),
          var(--card);
        --badge-bg: #f87171;
        --topbar-hover-bg: rgba(214, 224, 255, 0.12);
        --topbar-active-bg: rgba(214, 224, 255, 0.18);
        --topbar-active-fg: #f6f8ff;
        --footer-bg: #0a1833;
        --footer-indicator: #9db6ff;
        --footer-shadow: 0 -16px 32px rgba(5, 12, 28, 0.55);
        --skeleton-1: #17264a;
        --skeleton-2: #213362;
        --input-bg: #101d3a;
        --input-border: #27407c;
        --assignee-border: #2b3f6d;
        --assignee-bg: #101d3a;
        --assignee-divider: #263a66;
        --badge-counter-bg: rgba(90, 130, 210, 0.24);
        --badge-counter-fg: #b8c8ff;
        --attach-meta: #a7b4d6;
        --divider: rgba(122, 146, 194, 0.28);
        --focus-ring: rgba(90, 130, 210, 0.32);
        --tab-hover-bg: rgba(90, 130, 210, 0.22);
        --tab-active-bg: rgba(90, 130, 210, 0.26);
        --tab-active-text: #f6f8ff;
        --priority-high-bg: rgba(248, 113, 113, 0.22);
        --priority-high-text: #fecaca;
        --priority-middle-bg: rgba(90, 130, 210, 0.24);
        --priority-middle-text: #dbe4ff;
        --priority-low-bg: rgba(74, 222, 128, 0.22);
        --priority-low-text: #c1f7d8;
        --alert-info-bg: rgba(90, 130, 210, 0.22);
        --alert-info-border: rgba(90, 130, 210, 0.42);
        --alert-info-text: #f6f8ff;
      }
      /* ===== Global element resets ===== */
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        overflow-x: hidden;
        background-color: var(--surface);
        background-image: var(--body-bg);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        color: var(--text-900);
        position: relative;
      }
      /* ===== PWA preview mock layout (temporary) ===== */
      /* TODO: スタイルを /css/style.css へ分離 */
      .pwa-preview-shell {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 480px;
        margin: 16px auto;
        padding: 20px 16px calc(20px + var(--footer-h) + var(--footer-extra) + var(--safe-bottom));
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.82);
        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.12);
        backdrop-filter: blur(6px);
      }
      .pwa-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .pwa-header__title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-900);
      }
      .pwa-header__sync {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: var(--on-primary);
        box-shadow: 0 10px 18px rgba(81, 124, 178, 0.28);
      }
      .pwa-header__sync:focus-visible {
        outline: 3px solid rgba(81, 124, 178, 0.35);
        outline-offset: 2px;
      }
      .pwa-main {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .pwa-card {
        padding: 20px;
        border-radius: 16px;
        background: var(--card);
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
      }
      .pwa-card__meta {
        margin: 0 0 12px;
        color: var(--muted);
        font-size: 0.9rem;
      }
      .pwa-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 10px;
      }
      .pwa-list li {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        border-radius: 12px;
        background: rgba(81, 124, 178, 0.08);
        color: var(--text-900);
      }
      .pwa-list__dot {
        width: 10px;
        height: 10px;
        margin-top: 6px;
        border-radius: 50%;
        background: var(--primary);
        flex-shrink: 0;
      }
      .pwa-footer {
        margin-top: auto;
        min-height: calc(var(--footer-h) + var(--footer-extra));
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 18px;
        background: linear-gradient(135deg, rgba(81, 124, 178, 0.9), rgba(53, 86, 127, 0.92));
        box-shadow: var(--footer-shadow);
        padding: 8px 12px;
      }
      .pwa-footer__nav {
        width: 100%;
        display: flex;
        justify-content: space-around;
        gap: 8px;
      }
      .pwa-footer__button {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 8px 6px;
        border-radius: 12px;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.92);
        font-size: 0.75rem;
      }
      .pwa-footer__button:disabled,
      .pwa-footer__button.is-disabled {
        opacity: 0.45;
        pointer-events: none;
      }
      .pwa-footer__button:focus-visible {
        outline: 3px solid rgba(255, 255, 255, 0.4);
        outline-offset: 2px;
      }
      .pwa-footer__button--active {
        background: rgba(255, 255, 255, 0.18);
        color: #ffffff;
      }
      /* TODO: 既存UI統合までプレビュー表示を無効化 */
      body .pwa-preview-shell {
        display: none !important;
      }
      @media (min-width: 768px) {
        .pwa-preview-shell {
          margin-top: 32px;
        }
      }

      /* Header */
      header.navbar {
        position: relative;
        background: var(--primary);
        color: var(--on-primary);
        border-bottom: none;
        min-height: var(--header-h);
        padding-top: 4px;
        padding-bottom: 6px;
      }
      header .container-xl {
        padding-top: 0;
        padding-bottom: 0;
        min-height: calc(var(--header-h) - 8px);
        display: flex;
        align-items: center;
      }
      .navbar-brand.app-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        text-decoration: none;
        padding: 4px 0;
        color: var(--on-primary);
      }
      .navbar-brand.app-brand .brand-mark {
        position: relative;
        width: 38px;
        height: 38px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(72, 115, 194, 0.9), rgba(72, 115, 194, 0.52));
        box-shadow: 0 16px 28px rgba(72, 115, 194, 0.32);
        overflow: hidden;
      }
      .navbar-brand.app-brand .brand-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: inherit;
        border: 2px solid rgba(255, 255, 255, 0.45);
        inset: 0;
        opacity: 0.7;
      }
      .navbar-brand.app-brand .brand-glow {
        position: absolute;
        width: 140%;
        height: 140%;
        border-radius: inherit;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.45) 0%,
          rgba(255, 255, 255, 0) 65%
        );
        filter: blur(6px);
      }
      .navbar-brand.app-brand .brand-icon {
        position: relative;
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
        border-radius: inherit;
      }
      .navbar-brand.app-brand .brand-title {
        line-height: 1;
        display: inline-flex;
        align-items: center;
        height: 100%;
      }
      .navbar-brand.app-brand .brand-text-main {
        font-weight: 700;
        font-size: 1.24rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      @media (max-width: 768px) {
        .navbar-brand.app-brand {
          gap: 10px;
        }
        .navbar-brand.app-brand .brand-mark {
          width: 34px;
          height: 34px;
          border-radius: 11px;
        }
        .navbar-brand.app-brand .brand-text-main {
          font-size: 1.12rem;
        }
        header.navbar {
          position: sticky;
          top: 0;
          z-index: 1080;
          padding-top: calc(4px + var(--safe-top));
          padding-bottom: 8px;
          backdrop-filter: blur(12px);
          box-shadow: 0 8px 24px rgba(15, 23, 42, 0.18);
        }
        header.navbar::before {
          content: '';
          position: absolute;
          inset: 0;
          background: var(--primary);
          opacity: 0.96;
          z-index: -1;
        }
      }

      /* PC topbar */
      .topbar {
        background: var(--primary);
        border-top: 1px solid rgba(255, 255, 255, 0.12);
        border-bottom: 1px solid var(--divider);
        padding: 9px 0;
      }
      .topbar .nav-link {
        color: var(--on-primary);
        padding: 0.6rem 1rem;
        border-radius: 10px;
        display: flex;
        align-items: center;
        position: relative;
      }
      .topbar .nav-link:hover {
        background: var(--topbar-hover-bg);
        color: var(--on-primary);
      }
      .topbar .nav-link.active {
        background: var(--topbar-active-bg);
        color: var(--topbar-active-fg);
      }
      .topbar .nav-link .material-icons,
      .topbar .nav-link .material-icons-outlined {
        font-size: 28px;
      }
      .nav-link.nav-icon {
        position: relative;
      }
      .nav-icon-badge {
        position: absolute;
        top: 6px;
        right: 10px;
        transform: translate(45%, -45%);
      }
      .topbar .nav-icon-badge {
        box-shadow: 0 0 0 2px var(--primary);
      }
      .footer-nav .nav-icon-badge {
        top: 10px;
        right: 50%;
        transform: translate(55%, -55%);
        box-shadow: 0 0 0 2px var(--footer-bg);
      }
      .badge-unread {
        --s: 20px;
        background: var(--badge-bg) !important;
        color: #fff;
        font-weight: 800;
        font-size: 12px;
        min-width: var(--s);
        height: var(--s);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .badge-overdue {
        --s: 20px;
        background: var(--warn) !important;
        color: #fff;
        font-weight: 800;
        font-size: 12px;
        min-width: var(--s);
        height: var(--s);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      :root[data-theme='dark'] header.navbar,
      :root[data-theme='dark'] .topbar {
        background: var(--primary);
      }
      @media (max-width: 768px) {
        :root[data-theme='dark'] header.navbar::before {
          background: var(--primary);
        }
      }
      :root[data-theme='dark'] .footer-nav {
        background: linear-gradient(135deg, rgba(10, 18, 40, 0.92), rgba(5, 12, 30, 0.95));
      }

      /* Footer nav mobile */
      .footer-nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: calc(var(--footer-h) + var(--footer-extra) + var(--safe-bottom));
        padding-bottom: calc(var(--safe-bottom) + var(--footer-extra));
        padding-left: var(--safe-left);
        padding-right: var(--safe-right);
        background: var(--footer-bg);
        z-index: 1020;
        border-top: 1px solid var(--divider);
        box-shadow: var(--footer-shadow);
      }
      .footer-nav .container-fluid {
        padding-left: 0;
        padding-right: 0;
        height: 100%;
      }
      .footer-nav .navbar-nav {
        height: 100%;
        width: 100%;
      }
      .footer-nav .nav-item {
        flex: 1 1 25%;
        display: flex;
      }
      .footer-nav .nav-link {
        color: var(--on-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        position: relative;
        height: 100%;
        width: 100%;
        transition: transform 0.3s ease;
      }
      .footer-nav .nav-link .material-icons-outlined {
        font-size: 30px;
        color: var(--on-primary);
        transition: transform 0.36s ease, filter 0.36s ease, opacity 0.3s ease;
      }
      .footer-nav .nav-link .label {
        display: none;
      }
      .footer-nav .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 10px;
        left: 50%;
        width: 32px;
        height: 4px;
        transform: translateX(-50%);
        background: var(--footer-indicator);
        border-radius: 2px;
      }
      .footer-nav .nav-link.active {
        transform: translateY(-4px);
      }
      .footer-nav .nav-link .material-icons-outlined {
        opacity: 0.92;
      }
      .footer-nav .nav-link.active .material-icons-outlined {
        opacity: 1;
        transform: translateY(-3px);
        filter: drop-shadow(0 8px 16px rgba(15, 23, 42, 0.28));
        animation: navFloat 2.4s ease-in-out infinite;
      }
      @keyframes navFloat {
        0% {
          transform: translateY(-3px);
        }
        50% {
          transform: translateY(-6px);
        }
        100% {
          transform: translateY(-3px);
        }
      }

      .nav-tabs {
        border-bottom: 1px solid var(--divider);
        gap: 12px;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 4px;
      }
      html,
      body {
        font-family: var(--app-font);
      }
      *,
      *::before,
      *::after {
        font-family: inherit;
      }
      button,
      .btn,
      .form-control,
      .form-select,
      .form-label,
      input,
      select,
      textarea {
        font-family: var(--app-font);
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: var(--app-font);
      }
      .nav-tabs .nav-link {
        border: 0;
        border-radius: 999px;
        padding: 0.45rem 1.1rem;
        color: var(--muted);
        background: transparent;
        font-weight: 600;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .nav-tabs .nav-link:hover,
      .nav-tabs .nav-link:focus {
        color: var(--text-900);
        background: var(--tab-hover-bg);
      }
      .nav-tabs .nav-link.active {
        color: var(--tab-active-text);
        background: var(--tab-active-bg);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      }
      :root[data-theme='dark'] .nav-tabs .nav-link.active {
        box-shadow: 0 12px 24px rgba(2, 8, 20, 0.45);
      }

      /* Task board */
      .task-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .task-title-wrap {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .task-title-wrap .task-title-icon {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--primary);
        color: var(--on-primary);
        font-size: 22px;
        box-shadow: 0 10px 18px rgba(81, 124, 178, 0.25);
      }
      :root[data-theme='dark'] .task-title-wrap .task-title-icon {
        box-shadow: 0 16px 28px rgba(15, 23, 42, 0.45);
      }
      .task-header h3 {
        margin: 0;
      }
      .view-title {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-weight: 700;
        font-size: 1.65rem;
      }
      .task-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 1.5rem;
      }
      .task-tab-btn {
        border: 0;
        border-radius: 999px;
        background: rgba(81, 124, 178, 0.12);
        color: var(--text-700);
        padding: 0.55rem 1.3rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        transition: all var(--fade) ease;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }
      .task-tab-btn .material-icons-outlined {
        font-size: 18px;
      }
      .task-tab-btn:hover,
      .task-tab-btn:focus {
        background: var(--tab-hover-bg);
        color: var(--text-900);
        outline: none;
      }
      .task-tab-btn.active {
        background: var(--tab-active-bg);
        color: var(--tab-active-text);
        box-shadow: 0 14px 26px rgba(15, 23, 42, 0.14);
      }
      :root[data-theme='dark'] .task-tab-btn {
        background: rgba(122, 162, 255, 0.16);
      }
      :root[data-theme='dark'] .task-tab-btn.active {
        box-shadow: 0 18px 32px rgba(2, 8, 20, 0.55);
      }
      .task-panels {
        margin-top: 1.8rem;
      }
      .task-panel {
        display: none;
      }
      .task-panel.active {
        display: block;
      }
      .task-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .task-search {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        border-radius: 999px;
        padding: 0 0.75rem;
        min-height: 46px;
        box-shadow: var(--card-shadow);
      }
      .task-search .material-icons-outlined {
        color: var(--muted);
        font-size: 22px;
      }
      .task-search input {
        border: 0;
        background: transparent;
        color: var(--text-900);
        width: 100%;
        padding: 0.35rem 0.25rem;
        min-width: 0;
      }
      .task-search input::placeholder {
        color: var(--muted);
      }
      .task-search input:focus {
        outline: none;
      }
      .task-filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .task-filter-select {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 14px;
        padding: 0.55rem 1rem;
        min-width: 220px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        color: var(--text-900);
        box-shadow: var(--card-shadow);
        transition: border-color var(--fade) ease, box-shadow var(--fade) ease;
        background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%),
          linear-gradient(135deg, var(--muted) 50%, transparent 50%),
          linear-gradient(to right, rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0.28));
        background-position: calc(100% - 22px) 52%, calc(100% - 14px) 52%, calc(100% - 42px) 50%;
        background-size: 8px 8px, 8px 8px, 1px 28px;
        background-repeat: no-repeat;
        padding-right: 3rem;
      }
      .task-filter-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }
      :root[data-theme='dark'] .task-filter-select {
        background: var(--input-bg);
        color: var(--text-700);
      }
      .task-empty {
        border: 1px dashed var(--divider);
        border-radius: 14px;
        padding: 24px;
        text-align: center;
        color: var(--muted);
      }
      .task-list {
        min-height: 80px;
      }

      /* Layout / cards */
      .page-body {
        padding-top: clamp(8px, calc(var(--header-h) - 36px), 20px);
        padding-bottom: calc(var(--footer-h) + var(--footer-extra) + var(--safe-bottom) + 12px);
        min-height: calc(100vh - var(--header-h) - var(--footer-h));
      }
      @media (max-width: 768px) {
        .page-body {
          padding-top: clamp(12px, calc(var(--header-h) + var(--safe-top) - 40px), 28px);
          min-height: calc(
            100vh - var(--header-h) - var(--footer-h) - var(--footer-extra) - var(--safe-top)
          );
        }
      }
      #home-today-tasks {
        margin-bottom: clamp(28px, 6vw, 42px);
      }
      #home-unread {
        margin-top: clamp(28px, 6vw, 40px);
      }
      .container-xl {
        max-width: 1200px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        padding-left: calc(12px + env(safe-area-inset-left));
        padding-right: calc(12px + env(safe-area-inset-right));
      }
      .card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        background-clip: padding-box;
        color: var(--text-900);
        touch-action: pan-y;
      }
      .card .card-body {
        padding: 16px 18px;
        min-width: 0;
      }
      .card.app-card {
        position: relative;
        border-radius: 20px;
        border: 1px solid rgba(81, 124, 178, 0.18);
        background: linear-gradient(
            135deg,
            rgba(81, 124, 178, 0.12) 0%,
            rgba(81, 124, 178, 0.02) 80%
          ),
          var(--card);
        box-shadow: 0 18px 38px rgba(15, 23, 42, 0.16);
        transition: transform var(--fade) ease, box-shadow var(--fade) ease,
          border-color var(--fade) ease;
      }
      :root[data-theme='dark'] .card.app-card {
        border-color: rgba(90, 122, 196, 0.46);
        background: linear-gradient(135deg, rgba(75, 118, 195, 0.22) 0%, rgba(17, 29, 54, 0.92) 68%),
          var(--card);
        box-shadow: 0 20px 48px rgba(4, 10, 26, 0.68);
      }
      .card.app-card:hover,
      .card.app-card:focus-within {
        transform: translateY(-3px);
        box-shadow: 0 26px 58px rgba(15, 23, 42, 0.2);
        border-color: rgba(81, 124, 178, 0.32);
      }
      :root[data-theme='dark'] .card.app-card:hover,
      :root[data-theme='dark'] .card.app-card:focus-within {
        box-shadow: 0 28px 66px rgba(4, 10, 26, 0.82);
        border-color: rgba(90, 122, 196, 0.72);
      }
      .app-card-body {
        padding: 14px 18px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
        min-width: 0;
      }
      .app-card-main {
        flex: 1 1 auto;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .app-card-meta {
        flex: 0 0 auto;
        min-width: 96px;
        text-align: right;
        font-size: 0.9rem;
        color: var(--muted);
      }
      @media (max-width: 640px) {
        .app-card-body {
          gap: 10px;
        }
        .app-card-meta {
          width: 100%;
          text-align: left;
        }
      }
      .section-head {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .section-head .material-icons {
        color: var(--on-primary);
        background: var(--primary);
        width: 26px;
        height: 26px;
        border-radius: 8px;
        font-size: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Task / Message */
      .card.app-card.task-card {
        border-left: 4px solid rgba(81, 124, 178, 0.4);
        background: var(--card);
        box-shadow: 0 10px 28px rgba(15, 23, 42, 0.14);
      }
      :root[data-theme='dark'] .card.app-card.task-card {
        border-left-color: rgba(102, 135, 214, 0.6);
        box-shadow: 0 12px 32px rgba(3, 9, 24, 0.54);
      }
      .card.app-card.task-card .app-card-body {
        align-items: center;
      }
      .card.app-card.task-card .task-title-line strong {
        font-size: 1.05rem;
      }
      .card.app-card.task-card-completed {
        border-left-color: rgba(148, 163, 184, 0.9);
        background: linear-gradient(
            135deg,
            rgba(148, 163, 184, 0.18),
            rgba(148, 163, 184, 0.04) 70%
          ),
          var(--card);
        opacity: 0.92;
      }
      .card.app-card.task-card-completed .task-title-line strong {
        color: var(--muted);
        text-decoration: line-through;
      }
      .card.app-card.task-card.task-card-overdue {
        border-left-width: 5px;
      }
      .card.app-card.task-card.task-card-overdue-pending {
        border-left-color: #e34b43;
        background: linear-gradient(135deg, rgba(227, 75, 67, 0.22), rgba(227, 75, 67, 0.06) 70%),
          var(--card);
        box-shadow: 0 16px 40px rgba(227, 75, 67, 0.18);
      }
      :root[data-theme='dark'] .card.app-card.task-card.task-card-overdue-pending {
        background: linear-gradient(135deg, rgba(229, 98, 82, 0.42), rgba(17, 29, 54, 0.88) 74%),
          var(--card);
      }
      .card.app-card.task-card.task-card-overdue-inprogress {
        border-left-color: #f49d3f;
        background: linear-gradient(135deg, rgba(244, 157, 63, 0.22), rgba(244, 157, 63, 0.06) 70%),
          var(--card);
        box-shadow: 0 16px 38px rgba(244, 157, 63, 0.16);
      }
      :root[data-theme='dark'] .card.app-card.task-card.task-card-overdue-inprogress {
        background: linear-gradient(135deg, rgba(244, 157, 63, 0.35), rgba(17, 29, 54, 0.86) 78%),
          var(--card);
      }
      .card.app-card.msg-card {
        border-left: 5px solid transparent;
        background: linear-gradient(135deg, rgba(81, 124, 178, 0.12), rgba(81, 124, 178, 0.03) 70%),
          var(--card);
      }
      :root[data-theme='dark'] .card.app-card.msg-card {
        background: linear-gradient(135deg, rgba(53, 85, 168, 0.36), rgba(16, 25, 45, 0.88) 76%),
          var(--card);
      }
      .card.app-card.msg-card.unread {
        border-left-color: var(--warn);
        box-shadow: 0 22px 52px rgba(229, 57, 53, 0.18);
        background: linear-gradient(135deg, rgba(229, 57, 53, 0.18), rgba(229, 57, 53, 0.05) 68%),
          var(--card);
      }
      :root[data-theme='dark'] .card.app-card.msg-card.unread {
        background: linear-gradient(135deg, rgba(229, 98, 82, 0.32), rgba(17, 29, 54, 0.92) 70%),
          var(--card);
      }
      .msg-icon {
        width: 42px;
        height: 42px;
        border-radius: 14px;
        background: rgba(81, 124, 178, 0.16);
        display: inline-flex;
        justify-content: center;
        align-items: center;
        color: var(--primary);
        font-size: 22px;
        flex-shrink: 0;
      }
      .msg-card.unread .msg-icon {
        color: var(--warn);
        background: rgba(229, 57, 53, 0.16);
      }
      :root[data-theme='dark'] .msg-icon {
        background: rgba(91, 135, 224, 0.32);
        color: #cad6ff;
      }
      :root[data-theme='dark'] .msg-card.unread .msg-icon {
        background: rgba(229, 98, 82, 0.34);
        color: var(--warn);
      }
      .msg-card .priority-pill {
        font-size: 0.7rem;
        padding: 2px 8px;
      }

      .msg-lines {
        display: flex;
        flex-direction: column;
        gap: 6px;
        line-height: 1.35;
        min-width: 0;
      }
      .msg-preview {
        color: var(--muted);
        font-size: 0.95rem;
        line-height: 1.35;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .msg-link {
        display: flex;
        flex-direction: column;
        gap: 10px;
        text-decoration: none;
      }
      .msg-link:hover,
      .msg-link:focus {
        text-decoration: none;
      }
      .msg-title-line {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .msg-title-line .msg-title {
        font-weight: 700;
      }
      .msg-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: auto;
        flex-shrink: 0;
        align-self: center;
      }
      .msg-actions .btn {
        border-radius: 999px;
        padding-inline: 18px;
        font-weight: 600;
      }
      .msg-actions .spinner-border {
        margin-left: 8px;
      }
      .msg-content {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        min-width: 0;
      }
      .msg-card-compact .app-card-body {
        padding: 14px 18px;
      }
      .msg-card-compact .msg-preview {
        -webkit-line-clamp: 1;
      }

      /* Fade / Shimmer */
      .fade-container {
        opacity: 0;
        transition: opacity var(--fade) ease;
      }
      .fade-container.show {
        opacity: 1;
      }
      .skeleton {
        border-radius: 14px;
        background: linear-gradient(
          90deg,
          var(--skeleton-1) 25%,
          var(--skeleton-2) 50%,
          var(--skeleton-1) 75%
        );
        background-size: 200% 100%;
        animation: shim 2.6s infinite;
        min-height: 72px;
      }
      .skeleton.sm {
        min-height: 50px;
      }
      .skeleton.text {
        height: 16px;
        width: 70%;
        min-height: 16px;
      }
      @keyframes shim {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      /* Swipe views (px aligned) */
      .views-wrapper {
        position: relative;
        overflow: hidden;
        touch-action: pan-y;
      }
      .views-track {
        display: flex;
        transition: transform 650ms cubic-bezier(0.25, 0.8, 0.25, 1);
        will-change: transform;
      }
      .view-panel {
        flex: 0 0 100%;
        min-width: 0;
      }
      .view-panel.is-hidden {
        visibility: hidden;
        pointer-events: none;
        height: 0 !important;
        overflow: hidden !important;
      }
      .view-panel.show {
        height: auto !important;
        overflow: visible !important;
      }
      .pull-to-refresh {
        position: fixed;
        top: calc(var(--safe-top) + var(--header-h) - 24px);
        left: 50%;
        transform: translate(-50%, 0);
        transition: opacity 0.2s ease;
        padding: 8px 16px;
        border-radius: 999px;
        background: var(--card);
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        gap: 10px;
        pointer-events: none;
        z-index: 2050;
        opacity: 0;
        visibility: hidden;
        color: var(--text-900);
      }
      .pull-to-refresh.show {
        opacity: 1;
        visibility: visible;
      }
      .pull-to-refresh.ready .pull-to-refresh__icon {
        transform: rotate(180deg);
      }
      .pull-to-refresh.refreshing .pull-to-refresh__icon {
        transform: none;
        animation: ptr-spin 0.8s linear infinite;
      }
      .pull-to-refresh__icon {
        font-size: 20px;
        transition: transform 0.2s ease;
      }
      .pull-to-refresh__text {
        font-size: 0.9rem;
        font-weight: 600;
      }
      @keyframes ptr-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @media (min-width: 768px) {
        .pull-to-refresh {
          display: none;
        }
      }

      /* FAB */
      .fab.dropup-center {
        position: fixed;
        left: 50%;
        bottom: calc(var(--footer-h) + var(--footer-extra) + var(--safe-bottom) - 28px);
        transform: translateX(-50%);
        z-index: 1030;
      }
      .fab .btn {
        width: 66px;
        height: 66px;
        border-radius: 50%;
        padding: 0;
        border: none;
        background: linear-gradient(140deg, #ff97ab 0%, #ff5d7d 55%, #ff1f68 100%);
        box-shadow: 0 24px 36px rgba(255, 95, 125, 0.45), 0 10px 20px rgba(255, 95, 125, 0.28);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        transition: transform 0.24s ease, box-shadow 0.24s ease;
      }
      .fab .btn::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: radial-gradient(
          130% 130% at 25% 20%,
          rgba(255, 255, 255, 0.55),
          rgba(255, 255, 255, 0)
        );
        pointer-events: none;
        opacity: 0.85;
      }
      .fab .btn::after {
        content: '';
        position: absolute;
        inset: -25%;
        border-radius: inherit;
        background: radial-gradient(
          120% 120% at 50% 50%,
          rgba(255, 255, 255, 0.2),
          rgba(255, 255, 255, 0)
        );
        opacity: 0;
        transition: opacity 0.24s ease;
        pointer-events: none;
      }
      :root[data-theme='dark'] .fab .btn {
        background: linear-gradient(140deg, #ff6f90 0%, #ff3771 55%, #e01c5f 100%);
        box-shadow: 0 24px 34px rgba(224, 28, 95, 0.5), 0 12px 22px rgba(224, 28, 95, 0.28);
      }
      :root[data-theme='dark'] .fab .btn::before {
        opacity: 0.7;
      }
      .fab .btn:hover,
      .fab .btn:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 20px 34px rgba(232, 93, 106, 0.4);
      }
      .fab .btn:focus-visible {
        outline: none;
        box-shadow: 0 20px 34px rgba(232, 93, 106, 0.45), 0 0 0 4px rgba(255, 255, 255, 0.35);
      }
      .fab .btn:hover::after,
      .fab .btn:focus-visible::after {
        opacity: 0.35;
      }
      .fab .btn:active {
        transform: translateY(1px);
        box-shadow: 0 14px 24px rgba(232, 93, 106, 0.32);
      }
      .fab .btn .material-icons {
        font-size: 34px;
        color: var(--on-primary);
        position: relative;
        z-index: 1;
      }
      .fab .dropdown-toggle::after {
        display: none !important;
      }
      .fab .dropdown-menu {
        display: none;
        padding: 8px 12px;
        border-radius: 14px;
        box-shadow: var(--dropdown-shadow);
        gap: 12px;
        background: var(--card);
        border: 1px solid var(--card-border);
      }
      .fab .dropdown-menu .dropdown-item {
        border-radius: 999px;
        padding: 0.55rem 1.1rem;
        font-weight: 600;
        color: var(--text-900);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .fab .dropdown-menu .dropdown-item .material-icons-outlined {
        color: var(--text-900);
      }
      .fab .dropdown-menu .dropdown-item:hover,
      .fab .dropdown-menu .dropdown-item:focus {
        background: var(--tab-hover-bg);
        color: var(--text-900);
      }
      :root[data-theme='dark'] .fab .dropdown-menu .dropdown-item {
        color: #f5f8ff;
      }
      :root[data-theme='dark'] .fab .dropdown-menu .dropdown-item .material-icons-outlined {
        color: #f5f8ff;
      }
      .fab .dropdown-menu.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      @media (max-width: 576px) {
        .page-body {
          padding-left: 12px;
          padding-right: 12px;
        }
      }

      /* 検索バー */
      .subhead-bar .input-group-text {
        background: var(--input-bg);
        border-right: 0;
        border-color: var(--input-border);
        color: var(--text-700);
      }
      .subhead-bar .form-control {
        border-left: 0;
        background: var(--input-bg);
        border-color: var(--input-border);
        color: var(--text-900);
      }
      .subhead-bar .form-control::placeholder {
        color: var(--muted);
      }

      /* 設定ビュー - ユーザー表 */
      .role-badge {
        font-size: 0.85rem;
      }

      /* 担当者選択UI */
      .assignees-wrap {
        border: 1px solid var(--assignee-border);
        border-radius: 12px;
        padding: 10px;
        background: var(--assignee-bg);
      }
      .assignees-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .assignees-list {
        max-height: 260px;
        overflow: auto;
        border-top: 1px dashed var(--assignee-divider);
        padding-top: 8px;
      }
      .assignees-list .form-check {
        margin-bottom: 6px;
      }
      .badge-counter {
        background: var(--badge-counter-bg);
        color: var(--badge-counter-fg);
        border: 1px solid transparent;
      }

      /* 添付表示 */
      .attach-list .list-group-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .attach-meta {
        font-size: 0.9rem;
        color: var(--attach-meta);
      }

      .list-group-item {
        background: var(--card);
        border-color: var(--card-border);
        color: var(--text-900);
      }
      .text-muted {
        color: var(--muted) !important;
      }
      .task-title-line {
        color: var(--text-900);
      }
      .task-title-line strong {
        color: var(--text-900);
      }
      .link-surface {
        color: var(--text-900) !important;
      }
      .link-surface:hover,
      .link-surface:focus {
        color: var(--text-900) !important;
      }
      .link-surface .text-muted {
        color: var(--muted) !important;
      }
      .task-meta {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .alert-info {
        background: var(--alert-info-bg);
        color: var(--alert-info-text);
        border-color: var(--alert-info-border);
      }

      .priority-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .priority-pill.priority-high {
        background: var(--priority-high-bg);
        color: var(--priority-high-text);
      }
      .priority-pill.priority-middle {
        background: var(--priority-middle-bg);
        color: var(--priority-middle-text);
      }
      .priority-pill.priority-low {
        background: var(--priority-low-bg);
        color: var(--priority-low-text);
      }

      .task-assignee-line {
        color: var(--text-700);
        font-size: 0.86rem;
      }
      .task-meta-line {
        color: var(--muted);
        font-size: 0.82rem;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 4px;
      }
      .badge-soft {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(81, 124, 178, 0.12);
        color: var(--text-700);
        border: none;
        border-radius: 999px;
        font-size: 0.74rem;
        font-weight: 600;
        padding: 2px 10px;
      }
      .badge-soft .material-icons {
        font-size: 14px;
      }
      :root[data-theme='dark'] .badge-soft {
        background: rgba(122, 162, 255, 0.24);
        color: #e0e7ff;
      }
      .card.app-card.task-card-completed {
        border-left-color: rgba(148, 163, 184, 0.9);
        background: linear-gradient(
            135deg,
            rgba(148, 163, 184, 0.18),
            rgba(148, 163, 184, 0.04) 70%
          ),
          var(--card);
        opacity: 0.92;
      }
      .card.app-card.task-card-completed .task-title-line strong {
        text-decoration: line-through;
        color: var(--muted);
      }
      .badge-soft.badge-completed {
        background: rgba(148, 163, 184, 0.16);
        color: rgba(71, 85, 105, 0.92);
      }
      :root[data-theme='dark'] .badge-soft.badge-completed {
        background: rgba(148, 163, 184, 0.24);
        color: #e2e8f0;
      }
      .badge-soft.badge-overdue {
        background: rgba(227, 75, 67, 0.14);
        color: #d13d36;
      }
      :root[data-theme='dark'] .badge-soft.badge-overdue {
        background: rgba(229, 98, 82, 0.34);
        color: #fecaca;
      }

      .modal-modern {
        border-radius: 18px;
        border: 1px solid var(--card-border);
        background: var(--card);
        overflow: hidden;
      }
      .modal-modern .modal-header {
        border-bottom: 1px solid var(--divider);
        padding: 18px 22px;
        background: linear-gradient(135deg, rgba(81, 124, 178, 0.08), transparent);
      }
      :root[data-theme='dark'] .modal-modern .modal-header {
        background: linear-gradient(135deg, rgba(95, 125, 255, 0.22), rgba(16, 26, 53, 0.4));
      }
      .modal-modern .modal-title,
      .modal-modern h6 {
        font-weight: 700;
      }
      .modal-modern .modal-body {
        padding: 22px;
        background: linear-gradient(180deg, rgba(148, 163, 184, 0.04), transparent 24%);
      }
      .modal-modern .modal-footer {
        border-top: 1px solid var(--divider);
        padding: 16px 22px;
        background: var(--card);
      }
      .modal-modern .btn {
        border-radius: 999px;
      }
      .modal-modern .btn.btn-link {
        border-radius: 50px;
        padding: 6px 10px;
      }

      .form-section {
        border: 1px solid var(--card-border);
        border-radius: 14px;
        padding: 16px 18px;
        background: var(--card);
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.05);
        margin-bottom: 18px;
      }
      :root[data-theme='dark'] .form-section {
        box-shadow: 0 18px 32px rgba(2, 8, 20, 0.35);
      }
      .form-section-title {
        font-size: 0.9rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 8px;
      }
      .form-section .form-label {
        font-weight: 600;
      }
      .form-section .section-note {
        font-size: 0.85rem;
        color: var(--muted);
        margin-top: 4px;
      }
      .form-section .section-body {
        color: var(--text-900);
      }
      .settings-layout {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }
      .settings-block-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 16px;
      }
      .settings-block-header .settings-block-icon {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(81, 124, 178, 0.12);
        color: var(--primary);
      }
      :root[data-theme='dark'] .settings-block-header .settings-block-icon {
        background: rgba(122, 162, 255, 0.18);
        color: #dbe4ff;
      }
      .settings-block-header h5 {
        font-weight: 700;
        margin: 0;
      }
      .settings-block-header p {
        margin: 2px 0 0;
        color: var(--muted);
        font-size: 0.9rem;
      }
      .settings-profile-body {
        display: grid;
        grid-template-columns: minmax(0, 180px) minmax(0, 1fr);
        gap: 18px;
        align-items: start;
      }
      @media (max-width: 576px) {
        .settings-profile-body {
          grid-template-columns: 1fr;
        }
      }
      .settings-avatar-shell {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .settings-avatar {
        width: 96px;
        height: 96px;
        border-radius: 30px;
        object-fit: cover;
        box-shadow: 0 10px 32px rgba(15, 23, 42, 0.15);
        border: 3px solid rgba(81, 124, 178, 0.2);
        background: var(--card);
      }
      :root[data-theme='dark'] .settings-avatar {
        box-shadow: 0 16px 40px rgba(2, 8, 20, 0.55);
        border-color: rgba(122, 162, 255, 0.28);
      }
      .settings-avatar.is-pending {
        box-shadow: 0 0 0 3px rgba(81, 124, 178, 0.35);
      }
      :root[data-theme='dark'] .settings-avatar.is-pending {
        box-shadow: 0 0 0 3px rgba(122, 162, 255, 0.45);
      }
      .settings-image-meta {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .settings-image-meta.is-pending {
        color: var(--primary-700);
        font-weight: 600;
      }
      :root[data-theme='dark'] .settings-image-meta.is-pending {
        color: #dbe4ff;
      }
      .settings-upload-note {
        display: inline-flex;
        align-items: flex-start;
        gap: 6px;
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(81, 124, 178, 0.1);
        color: var(--text-900);
        font-size: 0.85rem;
      }
      .settings-upload-note .material-icons,
      .settings-upload-note .material-icons-outlined {
        font-size: 18px;
        margin-top: -2px;
      }
      :root[data-theme='dark'] .settings-upload-note {
        background: rgba(122, 162, 255, 0.18);
        color: #e8edff;
      }
      .settings-theme-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .theme-status {
        margin-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(81, 124, 178, 0.12);
        color: var(--primary-700);
        font-weight: 600;
        font-size: 0.85rem;
      }
      :root[data-theme='dark'] .theme-status {
        background: rgba(122, 162, 255, 0.22);
        color: #dbe4ff;
      }
      .settings-theme-guide {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .settings-theme-guide ul {
        margin: 0;
        padding-left: 1.15rem;
      }
      .settings-theme-guide li {
        margin-bottom: 4px;
      }
      .settings-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      .settings-admin-card {
        background: linear-gradient(135deg, rgba(81, 124, 178, 0.08), transparent);
      }
      :root[data-theme='dark'] .settings-admin-card {
        background: linear-gradient(135deg, rgba(95, 125, 255, 0.22), rgba(16, 26, 53, 0.6));
      }

      .modal-content {
        background: var(--card);
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
        color: var(--text-900);
      }
      .modal-header,
      .modal-footer {
        background: var(--card);
        border-color: var(--divider);
      }
      .modal-backdrop.show {
        opacity: 1;
        background: rgba(5, 10, 20, 0.6);
      }
      :root[data-theme='light'] .modal-backdrop.show {
        background: rgba(15, 23, 42, 0.35);
      }

      .form-label,
      .modal-title {
        color: var(--text-900);
      }
      .form-control,
      .form-select,
      textarea.form-control {
        background: var(--input-bg);
        border-color: var(--input-border);
        color: var(--text-900);
      }
      .form-control:focus,
      .form-select:focus,
      textarea.form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem var(--focus-ring);
      }
      .form-control::placeholder,
      textarea.form-control::placeholder {
        color: var(--muted);
      }
      .form-control:disabled,
      .form-select:disabled {
        opacity: 0.8;
      }
      .form-control-plaintext {
        color: var(--muted);
      }

      .btn-outline-primary {
        color: var(--primary);
        border-color: var(--primary);
      }
      .btn-outline-primary:hover,
      .btn-outline-primary:focus {
        background: var(--primary);
        color: var(--on-primary);
      }
      [data-theme='dark'] .btn-secondary {
        background: rgba(148, 163, 184, 0.18);
        border-color: rgba(148, 163, 184, 0.35);
        color: var(--text-900);
      }
      [data-theme='dark'] .btn-secondary:hover,
      [data-theme='dark'] .btn-secondary:focus {
        background: rgba(148, 163, 184, 0.28);
        border-color: rgba(148, 163, 184, 0.48);
      }

      /* 認証ゲート（削除） */
      .text-truncate-container {
        min-width: 0;
      }
      .auth-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(24px, 5vw, 64px);
        background:
          radial-gradient(circle at top right, rgba(59, 130, 246, 0.26), transparent 55%),
          radial-gradient(circle at bottom left, rgba(14, 165, 233, 0.18), transparent 45%),
          linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.75));
        backdrop-filter: blur(16px);
        z-index: 3000;
      }
      .auth-overlay.d-none {
        display: none !important;
      }
      .auth-shell {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: min(640px, 90vh);
        padding: clamp(16px, 4vw, 40px);
      }
      .auth-card {
        width: min(360px, 100%);
        margin: 0 auto;
        background: rgba(15, 23, 42, 0.92);
        border-radius: 24px;
        padding: clamp(28px, 4vw, 40px);
        box-shadow: 0 28px 72px rgba(2, 6, 23, 0.55);
        display: flex;
        flex-direction: column;
        gap: 20px;
        backdrop-filter: blur(12px);
      }
      .auth-card__title {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 600;
        color: #f8fafc;
        text-align: center;
      }
      .auth-card__subtitle {
        margin: 0;
        font-size: 0.96rem;
        color: rgba(226, 232, 240, 0.75);
        text-align: center;
        line-height: 1.6;
      }
      .auth-card__hint {
        font-size: 0.82rem;
        color: rgba(226, 232, 240, 0.6);
        text-align: center;
        line-height: 1.6;
      }
      .auth-card__actions {
        display: grid;
        gap: 12px;
      }

      .auth-session {
        display: none;
        align-items: center;
        gap: 16px;
      }
      .auth-session.is-visible {
        display: flex;
      }
      .auth-session__avatar {
        width: 52px;
        height: 52px;
        border-radius: 18px;
        object-fit: cover;
        background: rgba(148, 163, 184, 0.25);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .auth-session__meta {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .auth-session__name {
        font-weight: 600;
        font-size: 1rem;
      }
      .auth-session__email {
        font-size: 0.9rem;
        color: rgba(226, 232, 240, 0.7);
      }
      .auth-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        width: 100%;
        border-radius: 16px;
        padding: 14px 18px;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      .auth-button .material-icons,
      .auth-button .material-icons-outlined {
        font-size: 1.3rem;
      }
      .auth-button--primary {
        background: linear-gradient(135deg, #2563eb, #38bdf8);
        color: #f8fafc;
        box-shadow: 0 18px 36px rgba(37, 99, 235, 0.35);
      }
      .auth-button--primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 20px 45px rgba(37, 99, 235, 0.4);
      }
      .auth-button--secondary {
        background: rgba(148, 163, 184, 0.15);
        color: #e2e8f0;
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      .auth-button--secondary:hover {
        transform: translateY(-1px);
        border-color: rgba(148, 163, 184, 0.38);
      }
      .auth-meta {
        display: none;
      }
      .auth-meta strong {
        color: #f8fafc;
      }
      .auth-error {
        display: none;
        font-size: 0.88rem;
        line-height: 1.6;
        color: #fecaca;
        background: rgba(220, 38, 38, 0.12);
        border: 1px solid rgba(248, 113, 113, 0.35);
        border-radius: 14px;
        padding: 12px 16px;
      }
      .auth-error.is-visible {
        display: block;
      }
      @media (max-width: 920px) {
        .auth-shell {
          min-height: auto;
          padding: 24px;
        }
      }
      body.bootstrapping header.navbar,
      body.bootstrapping nav.topbar,
      body.bootstrapping .footer-nav,
      body.bootstrapping main.page-body,
      body.bootstrapping .fab,
      body.bootstrapping #notification-area {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .auth-backdrop {
        position: fixed;
        inset: 0;
        background: var(--body-bg);
        background-color: var(--surface);
        background-repeat: no-repeat;
        background-size: cover;
        background-attachment: fixed;
        z-index: 1500;
        pointer-events: none;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
      }
      :root[data-theme='dark'] .auth-backdrop {
        background: var(--body-bg);
        background-color: var(--surface);
      }
      body.auth-screen .auth-backdrop {
        opacity: 1;
        visibility: visible;
      }
      body.auth-screen {
        overflow: hidden;
      }
      body.auth-screen [data-app-shell] {
        opacity: 0;
        pointer-events: none !important;
        visibility: hidden;
      }
      body.auth-screen .bootstrap-loading {
        display: none !important;
      }
      .bootstrap-loading {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: rgba(10, 18, 40, 0.55);
        backdrop-filter: blur(8px);
        z-index: 2500;
      }
      body.bootstrapping .bootstrap-loading {
        display: flex;
      }
      .bootstrap-loading__card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 20px;
        padding: 32px 28px;
        box-shadow: 0 28px 60px rgba(15, 23, 42, 0.32);
        text-align: center;
        max-width: 320px;
        width: 100%;
      }
      :root[data-theme='dark'] .bootstrap-loading__card {
        background: rgba(9, 17, 35, 0.9);
        box-shadow: 0 28px 60px rgba(2, 8, 20, 0.6);
      }
      .bootstrap-loading__card .spinner-border {
        width: 3rem;
        height: 3rem;
        margin-bottom: 18px;
      }
      .bootstrap-loading__text {
        margin: 0;
        font-weight: 600;
        color: var(--text-900);
      }
    </style>
  </head>
  <body class="auth-screen">
    <!-- ===== Inline SVG sprite for reusable icons ===== -->
    <svg width="0" height="0" style="position: absolute">
      <symbol id="plane" viewBox="0 0 24 24">
        <path
          d="M2.2 11.2L20.6 2.6c.9-.4 1.8.6 1.3 1.5l-6.3 11.6c-.2.4-.7.6-1.1.5l-4.1-1.1a.8.8 0 0 1-.2-1.5l6.7-4.3-8.2 3.5c-.2.1-.5.1-.7-.1L2 12.3c-.6-.4-.5-1.2.2-1.6zM9.6 14.6l-.6 5a.8.8 0 0 0 1.3.7l3.9-3.4-4.6-1.3z"
        />
      </symbol>
    </svg>
    <!-- ===== Authentication backdrop and overlay ===== -->
    <div id="auth-backdrop" class="auth-backdrop" aria-hidden="true"></div>
    <div id="auth-overlay" class="auth-overlay d-none" aria-hidden="true">
      <div class="auth-shell">
        <section class="auth-card">
          <div id="auth-session" class="auth-session">
            <img id="auth-session-avatar" class="auth-session__avatar" alt="Profile" />
            <div class="auth-session__meta">
              <span id="auth-session-name" class="auth-session__name"></span>
              <span id="auth-session-email" class="auth-session__email"></span>
            </div>
          </div>
          <h1 class="auth-card__title">ShiftFlow 認証を開始</h1>
          <p class="auth-card__subtitle">組織の Google Workspace アカウントで利用者認証を行います。</p>
          <div class="auth-error" id="auth-error"></div>
          <div class="auth-card__actions">
            <button id="btn-auth-google" class="auth-button auth-button--primary" type="button">
              <span class="material-icons">login</span>
              <span>Google Workspace 認証を開始</span>
            </button>
            <button
              id="btn-auth-logout"
              class="auth-button auth-button--secondary d-none"
              type="button"
            >
              <span class="material-icons-outlined">logout</span>
              <span>サインアウト</span>
            </button>
          </div>
        </section>
      </div>
    </div>

    <!-- ===== Notification toast mount point ===== -->
    <div
      id="notification-area"
      data-app-shell
      hidden
      style="
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        width: 92%;
        max-width: 520px;
      "
    ></div>

    <!-- ===== Pull-to-refresh indicator ===== -->
    <div
      class="pull-to-refresh"
      id="pullToRefresh"
      role="status"
      aria-hidden="true"
      data-app-shell
      hidden
    >
      <span class="material-icons pull-to-refresh__icon" id="pullToRefreshIcon" aria-hidden="true"
        >expand_more</span
      >
      <span class="pull-to-refresh__text" id="pullToRefreshText">下に引っ張って更新</span>
    </div>

    <!-- ===== Initial bootstrap loading mask ===== -->
    <div id="bootstrap-loading" class="bootstrap-loading" aria-hidden="true" data-app-shell hidden>
      <div class="bootstrap-loading__card" role="status" aria-live="polite">
        <div class="spinner-border text-primary" role="presentation"></div>
        <p class="bootstrap-loading__text">ShiftFlow のデータを読み込んでいます…</p>
      </div>
    </div>

    <!-- ===== Static PWA preview shell (hidden until UI integration) ===== -->
    <!-- TODO: 既存UIと統合 -->
    <section
      class="pwa-preview-shell"
      aria-label="ShiftFlow モバイルプレビュー"
      data-app-shell
      hidden
    >
      <header class="pwa-header" aria-label="アプリ共通ヘッダー">
        <div class="pwa-header__title">ShiftFlow</div>
        <button
          type="button"
          class="pwa-header__sync"
          id="pwaSyncPreview"
          aria-label="最新情報を同期"
        >
          <span class="material-icons-outlined" aria-hidden="true">sync</span>
        </button>
      </header>
      <main class="pwa-main" aria-label="ホームカード">
        <article class="pwa-card" aria-labelledby="pwa-card-title">
          <h2 id="pwa-card-title" class="h5 mb-2">今日のタスク</h2>
          <p class="pwa-card__meta">進行中のタスクや共有メモの更新状況がここに表示されます。</p>
          <ul class="pwa-list" aria-label="ダミータスクリスト">
            <li>
              <span class="pwa-list__dot" aria-hidden="true"></span>
              朝礼メモを確認し、チームに共有する
            </li>
            <li>
              <span class="pwa-list__dot" aria-hidden="true"></span>
              交代スタッフの引き継ぎ事項をチェック
            </li>
            <li>
              <span class="pwa-list__dot" aria-hidden="true"></span>
              ヒヤリハットの報告をレビュー
            </li>
          </ul>
        </article>
      </main>
      <footer class="pwa-footer" aria-label="アプリ共通フッター">
        <nav class="pwa-footer__nav" aria-label="メインナビゲーション">
          <button
            type="button"
            class="pwa-footer__button pwa-footer__button--active"
            aria-label="ホーム"
          >
            <span class="material-icons-outlined" aria-hidden="true">home</span>
            <span>ホーム</span>
          </button>
          <button type="button" class="pwa-footer__button" aria-label="タスク">
            <span class="material-icons-outlined" aria-hidden="true">checklist</span>
            <span>タスク</span>
          </button>
          <button type="button" class="pwa-footer__button" aria-label="メッセージ">
            <span class="material-icons-outlined" aria-hidden="true">mail</span>
            <span>メッセ</span>
          </button>
          <button type="button" class="pwa-footer__button is-disabled" id="btn-mobile-logout" aria-label="ログアウト" disabled>
            <span class="material-icons-outlined" aria-hidden="true">logout</span>
            <span>ログアウト</span>
          </button>
        </nav>
      </footer>
    </section>

    <!-- ===== Desktop header and user menu ===== -->
    <header class="navbar navbar-expand-md d-print-none" data-app-shell hidden>
      <div class="container-xl">
        <a href="#" class="navbar-brand app-brand" data-view="home" title="" data-bind-user-email>
          <span class="brand-mark">
            <span class="brand-ring"></span>
            <img src="/icons/icon-192.png" alt="ShiftFlow" class="brand-icon" />
          </span>
          <span class="brand-title">
            <span class="brand-text-main">ShiftFlow</span>
          </span>
        </a>
        <div class="navbar-nav ms-auto flex-row align-items-center gap-2 order-md-last">
          <button
            type="button"
            class="btn btn-sm btn-outline-light btn-icon-only d-none"
            id="btn-header-logout"
            title="ログアウト"
          >
            <span class="material-icons-outlined align-middle">logout</span>
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-light btn-icon-only"
            id="btn-admin-menu"
            title="Admin menu (coming soon)"
          >
            <span class="material-icons-outlined align-middle">admin_panel_settings</span>
          </button>
          <span class="nav-link d-flex lh-1 text-reset p-0 align-items-center gap-2">
            <img
              src="/icons/icon-192.png"
              class="avatar avatar-sm js-user-avatar"
              data-avatar-url="/icons/icon-192.png"
              data-bind-user-avatar
              alt="User"
            />
            <span class="d-none d-xl-block ps-2">
              <strong data-bind-user-name>ゲストユーザー</strong>
              <small class="d-block" style="opacity: 0.9">ログイン中</small>
            </span>
          </span>
        </div>
      </div>
    </header>

    <!-- ===== Desktop topbar navigation ===== -->
    <nav class="navbar navbar-expand-md topbar d-none d-md-block" data-app-shell hidden>
      <div class="container-xl">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-view="home" title="Home"
              ><span class="material-icons-outlined">home</span></a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link nav-icon" href="#" data-view="tasks" title="Tasks">
              <span class="material-icons-outlined">send</span>
              <span class="badge badge-overdue nav-icon-badge d-none" id="badge-task-overdue-top"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-icon" href="#" data-view="messages" title="Messages">
              <span class="material-icons-outlined">mail</span>
              <span class="badge badge-unread nav-icon-badge d-none" id="badge-unread-top">0</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-view="settings" title="Settings"
              ><span class="material-icons-outlined">settings</span></a
            >
          </li>
        </ul>
      </div>
    </nav>

    <!-- 認証ゲート（ログイン画面）はGASが自動で表示するため、HTMLからは削除 -->

    <!-- ===== Main application view panels ===== -->
    <main class="page-body" data-app-shell hidden>
      <div class="views-wrapper container-xl" id="viewsWrapper">
        <div class="views-track" id="viewsTrack">
          <!-- ----- Home view panel ----- -->
          <section class="view-panel fade-container show" id="view-home">
            <div class="d-flex justify-content-between align-items-center mt-0">
              <div class="section-head">
                <span class="material-icons">event</span>
                <h3 class="m-0">Today's Task</h3>
              </div>
              <a href="#" class="link-soft" data-view="tasks">View all</a>
            </div>
            <!-- Mount point for the "today's tasks" card list -->
            <div id="home-today-tasks" class="mt-2"></div>

            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="section-head">
                <span class="material-icons">mark_email_unread</span>
                <h3 class="m-0">New Message</h3>
              </div>
              <a href="#" class="link-soft" data-view="messages">View all</a>
            </div>
            <!-- Mount point for unread message cards -->
            <div id="home-unread" class="mt-2"></div>
          </section>

          <!-- ----- Tasks view panel ----- -->
          <section class="view-panel fade-container is-hidden" id="view-tasks">
            <div class="task-header mt-0">
              <div class="task-title-wrap">
                <span class="material-icons-outlined task-title-icon">send</span>
                <h3 class="view-title">TASKS</h3>
              </div>
              <button
                class="btn btn-outline-primary d-flex align-items-center gap-1"
                id="task-reload"
                type="button"
              >
                <span class="material-icons align-middle">refresh</span>RELOAD
              </button>
            </div>

            <div class="task-tabs" id="taskTabs">
              <button class="task-tab-btn active" data-task-tab="my" type="button">MY TASK</button>
              <button class="task-tab-btn" data-task-tab="from" type="button">FROM ME</button>
              <button
                class="task-tab-btn d-none"
                data-task-tab="all"
                data-manager-only="true"
                type="button"
              >
                <span class="material-icons-outlined">admin_panel_settings</span>ALL TASKS
              </button>
            </div>

            <div class="task-panels">
              <div class="task-panel active" data-task-panel="my">
                <div class="task-controls">
                  <div class="task-search">
                    <span class="material-icons-outlined">search</span>
                    <input
                      type="search"
                      id="task-search-my"
                      placeholder="Search tasks"
                      aria-label="Search my tasks"
                    />
                  </div>
                </div>
                <!-- Results container for "My Tasks" -->
                <div class="task-list mt-3" id="task-list-my"></div>
              </div>

              <div class="task-panel" data-task-panel="from">
                <div class="task-controls">
                  <div class="task-search">
                    <span class="material-icons-outlined">search</span>
                    <input
                      type="search"
                      id="task-search-from"
                      placeholder="Search tasks"
                      aria-label="Search tasks I created"
                    />
                  </div>
                  <div class="task-filter-row">
                    <select class="task-filter-select" id="task-filter-from-assignee">
                      <option value="">Filter by assignee</option>
                    </select>
                  </div>
                </div>
                <!-- Results container for "From Me" tasks -->
                <div class="task-list mt-3" id="task-list-from"></div>
              </div>

              <div class="task-panel d-none" data-task-panel="all" data-manager-only="true">
                <div class="task-controls">
                  <div class="task-search">
                    <span class="material-icons-outlined">search</span>
                    <input
                      type="search"
                      id="task-search-all"
                      placeholder="Search tasks"
                      aria-label="Search all tasks"
                    />
                  </div>
                  <div class="task-filter-row">
                    <select class="task-filter-select" id="task-filter-all-assignee">
                      <option value="">Filter by assignee</option>
                    </select>
                  </div>
                </div>
                <!-- Results container for "All Tasks" (manager only) -->
                <div class="task-list mt-3" id="task-list-all"></div>
              </div>
            </div>
          </section>

          <!-- ----- Messages view panel ----- -->
          <section class="view-panel fade-container is-hidden" id="view-messages">
            <div class="task-header mt-0">
              <div class="task-title-wrap">
                <span class="material-icons-outlined task-title-icon">mail</span>
                <h3 class="view-title">MESSAGES</h3>
              </div>
            </div>
            <div class="subhead-bar mt-2">
              <div class="input-group">
                <span class="input-group-text material-icons-outlined">search</span>
                <input
                  type="text"
                  class="form-control"
                  id="msg-search-box"
                  placeholder="Search title or body"
                />
              </div>
            </div>
            <div class="row g-2 align-items-end mt-2">
              <div class="col-auto">
                <label class="form-label">Folder</label>
                <select id="flt-msg-folder" class="form-select" data-folder-select="filter">
                  <option value="">All</option>
                </select>
              </div>
              <div class="col-auto">
                <label class="form-label d-block">&nbsp;</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="flt-msg-unread" />
                  <label class="form-check-label" for="flt-msg-unread">Unread only</label>
                </div>
              </div>
              <div class="col-auto">
                <label class="form-label d-block">&nbsp;</label>
                <button
                  class="btn btn-outline-success"
                  id="btn-msg-markall"
                  type="button"
                  aria-label="Mark all unread as read"
                >
                  <span class="material-icons align-middle me-1">done_all</span>Mark All Read
                </button>
              </div>
            </div>
            <!-- Message card list mount point -->
            <div id="msg-list" class="mt-2"></div>
          </section>

          <!-- ----- Settings view panel ----- -->
          <section class="view-panel fade-container is-hidden" id="view-settings">
            <h3 class="mt-0"><span class="material-icons align-middle me-1">settings</span>設定</h3>
            <!-- Settings form wrapper (profile, appearance, etc.) -->
            <form class="settings-layout" id="form-settings">
              <div class="form-section settings-block">
                <div class="settings-block-header">
                  <div class="settings-block-icon">
                    <span class="material-icons-outlined">badge</span>
                  </div>
                  <div>
                    <h5>プロフィール</h5>
                    <p>メンバーに表示される名前とプロフィール画像を管理します。</p>
                  </div>
                </div>
                <div class="settings-profile-body">
                  <div class="settings-avatar-shell">
                    <img
                      class="settings-avatar js-user-avatar"
                      id="setting-avatar-preview"
                      src="/icons/icon-192.png"
                      data-avatar-url="/icons/icon-192.png"
                      data-placeholder="https://placehold.jp/150x150.png"
                      data-bind-user-avatar
                      alt="プロフィール画像のプレビュー"
                    />
                    <button
                      class="btn btn-outline-secondary w-100"
                      type="button"
                      id="btn-setting-image"
                    >
                      <span class="material-icons-outlined align-middle me-1">image</span>画像を選択
                    </button>
                    <div class="settings-image-meta" id="setting-image-name">未設定</div>
                    <input
                      type="file"
                      accept="image/*"
                      class="d-none"
                      id="setting-image-file"
                      aria-label="プロフィール画像を選択"
                    />
                  </div>
                  <div>
                    <label class="form-label" for="setting-name">表示名</label>
                    <input
                      class="form-control"
                      id="setting-name"
                      placeholder="チームで表示される名前"
                    />
                    <div class="settings-upload-note">
                      <span class="material-icons-outlined align-middle">info</span>
                      <span
                        >最大2MBの画像ファイルがアップロードされ、ドライブに安全に保存されます。</span
                      >
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-section settings-block">
                <div class="settings-block-header">
                  <div class="settings-block-icon">
                    <span class="material-icons-outlined">dark_mode</span>
                  </div>
                  <div>
                    <h5>外観設定</h5>
                    <p>アプリの配色テーマを切り替えて見やすさを調整します。</p>
                  </div>
                </div>
                <div class="settings-theme-grid">
                  <div>
                    <label class="form-label" for="setting-theme">テーマ</label>
                    <select class="form-select" id="setting-theme">
                      <option value="light">ライト</option>
                      <option value="dark">ダーク</option>
                      <option value="system">システムに合わせる</option>
                    </select>
                    <div class="theme-status" id="setting-theme-display">
                      <span class="material-icons-outlined align-middle">light_mode</span
                      >ライトテーマを適用中
                    </div>
                  </div>
                  <div class="settings-theme-guide">
                    <p class="mb-2">選択したテーマはすぐに反映されます。</p>
                    <ul class="mb-0">
                      <li><strong>ライト:</strong> 明るく爽やかなトーンで日中の作業に最適。</li>
                      <li><strong>ダーク:</strong> 暗い環境や長時間の閲覧で目を保護。</li>
                      <li><strong>システム:</strong> ご利用端末のテーマ設定に自動追従します。</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="settings-actions">
                <button class="btn btn-primary" type="button" id="btn-settings-save">
                  <span class="label">
                    <span class="material-icons align-middle me-1">save</span>変更を保存
                  </span>
                  <span
                    class="spinner-border spinner-border-sm d-none"
                    role="status"
                    aria-hidden="true"
                  ></span>
                </button>
              </div>
            </form>

            <div class="form-section settings-block settings-admin-card mt-2">
              <div class="settings-block-header">
                <div class="settings-block-icon">
                  <span class="material-icons-outlined">admin_panel_settings</span>
                </div>
                <div>
                  <h5>管理者メニュー</h5>
                  <p>
                    ユーザー管理機能を準備中です。今後この画面から各種管理が行えるようになります。
                  </p>
                </div>
              </div>
              <p class="mb-0 text-muted small">
                管理機能をご希望の場合は管理者までお問い合わせください。リリースまでしばらくお待ちください。
              </p>
            </div>
          </section>
        </div>
      </div>
    </main>

    <!-- ===== Floating action button for quick actions ===== -->
    <div class="fab dropup dropup-center" data-app-shell hidden>
      <button
        class="btn dropdown-toggle"
        id="fabButton"
        data-bs-toggle="dropdown"
        data-bs-auto-close="outside"
        data-bs-offset="10,10"
        aria-expanded="false"
        aria-label="作成"
      >
        <span class="material-icons">add</span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="fabButton">
        <li>
          <button class="dropdown-item" type="button" id="btn-open-new-task">
            <span class="material-icons-outlined">send</span> Task
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="button" id="btn-open-new-msg">
            <span class="material-icons-outlined">mail</span> Message
          </button>
        </li>
      </ul>
    </div>

    <!-- ===== Mobile bottom navigation ===== -->
    <nav class="navbar navbar-expand footer-nav d-md-none" data-app-shell hidden>
      <div class="container-fluid">
        <ul class="navbar-nav w-100 justify-content-around">
          <li class="nav-item">
            <a
              class="nav-link text-center active"
              href="#"
              data-view="home"
              aria-label="ホーム"
              title="ホーム"
            >
              <span class="material-icons-outlined" aria-hidden="true">home</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center nav-icon"
              href="#"
              data-view="tasks"
              aria-label="タスク"
              title="タスク"
            >
              <span class="material-icons-outlined" aria-hidden="true">send</span>
              <span class="badge badge-overdue nav-icon-badge d-none" id="badge-task-overdue-bottom"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center nav-icon"
              href="#"
              data-view="messages"
              aria-label="メッセージ"
              title="メッセージ"
            >
              <span class="material-icons-outlined" aria-hidden="true">mail</span>
              <span class="badge badge-unread nav-icon-badge d-none" id="badge-unread-bottom"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center"
              href="#"
              data-view="settings"
              aria-label="設定"
              title="設定"
            >
              <span class="material-icons-outlined" aria-hidden="true">settings</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- ===== Modal dialogs ===== -->
    <!-- ----- New Task modal ----- -->
    <div class="modal" id="newTaskModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="modal-title m-0">新しいタスク</h6>
          </div>
          <div class="modal-body">
            <form id="newTaskForm" class="modal-form">
              <div class="form-section">
                <div
                  id="taskFromMsgHint"
                  class="alert alert-info py-2 px-3 d-none mb-3"
                  role="alert"
                  style="border-radius: 10px"
                >
                  <span class="material-icons align-middle me-1">link</span>
                  <strong>元メッセージ：</strong
                  ><a href="#" id="backToMsgLink" class="text-decoration-none">—</a>
                </div>
                <div class="form-section-title">基本情報</div>
                <div class="mb-3">
                  <label class="form-label">タイトル</label>
                  <input type="text" class="form-control" id="taskTitle" required />
                </div>
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label">期限</label>
                    <input type="date" class="form-control" id="taskDueDate" required />
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">優先度</label>
                    <select class="form-select" id="taskPriority">
                      <option>中</option>
                      <option>高</option>
                      <option>低</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="form-section">
                <div class="form-section-title d-flex align-items-center justify-content-between">
                  担当者
                  <span class="ms-2 badge badge-counter" id="assignee-count-badge">選択 0 件</span>
                </div>
                <div class="assignees-wrap">
                  <div class="assignees-toolbar">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary"
                      id="btn-assignee-selectall"
                    >
                      すべて選択
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-secondary"
                      id="btn-assignee-clear"
                    >
                      すべて解除
                    </button>
                  </div>
                  <div id="assignee-list" class="assignees-list"></div>
                </div>
                <div class="section-note">
                  タスクの担当者を1名以上選択してください。自分自身も選択できます。
                </div>
              </div>

              <div class="form-section">
                <div class="form-section-title">繰り返し</div>
                <div class="mb-3">
                  <label class="form-label">パターン</label>
                  <select class="form-select" id="taskRepeatType">
                    <option value="none">単発（繰り返しなし）</option>
                    <option value="daily">毎日</option>
                    <option value="weekly">毎週</option>
                    <option value="monthly">毎月</option>
                  </select>
                  <div class="section-note">完了時に次回タスクを自動で生成します。</div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              キャンセル
            </button>
            <button type="button" class="btn btn-primary" id="saveTaskButton">
              <span class="label">保存する</span>
              <span
                class="spinner-border spinner-border-sm d-none"
                role="status"
                aria-hidden="true"
              ></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ----- Compose Message modal ----- -->
    <div class="modal" id="newMessageModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="modal-title m-0">新しいメッセージ</h6>
          </div>
          <div class="modal-body">
            <form id="newMessageForm" class="modal-form">
              <div class="form-section">
                <div class="form-section-title">基本情報</div>
                <div class="mb-3">
                  <label class="form-label">件名</label>
                  <input type="text" class="form-control" id="messageTitle" required />
                </div>
                <div class="mb-3">
                  <label class="form-label">本文</label>
                  <textarea class="form-control" id="messageBody" rows="5" required></textarea>
                </div>
              </div>
              <div class="form-section">
                <div class="form-section-title">詳細設定</div>
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label">フォルダ</label>
                    <select class="form-select" id="messageFolder" data-folder-select="compose">
                      <option value="">フォルダを選択</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">優先度</label>
                    <select class="form-select" id="messagePriority">
                      <option>中</option>
                      <option>高</option>
                      <option>低</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-section">
                <div class="form-section-title">添付画像</div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <button class="btn btn-outline-secondary" type="button" id="btn-message-attach">
                    画像を追加
                  </button>
                  <span class="small text-muted" id="message-attach-hint">最大3件・各4MBまで</span>
                </div>
                <input
                  type="file"
                  accept="image/*"
                  class="d-none"
                  id="message-attachment-input"
                  multiple
                  aria-label="添付画像を選択"
                />
                <ul class="list-unstyled small mb-0 mt-2" id="message-attachment-list"></ul>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              キャンセル
            </button>
            <button type="button" class="btn btn-primary" id="saveMessageButton">
              <span class="label">投稿する</span>
              <span
                class="spinner-border spinner-border-sm d-none"
                role="status"
                aria-hidden="true"
              ></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ----- Task detail modal ----- -->
    <div class="modal" id="taskDetailModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="m-0">タスク詳細</h6>
          </div>
          <div class="modal-body">
            <div id="task-detail-loading" class="skeleton mb-3"></div>
            <div id="task-detail-content" class="d-none">
              <h4 id="detailTaskTitle" class="mb-3"></h4>
              <div id="taskDetailBody" class="form-section mb-3"></div>
              <div id="taskAttachments" class="mb-3 d-none">
                <div class="form-section">
                  <h6 class="mb-2">
                    <span class="material-icons align-middle me-1">attach_file</span>添付
                  </h6>
                  <ul class="list-group attach-list" id="taskAttachList"></ul>
                </div>
              </div>
              <div class="form-section mb-2">
                <div class="row g-2">
                  <div class="col-12 col-md-4">
                    <label class="form-label">ステータス</label>
                    <select id="detailStatus" class="form-select">
                      <option>未着手</option>
                      <option>対応中</option>
                      <option>完了</option>
                    </select>
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label">期限</label>
                    <input id="detailDue" type="date" class="form-control" />
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label">優先度</label>
                    <select id="detailPriority" class="form-select">
                      <option>中</option>
                      <option>高</option>
                      <option>低</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2 flex-wrap">
                  <button class="btn btn-primary" id="btnTaskQuickSave">
                    <span class="label">この内容で更新</span>
                    <span
                      class="spinner-border spinner-border-sm d-none"
                      role="status"
                      aria-hidden="true"
                    ></span>
                  </button>
                  <button class="btn btn-success" id="btnTaskComplete">
                    <span class="label"
                      ><span class="material-icons align-middle me-1">task_alt</span
                      >完了にする</span
                    >
                    <span
                      class="spinner-border spinner-border-sm d-none"
                      role="status"
                      aria-hidden="true"
                    ></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger me-auto d-none" id="deleteTaskButton">
              削除
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ----- Message detail modal ----- -->
    <div class="modal" id="messageDetailModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="m-0">メッセージ詳細</h6>
          </div>
          <div class="modal-body">
            <div id="msg-detail-loading" class="skeleton mb-3"></div>
            <div id="msg-detail-content" class="d-none">
              <h4 id="msgDetailTitle" class="mb-3"></h4>
              <div id="msgDetailBody" class="form-section mb-3">
                <div class="section-body"></div>
              </div>
              <div id="msgAttachments" class="mb-3 d-none">
                <div class="form-section">
                  <h6 class="mb-2">
                    <span class="material-icons align-middle me-1">attach_file</span>添付
                  </h6>
                  <ul class="list-group attach-list" id="msgAttachList"></ul>
                </div>
              </div>
              <div class="d-flex flex-wrap gap-2 mb-3">
                <button class="btn btn-outline-primary" id="btnMsgToTask">
                  <span class="label">
                    <span class="material-icons align-middle me-1">send</span>この内容でタスク
                  </span>
                  <span
                    class="spinner-border spinner-border-sm d-none"
                    role="status"
                    aria-hidden="true"
                  ></span>
                </button>
                <button class="btn btn-primary" id="btnMsgMarkRead" data-read-state="unread">
                  <span class="label">
                    <span class="material-icons align-middle me-1 js-msg-read-icon"
                      >mark_email_read</span
                    >
                    <span class="label-text">既読にする</span>
                  </span>
                  <span
                    class="spinner-border spinner-border-sm d-none"
                    role="status"
                    aria-hidden="true"
                  ></span>
                </button>
              </div>
              <h5 class="mt-4">コメント</h5>
              <div id="comments-list" class="mb-2"></div>
              <textarea
                id="newCommentBody"
                class="form-control"
                rows="3"
                placeholder="コメントを入力..."
              ></textarea>
              <button class="btn btn-secondary mt-2" id="btnCommentPost">コメントを投稿</button>
              <div class="mt-4">
                <p><strong>既読:</strong> <span id="msgReadUsers"></span></p>
                <p><strong>未読:</strong> <span id="msgUnreadUsers"></span></p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger me-auto d-none" id="deleteMessageButton">
              削除
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Vendor bundle: Bootstrap components ===== -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>

    <!-- ===== Application runtime logic ===== -->
    <script>
      // ===== サーバー埋め込みデータ =====
      const __BOOT__ = (function () {
        const bootstrap = window.__SHIFT_FLOW_BOOTSTRAP__ || {};
        const user = bootstrap.userInfo || {};
        return {
          users: Array.isArray(bootstrap.users) ? bootstrap.users : [],
          currentEmail: typeof user.email === 'string' ? user.email : '',
          theme: user.theme || bootstrap.theme || 'light',
          imageUrl: typeof user.imageUrl === 'string' ? user.imageUrl : '',
          isManager: !!bootstrap.isManager,
          myTasks:
            bootstrap.myTasks && typeof bootstrap.myTasks === 'object'
              ? bootstrap.myTasks
              : { tasks: [], meta: {} },
          folders: Array.isArray(bootstrap.folders) ? bootstrap.folders : [],
        };
      })();
      let ACTIVE_USERS = Array.isArray(__BOOT__.users) ? __BOOT__.users : [];
      let CURRENT_USER_EMAIL = String(__BOOT__.currentEmail || '');
      let HAS_ACTIVE_EMAIL = CURRENT_USER_EMAIL.length > 0;
      let USER_IMAGE_URL = typeof __BOOT__.imageUrl === 'string' ? __BOOT__.imageUrl : '';
      let INITIAL_MY_TASK_PAYLOAD =
        __BOOT__.myTasks && typeof __BOOT__.myTasks === 'object'
          ? __BOOT__.myTasks
          : { tasks: [], meta: {} };
      let IS_MANAGER = !!__BOOT__.isManager;
      let FOLDERS = Array.isArray(__BOOT__.folders) ? __BOOT__.folders : [];
      const GAS_WEB_APP_URL =
        typeof window.__GAS_WEB_APP_URL__ === 'string' ? window.__GAS_WEB_APP_URL__ : '';
      const HAS_GAS_WEB_APP_URL = GAS_WEB_APP_URL.length > 0;
      const GOOGLE_CLIENT_ID =
        typeof window.__GOOGLE_CLIENT_ID__ === 'string' ? window.__GOOGLE_CLIENT_ID__ : '';
      window.__SHIFT_FLOW_AUTH_TOKEN__ = window.__SHIFT_FLOW_AUTH_TOKEN__ || '';
      let AUTH_TOKEN_PAYLOAD = null;
      let AUTH_READY = false;
      let BOOTSTRAP_STARTED = false;
      let RESTORED_BOOTSTRAP_FROM_CACHE = false;
      const BOOTSTRAP_CACHE_PREFIX = 'bootstrap:';
      const BOOTSTRAP_CACHE_RECENT_KEY = 'bootstrap:recent';
      const BOOTSTRAP_CACHE_DEFAULT_EMAIL = 'guest';
      const BOOTSTRAP_CACHE_MAX_AGE_MS = 60 * 1000;
      const AUTH_NOTICE_MESSAGE =
        'Google にサインインしてから再試行してください。カード内の「Google にサインイン」ボタンから認証できます。';
      const USER_AGENT = (navigator && navigator.userAgent) || '';
      const IS_IOS = /iphone|ipad|ipod/i.test(USER_AGENT) && !(window && window.MSStream);
      const IS_ANDROID = /android/i.test(USER_AGENT);
      const IS_MOBILE = IS_IOS || IS_ANDROID;
      const IS_SAFARI =
        /safari/i.test(USER_AGENT || '') &&
        !/chrome|crios|fxios|edgios|firefox/i.test(USER_AGENT || '');
      const IS_STANDALONE =
        (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
        (typeof navigator !== 'undefined' && navigator.standalone === true);
      const NEEDS_MANUAL_SIGNIN = IS_IOS && IS_STANDALONE;
      let AUTH_NOTICE_SHOWN = false;
      let MANAGER_NOTICE_SHOWN = false;
      let AUTH_HELP_REQUESTED = false;
      let TASKS_BOOTSTRAPPED = false;
      var _rszTimer = null;
      let ACTIVE_TASK_TAB = 'my';
      let AUTH_SESSION = { authenticated: false, user: null, expiresAt: 0 };
      if (!HAS_GAS_WEB_APP_URL) {
        console.warn(
          '[ShiftFlow] GAS_WEB_APP_URL is not defined. Set the Environment Variable on Cloudflare Pages.'
        );
      }

      var syncThemeMeta =
        typeof window.__SHIFT_FLOW_SYNC_THEME_META__ === 'function'
          ? window.__SHIFT_FLOW_SYNC_THEME_META__
          : function (theme) {
              var palette = window.__SHIFT_FLOW_THEME_META__ || {
                light: { statusBar: 'default' },
                dark: { statusBar: 'black-translucent' },
              };
              var getPrimary =
                typeof window.__SHIFT_FLOW_GET_PRIMARY__ === 'function'
                  ? window.__SHIFT_FLOW_GET_PRIMARY__
                  : function (mode) {
                      if (mode === 'dark') return '#4b67b3';
                      return '#517cb2';
                    };
              var resolvedTheme = theme === 'dark' ? 'dark' : 'light';
              var statusBar =
                (palette[resolvedTheme] && palette[resolvedTheme].statusBar) ||
                (resolvedTheme === 'dark' ? 'black-translucent' : 'default');
              var metaTheme = document.querySelector('meta[name="theme-color"]');
              if (metaTheme) {
                metaTheme.setAttribute('content', getPrimary(resolvedTheme));
              }
              var appleStatus = document.querySelector(
                'meta[name="apple-mobile-web-app-status-bar-style"]'
              );
              if (appleStatus && statusBar) {
                appleStatus.setAttribute('content', statusBar);
              }
            };
      if (typeof window.__SHIFT_FLOW_SYNC_THEME_META__ !== 'function') {
        window.__SHIFT_FLOW_SYNC_THEME_META__ = syncThemeMeta;
      }

      // ===== テーマ適用 =====
      const THEME_MEDIA = window.matchMedia
        ? window.matchMedia('(prefers-color-scheme: dark)')
        : null;
      let themePreference =
        (typeof document.documentElement.dataset.themePref === 'string' &&
          document.documentElement.dataset.themePref) ||
        'light';
      const PROFILE_PLACEHOLDER_URL = 'https://placehold.jp/150x150.png';
      const PROFILE_IMAGE_MAX_BYTES = 2 * 1024 * 1024;
      const MESSAGE_ATTACHMENT_MAX_BYTES = 4 * 1024 * 1024;
      const MESSAGE_ATTACHMENT_LIMIT = 3;
      let pendingProfileImage = null;
      let pendingMessageAttachments = [];
      if (__BOOT__.theme) themePreference = __BOOT__.theme || themePreference;

      function applyBootstrapBindings(bootstrap) {
        const source = bootstrap || window.__SHIFT_FLOW_BOOTSTRAP__ || {};
        const user = source.userInfo || {};
        const email = typeof user.email === 'string' ? user.email : '';
        const name = user.name || 'ゲストユーザー';
        const avatar = user.imageUrl || '/icons/icon-192.png';
        document.querySelectorAll('[data-bind-user-email]').forEach(function (el) {
          if (email) {
            el.setAttribute('title', email);
          } else {
            el.removeAttribute('title');
          }
          if (email && el.tagName === 'A' && el.textContent.trim() === '') {
            el.textContent = email;
          }
        });
        document.querySelectorAll('[data-bind-user-name]').forEach(function (el) {
          el.textContent = name;
        });
        document.querySelectorAll('[data-bind-user-avatar]').forEach(function (el) {
          el.setAttribute('src', avatar);
          el.setAttribute('data-avatar-url', avatar);
        });
      }
      applyBootstrapBindings(window.__SHIFT_FLOW_BOOTSTRAP__);

      function toggleManagerUI() {
        var shouldShow = !!IS_MANAGER;
        document.querySelectorAll('[data-manager-only]').forEach(function (el) {
          el.classList.toggle('d-none', !shouldShow);
          if (!shouldShow) {
            el.setAttribute('aria-hidden', 'true');
          } else {
            el.removeAttribute('aria-hidden');
          }
        });
        if (!shouldShow && typeof ACTIVE_TASK_TAB !== 'undefined' && ACTIVE_TASK_TAB === 'all') {
          ACTIVE_TASK_TAB = 'my';
        }
      }

      function populateAssigneeFilters() {
        var selects = [byId('task-filter-from-assignee'), byId('task-filter-all-assignee')];
        var rows = ACTIVE_USERS.slice().sort(function (a, b) {
          return String(a.name || a.email || '').localeCompare(
            String(b.name || b.email || ''),
            'ja'
          );
        });
        selects.forEach(function (select) {
          if (!select) return;
          var previous = select.value;
          select.innerHTML = '';
          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Filter by assignee';
          select.appendChild(placeholder);
          rows.forEach(function (user) {
            if (!user || !user.email) return;
            var option = document.createElement('option');
            option.value = user.email;
            option.textContent = user.name || user.email;
            select.appendChild(option);
          });
          if (
            previous &&
            rows.some(function (u) {
              return u.email === previous;
            })
          ) {
            select.value = previous;
          }
        });
      }

      function getDefaultFolderId() {
        if (!Array.isArray(FOLDERS) || FOLDERS.length === 0) return '';
        var fallback = FOLDERS[0].id || '';
        for (var i = 0; i < FOLDERS.length; i++) {
          var id = String(FOLDERS[i].id || '');
          var name = String(FOLDERS[i].name || '');
          if (id === '全体' || name === '全体') {
            return id || name;
          }
        }
        return fallback;
      }

      function populateFolderSelects() {
        var folders = Array.isArray(FOLDERS) ? FOLDERS : [];
        var filterSelect = byId('flt-msg-folder');
        if (filterSelect) {
          var prev = filterSelect.value;
          filterSelect.innerHTML = '';
          var allOption = document.createElement('option');
          allOption.value = '';
          allOption.textContent = 'All';
          filterSelect.appendChild(allOption);
          folders.forEach(function (folder) {
            if (!folder || !folder.id) return;
            var option = document.createElement('option');
            option.value = folder.id;
            option.textContent = folder.name || folder.id;
            filterSelect.appendChild(option);
          });
          if (
            prev &&
            folders.some(function (f) {
              return f.id === prev;
            })
          ) {
            filterSelect.value = prev;
          }
        }

        var composeSelect = byId('messageFolder');
        if (composeSelect) {
          var prevCompose =
            composeSelect.value && composeSelect.value !== '' ? composeSelect.value : null;
          composeSelect.innerHTML = '';
          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'フォルダを選択';
          composeSelect.appendChild(placeholder);
          folders.forEach(function (folder) {
            if (!folder || !folder.id) return;
            var option = document.createElement('option');
            option.value = folder.id;
            option.textContent = folder.name || folder.id;
            composeSelect.appendChild(option);
          });
          var defaultId = prevCompose || getDefaultFolderId();
          if (
            defaultId &&
            folders.some(function (f) {
              return f.id === defaultId;
            })
          ) {
            composeSelect.value = defaultId;
          } else {
            composeSelect.value = '';
          }
        }
      }

      function setBootstrapLoading(isLoading) {
        var body = document.body;
        if (body) {
          body.classList.toggle('bootstrapping', !!isLoading);
        }
        var metaTheme = document.querySelector('meta[name="theme-color"]');
        var appleStatus = document.querySelector(
          'meta[name="apple-mobile-web-app-status-bar-style"]'
        );
        var pref = document.documentElement.dataset.themePref || 'light';
        var resolvedPref =
          typeof resolveThemePreference === 'function' ? resolveThemePreference(pref) : pref;
        if (isLoading) {
          var getPrimary =
            typeof window.__SHIFT_FLOW_GET_PRIMARY__ === 'function'
              ? window.__SHIFT_FLOW_GET_PRIMARY__
              : function (mode) {
                  if (mode === 'dark') return '#4b67b3';
                  return '#517cb2';
                };
          var primaryColor = getPrimary(resolvedPref);
          if (metaTheme && primaryColor) {
            metaTheme.setAttribute('content', primaryColor);
          }
          if (appleStatus) {
            appleStatus.setAttribute(
              'content',
              resolvedPref === 'dark' ? 'black-translucent' : 'default'
            );
          }
        } else if (typeof syncThemeMeta === 'function') {
          syncThemeMeta(resolvedPref);
        }
        var loadingEl = byId('bootstrap-loading');
        if (!loadingEl) return;
        if (isLoading) {
          loadingEl.setAttribute('aria-hidden', 'false');
          loadingEl.setAttribute('aria-busy', 'true');
        } else {
          loadingEl.setAttribute('aria-hidden', 'true');
          loadingEl.removeAttribute('aria-busy');
        }
      }

      function isAuthError(err) {
        if (!err) return false;
        if (err.authRequired === true) return true;
        if (err.status === 401 || err.status === 403) return true;
        var msg = String(err.message || '');
        return msg.indexOf('Non-JSON response from backend') !== -1;
      }

      function applyBootstrapState(bootstrap) {
        var normalized = bootstrap || {};
        window.__SHIFT_FLOW_BOOTSTRAP__ = normalized;
        window.userInfo = normalized.userInfo || {};
        window.users = Array.isArray(normalized.users) ? normalized.users : [];
        window.folders = Array.isArray(normalized.folders) ? normalized.folders : [];
        window.initialTasks =
          normalized.myTasks && typeof normalized.myTasks === 'object'
            ? normalized.myTasks
            : { tasks: [], meta: {} };
        window.isManager = !!normalized.isManager;

        ACTIVE_USERS = Array.isArray(window.users) ? window.users : [];
        FOLDERS = Array.isArray(window.folders) ? window.folders : [];
        IS_MANAGER = !!normalized.isManager;

        var userInfo = normalized.userInfo || {};
        CURRENT_USER_EMAIL = String(userInfo.email || '');
        HAS_ACTIVE_EMAIL = CURRENT_USER_EMAIL.length > 0;
        USER_IMAGE_URL = typeof userInfo.imageUrl === 'string' ? userInfo.imageUrl : USER_IMAGE_URL;
        TASKS_BOOTSTRAPPED = false;
        INITIAL_MY_TASK_PAYLOAD = window.initialTasks;

        rebuildUserMap();
        applyBootstrapBindings(normalized);
        applyUserAvatar(userInfo.imageUrl || '');
        var themeValue = userInfo.theme || normalized.theme || themePreference;
        applyThemePreference(themeValue);
        updateThemeStatus(themeValue);

        toggleManagerUI();
        if (typeof TASK_STATE !== 'undefined' && TASK_STATE.all) {
          TASK_STATE.all.restricted = !IS_MANAGER;
        }
        populateAssigneeFilters();
        renderAssigneeList();
        populateFolderSelects();
        var shouldCacheBootstrap = true;
        var responseMeta =
          (typeof window !== 'undefined' && window.__SHIFT_FLOW_RESPONSE_META__) || {};
        var bootstrapMeta = responseMeta && responseMeta.getBootstrapData;
        if (
          bootstrapMeta &&
          bootstrapMeta.status === 'STALE' &&
          typeof RESTORED_BOOTSTRAP_FROM_CACHE === 'boolean' &&
          RESTORED_BOOTSTRAP_FROM_CACHE
        ) {
          shouldCacheBootstrap = false;
          console.info('[ShiftFlow] Skipped caching stale bootstrap payload.');
        }
        if (shouldCacheBootstrap) {
          cacheBootstrapSnapshot(normalized);
        }
      }

      function hydrateBootstrap() {
        if (!window.__SHIFT_FLOW_AUTH_TOKEN__) {
          return Promise.reject({ authRequired: true, message: 'Auth token missing' });
        }
        if (
          !(
            globalThis.google &&
            google.script &&
            google.script.run &&
            typeof google.script.run.getBootstrapData === 'function'
          )
        ) {
          toggleManagerUI();
          populateAssigneeFilters();
          populateFolderSelects();
          renderAssigneeList();
          return Promise.resolve();
        }
        return new Promise(function (resolve, reject) {
          google.script.run
            .withSuccessHandler(function (payload) {
              if (payload && typeof payload === 'object') {
                applyBootstrapState(payload);
              } else {
                toggleManagerUI();
                populateAssigneeFilters();
                populateFolderSelects();
                renderAssigneeList();
              }
              resolve();
            })
            .withFailureHandler(function (err) {
              console.error('Bootstrap fetch failed:', err);
              var authError = isAuthError(err);
              if (!authError) {
                notify(
                  '初期データの取得に失敗しました: ' +
                    (err && err.message ? err.message : '原因不明のエラー'),
                  false
                );
              }
              toggleManagerUI();
              populateAssigneeFilters();
              populateFolderSelects();
              renderAssigneeList();
              if (authError) {
                reject(err || { authRequired: true });
              } else {
                resolve();
              }
            })
            .getBootstrapData();
        });
      }

      function refreshDataAfterBootstrap() {
        if (!HAS_ACTIVE_EMAIL) {
          return;
        }
        loadHome();
        loadMessages();
        if (typeof TASK_STATE !== 'undefined') {
          if (TASK_STATE.my) {
            TASK_STATE.my.loaded = false;
            loadMyTasks();
          }
          if (TASK_STATE.from) {
            TASK_STATE.from.loaded = false;
            loadCreatedTasks();
          }
          if (TASK_STATE.all && IS_MANAGER) {
            TASK_STATE.all.loaded = false;
            loadAllTasks();
          }
        }
      }

      document.addEventListener('click', function (event) {
        var target =
          typeof event.target.closest === 'function'
            ? event.target.closest('[data-action="auth-retry"]')
            : null;
        if (!target) return;
        event.preventDefault();
        target.disabled = true;
        target.setAttribute('aria-busy', 'true');
        setBootstrapLoading(true);
        hydrateBootstrap()
          .then(function () {
            refreshDataAfterBootstrap();
          })
          .catch(function (err) {
            console.error('Auth retry failed:', err);
          })
          .then(function () {
            setBootstrapLoading(false);
            target.disabled = false;
            target.removeAttribute('aria-busy');
          });
      });

      toggleManagerUI();
      populateAssigneeFilters();
      populateFolderSelects();

      // ----- Bridge google.script.run calls when Apps Script runtime is unavailable -----
      (function ensureGoogleScriptRun() {
        var API_BASE_PATH = '/api';
        if (!globalThis.google) globalThis.google = {};
        if (!globalThis.google.script) globalThis.google.script = {};
        var existing = globalThis.google.script.run;
        if (existing && !existing.__isStub) {
          return;
        }

        var chainState = {
          success: null,
          failure: null,
          userObject: undefined,
        };

        function resetChain() {
          chainState.success = null;
          chainState.failure = null;
          chainState.userObject = undefined;
        }

        function deliver(handler, payload, userObject) {
          if (typeof handler !== 'function') {
            return;
          }
          try {
            if (userObject !== undefined) handler(payload, userObject);
            else handler(payload);
          } catch (handlerErr) {
            console.error('[ShiftFlow] handler execution failed', handlerErr);
          }
        }

        function deliverFailure(handler, error, userObject) {
          if (typeof handler === 'function') {
            deliver(handler, error, userObject);
            return;
          }
          if (error && (error.authRequired || error.status === 401 || error.status === 403)) {
            console.info('[ShiftFlow] auth required, prompting authentication.');
            clearAuthToken();
            var overlayMessage = '再度 Google Workspace 認証を開始してください。';
            if (error && error.response && error.response.reason) {
              overlayMessage = String(error.response.reason);
            } else if (error && error.response && error.response.error) {
              overlayMessage = String(error.response.error);
            }
            showAuthOverlay(overlayMessage);
            syncAuthSession({ silent: true }).catch(function () {});
            return;
          }
          console.error('[ShiftFlow] backend request failed', error);
        }

        function createError(message, extra) {
          var err = new Error(message || 'Request failed');
          if (extra && typeof extra === 'object') {
            Object.keys(extra).forEach(function (key) {
              if (key === 'message') return;
              err[key] = extra[key];
            });
          }
          return err;
        }

        // === Helpers ===
        let _lastSessionCheck = 0;
        async function _ensureSessionToken(forceReload) {
          if (!forceReload && AUTH_READY && window.__SHIFT_FLOW_AUTH_TOKEN__) {
            return window.__SHIFT_FLOW_AUTH_TOKEN__;
          }
          const now = Date.now();
          if (!forceReload && now - _lastSessionCheck < 500) {
            return window.__SHIFT_FLOW_AUTH_TOKEN__;
          }
          _lastSessionCheck = now;
          const session = await syncAuthSession({ silent: true });
          if (session && session.authenticated && window.__SHIFT_FLOW_AUTH_TOKEN__) {
            return window.__SHIFT_FLOW_AUTH_TOKEN__;
          }
          throw new Error('NO_SESSION');
        }

        function _rid() {
          return createRequestId();
        }

        function invokeRemote(route, argsSnapshot, handlers) {
          var url = API_BASE_PATH + '/' + encodeURIComponent(route);

          async function _doFetch(forceRefresh) {
            await _ensureSessionToken(forceRefresh);
            const init = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Accept: 'application/json',
                'X-ShiftFlow-Request-Id': _rid(),
              },
              credentials: 'include',
              body: JSON.stringify({ route: route, args: argsSnapshot }),
            };

            const res = await fetch(url, init);
            const ctype = res.headers.get('content-type') || '';
            if (ctype.indexOf('application/json') === -1) {
              const text = await res.text();
              const authRequired =
                res.status === 200 &&
                (text.includes('accounts.google.com') ||
                  text.includes('google-signin') ||
                  text.includes('<form'));
              throw createError('Non-JSON response from backend', {
                status: res.status,
                statusText: res.statusText,
                route,
                raw: text,
                authRequired,
              });
            }
            const body = await res.json();
            return { res, body };
          }

          (async () => {
            try {
              let packet = await _doFetch(false);
              if (!packet.res.ok && packet.res.status === 401) {
                clearAuthToken();
                await syncAuthSession({ silent: false });
                packet = await _doFetch(true);
              }

              const res = packet.res,
                body = packet.body || {};
              const { success: successHandler, failure: failureHandler, userObject } = handlers;

              if (!res.ok) {
                const reason = typeof body?.reason === 'string' ? body.reason : '';
                const msg = reason || `HTTP ${res.status} calling ${route}`;
                const httpError = createError(msg, {
                  status: res.status,
                  statusText: res.statusText,
                  route,
                  code: body?.code,
                  where: body?.where,
                  requestId: body?.requestId,
                  response: body,
                });
                if (res.status === 403 && body?.code === 'shared_secret_mismatch') {
                  httpError.hint =
                    'Shared secret はブラウザではなく Functions→GAS 間で一致させてください。';
                }
                deliverFailure(failureHandler, httpError, userObject);
                return;
              }

              if (body.ok === false) {
                const reason = typeof body.reason === 'string' ? body.reason : 'Unknown backend error';
                const backendError = createError(reason, {
                  route,
                  code: body?.code,
                  where: body?.where,
                  requestId: body?.requestId,
                  response: body,
                });
                deliverFailure(failureHandler, backendError, userObject);
                return;
              }

              const cacheStatusHeader = res.headers.get('x-shiftflow-cache') || '';
              const cacheAgeHeader = res.headers.get('x-shiftflow-cache-age') || '';
              if (typeof window !== 'undefined') {
                if (!window.__SHIFT_FLOW_RESPONSE_META__) {
                  window.__SHIFT_FLOW_RESPONSE_META__ = {};
                }
                var ageMs = Number(cacheAgeHeader);
                if (!Number.isFinite(ageMs) || ageMs < 0) {
                  ageMs = null;
                }
                window.__SHIFT_FLOW_RESPONSE_META__[route] = {
                  status: cacheStatusHeader ? cacheStatusHeader.toUpperCase() : '',
                  ageMs: ageMs,
                  receivedAt: Date.now(),
                };
                if (
                  route === 'getBootstrapData' &&
                  cacheStatusHeader &&
                  cacheStatusHeader.toUpperCase() === 'STALE'
                ) {
                  if (!window.__SHIFT_FLOW_PENDING_BOOTSTRAP_REFRESH__) {
                    window.__SHIFT_FLOW_PENDING_BOOTSTRAP_REFRESH__ = true;
                    setTimeout(function () {
                      window.__SHIFT_FLOW_PENDING_BOOTSTRAP_REFRESH__ = false;
                      if (typeof bootstrapAfterAuth === 'function') {
                        try {
                          bootstrapAfterAuth({ silent: true });
                        } catch (refreshErr) {
                          console.warn(
                            '[ShiftFlow] bootstrap refresh after stale cache failed',
                            refreshErr
                          );
                        }
                      }
                    }, 1800);
                  }
                }
              }

              deliver(successHandler, body.result, userObject);
            } catch (err) {
              const wrapped =
                err instanceof Error ? err : createError('Network error', { cause: err });
              wrapped.route = route;
              deliverFailure(handlers.failure, wrapped, handlers.userObject);
            }
          })();
        }

        var runProxy = new Proxy(function () {}, {
          get: function (target, prop) {
            if (prop === '__isStub') return false;
            if (prop === '__bridge') return 'fetch';
            if (prop === 'withSuccessHandler') {
              return function (fn) {
                chainState.success = typeof fn === 'function' ? fn : null;
                return runProxy;
              };
            }
            if (prop === 'withFailureHandler') {
              return function (fn) {
                chainState.failure = typeof fn === 'function' ? fn : null;
                return runProxy;
              };
            }
            if (prop === 'withUserObject') {
              return function (obj) {
                chainState.userObject = obj;
                return runProxy;
              };
            }
            if (prop === 'toString') {
              return function () {
                return '[object GoogleScriptRunBridge]';
              };
            }
            if (prop === 'then') {
              return undefined;
            }
            return function () {
              var argsSnapshot = Array.prototype.slice.call(arguments || []);
              var handlers = {
                success: chainState.success,
                failure: chainState.failure,
                userObject: chainState.userObject,
              };
              resetChain();
              invokeRemote(String(prop), argsSnapshot, handlers);
              return runProxy;
            };
          },
          apply: function (target, thisArg, argList) {
            if (!argList || argList.length === 0) {
              throw new Error('google.script.run requires a target function name.');
            }
            var route = String(argList[0] || '').trim();
            if (!route) {
              throw new Error('google.script.run requires a non-empty function name.');
            }
            var argsSnapshot = Array.prototype.slice.call(argList, 1);
            var handlers = {
              success: chainState.success,
              failure: chainState.failure,
              userObject: chainState.userObject,
            };
            resetChain();
            invokeRemote(route, argsSnapshot, handlers);
            return runProxy;
          },
        });

        globalThis.google.script.run = runProxy;
      })();

      function resolveThemePreference(pref) {
        if (pref === 'system') {
          return THEME_MEDIA && THEME_MEDIA.matches ? 'dark' : 'light';
        }
        return pref || 'light';
      }
      function createRequestId() {
        if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
          return crypto.randomUUID();
        }
        return 'req_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function applyResolvedTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        syncThemeMeta(theme);
      }
      function applyThemePreference(pref) {
        themePreference = pref || 'light';
        document.documentElement.dataset.themePref = themePreference;
        applyResolvedTheme(resolveThemePreference(themePreference));
      }
      function applyUserAvatar(url) {
        var candidate = typeof url === 'string' ? url.trim() : '';
        document.querySelectorAll('.js-user-avatar').forEach(function (el) {
          var fallback = String(el.getAttribute('data-avatar-url') || '').trim();
          var selected = candidate || fallback || PROFILE_PLACEHOLDER_URL;
          el.src = selected;
          el.setAttribute('data-avatar-url', selected);
        });
      }

      function buildGasAuthUrl(returnTo) {
        if (!GAS_WEB_APP_URL) return '';
        var base = GAS_WEB_APP_URL;
        var separator = base.indexOf('?') >= 0 ? '&' : '?';
        var target = String(returnTo || window.location.href || '').trim();
        return base + separator + 'return=' + encodeURIComponent(target);
      }

      applyThemePreference(themePreference);
      applyUserAvatar(USER_IMAGE_URL);

      if (THEME_MEDIA) {
        var themeMediaListener = function () {
          if (themePreference === 'system') {
            applyResolvedTheme(resolveThemePreference(themePreference));
          }
        };
        if (typeof THEME_MEDIA.addEventListener === 'function') {
          THEME_MEDIA.addEventListener('change', themeMediaListener);
        } else if (typeof THEME_MEDIA.addListener === 'function') {
          THEME_MEDIA.addListener(themeMediaListener);
        }
      }

      function describeThemeValue(value) {
        switch ((value || '').toLowerCase()) {
          case 'dark':
            return 'ダークテーマ';
          case 'system':
            return 'システム設定に連動';
          default:
            return 'ライトテーマ';
        }
      }
      function getThemeStatusIcon(value) {
        switch ((value || '').toLowerCase()) {
          case 'dark':
            return 'dark_mode';
          case 'system':
            return 'contrast';
          default:
            return 'light_mode';
        }
      }
      function updateThemeStatus(value) {
        var display = byId('setting-theme-display');
        if (!display) return;
        var icon = getThemeStatusIcon(value);
        var label = describeThemeValue(value) + ' を適用中';
        display.innerHTML =
          '<span class="material-icons-outlined align-middle">' +
          esc(icon) +
          '</span><span>' +
          esc(label) +
          '</span>';
      }

      // ===== ヘルパ =====
      function $$(selector, root) {
        return Array.prototype.slice.call((root || document).querySelectorAll(selector));
      }
      function byId(id) {
        return document.getElementById(id);
      }
      let userMap = new Map();

      function rebuildUserMap() {
        userMap = new Map(
          ACTIVE_USERS.filter(function (u) {
            return u && typeof u.email === 'string';
          }).map(function (u) {
            return [u.email, u.name];
          })
        );
      }
      rebuildUserMap();

      function getNameByEmail(email) {
        return userMap.get(email) || email;
      }
      function on(id, ev, fn) {
        var el = byId(id);
        if (el) {
          el.addEventListener(ev, fn);
        }
      }
      function notify(msg, ok) {
        var wrap = byId('notification-area');
        if (!wrap) return;
        var el = document.createElement('div');
        el.className =
          'alert ' +
          (ok !== false ? 'alert-success' : 'alert-danger') +
          ' alert-dismissible fade show';
        el.innerHTML =
          msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        wrap.appendChild(el);
        setTimeout(function () {
          el.classList.remove('show');
          setTimeout(function () {
            el.remove();
          }, 150);
        }, 2200);
      }
      function setAppShellHidden(hidden) {
        $$('[data-app-shell]').forEach(function (el) {
          if (hidden) {
            if (!el.hasAttribute('hidden')) el.setAttribute('hidden', '');
          } else {
            el.removeAttribute('hidden');
          }
        });
      }
      function requestAuthHelp() {
        if (AUTH_HELP_REQUESTED) return;
        AUTH_HELP_REQUESTED = true;
        if (
          !(
            globalThis.google &&
            google.script &&
            google.script.run &&
            typeof google.script.run.getAuthStatus === 'function' &&
            !google.script.run.__isStub
          )
        ) {
          renderAuthHelpDetails(null, true);
          return;
        }
        google.script.run
          .withSuccessHandler(renderAuthHelpDetails)
          .withFailureHandler(function (err) {
            var box = byId('auth-help-details');
            if (!box) return;
            if (isAuthError(err)) {
              box.innerHTML =
                '<div class="alert alert-warning small mb-0">Google アカウントでサインインすると診断情報が表示されます。' +
                '<a class="btn btn-sm btn-primary ms-2" href="' +
                esc(GAS_WEB_APP_URL) +
                '" target="_blank" rel="noopener">Google にサインイン</a></div>';
              return;
            }
            var msg = err && err.message ? err.message : err;
            box.innerHTML =
              '<div class="alert alert-danger small mb-0">診断情報の取得に失敗しました: ' +
              esc(msg || '不明なエラー') +
              '</div>';
          })
          .getAuthStatus();
      }
      function renderAuthHelpDetails(info, isStub) {
        var box = byId('auth-help-details');
        if (!box) return;
        if (isStub) {
          box.innerHTML =
            '<div class="alert alert-info small mb-0">Cloudflare Pages から直接診断詳細を取得することはできません。<br>Google にサインインしてから再読み込みすると、状態が自動で取得されます。</div>';
          return;
        }
        if (!info) {
          box.innerHTML =
            '<div class="alert alert-danger small mb-0">診断データが取得できませんでした。</div>';
          return;
        }
        var parts = [];
        parts.push('<div class="alert alert-info small mb-2">');
        parts.push('<div class="fw-bold mb-1">現在の診断結果</div>');
        parts.push('<ul class="mb-2 ps-3">');
        parts.push(
          '<li>ActiveUser: ' +
            (info.activeEmail
              ? esc(info.activeEmail)
              : '<span class="text-danger">取得不可</span>') +
            '</li>'
        );
        parts.push(
          '<li>EffectiveUser: ' +
            (info.effectiveUserEmail
              ? esc(info.effectiveUserEmail)
              : '<span class="text-muted">不明</span>') +
            '</li>'
        );
        parts.push(
          '<li>スプレッドシートアクセス: ' +
            (info.hasSpreadsheetAccess ? 'OK' : '<span class="text-danger">権限不足</span>') +
            '</li>'
        );
        if (info.userRecord) {
          parts.push(
            '<li>ユーザー登録: ' +
              (info.userRecord.isActive
                ? 'アクティブ'
                : '<span class="text-danger">停止中</span>') +
              '</li>'
          );
        } else if (info.normalizedActiveEmail) {
          parts.push('<li>ユーザー登録: <span class="text-danger">未登録</span></li>');
        }
        parts.push('</ul>');
        if (info.error) {
          parts.push('<div class="text-danger mb-2">エラー: ' + esc(info.error) + '</div>');
        }
        if (info.sheetUrl) {
          parts.push(
            '<div class="mb-1"><a class="link-primary" href="' +
              esc(info.sheetUrl) +
              '" target="_blank" rel="noopener">シートの共有設定を確認</a></div>'
          );
        }
        parts.push(
          '<div class="mb-0">サインインした Google アカウントで ShiftFlow を利用できます。401 が続く場合は再ログインし、Cloudflare 環境変数（GAS_WEB_APP_URL / GOOGLE_CLIENT_ID）が最新か確認してください。</div>'
        );
        parts.push('</div>');
        box.innerHTML = parts.join('');
      }
      function authRequiredCard() {
        requestAuthHelp();
        var signInButton = HAS_GAS_WEB_APP_URL
          ? '<a class="btn btn-primary" href="' +
            esc(GAS_WEB_APP_URL) +
            '" target="_blank" rel="noopener">Google にサインイン</a>'
          : '<button type="button" class="btn btn-primary" disabled>Google にサインイン (未設定)</button>';
        return (
          '<div class="card border-warning"><div class="card-body">' +
          '<p class="mb-2 text-warning"><span class="material-icons align-middle me-1">lock</span>Google アカウントへのサインインが必要です。</p>' +
          '<p class="mb-2">以下の手順を実行してください。</p>' +
          '<ol class="mb-3 ps-3">' +
          '<li>「Google にサインイン」を押して Apps Script Web アプリを開き、組織の Google アカウントで認証します。</li>' +
          '<li>サインイン完了後、このページに戻って「接続を再チェック」を押すか、ページを再読み込みします。</li>' +
          '</ol>' +
          '<div class="d-flex flex-wrap gap-2">' +
          signInButton +
          '<button type="button" class="btn btn-outline-primary" data-action="auth-retry">接続を再チェック</button>' +
          '</div>' +
          '<div id="auth-help-details" class="mt-3"></div>' +
          '</div></div>'
        );
      }

      function setAuthToken(token) {
        window.__SHIFT_FLOW_AUTH_TOKEN__ = token || '';
        AUTH_TOKEN_PAYLOAD = null;
        AUTH_READY = !!token;
        try {
          sessionStorage.removeItem('SHIFT_FLOW_ID_TOKEN');
        } catch (_err) {
          /* ignore storage exceptions */
        }
      }

      function clearAuthToken() {
        setAuthToken('');
        BOOTSTRAP_STARTED = false;
      }

      function showAuthOverlay(message) {
        const overlay = byId('auth-overlay');
        const errorEl = byId('auth-error');
        var displayMessage = message;
        if (!displayMessage && IS_MOBILE) {
          displayMessage = 'ShiftFlow を利用するには組織の Google Workspace 認証が必要です。';
        }
        if (document.body) {
          document.body.classList.add('auth-screen');
        }
        setAppShellHidden(true);
        if (overlay) {
          overlay.classList.remove('d-none');
          overlay.setAttribute('aria-hidden', 'false');
        }
        if (errorEl) {
          if (displayMessage) {
            errorEl.textContent = displayMessage;
            errorEl.classList.add('is-visible');
          } else {
            errorEl.textContent = '';
            errorEl.classList.remove('is-visible');
          }
        }
        const primaryButton = byId('btn-auth-google');
        if (primaryButton && (!AUTH_SESSION || !AUTH_SESSION.authenticated)) {
          setTimeout(function () {
            try {
              primaryButton.focus();
            } catch (_err) {
              /* noop */
            }
          }, 50);
        }
      }

      function hideAuthOverlay(revealShell) {
        const overlay = byId('auth-overlay');
        const errorEl = byId('auth-error');
        if (overlay) {
          overlay.classList.add('d-none');
          overlay.setAttribute('aria-hidden', 'true');
        }
        if (errorEl) {
          errorEl.textContent = '';
          errorEl.classList.remove('is-visible');
        }
        if (revealShell === false) {
          if (document.body) {
            document.body.classList.add('auth-screen');
          }
          setAppShellHidden(true);
          return;
        }
        if (document.body) {
          document.body.classList.remove('auth-screen');
        }
        setAppShellHidden(false);
      }

      function updateAuthSessionUI(session) {
        AUTH_SESSION = session || { authenticated: false, user: null, expiresAt: 0 };
        const container = byId('auth-session');
        const nameEl = byId('auth-session-name');
        const emailEl = byId('auth-session-email');
        const avatarEl = byId('auth-session-avatar');
        const logoutBtn = byId('btn-auth-logout');
        const headerLogoutBtn = byId('btn-header-logout');
        const mobileLogoutBtn = byId('btn-mobile-logout');

        const isLoggedIn = !!(session && session.authenticated);
        if (container) {
          container.classList.toggle('is-visible', isLoggedIn);
        }
        if (logoutBtn) {
          logoutBtn.classList.toggle('d-none', !isLoggedIn);
        }
        if (headerLogoutBtn) {
          headerLogoutBtn.classList.toggle('d-none', !isLoggedIn);
          headerLogoutBtn.disabled = !isLoggedIn;
        }
        if (mobileLogoutBtn) {
          mobileLogoutBtn.disabled = !isLoggedIn;
          mobileLogoutBtn.classList.toggle('is-disabled', !isLoggedIn);
        }
        if (isLoggedIn && session.user) {
          const name = session.user.name || '';
          const email = session.user.email || '';
          if (nameEl) nameEl.textContent = name;
          if (emailEl) emailEl.textContent = email;
          if (avatarEl) {
            avatarEl.src = session.user.picture || PROFILE_PLACEHOLDER_URL;
            avatarEl.alt = name || email || 'Profile';
          }
        } else {
          if (nameEl) nameEl.textContent = '';
          if (emailEl) emailEl.textContent = '';
          if (avatarEl) {
            avatarEl.src = PROFILE_PLACEHOLDER_URL;
            avatarEl.alt = 'Profile placeholder';
          }
        }
      }

      async function syncAuthSession(options) {
        const opts = options || {};
        const requestId = createRequestId();
        let response;
        try {
          response = await fetch('/auth/session', {
            method: 'GET',
            credentials: 'include',
            headers: {
              Accept: 'application/json',
              'X-ShiftFlow-Request-Id': requestId,
            },
          });
        } catch (err) {
          if (!opts.silent) {
            showAuthOverlay('認証状態を確認できませんでした。接続を確認してください。');
          }
          throw err;
        }
        if (!response.ok) {
          setAuthToken('');
          updateAuthSessionUI(null);
          if (!opts.silent) {
            showAuthOverlay('認証サーバーが応答しませんでした。時間をおいて再度お試しください。');
          }
          throw new Error('SESSION_STATUS_' + response.status);
        }
        const data = await response.json();
        if (data && data.authenticated) {
          updateAuthSessionUI(data);
          setAuthToken('SESSION');
          hideAuthOverlay();
        } else {
          setAuthToken('');
          updateAuthSessionUI(null);
          if (!opts.silent) {
            var reason = data && typeof data.reason === 'string' ? data.reason : '';
            var mappedMessage = (function () {
              switch (reason) {
                case 'idle_timeout':
                  return '一定時間操作がなかったため認証を再取得する必要があります。もう一度認証を開始してください。';
                case 'absolute_timeout':
                  return '長時間経過したため再度 Google Workspace 認証が必要です。';
                case 'no_session':
                  return NEEDS_MANUAL_SIGNIN
                    ? 'ホーム画面から開いた場合はブラウザで Google Workspace 認証を行ってください。'
                    : '組織の Google Workspace 認証を開始してください。';
                default:
                  return NEEDS_MANUAL_SIGNIN
                    ? 'ホーム画面から開いた場合はブラウザで Google Workspace 認証を行ってください。'
                    : '組織の Google Workspace 認証を開始してください。';
              }
            })();
            showAuthOverlay(opts.message || mappedMessage);
          }
        }
        return data;
      }

      function normalizeReturnTo(rawValue) {
        var fallback = '/';
        var value = typeof rawValue === 'string' ? rawValue.trim() : '';
        if (!value) return fallback;
        try {
          var candidate = new URL(value, window.location.origin);
          if (candidate.origin !== window.location.origin) {
            return fallback;
          }
          var normalized =
            (candidate.pathname || '/') + (candidate.search || '') + (candidate.hash || '');
          return normalized || fallback;
        } catch (_err) {
          if (value.charAt(0) === '/') {
            return value;
          }
          return fallback;
        }
      }

      function buildAuthStartUrl(returnTo) {
        var normalized = normalizeReturnTo(returnTo);
        var url = new URL('/auth/start', window.location.origin);
        if (normalized) {
          url.searchParams.set('returnTo', normalized);
        }
        return url.toString();
      }

      function startAuthFlow(options) {
        const opts = { external: true, ...(options || {}) };
        const manualMode = NEEDS_MANUAL_SIGNIN && HAS_GAS_WEB_APP_URL;
        const shouldPreOpenWindow = manualMode || opts.external;
        const returnTo = opts.returnTo || window.location.href;
        const startUrl = buildAuthStartUrl(returnTo);
        const fallbackTarget = manualMode ? buildGasAuthUrl(returnTo) || GAS_WEB_APP_URL : '';
        if (shouldPreOpenWindow) {
          const authWindow = window.open(startUrl, '_blank', 'noopener');
          if (!authWindow) {
            if (manualMode && fallbackTarget) {
              showAuthOverlay('組織の認証ページを別タブで開きました。認証完了後はこの画面をそのままお待ちください。');
              window.open(fallbackTarget, '_blank', 'noopener');
              return;
            }
            showAuthOverlay('Google Workspace の認証ページを開いています。完了するとこの画面が自動で更新されます。');
            window.location.assign(startUrl);
            return;
          }
          try {
            authWindow.opener = null;
            authWindow.focus();
          } catch (_err) {}
          showAuthOverlay('Google Workspace の認証ページを開いています。完了するとこの画面が自動で更新されます。');
          return;
        }

        showAuthOverlay('Google Workspace の認証ページを開いています。完了するとこの画面が自動で更新されます。');
        window.location.assign(startUrl);
      }

      async function performLogout() {
        try {
          const requestId = createRequestId();
          await fetch('/auth/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
              Accept: 'application/json',
              'X-ShiftFlow-Request-Id': requestId,
            },
          });
        } catch (err) {
          console.warn('[ShiftFlow] Logout request failed', err);
        }
        clearAuthToken();
        updateAuthSessionUI(null);
        showAuthOverlay('サインアウトしました。再度 Google Workspace 認証を開始してください。');
      }

      function attachAuthEventHandlers() {
        on('btn-auth-google', 'click', function (event) {
          event.preventDefault();
          startAuthFlow({ external: true, returnTo: window.location.href });
        });
        on('btn-header-logout', 'click', function (event) {
          event.preventDefault();
          performLogout();
        });
        on('btn-mobile-logout', 'click', function (event) {
          event.preventDefault();
          if (event.currentTarget && event.currentTarget.disabled) return;
          performLogout();
        });
        on('btn-auth-logout', 'click', function (event) {
          event.preventDefault();
          performLogout();
        });
      }

      async function initializeAuthGateway() {
        attachAuthEventHandlers();
        let session = null;
        try {
          session = await syncAuthSession({ silent: true });
        } catch (err) {
          console.warn('[ShiftFlow] Initial auth sync failed', err);
          showAuthOverlay('認証状態を確認できませんでした。時間をおいて再度お試しください。');
          return;
        }
        if (!session || !session.authenticated) {
          showAuthOverlay(
            NEEDS_MANUAL_SIGNIN
              ? 'ホーム画面から開いた場合はブラウザで Google Workspace 認証を行ってください。'
              : '組織の Google Workspace 認証を開始してください。'
          );
          return;
        }

        var restorePromise = Promise.resolve(false);
        var sessionEmail = session.user && session.user.email ? session.user.email : '';
        if (sessionEmail) {
          restorePromise = restoreBootstrapSnapshot(sessionEmail).then(function (record) {
            if (record && record.bootstrap) {
              applyBootstrapState(record.bootstrap);
              RESTORED_BOOTSTRAP_FROM_CACHE = true;
              ensureTaskBootstrap();
              return true;
            }
            return false;
          });
        }

        restorePromise.then(
          function () {
            bootstrapAfterAuth();
          },
          function (err) {
            console.warn('[ShiftFlow] bootstrap warm start failed', err);
            bootstrapAfterAuth();
          }
        );
      }

      

      

      

      

      function bootstrapAfterAuth(options) {
        if (!window.__SHIFT_FLOW_AUTH_TOKEN__) {
          showAuthOverlay();
          return;
        }
        if (BOOTSTRAP_STARTED) return;
        BOOTSTRAP_STARTED = true;
        var suppressLoading =
          (options && options.silent === true) || RESTORED_BOOTSTRAP_FROM_CACHE;
        var silentReload = options && options.silent === true;
        RESTORED_BOOTSTRAP_FROM_CACHE = false;
        if (suppressLoading) {
          setBootstrapLoading(false);
        } else {
          setBootstrapLoading(true);
        }
        hydrateBootstrap()
          .then(function () {
            try {
              ensureTaskBootstrap();
              if (silentReload) {
                try {
                  refreshCurrentView();
                } catch (refreshErr) {
                  console.warn('[ShiftFlow] refresh after silent bootstrap failed', refreshErr);
                }
              } else {
                navigateTo('home');
              }
            } finally {
              BOOTSTRAP_STARTED = false;
              setBootstrapLoading(false);
            }
          })
          .catch(function (err) {
            BOOTSTRAP_STARTED = false;
            setBootstrapLoading(false);
            if (isAuthError && isAuthError(err)) {
              clearAuthToken();
              updateAuthSessionUI(null);
            showAuthOverlay('セッションが切れました。再度 Google Workspace 認証を開始してください。');
              syncAuthSession({ silent: true }).catch(function () {});
              return;
            }
            console.error('Bootstrap load encountered an error:', err);
            notify(
              '初期データの取得に失敗しました: ' +
                (err && err.message ? err.message : '不明なエラー'),
              false
            );
          });
      }
      function managerRequiredCard(info) {
        info = info || {};
        var reason = esc(info.reason || '権限がありません。');
        var stats = '';
        if (typeof info.totalRows === 'number' || typeof info.returned === 'number') {
          var total = typeof info.totalRows === 'number' ? info.totalRows : '—';
          var returned = typeof info.returned === 'number' ? info.returned : '—';
          stats +=
            '<p class="mb-1 small text-muted">対象行数: 総数 ' +
            total +
            ' / 返却 ' +
            returned +
            '</p>';
        }
        return (
          '<div class="card border-warning"><div class="card-body">' +
          '<p class="mb-2 text-warning"><span class="material-icons align-middle me-1">admin_panel_settings</span>' +
          reason +
          '</p>' +
          stats +
          '</div></div>'
        );
      }
      function esc(s) {
        return String(s || '').replace(/[&<>"']/g, function (c) {
          return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
        });
      }
      function scrollToTopNow() {
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        requestAnimationFrame(function () {
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
        });
      }
      function debounce(fn, ms) {
        var t = null;
        return function () {
          var ctx = this,
            args = arguments;
          clearTimeout(t);
          t = setTimeout(function () {
            fn.apply(ctx, args);
          }, ms);
        };
      }
      function humanBytes(n) {
        n = Number(n || 0);
        if (n < 1024) return n + ' B';
        var u = ['KB', 'MB', 'GB', 'TB'],
          i = -1;
        do {
          n /= 1024;
          i++;
        } while (n >= 1024 && i < u.length - 1);
        return n.toFixed(n >= 10 ? 0 : 1) + ' ' + u[i];
      }

      function readFileAsDataUrl(file) {
        return new Promise(function (resolve, reject) {
          var reader = new FileReader();
          reader.onload = function (e) {
            resolve(e && e.target ? e.target.result : reader.result);
          };
          reader.onerror = function (err) {
            reject(err || new Error('FileReader error'));
          };
          reader.readAsDataURL(file);
        });
      }

      var CACHE_DB_NAME = 'shiftflow-cache';
      var CACHE_DB_VERSION = 1;
      var CACHE_STORE_NAME = 'datasets';
      var SUPPORTS_IDB = typeof indexedDB !== 'undefined' && !!indexedDB;
      var CACHE_DB_PROMISE = null;

      function openCacheDb() {
        if (!SUPPORTS_IDB) {
          return Promise.reject(new Error('IndexedDB not supported'));
        }
        if (CACHE_DB_PROMISE) return CACHE_DB_PROMISE;
        CACHE_DB_PROMISE = new Promise(function (resolve, reject) {
          var request = indexedDB.open(CACHE_DB_NAME, CACHE_DB_VERSION);
          request.onupgradeneeded = function (event) {
            var db = event.target && event.target.result;
            if (!db) return;
            if (!db.objectStoreNames.contains(CACHE_STORE_NAME)) {
              db.createObjectStore(CACHE_STORE_NAME, { keyPath: 'key' });
            }
          };
          request.onsuccess = function (event) {
            var db = event.target && event.target.result;
            if (!db) {
              reject(new Error('Failed to open cache DB'));
              return;
            }
            resolve(db);
          };
          request.onerror = function (event) {
            reject((event && event.target && event.target.error) || new Error('IndexedDB error'));
          };
        }).catch(function (err) {
          CACHE_DB_PROMISE = null;
          throw err;
        });
        return CACHE_DB_PROMISE;
      }

      function readCacheEntry(key) {
        if (!SUPPORTS_IDB) {
          return Promise.resolve(null);
        }
        return openCacheDb()
          .then(function (db) {
            return new Promise(function (resolve, reject) {
              var tx = db.transaction(CACHE_STORE_NAME, 'readonly');
              var store = tx.objectStore(CACHE_STORE_NAME);
              var req = store.get(key);
              req.onsuccess = function (event) {
                resolve((event && event.target && event.target.result) || null);
              };
              req.onerror = function (event) {
                reject((event && event.target && event.target.error) || new Error('read failed'));
              };
            });
          })
          .catch(function () {
            return null;
          });
      }

      function writeCacheEntry(key, value) {
        if (!SUPPORTS_IDB) {
          return Promise.resolve(false);
        }
        return openCacheDb()
          .then(function (db) {
            return new Promise(function (resolve, reject) {
              var tx = db.transaction(CACHE_STORE_NAME, 'readwrite');
              var store = tx.objectStore(CACHE_STORE_NAME);
              var req = store.put({
                key: key,
                value: value,
                updatedAt: Date.now(),
              });
              req.onsuccess = function () {
                resolve(true);
              };
              req.onerror = function (event) {
                reject((event && event.target && event.target.error) || new Error('write failed'));
              };
            });
          })
          .catch(function () {
            return false;
          });
      }

      function normalizeEmailValue(value) {
        if (!value) return '';
        return String(value).trim().toLowerCase();
      }

      function resolveUserCacheNamespace() {
        if (typeof CURRENT_USER_EMAIL === 'string' && CURRENT_USER_EMAIL) {
          return normalizeEmailValue(CURRENT_USER_EMAIL);
        }
        var fallbackEmail =
          (window.userInfo && typeof window.userInfo.email === 'string' && window.userInfo.email) ||
          '';
        return normalizeEmailValue(fallbackEmail || '');
      }

      function buildUserCacheKey(baseKey) {
        var ns = resolveUserCacheNamespace();
        if (ns) {
          return 'user:' + ns + ':' + baseKey;
        }
        return 'user:__guest__:' + baseKey;
      }

      function readUserCacheEntry(baseKey) {
        return readCacheEntry(buildUserCacheKey(baseKey));
      }

      function writeUserCacheEntry(baseKey, value) {
        return writeCacheEntry(buildUserCacheKey(baseKey), value);
      }

      function getBootstrapCacheKey(email) {
        var normalized = normalizeEmailValue(email || '');
        if (!normalized) {
          normalized = BOOTSTRAP_CACHE_DEFAULT_EMAIL;
        }
        return BOOTSTRAP_CACHE_PREFIX + normalized;
      }

      function cacheBootstrapSnapshot(snapshot) {
        if (!snapshot || typeof snapshot !== 'object') {
          return Promise.resolve(false);
        }
        var emailSource =
          (snapshot.userInfo && snapshot.userInfo.email) ||
          (AUTH_TOKEN_PAYLOAD && AUTH_TOKEN_PAYLOAD.email) ||
          CURRENT_USER_EMAIL ||
          '';
        var normalizedEmail = normalizeEmailValue(emailSource || '');
        if (!normalizedEmail) {
          normalizedEmail = BOOTSTRAP_CACHE_DEFAULT_EMAIL;
        }
        var record = {
          email: normalizedEmail,
          cachedAt: Date.now(),
          bootstrap: snapshot,
        };
        var primaryKey = getBootstrapCacheKey(normalizedEmail);
        return writeCacheEntry(primaryKey, record)
          .then(function () {
            return writeCacheEntry(BOOTSTRAP_CACHE_RECENT_KEY, record);
          })
          .catch(function (err) {
            console.warn('[ShiftFlow] failed to cache bootstrap snapshot', err);
            return false;
          });
      }

      function restoreBootstrapSnapshot(candidateEmail) {
        var normalizedCandidate = normalizeEmailValue(candidateEmail || '');
        var keys = [];
        if (normalizedCandidate) {
          keys.push(getBootstrapCacheKey(normalizedCandidate));
        }
        keys.push(BOOTSTRAP_CACHE_RECENT_KEY);
        var attempt = Promise.resolve(null);
        keys.forEach(function (key) {
          attempt = attempt.then(function (current) {
            if (current) return current;
            return readCacheEntry(key).then(function (entry) {
              if (!entry || !entry.value) {
                return null;
              }
              var record = entry.value;
              if (
                normalizedCandidate &&
                normalizeEmailValue(record.email || '') !== normalizedCandidate
              ) {
                return null;
              }
              if (!record.bootstrap || typeof record.bootstrap !== 'object') {
                return null;
              }
              var cachedAtMs = Number(record.cachedAt || 0);
              if (!cachedAtMs || Date.now() - cachedAtMs > BOOTSTRAP_CACHE_MAX_AGE_MS) {
                return null;
              }
              return record;
            });
          });
        });
        return attempt.catch(function () {
          return null;
        });
      }

      function priorityClassName(pr) {
        switch (String(pr || '中')) {
          case '高':
            return 'priority-high';
          case '低':
            return 'priority-low';
          default:
            return 'priority-middle';
        }
      }
      function formatDateLabel(iso) {
        if (!iso) return '—';
        var d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.getMonth() + 1 + '/' + d.getDate();
      }
      function normalizeArray(data) {
        if (Array.isArray(data)) return data;
        if (!data) return [];
        if (typeof data.length === 'number') {
          try {
            return Array.prototype.slice.call(data);
          } catch (e) {}
        }
        if (typeof data === 'object') {
          return Object.keys(data)
            .filter(function (k) {
              return !isNaN(k);
            })
            .sort(function (a, b) {
              return Number(a) - Number(b);
            })
            .map(function (k) {
              return data[k];
            });
        }
        return [];
      }
      function extractTaskPayload(result) {
        var rows = [];
        var meta = {};
        if (result && typeof result === 'object' && !Array.isArray(result)) {
          if (Array.isArray(result.tasks)) rows = result.tasks;
          if (result.meta && typeof result.meta === 'object') meta = result.meta;
        } else if (Array.isArray(result)) {
          rows = result;
        } else {
          rows = normalizeArray(result);
        }
        return { rows: Array.isArray(rows) ? rows : [], meta: meta || {} };
      }

      (function syncThemeDisplayInitial() {
        var select = byId('setting-theme');
        if (select) {
          select.value = themePreference;
        }
        updateThemeStatus(themePreference);
      })();
      on('setting-theme', 'change', function () {
        var value = this.value || 'light';
        updateThemeStatus(value);
        applyThemePreference(value);
      });

      // ===== スワイプビュー =====
      var order = ['home', 'tasks', 'messages', 'settings'];
      var CURRENT_VIEW = 'home';
      var SWIPE_LOCK = false;
      var SWIPE_VERTICAL_TOLERANCE = 160;
      var SWIPE_ACTIVATION_DELTA = 14;
      var SWIPE_TRANSITION = 'transform 260ms cubic-bezier(0.22, 0.61, 0.36, 1)';
      var CURRENT_TRANSFORM = 0;

      window.__SHIFT_FLOW_GESTURE__ = null;

      function trackTo(view, opts) {
        var track = byId('viewsTrack');
        var idx = order.indexOf(view);
        var panel = byId('view-' + view);
        if (!track || !panel || idx < 0) return;
        var animate = !opts || opts.animate !== false;
        var offset = panel.offsetLeft;
        if (!animate) {
          track.style.transition = 'none';
          track.style.transform = 'translateX(' + -offset + 'px)';
          requestAnimationFrame(function () {
            track.style.transition = SWIPE_TRANSITION;
          });
        } else {
          track.style.transition = SWIPE_TRANSITION;
          requestAnimationFrame(function () {
            track.style.transform = 'translateX(' + -offset + 'px)';
          });
        }
        CURRENT_TRANSFORM = -offset;
      }

      function setActiveNav(view) {
        $$('.topbar .nav-link').forEach(function (a) {
          a.classList.toggle('active', a.getAttribute('data-view') === view);
        });
        $$('.footer-nav [data-view]').forEach(function (a) {
          a.classList.toggle('active', a.getAttribute('data-view') === view);
        });
      }
      function showPanel(view) {
        order.forEach(function (v) {
          var el = byId('view-' + v);
          if (!el) return;
          if (v === view) {
            el.classList.remove('is-hidden');
            el.classList.add('show');
          } else {
            el.classList.add('is-hidden');
            el.classList.remove('show');
          }
        });
      }
      function navigateTo(v, opts) {
        var options = opts || {};
        CURRENT_VIEW = v;
        setActiveNav(v);
        showPanel(v);
        trackTo(v, { animate: options.animate !== false });
        if (!options.skipScroll) {
          scrollToTopNow();
        }
        if (v === 'home') loadHome();
        if (v === 'tasks') {
          ensureTaskBootstrap();
          var activeTaskTab = ACTIVE_TASK_TAB || 'my';
          setTaskLoading(activeTaskTab, true);
          activateTaskTab(activeTaskTab, false);
          reloadActiveTaskTab();
        }
        if (v === 'messages') loadMessages();
        if (v === 'settings') loadSettings();
      }

      function refreshCurrentView() {
        if (CURRENT_VIEW === 'home') {
          return Promise.resolve(loadHome());
        }
        if (CURRENT_VIEW === 'tasks') {
          ensureTaskBootstrap();
          return Promise.all([
            Promise.resolve(reloadActiveTaskTab()),
            Promise.resolve(loadHome()),
          ]).then(function () {});
        }
        if (CURRENT_VIEW === 'messages') {
          return Promise.all([Promise.resolve(loadMessages()), Promise.resolve(loadHome())]).then(
            function () {}
          );
        }
        if (CURRENT_VIEW === 'settings') {
          return Promise.resolve(loadSettings());
        }
        return Promise.resolve(loadHome());
      }

      (function enableSwipe() {
        var wrap = byId('viewsWrapper');
        var track = byId('viewsTrack');
        var pageShell = document.querySelector('.page-body[data-app-shell]');
        if (!wrap || !track) return;
        var state = {
          active: false,
          dragging: false,
          startX: 0,
          startY: 0,
          startTime: 0,
          baseOffset: 0,
          rawDx: 0,
          rawDy: 0,
        };
        var activeTouchId = null;
        var unify = function (e) {
          if (e.changedTouches && e.changedTouches.length) return e.changedTouches[0];
          if (e.touches && e.touches.length) return e.touches[0];
          return e;
        };
        function getActiveTouch(e) {
          if (activeTouchId == null) {
            return unify(e);
          }
          if (e.changedTouches && e.changedTouches.length) {
            for (var i = 0; i < e.changedTouches.length; i++) {
              var changed = e.changedTouches[i];
              if (changed.identifier === activeTouchId) return changed;
            }
          }
          if (e.touches && e.touches.length) {
            for (var j = 0; j < e.touches.length; j++) {
              var touch = e.touches[j];
              if (touch.identifier === activeTouchId) return touch;
            }
          }
          return null;
        }
        function swipeThreshold() {
          var base =
            wrap.offsetWidth || window.innerWidth || document.documentElement.clientWidth || 360;
          return Math.max(48, Math.min(140, base * 0.18));
        }
        function isWithinSwipeArea(node) {
          if (!wrap || !node) return false;
          if (node.closest && node.closest('.modal.show')) return false;
          if (node === wrap) return true;
          if (node instanceof Node) {
            if (wrap.contains(node)) return true;
            if (node.closest) {
              var withinWrap = node.closest('#viewsWrapper');
              if (withinWrap) return true;
              var withinTrack = node.closest('#viewsTrack');
              if (withinTrack && wrap.contains(withinTrack)) return true;
              if (pageShell && node.closest('.page-body[data-app-shell]') === pageShell)
                return true;
            }
            return false;
          }
          return false;
        }
        function resetSwipe(shouldSnap) {
          state.active = false;
          state.dragging = false;
          state.startX = 0;
          state.startY = 0;
          state.startTime = 0;
          state.baseOffset = CURRENT_TRANSFORM;
          state.rawDx = 0;
          state.rawDy = 0;
          activeTouchId = null;
          if (shouldSnap !== false) {
            track.style.transition = SWIPE_TRANSITION;
            track.style.transform = 'translateX(' + CURRENT_TRANSFORM + 'px)';
          }
          window.__SHIFT_FLOW_GESTURE__ = null;
        }
        function handleSwipeStart(e) {
          if (SWIPE_LOCK) return;
          if (document.body && document.body.classList.contains('modal-open')) return;
          if (e.touches && e.touches.length > 1) {
            resetSwipe();
            return;
          }
          var t = unify(e);
          if (!t) return;
          var origin = t.target || e.target;
          if (!isWithinSwipeArea(origin)) return;
          state.active = true;
          state.dragging = false;
          state.startX = t.clientX;
          state.startY = t.clientY;
          state.startTime = Date.now();
          state.baseOffset = CURRENT_TRANSFORM;
          state.rawDx = 0;
          state.rawDy = 0;
          activeTouchId = typeof t.identifier === 'number' ? t.identifier : null;
          track.style.transition = 'none';
          window.__SHIFT_FLOW_GESTURE__ = null;
        }
        function handleSwipeMove(e) {
          if (!state.active) return;
          if (e.touches && e.touches.length > 1) {
            resetSwipe();
            return;
          }
          var t = getActiveTouch(e);
          if (!t) return;
          var dx = t.clientX - state.startX;
          var dy = t.clientY - state.startY;
          if (!state.dragging) {
            if (Math.abs(dx) >= SWIPE_ACTIVATION_DELTA && Math.abs(dx) > Math.abs(dy) + 10) {
              state.dragging = true;
              window.__SHIFT_FLOW_GESTURE__ = 'horizontal';
              track.style.transition = 'none';
            } else if (Math.abs(dy) >= SWIPE_ACTIVATION_DELTA && Math.abs(dy) > Math.abs(dx) + 10) {
              window.__SHIFT_FLOW_GESTURE__ = 'vertical';
              resetSwipe();
              return;
            } else {
              return;
            }
          }
          if (window.__SHIFT_FLOW_GESTURE__ !== 'horizontal') return;
          if (e.cancelable) e.preventDefault();
          state.rawDx = dx;
          state.rawDy = dy;
          var nextOffset = state.baseOffset + dx;
          track.style.transform = 'translateX(' + nextOffset + 'px)';
        }
        function handleSwipeEnd(e) {
          if (!state.active) {
            resetSwipe();
            return;
          }
          if (activeTouchId != null && !getActiveTouch(e)) {
            resetSwipe();
            return;
          }
          var triggered = false;
          if (state.dragging && !SWIPE_LOCK) {
            var dx = state.rawDx;
            var dy = state.rawDy;
            var dt = Date.now() - state.startTime;
            var threshold = swipeThreshold();
            var flickDistance = 42;
            var flickTime = 280;
            var withinVerticalGuard = Math.abs(dy) < SWIPE_VERTICAL_TOLERANCE;
            var distanceSatisfied = Math.abs(dx) >= threshold;
            var flickSatisfied = Math.abs(dx) >= flickDistance && dt < flickTime;
            if ((distanceSatisfied || flickSatisfied) && withinVerticalGuard) {
              var idx = order.indexOf(CURRENT_VIEW);
              var count = order.length;
              var lastIndex = count - 1;
              var target = null;
              if (dx < 0) {
                target = idx < lastIndex ? order[idx + 1] : order[0];
              } else if (dx > 0) {
                target = idx > 0 ? order[idx - 1] : order[lastIndex];
              }
              if (target && target !== CURRENT_VIEW) {
                SWIPE_LOCK = true;
                navigateTo(target, { animate: true });
                var targetPanel = byId('view-' + target);
                if (targetPanel) {
                  CURRENT_TRANSFORM = -targetPanel.offsetLeft;
                }
                setTimeout(function () {
                  SWIPE_LOCK = false;
                }, 360);
                triggered = true;
              }
            }
          }
          if (!triggered) {
            track.style.transition = SWIPE_TRANSITION;
            track.style.transform = 'translateX(' + state.baseOffset + 'px)';
            CURRENT_TRANSFORM = state.baseOffset;
          }
          resetSwipe(triggered ? false : true);
        }
        function handleSwipeCancel() {
          if (!state.active) return;
          track.style.transition = SWIPE_TRANSITION;
          track.style.transform = 'translateX(' + CURRENT_TRANSFORM + 'px)';
          resetSwipe();
        }

        document.addEventListener('touchstart', handleSwipeStart, { passive: true, capture: true });
        document.addEventListener('touchmove', handleSwipeMove, { passive: false, capture: true });
        document.addEventListener('touchend', handleSwipeEnd, { passive: true, capture: true });
        document.addEventListener('touchcancel', handleSwipeCancel, {
          passive: true,
          capture: true,
        });
      })();

      window.addEventListener('resize', function () {
        clearTimeout(_rszTimer);
        _rszTimer = setTimeout(function () {
          trackTo(CURRENT_VIEW, { animate: false });
        }, 120);
      });

      function initPullToRefresh() {
        var hasTouch = 'ontouchstart' in window || (navigator.maxTouchPoints || 0) > 0;
        if (!hasTouch) return;
        if (window.matchMedia) {
          var coarse = window.matchMedia('(pointer: coarse)');
          if (coarse && coarse.matches === false && (navigator.maxTouchPoints || 0) === 0) return;
        }
        var ptrEl = byId('pullToRefresh');
        if (!ptrEl) return;
        var iconEl = byId('pullToRefreshIcon');
        var textEl = byId('pullToRefreshText');
        var iconDefault = 'expand_more';
        var iconRefreshing = 'autorenew';
        var threshold = 110;
        var activationDelay = 90;
        var activationDistance = 32;
        var revealDistance = 20;
        var pulling = false;
        var ready = false;
        var refreshing = false;
        var startY = 0;
        var startX = 0;
        var interactionMode = null;
        var startedAt = 0;
        var scrollEl = document.scrollingElement || document.documentElement;
        var horizontalGuard = 12;
        var pullIntentAt = 0;

        function atTop() {
          var top =
            scrollEl && typeof scrollEl.scrollTop === 'number'
              ? scrollEl.scrollTop
              : window.pageYOffset ||
                document.documentElement.scrollTop ||
                document.body.scrollTop ||
                0;
          return top <= 0;
        }
        function setReady(flag) {
          ready = !!flag;
          ptrEl.classList.toggle('ready', ready);
          if (!refreshing && textEl) {
            textEl.textContent = ready ? '指を離すと更新' : '下に引っ張って更新';
          }
        }
        function show() {
          if (!ptrEl.classList.contains('show')) {
            ptrEl.classList.add('show');
          }
          ptrEl.setAttribute('aria-hidden', 'false');
        }
        function setRefreshing(flag) {
          refreshing = !!flag;
          ptrEl.classList.toggle('refreshing', refreshing);
          if (refreshing) {
            ptrEl.setAttribute('aria-busy', 'true');
            setReady(false);
            if (iconEl) {
              iconEl.textContent = iconRefreshing;
            }
          } else {
            ptrEl.setAttribute('aria-busy', 'false');
            if (iconEl) {
              iconEl.textContent = iconDefault;
            }
          }
          if (textEl) {
            textEl.textContent = refreshing
              ? '更新中…'
              : ready
              ? '指を離すと更新'
              : '下に引っ張って更新';
          }
        }
        function hide() {
          ptrEl.classList.remove('show', 'refreshing', 'ready');
          ptrEl.removeAttribute('aria-busy');
          ptrEl.setAttribute('aria-hidden', 'true');
          setReady(false);
          if (iconEl) {
            iconEl.textContent = iconDefault;
          }
          if (textEl) {
            textEl.textContent = '下に引っ張って更新';
          }
        }
        function resetPull() {
          pulling = false;
          startY = 0;
          startX = 0;
          interactionMode = null;
          pullIntentAt = 0;
          setReady(false);
        }
        function triggerRefresh() {
          if (refreshing) return;
          setRefreshing(true);
          show();
          startedAt = Date.now();
          var result;
          try {
            result = refreshCurrentView();
          } catch (err) {
            result = Promise.reject(err);
          }
          Promise.resolve(result)
            .catch(function (err) {
              console.warn('Pull-to-refresh update failed:', err);
            })
            .then(function () {
              var elapsed = Date.now() - startedAt;
              var delay = elapsed < 500 ? 500 - elapsed : 0;
              setTimeout(function () {
                setRefreshing(false);
                hide();
              }, delay);
            });
        }

        hide();

        window.addEventListener(
          'touchstart',
          function (e) {
            if (refreshing) return;
            if (document.body.classList.contains('modal-open')) return;
            if (!atTop()) return;
            if (e.touches && e.touches.length > 1) return;
            if (window.__SHIFT_FLOW_GESTURE__ === 'horizontal') return;
            var touch = e.touches ? e.touches[0] : e;
            startY = touch.clientY;
            startX = touch.clientX;
            interactionMode = null;
            pullIntentAt = Date.now();
            pulling = true;
            setReady(false);
          },
          { passive: true }
        );
        window.addEventListener(
          'touchmove',
          function (e) {
            if (!pulling) return;
            if (e.touches && e.touches.length > 1) return;
            if (window.__SHIFT_FLOW_GESTURE__ === 'horizontal') {
              hide();
              resetPull();
              return;
            }
            if (!atTop()) {
              resetPull();
              hide();
              return;
            }
            var touch = e.touches ? e.touches[0] : e;
            var diffX = touch.clientX - startX;
            var diff = touch.clientY - startY;
            var absX = Math.abs(diffX);
            var absY = Math.abs(diff);
            var elapsed = Date.now() - pullIntentAt;
            if (interactionMode === null) {
              if (absX > horizontalGuard && absX > absY) {
                interactionMode = 'horizontal';
                hide();
                resetPull();
                return;
              }
              if (diff > 0 && (absY >= absX || absY > horizontalGuard)) {
                if (elapsed < activationDelay || diff < activationDistance) {
                  return;
                }
                interactionMode = 'vertical';
              }
            }
            if (interactionMode === 'horizontal') {
              return;
            }
            if (interactionMode === null) {
              if (diff <= 0) {
                setReady(false);
              }
              return;
            }
            if (diff <= 0) {
              setReady(false);
              return;
            }
            if (diff >= revealDistance) {
              show();
            }
            setReady(diff >= threshold);
          },
          { passive: true }
        );
        window.addEventListener(
          'touchend',
          function () {
            if (!pulling) return;
            if (refreshing) {
              resetPull();
              return;
            }
            if (ready) {
              triggerRefresh();
            } else {
              hide();
            }
            resetPull();
          },
          { passive: true }
        );
        window.addEventListener(
          'touchcancel',
          function () {
            if (refreshing) return;
            hide();
            resetPull();
          },
          { passive: true }
        );
      }

      var MIN_CONTENT_SKELETON_MS = 220;

      function revealAfterDelay(startedAt, minDuration, fn) {
        if (typeof fn !== 'function') return;
        var delay = 0;
        if (typeof startedAt === 'number' && startedAt > 0 && typeof minDuration === 'number') {
          var elapsed = Date.now() - startedAt;
          if (elapsed < minDuration) {
            delay = minDuration - elapsed;
          }
        }
        if (delay > 0) {
          setTimeout(fn, delay);
        } else {
          fn();
        }
      }

      function skel(n) {
        var h = '';
        for (var i = 0; i < (n || 4); i++) {
          h += '<div class="skeleton mb-2"></div>';
        }
        return h;
      }

      function renderHomeView(data) {
        var payload = data || {};
        var tasks = normalizeArray(payload.tasks);
        var tHTML = tasks.length
          ? tasks
              .map(function (t) {
                return rowTask(t, false);
              })
              .join('')
          : '<div class="card app-card task-card mb-2"><div class="card-body text-muted">今日のタスクはありません。</div></div>';
        byId('home-today-tasks').innerHTML = tHTML;

        var unread = normalizeArray(payload.messages).filter(function (x) {
          return !x.isRead;
        });
        [byId('badge-unread-top'), byId('badge-unread-bottom')].forEach(function (b) {
          if (!b) return;
          b.textContent = unread.length;
          b.classList.toggle('d-none', unread.length === 0);
        });

        var mHTML = unread.length
          ? unread
              .map(function (m) {
                return renderMessageCard(m, { compact: true, hideAction: true });
              })
              .join('')
          : '<div class="card app-card msg-card mb-2"><div class="card-body text-muted">未読のメッセージはありません。</div></div>';
        byId('home-unread').innerHTML = mHTML;
        var sourceRows =
          TASK_STATE &&
          TASK_STATE.my &&
          Array.isArray(TASK_STATE.my.rows) &&
          TASK_STATE.my.rows.length
            ? TASK_STATE.my.rows
            : tasks;
        updateTaskOverdueBadge(sourceRows);
      }

      function collectActiveTaskRows() {
        var state = window.TASK_STATE;
        var scopes = ['my', 'from', 'all'];
        var seen = Object.create(null);
        var collected = [];
        scopes.forEach(function (scope) {
          var list = state && state[scope] && state[scope].rows;
          normalizeArray(list).forEach(function (task) {
            if (!task) return;
            var key =
              task.id != null
                ? 'id:' + task.id
                : 'hash:' + [task.title, task.dueDate, task.status].join('|');
            if (seen[key]) return;
            seen[key] = true;
            collected.push(task);
          });
        });
        return collected;
      }

      function computeOverdueTaskCount(rows) {
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        return normalizeArray(rows).reduce(function (count, task) {
          if (!task) return count;
          if (task.isCompleted || String(task.status || '').trim() === '完了') {
            return count;
          }
          var status = String(task.status || '').trim();
          if (status && status !== '未着手' && status !== '対応中') {
            return count;
          }
          if (!task.dueDate) {
            return count;
          }
          var due = new Date(task.dueDate);
          if (isNaN(due.getTime())) {
            return count;
          }
          due.setHours(0, 0, 0, 0);
          return due.getTime() <= today.getTime() ? count + 1 : count;
        }, 0);
      }

      function updateTaskOverdueBadge(rows) {
        var source = normalizeArray(rows);
        if (!source.length) {
          source = collectActiveTaskRows();
        }
        var count = computeOverdueTaskCount(source);
        [byId('badge-task-overdue-top'), byId('badge-task-overdue-bottom')].forEach(function (el) {
          if (!el) return;
          el.textContent = count;
          el.classList.toggle('d-none', count === 0);
        });
      }

      function loadHomeFromCache() {
        return readUserCacheEntry('home').then(function (entry) {
          if (!entry || !entry.value) return null;
          var value = entry.value || {};
          return {
            tasks: normalizeArray(value.tasks),
            messages: normalizeArray(value.messages),
          };
        });
      }

      function cacheHomePayload(data) {
        return writeUserCacheEntry('home', {
          tasks: normalizeArray(data && data.tasks),
          messages: normalizeArray(data && data.messages),
        });
      }

      // ===== Home =====
      function loadHome() {
        if (!HAS_ACTIVE_EMAIL) {
          var card = authRequiredCard();
          byId('home-today-tasks').innerHTML = card;
          byId('home-unread').innerHTML = card;
          if (!AUTH_NOTICE_SHOWN) {
            notify(AUTH_NOTICE_MESSAGE, false);
            AUTH_NOTICE_SHOWN = true;
          }
          return Promise.resolve(false);
        }
        var skeletonRendered = false;
        var cachedPayload = null;
        var skeletonStartedAt = 0;
        function ensureSkeleton() {
          if (skeletonRendered) return;
          byId('home-today-tasks').innerHTML = skel(3);
          byId('home-unread').innerHTML = skel(3);
          skeletonRendered = true;
        }
        return loadHomeFromCache()
          .catch(function () {
            return null;
          })
          .then(function (cached) {
            if (cached) {
              cachedPayload = cached;
            }
            ensureSkeleton();
            skeletonStartedAt = Date.now();
            return new Promise(function (resolve) {
              if (!(globalThis.google && google.script && google.script.run)) {
                revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                  if (cachedPayload) {
                    renderHomeView(cachedPayload);
                  } else {
                    ensureSkeleton();
                  }
                });
                resolve(false);
                return;
              }
              google.script.run
                .withSuccessHandler(function (d) {
                  cacheHomePayload(d);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    renderHomeView(d);
                  });
                  resolve(true);
                })
                .withFailureHandler(function (e) {
                  notify('ホーム読み込み失敗: ' + e.message, false);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (cachedPayload) {
                      renderHomeView(cachedPayload);
                    } else {
                      ensureSkeleton();
                    }
                  });
                  resolve(false);
                })
                .getHomeContent();
            });
          });
      }

      // ===== Tasks =====
      const TASK_STATE = {
        my: { rows: [], meta: {}, loaded: false, loading: false },
        from: { rows: [], meta: {}, loaded: false, loading: false },
        all: { rows: [], meta: {}, loaded: false, loading: false, restricted: !IS_MANAGER },
      };
      const TASK_FILTERS = {
        my: { search: '' },
        from: { search: '', assignee: '' },
        all: { search: '', assignee: '' },
      };

      function displayAssignees(r) {
        var assigneeEmails =
          Array.isArray(r.assignees) && r.assignees.length
            ? r.assignees
            : r.assignee
            ? [r.assignee]
            : [];
        if (!assigneeEmails.length) return '';
        return assigneeEmails
          .map(function (email) {
            return getNameByEmail(email);
          })
          .join(', ');
      }

      function rowTask(r, showAssignee) {
        var priority = r.priority || '中';
        var priorityCls = priorityClassName(priority);
        var priorityPill =
          '<span class="priority-pill ' + priorityCls + '">' + esc(priority) + '</span>';
        var dueLabel = formatDateLabel(r.dueDate);
        var isCompleted = !!r.isCompleted || String(r.status || '').trim() === '完了';
        var statusLabel = String(r.status || '').trim();
        var dueDateObj = r.dueDate ? new Date(r.dueDate) : null;
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var isOverdue = false;
        if (dueDateObj instanceof Date && !isNaN(dueDateObj.getTime())) {
          var dueStart = new Date(dueDateObj.getTime());
          dueStart.setHours(0, 0, 0, 0);
          isOverdue = !isCompleted && dueStart.getTime() < today.getTime();
        }

        var cardClass = 'card app-card task-card mb-2 text-decoration-none link-surface';
        if (isCompleted) cardClass += ' task-card-completed';
        else if (isOverdue) {
          cardClass += ' task-card-overdue';
          if (statusLabel === '未着手') cardClass += ' task-card-overdue-pending';
          else if (statusLabel === '対応中') cardClass += ' task-card-overdue-inprogress';
        }
        var text =
          '<a href="#" class="' +
          cardClass +
          '" onclick="event.preventDefault(); openTaskDetail(\'' +
          r.id +
          '\')">' +
          '<div class="card-body app-card-body">' +
          '<div class="task-info-wrap app-card-main">' +
          '<div class="task-title-line d-flex align-items-center gap-2 flex-wrap">' +
          priorityPill +
          '<strong>' +
          esc(r.title) +
          '</strong>' +
          '</div>';
        if (showAssignee) {
          var assigneesText = displayAssignees(r);
          text +=
            '<div class="task-assignee-line">' +
            (assigneesText ? '@' + esc(assigneesText) : '担当者未設定') +
            '</div>';
        }
        var createdByMe =
          r.createdBy &&
          CURRENT_USER_EMAIL &&
          String(r.createdBy).toLowerCase() === CURRENT_USER_EMAIL.toLowerCase();
        if (createdByMe) {
          text +=
            '<div class="task-meta-line"><span class="badge-soft"><span class="material-icons">outgoing_mail</span>あなたが作成</span></div>';
        }
        if (isCompleted) {
          text +=
            '<div class="task-meta-line"><span class="badge-soft badge-completed"><span class="material-icons">task_alt</span>完了</span></div>';
        } else if (isOverdue) {
          text +=
            '<div class="task-meta-line"><span class="badge-soft badge-overdue"><span class="material-icons">warning</span>期限超過</span></div>';
        }
        text +=
          '</div>' +
          '<div class="task-meta app-card-meta text-end">' +
          '<div>期限 ' +
          esc(dueLabel) +
          '</div>' +
          (r.status ? '<div class="small text-muted">' + esc(r.status) + '</div>' : '') +
          '</div>' +
          '</div></a>';
        return text;
      }

      function getTaskContainerId(scope) {
        if (scope === 'from') return 'task-list-from';
        if (scope === 'all') return 'task-list-all';
        return 'task-list-my';
      }

      function setTaskContent(scope, html) {
        var el = byId(getTaskContainerId(scope));
        if (el) {
          el.innerHTML = html;
        }
      }

      function setTaskLoading(scope, loading) {
        var state = TASK_STATE[scope];
        if (!state) return;
        state.loading = !!loading;
        if (loading) {
          setTaskContent(scope, skel(6));
        }
      }

      function setTaskError(scope, message) {
        setTaskContent(
          scope,
          '<div class="task-empty text-danger">' +
            esc(message || 'タスクの表示中にエラーが発生しました。') +
            '</div>'
        );
      }

      function filterTaskRows(scope) {
        var state = TASK_STATE[scope];
        if (!state) return [];
        var rows = normalizeArray(state.rows).slice();
        var filters = TASK_FILTERS[scope] || {};
        var assigneeFilter = (filters.assignee || '').trim().toLowerCase();
        if (assigneeFilter) {
          rows = rows.filter(function (row) {
            var list = normalizeArray(
              row.assignees && row.assignees.length
                ? row.assignees
                : row.assignee
                ? [row.assignee]
                : []
            );
            if (!list.length) return false;
            return list.some(function (email) {
              return (
                String(email || '')
                  .trim()
                  .toLowerCase() === assigneeFilter
              );
            });
          });
        }
        var search = (filters.search || '').trim().toLowerCase();
        if (search) {
          rows = rows.filter(function (row) {
            var haystack = [
              row.title || '',
              row.status || '',
              row.priority || '',
              displayAssignees(row),
              row.createdBy || '',
              formatDateLabel(row.dueDate) || '',
            ]
              .join(' ')
              .toLowerCase();
            return haystack.indexOf(search) >= 0;
          });
        }
        return rows;
      }

      function renderTaskList(scope) {
        if (scope === 'all' && TASK_STATE.all.restricted) {
          setTaskContent(scope, '<div class="task-empty">管理者権限が必要です。</div>');
          return;
        }
        if (scope === 'my' && !HAS_ACTIVE_EMAIL) {
          setTaskContent(scope, authRequiredCard());
          return;
        }
        if (TASK_STATE[scope].loading) {
          setTaskContent(scope, skel(6));
          return;
        }
        var rows = filterTaskRows(scope);
        if (!rows.length) {
          setTaskContent(scope, '<div class="task-empty">表示できるタスクはありません。</div>');
          return;
        }
        setTaskContent(
          scope,
          rows
            .map(function (r) {
              return rowTask(r, true);
            })
            .join('')
        );
      }

      function loadTasksFromCache(scope, options) {
        var opts = options || {};
        var mutateState = opts.mutate !== false;
        var shouldRender = opts.render !== false;
        return readUserCacheEntry('tasks:' + scope).then(function (entry) {
          if (!entry || !entry.value) return null;
          var payload = entry.value || {};
          var rows = normalizeArray(payload.rows);
          var meta = payload.meta && typeof payload.meta === 'object' ? payload.meta : {};
          if (mutateState) {
            TASK_STATE[scope].rows = rows;
            TASK_STATE[scope].meta = meta;
            TASK_STATE[scope].loaded = true;
            TASK_STATE[scope].loading = false;
            if (shouldRender) {
              renderTaskList(scope);
              if (scope === 'my') {
                updateTaskOverdueBadge(rows);
              } else {
                updateTaskOverdueBadge();
              }
            }
          }
          return { rows: rows, meta: meta };
        });
      }

      function cacheTasks(scope, rows, meta) {
        return writeUserCacheEntry('tasks:' + scope, {
          rows: Array.isArray(rows) ? rows : [],
          meta: meta && typeof meta === 'object' ? meta : {},
        });
      }

      function ensureTaskBootstrap() {
        if (TASKS_BOOTSTRAPPED) return;
        TASKS_BOOTSTRAPPED = true;
        var initialRows = normalizeArray(INITIAL_MY_TASK_PAYLOAD && INITIAL_MY_TASK_PAYLOAD.tasks);
        TASK_STATE.my.rows = initialRows;
        TASK_STATE.my.meta = (INITIAL_MY_TASK_PAYLOAD && INITIAL_MY_TASK_PAYLOAD.meta) || {};
        TASK_STATE.my.loaded = initialRows.length > 0;
        renderTaskList('my');
        updateTaskOverdueBadge(initialRows);
        if (initialRows.length) {
          cacheTasks('my', initialRows, TASK_STATE.my.meta);
        }
      }

      function loadMyTasks() {
        var scope = 'my';
        if (!HAS_ACTIVE_EMAIL) {
          renderTaskList(scope);
          if (!AUTH_NOTICE_SHOWN) {
            notify(AUTH_NOTICE_MESSAGE, false);
            AUTH_NOTICE_SHOWN = true;
          }
          return Promise.resolve(false);
        }
        var cachedPayload = null;
        setTaskLoading(scope, true);
        var skeletonStartedAt = Date.now();
        return loadTasksFromCache(scope, { render: false, mutate: false })
          .catch(function () {
            return null;
          })
          .then(function (cached) {
            if (cached && Array.isArray(cached.rows)) {
              cachedPayload = cached;
            }
            return new Promise(function (resolve) {
              if (!(globalThis.google && google.script && google.script.run)) {
                TASK_STATE[scope].loading = false;
                revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                  if (cachedPayload) {
                    TASK_STATE[scope].rows = cachedPayload.rows;
                    TASK_STATE[scope].meta = cachedPayload.meta || {};
                    TASK_STATE[scope].loaded = true;
                    TASK_STATE[scope].loading = false;
                    renderTaskList(scope);
                    updateTaskOverdueBadge(cachedPayload.rows);
                  } else {
                    setTaskError(
                      scope,
                      'Google Apps Script のランタイムに接続できません。ページを再読み込みしてください。'
                    );
                  }
                });
                resolve(false);
                return;
              }
              google.script.run
                .withSuccessHandler(function (result) {
                  var payload = extractTaskPayload(result);
                  TASK_STATE.my.rows = payload.rows;
                  TASK_STATE.my.meta = payload.meta || {};
                  TASK_STATE.my.loaded = true;
                  TASK_STATE.my.loading = false;
                  cacheTasks(scope, payload.rows, payload.meta);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    renderTaskList(scope);
                    updateTaskOverdueBadge(payload.rows);
                  });
                  resolve(true);
                })
                .withFailureHandler(function (error) {
                  TASK_STATE.my.loading = false;
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (cachedPayload) {
                      TASK_STATE[scope].rows = cachedPayload.rows;
                      TASK_STATE[scope].meta = cachedPayload.meta || {};
                      TASK_STATE[scope].loaded = true;
                      TASK_STATE[scope].loading = false;
                      renderTaskList(scope);
                      updateTaskOverdueBadge(cachedPayload.rows);
                    } else {
                      setTaskError(scope, 'マイタスクの表示中にエラーが発生しました。');
                    }
                  });
                  notify(
                    'マイタスク取得失敗: ' + (error && error.message ? error.message : error),
                    false
                  );
                  resolve(false);
                })
                .listMyTasks();
            });
          });
      }

      function loadCreatedTasks() {
        var scope = 'from';
        var cachedPayload = null;
        setTaskLoading(scope, true);
        var skeletonStartedAt = Date.now();
        return loadTasksFromCache(scope, { render: false, mutate: false })
          .catch(function () {
            return null;
          })
          .then(function (cached) {
            if (cached && Array.isArray(cached.rows)) {
              cachedPayload = cached;
            }
            return new Promise(function (resolve) {
              if (!(globalThis.google && google.script && google.script.run)) {
                TASK_STATE[scope].loading = false;
                revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                  if (cachedPayload) {
                    TASK_STATE[scope].rows = cachedPayload.rows;
                    TASK_STATE[scope].meta = cachedPayload.meta || {};
                    TASK_STATE[scope].loaded = true;
                    TASK_STATE[scope].loading = false;
                    renderTaskList(scope);
                    updateTaskOverdueBadge();
                  } else {
                    setTaskError(
                      scope,
                      'Google Apps Script のランタイムに接続できません。ページを再読み込みしてください。'
                    );
                  }
                });
                resolve(false);
                return;
              }
              google.script.run
                .withSuccessHandler(function (result) {
                  var payload = extractTaskPayload(result);
                  TASK_STATE.from.rows = payload.rows;
                  TASK_STATE.from.meta = payload.meta || {};
                  TASK_STATE.from.loaded = true;
                  TASK_STATE.from.loading = false;
                  cacheTasks(scope, payload.rows, payload.meta);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    renderTaskList(scope);
                    updateTaskOverdueBadge();
                  });
                  resolve(true);
                })
                .withFailureHandler(function (error) {
                  TASK_STATE.from.loading = false;
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (cachedPayload) {
                      TASK_STATE[scope].rows = cachedPayload.rows;
                      TASK_STATE[scope].meta = cachedPayload.meta || {};
                      TASK_STATE[scope].loaded = true;
                      TASK_STATE[scope].loading = false;
                      renderTaskList(scope);
                      updateTaskOverdueBadge();
                    } else {
                      setTaskError(scope, 'タスクの表示中にエラーが発生しました。');
                    }
                  });
                  notify(
                    '作成したタスクの取得に失敗しました: ' +
                      (error && error.message ? error.message : error),
                    false
                  );
                  resolve(false);
                })
                .listCreatedTasks(null);
            });
          });
      }

      function loadAllTasks() {
        var scope = 'all';
        if (!IS_MANAGER) {
          TASK_STATE.all.restricted = true;
          renderTaskList(scope);
          return Promise.resolve(false);
        }
        var cachedPayload = null;
        setTaskLoading(scope, true);
        var skeletonStartedAt = Date.now();
        return loadTasksFromCache(scope, { render: false, mutate: false })
          .catch(function () {
            return null;
          })
          .then(function (cached) {
            if (cached && Array.isArray(cached.rows)) {
              cachedPayload = cached;
            }
            return new Promise(function (resolve) {
              if (!(globalThis.google && google.script && google.script.run)) {
                TASK_STATE[scope].loading = false;
                revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                  if (cachedPayload) {
                    TASK_STATE[scope].rows = cachedPayload.rows;
                    TASK_STATE[scope].meta = cachedPayload.meta || {};
                    TASK_STATE[scope].loaded = true;
                    TASK_STATE[scope].loading = false;
                    renderTaskList(scope);
                    updateTaskOverdueBadge();
                  } else {
                    setTaskError(
                      scope,
                      'Google Apps Script のランタイムに接続できません。ページを再読み込みしてください。'
                    );
                  }
                });
                resolve(false);
                return;
              }
              google.script.run
                .withSuccessHandler(function (result) {
                  var payload = extractTaskPayload(result);
                  if (payload.meta && payload.meta.managerOnly && !payload.meta.isManager) {
                    TASK_STATE.all.restricted = true;
                    TASK_STATE.all.loading = false;
                    revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                      renderTaskList(scope);
                    });
                    if (!MANAGER_NOTICE_SHOWN) {
                      notify('全体のタスク閲覧には管理者権限が必要です。', false);
                      MANAGER_NOTICE_SHOWN = true;
                    }
                    resolve(false);
                    return;
                  }
                  TASK_STATE.all.rows = payload.rows;
                  TASK_STATE.all.meta = payload.meta || {};
                  TASK_STATE.all.loaded = true;
                  TASK_STATE.all.restricted = false;
                  TASK_STATE.all.loading = false;
                  cacheTasks(scope, payload.rows, payload.meta);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    renderTaskList(scope);
                    updateTaskOverdueBadge();
                  });
                  resolve(true);
                })
                .withFailureHandler(function (error) {
                  TASK_STATE.all.loading = false;
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (cachedPayload) {
                      TASK_STATE[scope].rows = cachedPayload.rows;
                      TASK_STATE[scope].meta = cachedPayload.meta || {};
                      TASK_STATE[scope].loaded = true;
                      TASK_STATE[scope].loading = false;
                      renderTaskList(scope);
                      updateTaskOverdueBadge();
                    } else {
                      setTaskError(scope, 'タスクの表示中にエラーが発生しました。');
                    }
                  });
                  notify(
                    '全体タスクの取得に失敗しました: ' +
                      (error && error.message ? error.message : error),
                    false
                  );
                  resolve(false);
                })
                .listAllTasks(null);
            });
          });
      }

      function activateTaskTab(tab, shouldLoad) {
        if (tab === 'all' && !IS_MANAGER) {
          TASK_STATE.all.restricted = true;
          renderTaskList('all');
          return;
        }
        if (!tab) tab = 'my';
        ACTIVE_TASK_TAB = tab;
        $$('#taskTabs .task-tab-btn').forEach(function (btn) {
          btn.classList.toggle('active', btn.getAttribute('data-task-tab') === tab);
        });
        $$('.task-panels .task-panel').forEach(function (panel) {
          panel.classList.toggle('active', panel.getAttribute('data-task-panel') === tab);
        });
        if (shouldLoad) {
          if (tab === 'my') {
            loadMyTasks();
            return;
          }
          if (tab === 'from') {
            loadCreatedTasks();
            return;
          }
          if (tab === 'all') {
            loadAllTasks();
            return;
          }
        }
        renderTaskList(tab);
      }

      function reloadActiveTaskTab() {
        var active = ACTIVE_TASK_TAB || 'my';
        if (active === 'from') {
          return loadCreatedTasks();
        }
        if (active === 'all') {
          return loadAllTasks();
        }
        return loadMyTasks();
      }

      var API_REFRESH_COOLDOWN_MS = 1500;
      var API_REFRESH_LAST_RUN = {};
      var API_REFRESH_PENDING = {};

      function isWithinApiCooldown(key) {
        var now = Date.now();
        var last = API_REFRESH_LAST_RUN[key] || 0;
        return now - last < API_REFRESH_COOLDOWN_MS;
      }

      function scheduleApiRefresh(key, fn) {
        if (typeof fn !== 'function') return;
        API_REFRESH_LAST_RUN[key] = Date.now();
        if (document.hidden) {
          API_REFRESH_PENDING[key] = fn;
          return;
        }
        try {
          fn();
        } catch (err) {
          console.warn('API refresh handler failed:', err);
        }
      }

      function flushPendingApiRefreshes() {
        var keys = Object.keys(API_REFRESH_PENDING);
        if (!keys.length) return;
        keys.forEach(function (key) {
          var fn = API_REFRESH_PENDING[key];
          delete API_REFRESH_PENDING[key];
          if (typeof fn === 'function') {
            try {
              fn();
            } catch (err) {
              console.warn('Pending API refresh failed:', err);
            }
          }
        });
      }

      document.addEventListener('visibilitychange', function () {
        if (!document.hidden) {
          flushPendingApiRefreshes();
        }
      });
      window.addEventListener('focus', flushPendingApiRefreshes);

      window.__SHIFT_FLOW_TRIGGER_REFRESH__ = function (message) {
        if (!message || !message.url) {
          return;
        }
        var pathname = '';
        try {
          pathname = new URL(message.url, window.location.origin).pathname || '';
        } catch (err) {
          pathname = String(message.url || '');
        }

        var handlerKey = '';
        var handler = null;

        if (pathname.indexOf('/api/tasks') === 0) {
          handlerKey = 'tasks';
          handler = function () {
            reloadActiveTaskTab();
          };
        } else if (pathname.indexOf('/api/messages') === 0) {
          handlerKey = 'messages';
          handler = function () {
            loadMessages();
          };
        } else if (pathname.indexOf('/api/home') === 0) {
          handlerKey = 'home';
          handler = function () {
            loadHome();
          };
        } else {
          return;
        }

        if (isWithinApiCooldown(handlerKey)) {
          return;
        }

        scheduleApiRefresh(handlerKey, handler);
      };

      function bindTaskControls() {
        $$('#taskTabs .task-tab-btn').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var tab = btn.getAttribute('data-task-tab');
            if (!tab) return;
            var state = TASK_STATE[tab] || {};
            var shouldLoad = tab !== ACTIVE_TASK_TAB || !state.loaded;
            activateTaskTab(tab, shouldLoad);
          });
        });
        on('task-search-my', 'input', function () {
          TASK_FILTERS.my.search = (this.value || '').trim();
          renderTaskList('my');
        });
        on('task-search-from', 'input', function () {
          TASK_FILTERS.from.search = (this.value || '').trim();
          renderTaskList('from');
        });
        on('task-search-all', 'input', function () {
          TASK_FILTERS.all.search = (this.value || '').trim();
          renderTaskList('all');
        });
        on('task-filter-from-assignee', 'change', function () {
          TASK_FILTERS.from.assignee = this.value || '';
          renderTaskList('from');
        });
        on('task-filter-all-assignee', 'change', function () {
          TASK_FILTERS.all.assignee = this.value || '';
          renderTaskList('all');
        });
        on('task-reload', 'click', reloadActiveTaskTab);
      }

      // ===== Messages =====
      function renderMessageCard(m, options) {
        var opts = options || {};
        var isRead = !!m.isRead;
        var classes = ['card', 'app-card', 'msg-card', 'mb-2'];
        if (!isRead) classes.push('unread');
        if (opts.compact) classes.push('msg-card-compact');
        var priority = m.priority || '中';
        var priorityPill =
          '<span class="priority-pill ' +
          priorityClassName(priority) +
          '">' +
          esc(priority) +
          '</span>';
        var preview = m.preview || m.body || '';
        var previewHtml = esc(preview || '').replace(/\n/g, '<br>');
        var icon = isRead ? 'mark_email_read' : 'mark_email_unread';
        var linkClasses = ['msg-link', 'link-surface', 'flex-grow-1'];
        var bodyClasses = ['card-body', 'app-card-body'];
        var actionHtml = '';
        if (!opts.hideAction) {
          var lab = isRead ? 'Mark as unread' : 'Mark as read';
          var style = isRead ? 'btn-outline-primary' : 'btn-primary';
          var toggleFlag = isRead ? 'false' : 'true';
          actionHtml =
            '<div class="msg-actions flex-shrink-0">' +
            '<button class="btn ' +
            style +
            ' btn-sm msg-action-btn" onclick="event.preventDefault(); toggleRead(this,\'' +
            m.id +
            "'," +
            toggleFlag +
            ')">' +
            '<span class="label">' +
            lab +
            '</span>' +
            '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>' +
            '</button>' +
            '</div>';
        }
        return (
          '<div class="' +
          classes.join(' ') +
          '" data-memo="' +
          m.id +
          '">' +
          '<div class="' +
          bodyClasses.join(' ') +
          '">' +
          '<a href="#" class="' +
          linkClasses.join(' ') +
          '" onclick="event.preventDefault(); openMessageModal(\'' +
          m.id +
          '\')">' +
          '<div class="msg-content">' +
          '<span class="msg-icon material-icons">' +
          icon +
          '</span>' +
          '<div class="msg-lines app-card-main flex-grow-1">' +
          '<div class="msg-title-line">' +
          priorityPill +
          '<span class="msg-title ' +
          (isRead ? 'text-muted' : '') +
          '">' +
          esc(m.title) +
          '</span>' +
          '</div>' +
          '<div class="msg-preview">' +
          previewHtml +
          '</div>' +
          '</div>' +
          '</div>' +
          '</a>' +
          actionHtml +
          '</div>' +
          '</div>'
        );
      }

      function rowMsg(m) {
        return renderMessageCard(m, { hideAction: false });
      }
      function filterMessages(list) {
        var folderEl = byId('flt-msg-folder');
        var folderId = folderEl ? folderEl.value || '' : '';
        folderId = String(folderId).trim();
        if (!folderId || folderId.toLowerCase() === 'all') {
          folderId = '';
        }
        var unreadOnly = byId('flt-msg-unread') ? !!byId('flt-msg-unread').checked : false;
        var kw = byId('msg-search-box') ? (byId('msg-search-box').value || '').trim() : '';
        var rows = normalizeArray(list).slice();
        if (unreadOnly)
          rows = rows.filter(function (x) {
            return !x.isRead;
          });
        if (folderId) {
          var normalized = folderId.toLowerCase();
          rows = rows.filter(function (x) {
            var candidate = String(x && x.folderId != null ? x.folderId : '').trim();
            return candidate.toLowerCase() === normalized;
          });
        }
        if (kw) {
          rows = rows.filter(function (x) {
            return String(x.title || '').indexOf(kw) >= 0 || String(x.body || '').indexOf(kw) >= 0;
          });
        }
        return rows;
      }
      function getMessagesCacheKey(folderId, unreadOnly) {
        var folder = folderId ? String(folderId) : 'all';
        return 'messages:' + folder + ':unread:' + (unreadOnly ? '1' : '0');
      }
      function loadMessagesFromCache(cacheKey) {
        return readUserCacheEntry(cacheKey).then(function (entry) {
          if (!entry || !entry.value) return null;
          var rows = normalizeArray(entry.value.rows);
          return { rows: rows, empty: entry.value.empty };
        });
      }
      function cacheMessages(cacheKey, rows) {
        return writeUserCacheEntry(cacheKey, {
          rows: Array.isArray(rows) ? rows : [],
          empty: !rows || rows.length === 0,
        });
      }
      function renderMessageList(rows) {
        var list = Array.isArray(rows) ? rows : [];
        if (!list.length) {
          return '<div class="card app-card msg-card mb-2"><div class="card-body text-muted">No messages.</div></div>';
        }
        return list
          .map(function (m) {
            return rowMsg(m);
          })
          .join('');
      }
      function setMsgLoading(loading) {
        if (loading) byId('msg-list').innerHTML = skel(6);
        var btnAll = byId('btn-msg-markall');
        if (btnAll) btnAll.disabled = !!loading;
      }
      function loadMessages() {
        if (!HAS_ACTIVE_EMAIL) {
          byId('msg-list').innerHTML = authRequiredCard();
          if (!AUTH_NOTICE_SHOWN) {
            notify(AUTH_NOTICE_MESSAGE, false);
            AUTH_NOTICE_SHOWN = true;
          }
          return Promise.resolve(false);
        }
        var folderOpt = byId('flt-msg-folder') ? byId('flt-msg-folder').value : '';
        if (folderOpt != null) folderOpt = String(folderOpt).trim();
        if (!folderOpt || folderOpt.toLowerCase() === 'all') folderOpt = '';
        var unreadOnlyFlag = !!(byId('flt-msg-unread') || {}).checked;
        var searchKeyword = byId('msg-search-box')
          ? (byId('msg-search-box').value || '').trim()
          : '';
        var useCache = !searchKeyword;
        var cacheKey = useCache ? getMessagesCacheKey(folderOpt, unreadOnlyFlag) : null;
        var cachedRows = null;
        var skeletonStartedAt = Date.now();
        setMsgLoading(true);
        var cachePromise = useCache
          ? loadMessagesFromCache(cacheKey).catch(function () {
              return null;
            })
          : Promise.resolve(null);
        return cachePromise
          .then(function (cached) {
            if (cached && Array.isArray(cached.rows)) {
              cachedRows = cached.rows;
            }
          })
          .then(function () {
            return new Promise(function (resolve) {
              google.script.run
                .withSuccessHandler(function (list) {
                  var rows = filterMessages(list);
                  if (useCache) {
                    cacheMessages(cacheKey, rows);
                  }
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    byId('msg-list').innerHTML = renderMessageList(rows);
                    setMsgLoading(false);
                  });
                  resolve(true);
                })
                .withFailureHandler(function (e) {
                  notify('Failed to load messages: ' + e.message, false);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (Array.isArray(cachedRows)) {
                      byId('msg-list').innerHTML = renderMessageList(cachedRows);
                    } else {
                      byId('msg-list').innerHTML =
                        '<div class="card app-card msg-card mb-2"><div class="card-body text-danger">メッセージの読み込みに失敗しました。</div></div>';
                    }
                    setMsgLoading(false);
                  });
                  resolve(false);
                })
                .getMessages({
                  folderId: folderOpt || undefined,
                  unreadOnly: unreadOnlyFlag,
                });
            });
          });
      }
      function toggleRead(btn, memoId, shouldRead, onComplete) {
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function () {
            setButtonLoading(btn, false);
            if (typeof onComplete === 'function') onComplete(null, shouldRead);
            loadMessages();
            loadHome();
          })
          .withFailureHandler(function (e) {
            setButtonLoading(btn, false);
            notify('Failed to update read status: ' + e.message, false);
            if (typeof onComplete === 'function') {
              var err =
                e instanceof Error
                  ? e
                  : new Error(e && e.message ? e.message : String(e || 'Unknown error'));
              onComplete(err);
            }
          })
          .toggleMemoRead(memoId, shouldRead);
      }
      on('btn-msg-markall', 'click', function () {
        var btn = byId('btn-msg-markall');
        if (!btn) return;
        btn.disabled = true;
        var originalHTML = btn.innerHTML;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Processing...';
        var folderRef = byId('flt-msg-folder') ? byId('flt-msg-folder').value : '';
        if (folderRef != null) folderRef = String(folderRef).trim();
        if (!folderRef || folderRef.toLowerCase() === 'all') folderRef = '';
        google.script.run
          .withSuccessHandler(function (list) {
            var rows = filterMessages(list).filter(function (x) {
              return !x.isRead;
            });
            var ids = rows.map(function (x) {
              return x.id;
            });
            if (ids.length === 0) {
              notify('No unread messages to mark as read.', true);
              btn.disabled = false;
              btn.innerHTML = originalHTML;
              return;
            }
            google.script.run
              .withSuccessHandler(function (res) {
                notify(
                  res && res.message ? res.message : 'Marked unread messages as read.',
                  res && res.success !== false
                );
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                loadMessages();
                loadHome();
              })
              .withFailureHandler(function (e) {
                notify('Failed to mark messages as read: ' + e.message, false);
                btn.disabled = false;
                btn.innerHTML = originalHTML;
              })
              .markMemosReadBulk(ids);
          })
          .withFailureHandler(function (e) {
            notify('Failed to refresh messages: ' + e.message, false);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
          })
          .getMessages({
            folderId: folderRef || undefined,
            unreadOnly: !!(byId('flt-msg-unread') || {}).checked,
          });
      });

      // ===== Detail / Modal =====
      function renderAttachList(list) {
        if (!Array.isArray(list) || list.length === 0) return '';
        return list
          .map(function (a) {
            var name = esc(a.name || '(不明)');
            var size = humanBytes(a.size || 0);
            var mime = esc(a.mimeType || '');
            var url = esc(a.url || '#');
            return (
              '<li class="list-group-item">' +
              '<div class="me-2 flex-grow-1"><div>' +
              name +
              '</div>' +
              '<div class="attach-meta">' +
              mime +
              ' ・ ' +
              size +
              '</div></div>' +
              '<a class="btn btn-sm btn-outline-primary" href="' +
              url +
              '" target="_blank" rel="noopener">開く</a>' +
              '</li>'
            );
          })
          .join('');
      }
      var CURRENT_TASK_ID = null;
      function openTaskDetail(id) {
        CURRENT_TASK_ID = id;
        var modalEl = byId('taskDetailModal');
        if (!modalEl) {
          notify('タスク詳細モーダルが見つかりません', false);
          return;
        }
        var m = new bootstrap.Modal(modalEl);
        m.show();
        byId('task-detail-loading').classList.remove('d-none');
        byId('task-detail-content').classList.add('d-none');
        byId('deleteTaskButton').classList.add('d-none');
        byId('taskAttachments').classList.add('d-none');
        byId('taskAttachList').innerHTML = '';
        google.script.run
          .withSuccessHandler(function (t) {
            if (!t) {
              notify('タスクが見つかりませんでした', false);
              return;
            }
            byId('detailTaskTitle').textContent = t.title;
            var assigneeEmails =
              Array.isArray(t.assignees) && t.assignees.length
                ? t.assignees
                : t.assignee
                ? [t.assignee]
                : [];
            var assigneesText = assigneeEmails.map((email) => getNameByEmail(email)).join(', ');
            if (!assigneesText) assigneesText = '担当者未設定';
            var repeatLabel = 'なし';
            if (t.repeatRule) {
              var rule = String(t.repeatRule).toUpperCase();
              if (rule === 'DAILY') repeatLabel = '毎日';
              else if (rule === 'WEEKLY') repeatLabel = '毎週';
              else if (rule === 'MONTHLY') repeatLabel = '毎月';
              else repeatLabel = t.repeatRule;
            }
            var detailSection = byId('taskDetailBody');
            detailSection.innerHTML =
              '<div class="section-body">' +
              '<p class="mb-2"><strong>担当者:</strong> ' +
              esc(assigneesText) +
              '</p>' +
              '<p class="mb-0"><strong>繰り返し:</strong> ' +
              esc(repeatLabel) +
              '</p>' +
              '</div>';
            var att = Array.isArray(t.attachments) ? t.attachments : [];
            if (att.length) {
              byId('taskAttachList').innerHTML = renderAttachList(att);
              byId('taskAttachments').classList.remove('d-none');
            }
            byId('detailStatus').value = t.status || '未着手';
            byId('detailDue').value = t.dueDate || '';
            byId('detailPriority').value = t.priority || '中';
            if (t.canDelete) byId('deleteTaskButton').classList.remove('d-none');
            byId('task-detail-loading').classList.add('d-none');
            byId('task-detail-content').classList.remove('d-none');
          })
          .getTaskById(id);
      }
      on('btnTaskQuickSave', 'click', function () {
        if (!CURRENT_TASK_ID) return;
        var btn = byId('btnTaskQuickSave');
        var payload = {
          id: CURRENT_TASK_ID,
          title: byId('detailTaskTitle').textContent,
          dueDate: byId('detailDue').value,
          status: byId('detailStatus').value,
          priority: byId('detailPriority').value,
        };
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function (res) {
            setButtonLoading(btn, false);
            notify(res && res.message ? res.message : '更新しました', res && res.success !== false);
            loadHome();
            loadMyTasks();
            openTaskDetail(CURRENT_TASK_ID);
          })
          .withFailureHandler(function (e) {
            setButtonLoading(btn, false);
            notify('更新に失敗: ' + e.message, false);
          })
          .updateTask(payload);
      });
      on('btnTaskComplete', 'click', function () {
        if (!CURRENT_TASK_ID) return;
        var btn = byId('btnTaskComplete');
        if (!confirm('このタスクを完了にします。よろしいですか？')) return;
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function (res) {
            setButtonLoading(btn, false);
            notify(res && res.message ? res.message : '完了しました', res && res.success !== false);
            var inst = bootstrap.Modal.getInstance(byId('taskDetailModal'));
            if (inst) inst.hide();
            loadHome();
            loadMyTasks();
          })
          .withFailureHandler(function (e) {
            setButtonLoading(btn, false);
            notify('完了処理に失敗: ' + e.message, false);
          })
          .completeTask(CURRENT_TASK_ID);
      });
      on('deleteTaskButton', 'click', function () {
        if (!CURRENT_TASK_ID) return;
        if (!confirm('このタスクを削除します。よろしいですか？')) return;
        google.script.run
          .withSuccessHandler(function (res) {
            notify(res && res.message ? res.message : '削除しました', res && res.success !== false);
            var inst = bootstrap.Modal.getInstance(byId('taskDetailModal'));
            if (inst) inst.hide();
            loadHome();
            loadMyTasks();
          })
          .withFailureHandler(function (e) {
            notify('削除に失敗: ' + e.message, false);
          })
          .deleteTaskById(CURRENT_TASK_ID);
      });
      var CURRENT_MEMO_ID = null;
      var CURRENT_MEMO_IS_READ = false;
      function updateMessageReadButton(isRead) {
        var btn = byId('btnMsgMarkRead');
        if (!btn) return;
        var nextClass = isRead ? 'btn-outline-primary' : 'btn-primary';
        btn.classList.remove('btn-primary', 'btn-outline-primary');
        btn.classList.add(nextClass);
        btn.setAttribute('data-read-state', isRead ? 'read' : 'unread');
        var text = isRead ? '未読に戻す' : '既読にする';
        btn.setAttribute('aria-label', text);
        var iconEl = btn.querySelector('.js-msg-read-icon');
        if (iconEl) iconEl.textContent = isRead ? 'mark_email_unread' : 'mark_email_read';
        var textEl = btn.querySelector('.label-text');
        if (textEl) textEl.textContent = text;
      }
      function renderMessageDetail(data) {
        if (!data) return;
        CURRENT_MEMO_IS_READ = false;
        var titleEl = byId('msgDetailTitle');
        if (titleEl) titleEl.textContent = data.title || '';
        var bodySlot = byId('msgDetailBody');
        if (bodySlot) {
          var section = bodySlot.querySelector('.section-body');
          if (section) {
            section.innerHTML = esc(data.body || '').replace(/\n/g, '<br>');
          }
        }
        var attachmentsWrap = byId('msgAttachments');
        var attachList = byId('msgAttachList');
        var att = Array.isArray(data.attachments) ? data.attachments : [];
        if (att.length) {
          if (attachList) attachList.innerHTML = renderAttachList(att);
          if (attachmentsWrap) attachmentsWrap.classList.remove('d-none');
        } else {
          if (attachmentsWrap) attachmentsWrap.classList.add('d-none');
          if (attachList) attachList.innerHTML = '';
        }
        var commentsHtml = '';
        (data.comments || []).forEach(function (c) {
          var email = String(c.authorEmail || '').trim();
          var name = String(c.authorName || '').trim();
          if (!name && c.author) {
            name = String(c.author || '').trim();
          }
          if (!name && email) {
            var mapped = getNameByEmail(email);
            name = mapped !== email ? mapped : '';
          }
          var authorLabel = name;
          if (!authorLabel && c.author) {
            authorLabel = String(c.author || '').trim();
          }
          if (!authorLabel) {
            authorLabel = '投稿者不明';
          }
          var safeBody = esc(c.body || '')
            .replace(/&lt;br&gt;/gi, '<br>')
            .replace(/\n/g, '<br>');
          commentsHtml +=
            '<div class="card mb-2"><div class="card-body"><p class="mb-0">' +
            safeBody +
            '</p><small class="text-muted">' +
            esc(authorLabel) +
            ' - ' +
            esc(c.createdAt) +
            '</small></div></div>';
        });
        if (!data.comments || data.comments.length === 0) {
          commentsHtml = '<p class="text-muted">コメントはまだありません。</p>';
        }
        var commentsEl = byId('comments-list');
        if (commentsEl) commentsEl.innerHTML = commentsHtml;
        var readEl = byId('msgReadUsers');
        if (readEl) readEl.textContent = (data.readUsers || []).join(', ');
        var unreadEl = byId('msgUnreadUsers');
        if (unreadEl) unreadEl.textContent = (data.unreadUsers || []).join(', ');
        var deleteBtn = byId('deleteMessageButton');
        if (deleteBtn) deleteBtn.classList.toggle('d-none', !data.canDelete);
        var currentDisplayName = getNameByEmail(CURRENT_USER_EMAIL);
        if (currentDisplayName) {
          CURRENT_MEMO_IS_READ = Array.isArray(data.readUsers)
            ? data.readUsers.indexOf(currentDisplayName) !== -1
            : false;
        }
        updateMessageReadButton(CURRENT_MEMO_IS_READ);
      }
      function refreshMessageDetail() {
        if (!CURRENT_MEMO_ID) return;
        google.script.run
          .withSuccessHandler(function (data) {
            if (!data) return;
            renderMessageDetail(data);
          })
          .withFailureHandler(function (e) {
            notify('メッセージの再読み込みに失敗: ' + e.message, false);
          })
          .getMessageById(CURRENT_MEMO_ID);
      }
      function openMessageModal(memoId) {
        CURRENT_MEMO_ID = memoId;
        CURRENT_MEMO_IS_READ = false;
        var modalEl = byId('messageDetailModal');
        if (!modalEl) {
          notify('メッセージ詳細モーダルが見つかりません', false);
          return;
        }
        var m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        m.show();
        byId('msg-detail-loading').classList.remove('d-none');
        byId('msg-detail-content').classList.add('d-none');
        byId('deleteMessageButton').classList.add('d-none');
        byId('msgAttachments').classList.add('d-none');
        byId('msgAttachList').innerHTML = '';
        google.script.run
          .withSuccessHandler(function () {
            google.script.run
              .withSuccessHandler(function (data) {
                if (!data) {
                  notify('メッセージ取得失敗', false);
                  return;
                }
                renderMessageDetail(data);
                byId('msg-detail-loading').classList.add('d-none');
                byId('msg-detail-content').classList.remove('d-none');
                loadHome();
              })
              .getMessageById(memoId);
          })
          .markMemoAsRead(memoId);
      }
      on('btnCommentPost', 'click', function () {
        var body = (byId('newCommentBody').value || '').trim();
        if (!body) {
          notify('コメントが未入力です', false);
          return;
        }
        google.script.run
          .withSuccessHandler(function (res) {
            if (res && res.success) {
              byId('newCommentBody').value = '';
              openMessageModal(CURRENT_MEMO_ID);
            }
            notify(res.message || '完了', res.success !== false);
          })
          .addNewComment({ memoId: CURRENT_MEMO_ID, body: body });
      });
      on('btnMsgMarkRead', 'click', function () {
        if (!CURRENT_MEMO_ID) return;
        var btn = byId('btnMsgMarkRead');
        if (!btn) return;
        var shouldRead = !CURRENT_MEMO_IS_READ;
        toggleRead(btn, CURRENT_MEMO_ID, shouldRead, function (err) {
          if (err) return;
          CURRENT_MEMO_IS_READ = shouldRead;
          updateMessageReadButton(CURRENT_MEMO_IS_READ);
          refreshMessageDetail();
        });
      });
      on('btnMsgToTask', 'click', function () {
        if (!CURRENT_MEMO_ID) return;
        var btn = byId('btnMsgToTask');
        if (!btn) return;
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function (data) {
            setButtonLoading(btn, false);
            if (!data) {
              notify('メッセージが取得できませんでした。', false);
              return;
            }
            var detailModalEl = byId('messageDetailModal');
            var detailModal =
              detailModalEl &&
              (bootstrap.Modal.getInstance(detailModalEl) || new bootstrap.Modal(detailModalEl));
            if (detailModal) detailModal.hide();
            var hint = byId('taskFromMsgHint');
            if (hint) hint.classList.remove('d-none');
            var backLink = byId('backToMsgLink');
            if (backLink) {
              backLink.textContent = data.title || '元メッセージ';
              backLink.onclick = function (e) {
                e.preventDefault();
                if (!detailModalEl) return;
                var modal =
                  bootstrap.Modal.getInstance(detailModalEl) || new bootstrap.Modal(detailModalEl);
                modal.show();
              };
            }
            var titleInput = byId('taskTitle');
            if (titleInput) titleInput.value = '[From Message] ' + (data.title || '');
            var today = new Date();
            var y = today.getFullYear(),
              m = ('0' + (today.getMonth() + 1)).slice(-2),
              d = ('0' + today.getDate()).slice(-2);
            var dueInput = byId('taskDueDate');
            if (dueInput) dueInput.value = y + '-' + m + '-' + d;
            var priorityInput = byId('taskPriority');
            if (priorityInput) priorityInput.value = data.priority || '中';
            resetAssigneeList();
            var taskModalEl = byId('newTaskModal');
            if (!taskModalEl) return;
            var taskModal =
              bootstrap.Modal.getInstance(taskModalEl) || new bootstrap.Modal(taskModalEl);
            taskModal.show();
            setTimeout(function () {
              if (titleInput) titleInput.focus();
            }, 120);
          })
          .withFailureHandler(function (e) {
            setButtonLoading(btn, false);
            notify('タスク作成用の情報取得に失敗しました: ' + e.message, false);
          })
          .getMessageById(CURRENT_MEMO_ID);
      });
      on('deleteMessageButton', 'click', function () {
        if (!CURRENT_MEMO_ID) return;
        if (!confirm('このメッセージを削除します。よろしいですか？')) return;
        google.script.run
          .withSuccessHandler(function (res) {
            notify(res && res.message ? res.message : '削除しました', res && res.success !== false);
            var inst = bootstrap.Modal.getInstance(byId('messageDetailModal'));
            if (inst) inst.hide();
            loadMessages();
            loadHome();
          })
          .withFailureHandler(function (e) {
            notify('削除に失敗: ' + e.message, false);
          })
          .deleteMessageById(CURRENT_MEMO_ID);
      });

      function setProfileImageLabel(text, pending) {
        var label = byId('setting-image-name');
        if (!label) return;
        var value = text && String(text).trim() ? String(text).trim() : '未設定';
        if (pending && value !== '未設定') {
          value += '（未保存）';
        }
        label.textContent = value;
        label.classList.toggle('is-pending', !!pending);
      }
      function updateSettingsAvatarPreview(url, opts) {
        var img = byId('setting-avatar-preview');
        if (!img) return;
        var pending = !!(opts && opts.pending);
        var override = typeof url === 'string' ? url.trim() : '';
        if (!override) {
          var saved = String(img.getAttribute('data-avatar-url') || '').trim();
          var fallback = img.getAttribute('data-placeholder') || PROFILE_PLACEHOLDER_URL;
          img.src = saved || fallback;
          img.classList.remove('is-pending');
          return;
        }
        img.src = override;
        img.classList.toggle('is-pending', pending);
        if (!pending) {
          img.setAttribute('data-avatar-url', override);
        }
      }

      function renderPendingMessageAttachments() {
        var list = byId('message-attachment-list');
        if (!list) return;
        if (!Array.isArray(pendingMessageAttachments) || pendingMessageAttachments.length === 0) {
          list.innerHTML =
            '<li class="text-muted">添付はありません。必要に応じて画像を追加してください。</li>';
          return;
        }
        list.innerHTML = pendingMessageAttachments
          .map(function (att, idx) {
            var name = esc(att && att.name ? att.name : '画像');
            var size = humanBytes(att && att.size ? att.size : 0);
            return (
              '<li class="d-flex align-items-center justify-content-between gap-2 mb-1">' +
              '<span>' +
              name +
              ' (' +
              size +
              ')</span>' +
              '<button type="button" class="btn btn-link btn-sm text-danger p-0" data-attachment-remove="' +
              idx +
              '">削除</button>' +
              '</li>'
            );
          })
          .join('');
      }

      function bindProfileImageUploader() {
        on('btn-setting-image', 'click', function () {
          var input = byId('setting-image-file');
          if (input) input.click();
        });
        var input = byId('setting-image-file');
        if (!input) return;
        input.addEventListener('change', function () {
          var file = input.files && input.files[0];
          if (!file) return;
          if (!/^image\//i.test(file.type || '')) {
            notify('画像ファイルを選択してください。', false);
            input.value = '';
            return;
          }
          if (file.size > PROFILE_IMAGE_MAX_BYTES) {
            notify(
              '画像サイズは最大 ' + humanBytes(PROFILE_IMAGE_MAX_BYTES) + ' までです。',
              false
            );
            input.value = '';
            return;
          }
          readFileAsDataUrl(file)
            .then(function (data) {
              pendingProfileImage = { name: file.name, dataUri: data, size: file.size };
              setProfileImageLabel(file.name, true);
              updateSettingsAvatarPreview(data, { pending: true });
              input.value = '';
            })
            .catch(function () {
              notify('画像の読み込みに失敗しました。', false);
              input.value = '';
            });
        });
      }

      function bindMessageAttachmentUploader() {
        on('btn-message-attach', 'click', function () {
          var input = byId('message-attachment-input');
          if (input) input.click();
        });
        var input = byId('message-attachment-input');
        if (input) {
          input.addEventListener('change', function () {
            var files = Array.prototype.slice.call(input.files || []);
            if (!files.length) return;
            var slots = MESSAGE_ATTACHMENT_LIMIT - pendingMessageAttachments.length;
            if (slots <= 0) {
              notify('添付は最大 ' + MESSAGE_ATTACHMENT_LIMIT + ' 件までです。', false);
              input.value = '';
              return;
            }
            if (files.length > slots) {
              notify('添付は最大 ' + MESSAGE_ATTACHMENT_LIMIT + ' 件までです。', false);
              files = files.slice(0, slots);
            }
            var tasks = files.map(function (file) {
              if (!/^image\//i.test(file.type || '')) {
                notify(file.name + ' は画像ファイルではありません。', false);
                return Promise.resolve(null);
              }
              if (file.size > MESSAGE_ATTACHMENT_MAX_BYTES) {
                notify(
                  file.name +
                    ' は ' +
                    humanBytes(MESSAGE_ATTACHMENT_MAX_BYTES) +
                    ' を超えています。',
                  false
                );
                return Promise.resolve(null);
              }
              return readFileAsDataUrl(file).then(function (data) {
                return { name: file.name, dataUri: data, size: file.size };
              });
            });
            Promise.all(tasks)
              .then(function (items) {
                items.forEach(function (item) {
                  if (!item) return;
                  if (pendingMessageAttachments.length >= MESSAGE_ATTACHMENT_LIMIT) return;
                  pendingMessageAttachments.push(item);
                });
                renderPendingMessageAttachments();
                input.value = '';
              })
              .catch(function () {
                notify('添付画像の読み込みに失敗しました。', false);
                input.value = '';
              });
          });
        }
        var list = byId('message-attachment-list');
        if (list) {
          list.addEventListener('click', function (e) {
            var target = e.target;
            if (!target) return;
            var btn =
              typeof target.closest === 'function'
                ? target.closest('[data-attachment-remove]')
                : null;
            if (!btn && target.getAttribute && target.hasAttribute('data-attachment-remove')) {
              btn = target;
            }
            if (!btn) return;
            e.preventDefault();
            var idx = Number(btn.getAttribute('data-attachment-remove'));
            if (Number.isNaN ? Number.isNaN(idx) : isNaN(idx)) return;
            pendingMessageAttachments.splice(idx, 1);
            renderPendingMessageAttachments();
          });
        }
        renderPendingMessageAttachments();
      }

      // ===== 設定 =====
      function loadSettings() {
        return new Promise(function (resolve) {
          if (!HAS_ACTIVE_EMAIL) {
            notify(AUTH_NOTICE_MESSAGE, false);
            resolve(false);
            return;
          }
          google.script.run
            .withSuccessHandler(function (s) {
              if (!s) {
                resolve(false);
                return;
              }
              byId('setting-name').value = s.name || '';
              pendingProfileImage = null;
              var fileInput = byId('setting-image-file');
              if (fileInput) fileInput.value = '';
              var labelText = '';
              if (s.imageName) labelText = s.imageName;
              else if (s.imageUrl && s.imageUrl !== PROFILE_PLACEHOLDER_URL) labelText = '設定済み';
              setProfileImageLabel(labelText, false);
              updateSettingsAvatarPreview(s.imageUrl || '', { pending: false });
              applyUserAvatar(s.imageUrl || '');
              var themeVal = String(s.theme || 'light').toLowerCase();
              if (['light', 'dark', 'system'].indexOf(themeVal) === -1) {
                themeVal = 'light';
              }
              var themeInput = byId('setting-theme');
              if (themeInput) {
                themeInput.value = themeVal;
                updateThemeStatus(themeVal);
                applyThemePreference(themeVal);
              } else {
                applyThemePreference(themeVal);
                updateThemeStatus(themeVal);
              }
              resolve(true);
            })
            .withFailureHandler(function (e) {
              notify('設定読み込み失敗: ' + e.message, false);
              resolve(false);
            })
            .getUserSettings();
        });
      }
      on('btn-settings-save', 'click', function () {
        var btn = byId('btn-settings-save');
        var lbl = btn.querySelector('.label');
        var sp = btn.querySelector('.spinner-border');
        btn.disabled = true;
        if (lbl) lbl.classList.add('d-none');
        if (sp) sp.classList.remove('d-none');
        var payload = {
          name: byId('setting-name').value || '',
          imageData: pendingProfileImage ? pendingProfileImage.dataUri : '',
          theme: byId('setting-theme').value || 'light',
        };
        google.script.run
          .withSuccessHandler(function (res) {
            notify(res && res.message ? res.message : '保存しました', res && res.success !== false);
            btn.disabled = false;
            if (lbl) lbl.classList.remove('d-none');
            if (sp) sp.classList.add('d-none');
            if (res && res.success) {
              var labelText = '';
              if (res.imageName) labelText = res.imageName;
              else if (res.imageUrl && res.imageUrl !== PROFILE_PLACEHOLDER_URL)
                labelText = '設定済み';
              setProfileImageLabel(labelText, false);
              updateSettingsAvatarPreview(res.imageUrl || '', { pending: false });
              applyUserAvatar(res.imageUrl || '');
              pendingProfileImage = null;
              var fileInput = byId('setting-image-file');
              if (fileInput) fileInput.value = '';
            }
          })
          .withFailureHandler(function (e) {
            notify('保存に失敗: ' + e.message, false);
            btn.disabled = false;
            if (lbl) lbl.classList.remove('d-none');
            if (sp) sp.classList.add('d-none');
          })
          .saveUserSettings(payload);
      });

      // ===== 担当者選択（複数） =====
      var selectedAssignees = new Set();
      function renderAssigneeList() {
        var listEl = byId('assignee-list');
        if (!listEl) return;
        var rows = ACTIVE_USERS.slice().sort(function (a, b) {
          return String(a.name || '').localeCompare(String(b.name || ''), 'ja');
        });
        var html = rows
          .map(function (u) {
            var id = 'assignee__' + (u.email || '').replace(/[^a-z0-9]/gi, '_');
            var checked = selectedAssignees.has(u.email) ? ' checked' : '';
            return (
              '<div class="form-check">' +
              '<input class="form-check-input assignee-chk" type="checkbox" id="' +
              id +
              '" data-email="' +
              esc(u.email) +
              '"' +
              checked +
              '>' +
              '<label class="form-check-label" for="' +
              id +
              '">' +
              esc(u.name) +
              '</label>' +
              '</div>'
            );
          })
          .join('');
        listEl.innerHTML = html;
        updateSelectedCount();
      }
      function toggleSelectAll(toSelect) {
        ACTIVE_USERS.forEach(function (u) {
          if (toSelect) {
            selectedAssignees.add(u.email);
          } else {
            selectedAssignees.delete(u.email);
          }
        });
        renderAssigneeList();
      }
      function updateSelectedCount() {
        var cnt = selectedAssignees.size;
        var badge = byId('assignee-count-badge');
        if (badge) badge.textContent = '選択 ' + cnt + ' 件';
      }
      function getSelectedAssignees() {
        return Array.from(selectedAssignees);
      }
      function resetAssigneeList() {
        selectedAssignees.clear();
        renderAssigneeList();
      }
      (function bindAssigneeHandlers() {
        var listEl = byId('assignee-list');
        if (listEl) {
          listEl.addEventListener('change', function (e) {
            var target = e.target;
            if (target.matches('.assignee-chk')) {
              var email = target.getAttribute('data-email');
              if (!email) return;
              if (target.checked) {
                selectedAssignees.add(email);
              } else {
                selectedAssignees.delete(email);
              }
              updateSelectedCount();
            }
          });
        }
        on('btn-assignee-selectall', 'click', function () {
          toggleSelectAll(true);
        });
        on('btn-assignee-clear', 'click', function () {
          toggleSelectAll(false);
        });
      })();

      function setButtonLoading(btn, loading) {
        if (!btn) return;
        var label = btn.querySelector('.label');
        var spinner = btn.querySelector('.spinner-border');
        btn.disabled = !!loading;
        btn.setAttribute('aria-busy', loading ? 'true' : 'false');
        if (label) {
          label.classList.toggle('d-none', !!loading);
        }
        if (spinner) {
          spinner.classList.toggle('d-none', !loading);
        }
      }

      // ===== 保存ハンドラ =====
      function attachSaveHandlers() {
        on('saveTaskButton', 'click', function () {
          var btn = byId('saveTaskButton');
          var assignees = getSelectedAssignees();
          if (assignees.length === 0) {
            notify('担当者を1名以上選択してください。', false);
            return;
          }
          var task = {
            title: byId('taskTitle').value,
            dueDate: byId('taskDueDate').value,
            priority: byId('taskPriority').value,
            assignees: assignees,
          };
          if (!task.title || !task.dueDate) {
            notify('タイトルと期限は必須です。', false);
            return;
          }
          var repeatTypeEl = byId('taskRepeatType');
          var repeatType = repeatTypeEl ? repeatTypeEl.value : 'none';
          if (repeatType === 'daily') task.repeatRule = 'DAILY';
          else if (repeatType === 'weekly') task.repeatRule = 'WEEKLY';
          else if (repeatType === 'monthly') task.repeatRule = 'MONTHLY';
          else task.repeatRule = '';

          setButtonLoading(btn, true);
          google.script.run
            .withSuccessHandler(function (res) {
              setButtonLoading(btn, false);
              if (res && res.success) {
                var inst = bootstrap.Modal.getInstance(byId('newTaskModal'));
                if (inst) inst.hide();
                notify('タスクを作成しました。', true);
              } else {
                notify((res && res.message) || 'タスクの作成に失敗しました。', false);
              }
              loadHome();
              loadMyTasks();
              if (TASK_STATE.from.loaded) loadCreatedTasks();
              if (IS_MANAGER && TASK_STATE.all.loaded) loadAllTasks();
            })
            .withFailureHandler(function (e) {
              setButtonLoading(btn, false);
              notify('タスクの作成に失敗しました: ' + e.message, false);
            })
            .addNewTask(task);
        });
        on('saveMessageButton', 'click', function () {
          var btn = byId('saveMessageButton');
          var messageData = {
            title: byId('messageTitle').value,
            body: byId('messageBody').value,
            priority: byId('messagePriority').value,
            folderId: byId('messageFolder').value,
            attachments: pendingMessageAttachments.slice(),
          };
          if (!messageData.title || !messageData.body) {
            notify('件名と本文は必須です。', false);
            return;
          }
          setButtonLoading(btn, true);
          google.script.run
            .withSuccessHandler(function (res) {
              setButtonLoading(btn, false);
              if (res && res.success) {
                var inst = bootstrap.Modal.getInstance(byId('newMessageModal'));
                if (inst) inst.hide();
                pendingMessageAttachments = [];
                renderPendingMessageAttachments();
                var input = byId('message-attachment-input');
                if (input) input.value = '';
              }
              notify(res.message || '完了', res.success !== false);
              loadHome();
              loadMessages();
            })
            .withFailureHandler(function (e) {
              setButtonLoading(btn, false);
              notify('メッセージの投稿に失敗しました: ' + e.message, false);
            })
            .addNewMessage(messageData);
        });
      }

      // ===== ビューナビゲーション・フォーム初期化 =====
      const NavigationController = (function () {
        function handleViewLinkClick(event) {
          if (!event || !event.currentTarget) return;
          event.preventDefault();
          const targetView = event.currentTarget.getAttribute('data-view');
          if (targetView) {
            navigateTo(targetView);
          }
        }

        function attachViewLinks() {
          $$('[data-view]').forEach(function (link) {
            link.addEventListener('click', handleViewLinkClick);
          });
        }

        function openNewTaskModal(event) {
          if (event) event.preventDefault();
          const hint = byId('taskFromMsgHint');
          if (hint) {
            hint.classList.add('d-none');
          }
          const modalEl = byId('newTaskModal');
          if (modalEl) {
            new bootstrap.Modal(modalEl).show();
          }
        }

        function openNewMessageModal(event) {
          if (event) event.preventDefault();
          const modalEl = byId('newMessageModal');
          if (modalEl) {
            new bootstrap.Modal(modalEl).show();
          }
        }

        function attachFabHandlers() {
          on('btn-open-new-task', 'click', openNewTaskModal);
          on('btn-open-new-msg', 'click', openNewMessageModal);
        }

        function attachMessageFilters() {
          on('flt-msg-folder', 'change', loadMessages);
          on('flt-msg-unread', 'change', loadMessages);
          on('msg-search-box', 'input', debounce(loadMessages, 400));
        }

        function attachAdminMenuHandler() {
          on('btn-admin-menu', 'click', function () {
            notify('管理者メニューは準備中です。機能は近日追加されます。', true);
          });
        }

        function init() {
          attachViewLinks();
          attachFabHandlers();
          attachMessageFilters();
          attachAdminMenuHandler();
        }

        return {
          init,
          openNewTaskModal,
          openNewMessageModal,
        };
      })();

      function resetTaskModalState() {
        var taskForm = byId('newTaskForm');
        if (taskForm) taskForm.reset();
        var fromMsgHint = byId('taskFromMsgHint');
        if (fromMsgHint) {
          fromMsgHint.classList.add('d-none');
        }
        var today = new Date();
        var y = today.getFullYear();
        var m = ('0' + (today.getMonth() + 1)).slice(-2);
        var d = ('0' + today.getDate()).slice(-2);
        var dueInput = byId('taskDueDate');
        if (dueInput) {
          dueInput.value = y + '-' + m + '-' + d;
        }
        var prioritySelect = byId('taskPriority');
        if (prioritySelect) {
          prioritySelect.value = '中';
        }
        var repeatTypeEl = byId('taskRepeatType');
        if (repeatTypeEl) {
          repeatTypeEl.value = 'none';
        }
        resetAssigneeList();
        var saveBtn = byId('saveTaskButton');
        setButtonLoading(saveBtn, false);
        setTimeout(function () {
          var titleInput = byId('taskTitle');
          if (titleInput) {
            titleInput.focus();
          }
        }, 60);
      }

      function resetMessageModalState() {
        var messageForm = byId('newMessageForm');
        if (messageForm) {
          messageForm.reset();
        }
        var folderSelect = byId('messageFolder');
        if (folderSelect) {
          var defaultFolder = getDefaultFolderId();
          folderSelect.value = defaultFolder || '';
        }
        var prioritySelect = byId('messagePriority');
        if (prioritySelect) {
          prioritySelect.value = '中';
        }
        pendingMessageAttachments = [];
        renderPendingMessageAttachments();
        var fileInput = byId('message-attachment-input');
        if (fileInput) {
          fileInput.value = '';
        }
        var saveBtn = byId('saveMessageButton');
        setButtonLoading(saveBtn, false);
        setTimeout(function () {
          var titleInput = byId('messageTitle');
          if (titleInput) {
            titleInput.focus();
          }
        }, 60);
      }

      function handleModalShown(event) {
        var target = event && event.target;
        if (!target) return;
        if (target.id === 'newTaskModal') {
          resetTaskModalState();
          return;
        }
        if (target.id === 'newMessageModal') {
          resetMessageModalState();
        }
      }

      document.addEventListener('shown.bs.modal', handleModalShown);

      // ===== 初期化 =====
      window.addEventListener('load', function () {
        // GAS組み込み認証では、このスクリプトが実行される時点で
        // 常に認証済みのため、ログイン画面の表示切り替えは不要。

        // ナビゲーションやボタンのイベントリスナーを設定
        NavigationController.init();
        bindTaskControls();
        bindProfileImageUploader();
        bindMessageAttachmentUploader();
        attachSaveHandlers();

        initPullToRefresh();
        initializeAuthGateway();
      });
    </script>
    <script>
      (function () {
        try {
          var manifestUrl = new URL(window.location.href);
          if (manifestUrl.pathname.indexOf('/userCodeAppPanel') !== -1) {
            manifestUrl.pathname = manifestUrl.pathname.replace(/\/userCodeAppPanel$/, '/exec');
            manifestUrl.search = '';
            manifestUrl.searchParams.set('page', 'manifest');
          } else {
            manifestUrl.searchParams.set('page', 'manifest');
          }
          var linkEl = document.createElement('link');
          linkEl.rel = 'manifest';
          linkEl.href = manifestUrl.toString();
          document.head.appendChild(linkEl);
        } catch (err) {
          console.warn('Failed to attach manifest link:', err);
        }
      })();
    </script>
    <!-- TODO: API デバッグ用UIは本番公開前に非表示化する -->
  </body>
</html>
