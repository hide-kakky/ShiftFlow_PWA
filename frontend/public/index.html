<!DOCTYPE html>
<html data-theme="light">
  <head>
    <!-- ===== Base PWA metadata and viewport configuration ===== -->
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#517cb2" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ShiftFlow" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <!-- ===== External UI stylesheets ===== -->
    <link
      href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined"
      rel="stylesheet"
    />
    <!-- Google Sign-In スクリプトは不要なため削除 -->
    <!-- ===== Service worker registration and cache refresh messaging ===== -->
    <script>
      window.addEventListener('load', function () {
        if (!('serviceWorker' in navigator)) {
          return;
        }
        navigator.serviceWorker.register('/sw.js').catch(function (error) {
          console.warn('Service worker registration failed:', error);
        });
        navigator.serviceWorker.addEventListener('message', function (event) {
          if (!event || !event.data) return;
          if (event.data.type === 'API_CACHE_UPDATED') {
            var handler = window.__SHIFT_FLOW_TRIGGER_REFRESH__;
            if (typeof handler === 'function') {
              try {
                handler(event.data);
              } catch (err) {
                console.warn('API cache update handling failed:', err);
              }
            }
            return;
          }
          if (event.data.type === 'APP_SHELL_UPDATED') {
            promptForAppUpdate(event.data);
          }
        });
      });
    </script>
    <!-- ===== Runtime configuration endpoint (Cloudflare Functions) ===== -->
    <script src="/config"></script>
    <!-- ===== Static application constants ===== -->
    <script src="/app-config.js"></script>
    <script src="/i18n.js"></script>
    <!-- ===== Google Identity Services (One Tap / FedCM support) ===== -->
    <!-- TODO: manifest 動的補完スクリプトと静的 manifest の整合性を確認 -->
    <!-- ===== Initial bootstrap payload rendered by backend ===== -->
    <script id="shiftflow-bootstrap" type="application/json">
      {
        "userInfo": {
          "name": "ゲストユーザー",
          "email": "",
          "imageUrl": "/icons/icon-192.png",
          "theme": "light",
          "language": "ja"
        },
        "users": [],
        "folders": [],
        "myTasks": {
          "tasks": [],
          "meta": {}
        },
        "isManager": false
      }
    </script>
    <!-- ===== Merge bootstrap payload defaults and expose globals ===== -->
    <script>
      (function () {
        var defaults = {
          userInfo: {
            name: 'ゲストユーザー',
            email: '',
            imageUrl: '/icons/icon-192.png',
            theme: 'light',
            language: 'ja',
          },
          users: [],
          folders: [],
          myTasks: { tasks: [], meta: {} },
          isManager: false,
        };
        var el = document.getElementById('shiftflow-bootstrap');
        var parsed = {};
        if (el) {
          try {
            parsed = JSON.parse(el.textContent || el.innerText || '{}') || {};
          } catch (err) {
            console.warn('Failed to parse bootstrap payload:', err);
          }
        }
        var merged = Object.assign({}, defaults, parsed);
        merged.userInfo = Object.assign({}, defaults.userInfo, parsed.userInfo || {});
        merged.userInfo.language = merged.userInfo.language || 'ja';
        window.__SHIFT_FLOW_BOOTSTRAP__ = merged;
        window.userInfo = merged.userInfo;
        window.users = Array.isArray(merged.users) ? merged.users : [];
        window.folders = Array.isArray(merged.folders) ? merged.folders : [];
        window.initialTasks = merged.myTasks || defaults.myTasks;
        window.isManager = !!merged.isManager;
      })();
    </script>

    <!-- ===== Theme helpers for syncing CSS custom properties ===== -->
    <script>
      (function () {
        var themeMeta = {
          light: { statusBar: 'default' },
          dark: { statusBar: 'black-translucent' },
        };
        function readCSSVariable(name) {
          try {
            var styles = window.getComputedStyle(document.documentElement);
            var value = styles ? styles.getPropertyValue(name) : '';
            return typeof value === 'string' ? value.trim() : '';
          } catch (err) {
            return '';
          }
        }
        function computeSurfaceColor(theme) {
          var fallback = theme === 'dark' ? '#050b18' : '#f2f4f9';
          return readCSSVariable('--surface') || fallback;
        }
        function computePrimaryColor(theme) {
          var fallback = theme === 'dark' ? '#4b67b3' : '#517cb2';
          return readCSSVariable('--primary') || fallback;
        }
        window.__SHIFT_FLOW_THEME_META__ = themeMeta;
        window.__SHIFT_FLOW_GET_SURFACE__ = computeSurfaceColor;
        window.__SHIFT_FLOW_GET_PRIMARY__ = computePrimaryColor;
        window.__SHIFT_FLOW_SYNC_THEME_META__ = function (theme) {
          var resolvedTheme = theme === 'dark' ? 'dark' : 'light';
          var metaTheme = document.querySelector('meta[name="theme-color"]');
          var primaryColor = computePrimaryColor(resolvedTheme);
          if (metaTheme && primaryColor) {
            metaTheme.setAttribute('content', primaryColor);
          }
          var appleStatus = document.querySelector(
            'meta[name="apple-mobile-web-app-status-bar-style"]'
          );
          var statusBar =
            (themeMeta[resolvedTheme] && themeMeta[resolvedTheme].statusBar) ||
            (resolvedTheme === 'dark' ? 'black-translucent' : 'default');
          if (appleStatus && statusBar) {
            appleStatus.setAttribute('content', statusBar);
          }
        };

        var bootstrap = window.__SHIFT_FLOW_BOOTSTRAP__ || {};
        var pref = (bootstrap.userInfo && bootstrap.userInfo.theme) || bootstrap.theme || 'light';
        var media = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
        var resolved = pref === 'system' && media ? (media.matches ? 'dark' : 'light') : pref;
        document.documentElement.setAttribute('data-theme', resolved);
        document.documentElement.dataset.themePref = pref;
        window.__SHIFT_FLOW_SYNC_THEME_META__(resolved);
      })();
    </script>

    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* iOS標準の端スワイプ戻るを無効化 */
      html,
      body {
        overscroll-behavior-x: none;
      }
      /* ===== Light theme design tokens and global variables ===== */
      :root {
        color-scheme: light;
        --primary: #517cb2;
        --primary-700: #35567f;
        --surface: #f2f4f9;
        --card: #ffffff;
        --card-border: #dfe6f2;
        --card-shadow: 0 10px 32px rgba(15, 23, 42, 0.08);
        --text-900: #0f172a;
        --text-700: #1e293b;
        --muted: #475569;
        --on-primary: #ffffff;
        --warn: #f5a524;
        --fab: #e85d6a;
        --fab-shadow: 0 14px 28px rgba(232, 93, 106, 0.35);
        --dropdown-shadow: 0 10px 28px rgba(0, 0, 0, 0.2);
        --footer-h: 72px;
        --footer-extra: 18px;
        --header-h: 48px;
        --fade: 220ms;
        --body-bg: linear-gradient(
            180deg,
            rgba(81, 124, 178, 0.32) 0%,
            rgba(81, 124, 178, 0.12) 46%,
            rgba(255, 255, 255, 0) 85%
          ),
          linear-gradient(130deg, rgba(94, 122, 184, 0.22) 0%, rgba(255, 255, 255, 0) 68%),
          var(--surface);
        --task-card-bg: linear-gradient(0deg, rgba(81, 124, 178, 0.1), rgba(81, 124, 178, 0.1)),
          var(--card);
        --msg-card-unread-bg: linear-gradient(
            0deg,
            rgba(255, 245, 225, 0.95),
            rgba(255, 245, 225, 0.95)
          ),
          var(--card);
        --badge-bg: #e53935;
        --topbar-hover-bg: rgba(255, 255, 255, 0.12);
        --topbar-active-bg: #ffffff;
        --topbar-active-fg: var(--primary);
        --footer-bg: var(--primary);
        --footer-indicator: #ffffff;
        --footer-shadow: 0 -8px 20px rgba(81, 124, 178, 0.18);
        --skeleton-1: #cfdaf0;
        --skeleton-2: #e6edfb;
        --input-bg: #ffffff;
        --input-border: #ced4da;
        --assignee-border: #e8edf5;
        --assignee-bg: #ffffff;
        --assignee-divider: #e6ebf5;
        --badge-counter-bg: #e7f0ff;
        --badge-counter-fg: #1d4ed8;
        --attach-meta: #64748b;
        --divider: rgba(15, 23, 42, 0.08);
        --focus-ring: rgba(81, 124, 178, 0.25);
        --tab-hover-bg: rgba(81, 124, 178, 0.12);
        --tab-active-bg: #ffffff;
        --tab-active-text: var(--primary);
        --priority-high-bg: rgba(229, 57, 53, 0.12);
        --priority-high-text: #b91c1c;
        --priority-middle-bg: rgba(81, 124, 178, 0.14);
        --priority-middle-text: var(--primary-700);
        --priority-low-bg: rgba(16, 185, 129, 0.14);
        --priority-low-text: #166534;
        --alert-info-bg: rgba(81, 124, 178, 0.12);
        --alert-info-border: rgba(81, 124, 178, 0.25);
        --alert-info-text: var(--text-900);
        --app-font: 'Noto Sans JP', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        font-family: var(--app-font);
      }
      /* ===== Dark theme overrides ===== */
      :root[data-theme='dark'] {
        color-scheme: dark;
        --primary: #4b67b3;
        --primary-700: #394f8f;
        --surface: #0b1224;
        --card: #0f1a32;
        --card-border: rgba(122, 162, 255, 0.25);
        --card-shadow: 0 24px 48px rgba(5, 12, 28, 0.6);
        --text-900: #f2f6ff;
        --text-700: #d5deff;
        --muted: #cdd8ff;
        --on-primary: #f6f8ff;
        --warn: #f5a524;
        --fab: #f16fa2;
        --fab-shadow: 0 18px 36px rgba(241, 111, 162, 0.4);
        --dropdown-shadow: 0 24px 48px rgba(4, 10, 26, 0.75);
        --body-bg: linear-gradient(
            180deg,
            rgba(75, 118, 195, 0.38) 0%,
            rgba(38, 58, 120, 0.3) 54%,
            rgba(8, 19, 38, 0.92) 100%
          ),
          linear-gradient(140deg, rgba(66, 103, 185, 0.26) 0%, rgba(8, 19, 38, 0) 72%), #050b18;
        --task-card-bg: linear-gradient(0deg, rgba(90, 130, 210, 0.18), rgba(90, 130, 210, 0.12)),
          var(--card);
        --msg-card-unread-bg: linear-gradient(
            0deg,
            rgba(255, 196, 119, 0.2),
            rgba(255, 196, 119, 0.12)
          ),
          var(--card);
        --badge-bg: #f87171;
        --topbar-hover-bg: rgba(214, 224, 255, 0.12);
        --topbar-active-bg: rgba(214, 224, 255, 0.18);
        --topbar-active-fg: #f6f8ff;
        --footer-bg: #0a1833;
        --footer-indicator: #9db6ff;
        --footer-shadow: 0 -16px 32px rgba(5, 12, 28, 0.55);
        --skeleton-1: #17264a;
        --skeleton-2: #213362;
        --input-bg: #101d3a;
        --input-border: #27407c;
        --assignee-border: #2b3f6d;
        --assignee-bg: #101d3a;
        --assignee-divider: #263a66;
        --badge-counter-bg: rgba(90, 130, 210, 0.24);
        --badge-counter-fg: #b8c8ff;
        --attach-meta: #a7b4d6;
        --divider: rgba(122, 146, 194, 0.28);
        --focus-ring: rgba(90, 130, 210, 0.32);
        --tab-hover-bg: rgba(90, 130, 210, 0.22);
        --tab-active-bg: rgba(90, 130, 210, 0.26);
        --tab-active-text: #f6f8ff;
        --priority-high-bg: rgba(248, 113, 113, 0.22);
        --priority-high-text: #fecaca;
        --priority-middle-bg: rgba(90, 130, 210, 0.24);
        --priority-middle-text: #dbe4ff;
        --priority-low-bg: rgba(74, 222, 128, 0.22);
        --priority-low-text: #c1f7d8;
        --alert-info-bg: rgba(90, 130, 210, 0.22);
        --alert-info-border: rgba(90, 130, 210, 0.42);
        --alert-info-text: #f6f8ff;
      }
      /* ===== Global element resets ===== */
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        overflow-x: hidden;
        background-color: var(--surface);
        background-image: var(--body-bg);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        color: var(--text-900);
        position: relative;
      }
      /* ===== PWA preview mock layout (temporary) ===== */
      /* TODO: スタイルを /css/style.css へ分離 */
      .pwa-preview-shell {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 480px;
        margin: 16px auto;
        padding: 20px 16px calc(20px + var(--footer-h) + var(--footer-extra) + var(--safe-bottom));
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.82);
        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.12);
        backdrop-filter: blur(6px);
      }
      .pwa-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .pwa-header__title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-900);
      }
      .pwa-header__sync {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: var(--on-primary);
        box-shadow: 0 10px 18px rgba(81, 124, 178, 0.28);
      }
      .pwa-header__sync:focus-visible {
        outline: 3px solid rgba(81, 124, 178, 0.35);
        outline-offset: 2px;
      }
      .pwa-main {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .pwa-card {
        padding: 20px;
        border-radius: 16px;
        background: var(--card);
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
      }
      .pwa-card__meta {
        margin: 0 0 12px;
        color: var(--muted);
        font-size: 0.9rem;
      }
      .pwa-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 10px;
      }
      .pwa-list li {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        border-radius: 12px;
        background: rgba(81, 124, 178, 0.08);
        color: var(--text-900);
      }
      .pwa-list__dot {
        width: 10px;
        height: 10px;
        margin-top: 6px;
        border-radius: 50%;
        background: var(--primary);
        flex-shrink: 0;
      }
      .pwa-footer {
        margin-top: auto;
        min-height: calc(var(--footer-h) + var(--footer-extra));
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 18px;
        background: linear-gradient(135deg, rgba(81, 124, 178, 0.9), rgba(53, 86, 127, 0.92));
        box-shadow: var(--footer-shadow);
        padding: 8px 12px;
      }
      .pwa-footer__nav {
        width: 100%;
        display: flex;
        justify-content: space-around;
        gap: 8px;
      }
      .pwa-footer__button {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 8px 6px;
        border-radius: 12px;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.92);
        font-size: 0.75rem;
      }
      .pwa-footer__button:disabled,
      .pwa-footer__button.is-disabled {
        opacity: 0.45;
        pointer-events: none;
      }
      .pwa-footer__button:focus-visible {
        outline: 3px solid rgba(255, 255, 255, 0.4);
        outline-offset: 2px;
      }
      .pwa-footer__button--active {
        background: rgba(255, 255, 255, 0.18);
        color: #ffffff;
      }
      /* TODO: 既存UI統合までプレビュー表示を無効化 */
      body .pwa-preview-shell {
        display: none !important;
      }
      @media (min-width: 768px) {
        .pwa-preview-shell {
          margin-top: 32px;
        }
      }

      /* Header */
      header.navbar {
        position: relative;
        background: var(--primary);
        color: var(--on-primary);
        border-bottom: none;
        min-height: var(--header-h);
        padding-top: 4px;
        padding-bottom: 6px;
      }
      header .container-xl {
        padding-top: 0;
        padding-bottom: 0;
        min-height: calc(var(--header-h) - 8px);
        display: flex;
        align-items: center;
      }
      .navbar-brand.app-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        text-decoration: none;
        padding: 4px 0;
        color: var(--on-primary);
      }
      .navbar-brand.app-brand .brand-mark {
        position: relative;
        width: 38px;
        height: 38px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(72, 115, 194, 0.9), rgba(72, 115, 194, 0.52));
        box-shadow: 0 16px 28px rgba(72, 115, 194, 0.32);
        overflow: hidden;
      }
      .navbar-brand.app-brand .brand-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: inherit;
        border: 2px solid rgba(255, 255, 255, 0.45);
        inset: 0;
        opacity: 0.7;
      }
      .navbar-brand.app-brand .brand-glow {
        position: absolute;
        width: 140%;
        height: 140%;
        border-radius: inherit;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.45) 0%,
          rgba(255, 255, 255, 0) 65%
        );
        filter: blur(6px);
      }
      .navbar-brand.app-brand .brand-icon {
        position: relative;
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
        border-radius: inherit;
      }
      .navbar-brand.app-brand .brand-title {
        line-height: 1;
        display: inline-flex;
        align-items: center;
        height: 100%;
      }
      .navbar-brand.app-brand .brand-text-main {
        font-weight: 700;
        font-size: 1.24rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      @media (max-width: 768px) {
        .navbar-brand.app-brand {
          gap: 10px;
        }
        .navbar-brand.app-brand .brand-mark {
          width: 34px;
          height: 34px;
          border-radius: 11px;
        }
        .navbar-brand.app-brand .brand-text-main {
          font-size: 1.12rem;
        }
        header.navbar {
          position: sticky;
          top: 0;
          z-index: 1080;
          padding-top: calc(4px + var(--safe-top));
          padding-bottom: 8px;
          backdrop-filter: blur(12px);
          box-shadow: 0 8px 24px rgba(15, 23, 42, 0.18);
        }
        header.navbar::before {
          content: '';
          position: absolute;
          inset: 0;
          background: var(--primary);
          opacity: 0.96;
          z-index: -1;
        }
      }

      /* PC topbar (sidebar style) */
      .topbar {
        background: var(--card);
        border: 1px solid var(--card-border);
        padding: 12px;
        border-radius: 16px;
        box-shadow: var(--card-shadow), inset 0 0 0 1px rgba(15, 23, 42, 0.04);
      }
      .topbar .container-xl {
        padding: 0;
      }
      .topbar .navbar-nav {
        gap: 8px;
      }
      .topbar .nav-link {
        color: var(--text-900);
        padding: 0.65rem 0.9rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
        font-weight: 700;
        letter-spacing: 0.01em;
      }
      .topbar .nav-link:hover {
        background: var(--tab-hover-bg);
        color: var(--text-900);
      }
      .topbar .nav-link.active {
        background: var(--tab-active-bg);
        color: var(--tab-active-text);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.16);
      }
      .topbar .nav-link .material-icons,
      .topbar .nav-link .material-icons-outlined {
        font-size: 24px;
      }
      .topbar .nav-label {
        margin-left: 6px;
        flex: 1;
        font-size: 0.95rem;
      }
      .user-menu-dropdown {
        position: relative;
      }
      .user-menu-dropdown .user-menu-trigger {
        border: none;
        background: rgba(8, 20, 46, 0.15);
        color: #fff;
        border-radius: 999px;
        padding: 4px 8px 4px 4px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        min-height: 44px;
        min-width: 44px;
        transition: background 0.2s ease, transform 0.2s ease;
      }
      .user-menu-dropdown .user-menu-trigger:focus-visible {
        outline: 3px solid rgba(255, 255, 255, 0.45);
        outline-offset: 2px;
      }
      :root[data-theme='dark'] .user-menu-dropdown .user-menu-trigger {
        background: rgba(255, 255, 255, 0.12);
        color: #f6f8ff;
      }
      .user-menu-dropdown .user-menu-trigger .material-icons-outlined {
        font-size: 22px;
        opacity: 0.8;
      }
      :root[data-theme='dark'] .user-menu-dropdown .user-menu-trigger .user-menu-name {
        color: #f6f8ff;
      }
      :root[data-theme='dark'] .user-menu-dropdown .user-menu-trigger small {
        color: #d5deff;
      }
      .user-menu-dropdown .dropdown-toggle::after {
        display: none !important;
      }
      .user-menu-dropdown .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        margin: 0;
      }
      .user-menu-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.8);
      }
      .user-menu {
        min-width: 240px;
        padding: 6px 0;
      }
      .user-menu-meta {
        padding: 6px 16px 2px;
      }
      .user-menu-meta strong {
        display: block;
        font-size: 0.95rem;
      }
      .user-menu-meta small {
        color: var(--text-700) !important;
        opacity: 0.92;
      }
      .user-menu .dropdown-item .material-icons-outlined {
        font-size: 20px;
      }
      .user-menu .dropdown-item:focus,
      .user-menu .dropdown-item:hover {
        background: rgba(81, 124, 178, 0.12);
      }
      .nav-link.nav-icon {
        position: relative;
      }
      .nav-icon-badge {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
      }
      .topbar .nav-icon-badge {
        box-shadow: 0 0 0 2px var(--card);
      }
      .footer-nav .nav-icon-badge {
        top: 10px;
        right: 50%;
        transform: translate(55%, -55%);
        box-shadow: 0 0 0 2px var(--footer-bg);
      }
      .badge-unread {
        --s: 20px;
        background: var(--badge-bg) !important;
        color: #fff;
        font-weight: 800;
        font-size: 12px;
        min-width: var(--s);
        height: var(--s);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .badge-overdue {
        --s: 20px;
        background: var(--warn) !important;
        color: #fff;
        font-weight: 800;
        font-size: 12px;
        min-width: var(--s);
        height: var(--s);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      :root[data-theme='dark'] header.navbar {
        background: var(--primary);
      }
      :root[data-theme='dark'] .topbar {
        background: var(--card);
      }
      @media (max-width: 768px) {
        :root[data-theme='dark'] header.navbar::before {
          background: var(--primary);
        }
      }
      :root[data-theme='dark'] .footer-nav {
        background: linear-gradient(135deg, rgba(10, 18, 40, 0.92), rgba(5, 12, 30, 0.95));
      }

      /* Desktop layout shell */
      .app-shell-grid {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      @media (min-width: 992px) {
        .app-shell-grid {
          display: grid;
          grid-template-columns: 220px 1fr;
          gap: 12px;
          align-items: start;
          max-width: 1600px;
          padding-left: calc(12px + env(safe-area-inset-left));
          padding-right: calc(12px + env(safe-area-inset-right));
          margin: 8px auto 0;
        }
        header.navbar {
          position: sticky;
          top: 0;
          z-index: 1100;
          box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
          backdrop-filter: blur(10px);
        }
        header.navbar::before {
          content: '';
          position: absolute;
          inset: 0;
          background: var(--primary);
          opacity: 0.96;
          z-index: -1;
        }
        .topbar {
          position: sticky;
          top: calc(var(--header-h) + var(--safe-top) + 10px);
          align-self: flex-start;
          min-height: calc(100vh - var(--header-h) - 32px);
          padding: 14px;
        }
        .topbar .navbar-nav {
          flex-direction: column;
          gap: 8px;
          align-items: stretch;
        }
        .topbar .nav-item {
          width: 100%;
        }
        .topbar .nav-link {
          justify-content: flex-start;
          width: 100%;
          min-height: 48px;
        }
      }

      /* Footer nav mobile */
      .footer-nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: calc(var(--footer-h) + var(--footer-extra) + var(--safe-bottom));
        padding-bottom: calc(var(--safe-bottom) + var(--footer-extra));
        padding-left: var(--safe-left);
        padding-right: var(--safe-right);
        background: var(--footer-bg);
        z-index: 1020;
        border-top: 1px solid var(--divider);
        box-shadow: var(--footer-shadow);
      }
      .footer-nav .container-fluid {
        padding-left: 0;
        padding-right: 0;
        height: 100%;
      }
      .footer-nav .navbar-nav {
        height: 100%;
        width: 100%;
      }
      .footer-nav .nav-item {
        flex: 1 1 25%;
        display: flex;
      }
      .footer-nav .nav-link {
        color: var(--on-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        position: relative;
        height: 100%;
        width: 100%;
        transition: transform 0.3s ease;
      }
      .footer-nav .nav-link .material-icons-outlined {
        font-size: 30px;
        color: var(--on-primary);
        transition: transform 0.36s ease, filter 0.36s ease, opacity 0.3s ease;
      }
      .footer-nav .nav-link .label {
        display: none;
      }
      .footer-nav .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 10px;
        left: 50%;
        width: 32px;
        height: 4px;
        transform: translateX(-50%);
        background: var(--footer-indicator);
        border-radius: 2px;
      }
      .footer-nav .nav-link.active {
        transform: translateY(-4px);
      }
      .footer-nav .nav-link .material-icons-outlined {
        opacity: 0.92;
      }
      .footer-nav .nav-link.active .material-icons-outlined {
        opacity: 1;
        transform: translateY(-3px);
        filter: drop-shadow(0 8px 16px rgba(15, 23, 42, 0.28));
        animation: navFloat 2.4s ease-in-out infinite;
      }
      .admin-footer-nav {
        display: none;
        background: linear-gradient(135deg, rgba(20, 36, 73, 0.95), rgba(7, 16, 36, 0.95));
      }
      body.admin-view-active .admin-footer-nav {
        display: flex !important;
      }
      body.admin-view-active nav.footer-nav:not(.admin-footer-nav) {
        display: none !important;
      }
      @media (min-width: 992px) {
        .admin-footer-nav {
          display: none !important;
        }
      }
      @keyframes navFloat {
        0% {
          transform: translateY(-3px);
        }
        50% {
          transform: translateY(-6px);
        }
        100% {
          transform: translateY(-3px);
        }
      }

      .nav-tabs {
        border-bottom: 1px solid var(--divider);
        gap: 12px;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 4px;
      }
      html,
      body {
        font-family: var(--app-font);
      }
      *,
      *::before,
      *::after {
        font-family: inherit;
      }
      button,
      .btn,
      .form-control,
      .form-select,
      .form-label,
      input,
      select,
      textarea {
        font-family: var(--app-font);
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: var(--app-font);
      }
      .nav-tabs .nav-link {
        border: 0;
        border-radius: 999px;
        padding: 0.45rem 1.1rem;
        color: var(--muted);
        background: transparent;
        font-weight: 600;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .nav-tabs .nav-link:hover,
      .nav-tabs .nav-link:focus {
        color: var(--text-900);
        background: var(--tab-hover-bg);
      }
      .nav-tabs .nav-link.active {
        color: var(--tab-active-text);
        background: var(--tab-active-bg);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      }
      :root[data-theme='dark'] .nav-tabs .nav-link.active {
        box-shadow: 0 12px 24px rgba(2, 8, 20, 0.45);
      }

      /* Task board */
      .task-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .task-title-wrap {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .task-title-wrap .task-title-icon {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--primary);
        color: var(--on-primary);
        font-size: 22px;
        box-shadow: 0 10px 18px rgba(81, 124, 178, 0.25);
      }
      :root[data-theme='dark'] .task-title-wrap .task-title-icon {
        box-shadow: 0 16px 28px rgba(15, 23, 42, 0.45);
      }
      .task-header h3 {
        margin: 0;
      }
      .view-title {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-weight: 700;
        font-size: 1.65rem;
      }
      .task-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 1.5rem;
      }
      .task-tab-btn {
        border: 0;
        border-radius: 999px;
        background: rgba(81, 124, 178, 0.12);
        color: var(--text-700);
        padding: 0.55rem 1.3rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        transition: all var(--fade) ease;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }
      .task-tab-btn .material-icons-outlined {
        font-size: 18px;
      }
      .task-tab-btn:hover,
      .task-tab-btn:focus {
        background: var(--tab-hover-bg);
        color: var(--text-900);
        outline: none;
      }
      .task-tab-btn.active {
        background: var(--tab-active-bg);
        color: var(--tab-active-text);
        box-shadow: 0 14px 26px rgba(15, 23, 42, 0.14);
      }
      :root[data-theme='dark'] .task-tab-btn {
        background: rgba(122, 162, 255, 0.16);
      }
      :root[data-theme='dark'] .task-tab-btn.active {
        box-shadow: 0 18px 32px rgba(2, 8, 20, 0.55);
      }
      .task-panels {
        margin-top: 1.8rem;
      }
      .task-panel {
        display: none;
      }
      .task-panel.active {
        display: block;
      }
      .task-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .task-search {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        border-radius: 999px;
        padding: 0 0.75rem;
        min-height: 46px;
        box-shadow: var(--card-shadow);
      }
      .task-search .material-icons-outlined {
        color: var(--muted);
        font-size: 22px;
      }
      .task-search input {
        border: 0;
        background: transparent;
        color: var(--text-900);
        width: 100%;
        padding: 0.35rem 0.25rem;
        min-width: 0;
      }
      .task-search input::placeholder {
        color: var(--muted);
      }
      .task-search input:focus {
        outline: none;
      }
      .task-filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .task-filter-select {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 14px;
        padding: 0.55rem 1rem;
        min-width: 220px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        color: var(--text-900);
        box-shadow: var(--card-shadow);
        transition: border-color var(--fade) ease, box-shadow var(--fade) ease;
        background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%),
          linear-gradient(135deg, var(--muted) 50%, transparent 50%),
          linear-gradient(to right, rgba(148, 163, 184, 0.28), rgba(148, 163, 184, 0.28));
        background-position: calc(100% - 22px) 52%, calc(100% - 14px) 52%, calc(100% - 42px) 50%;
        background-size: 8px 8px, 8px 8px, 1px 28px;
        background-repeat: no-repeat;
        padding-right: 3rem;
      }
      .task-filter-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--focus-ring);
      }
      :root[data-theme='dark'] .task-filter-select {
        background: var(--input-bg);
        color: var(--text-700);
      }
      .task-empty {
        border: 1px dashed var(--divider);
        border-radius: 14px;
        padding: 24px;
        text-align: center;
        color: var(--muted);
      }
      .task-list {
        min-height: 80px;
      }

      /* Layout / cards */
      .page-body {
        padding-top: calc(var(--safe-top, 0px) + 8px);
        padding-bottom: calc(var(--footer-h) + var(--footer-extra) + var(--safe-bottom) + 12px);
        min-height: calc(100vh - var(--header-h) - var(--footer-h));
      }
      body.admin-view-active .page-body {
        padding-top: calc(var(--safe-top, 0px) + 4px);
      }
      @media (max-width: 768px) {
        .page-body {
          padding-top: calc(var(--safe-top, 0px) + 8px);
          min-height: calc(
            100vh - var(--header-h) - var(--footer-h) - var(--footer-extra) - var(--safe-top)
          );
        }
      }
      #home-today-tasks {
        margin-bottom: clamp(28px, 6vw, 42px);
      }
      #home-unread {
        margin-top: clamp(28px, 6vw, 40px);
      }
      .container-xl {
        max-width: 1760px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        padding-left: calc(10px + env(safe-area-inset-left));
        padding-right: calc(10px + env(safe-area-inset-right));
      }
      .card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        background-clip: padding-box;
        color: var(--text-900);
        touch-action: pan-y;
      }
      .card .card-body {
        padding: 16px 18px;
        min-width: 0;
      }
      .card.app-card {
        position: relative;
        border-radius: 20px;
        border: 1px solid rgba(81, 124, 178, 0.22);
        background: linear-gradient(
            135deg,
            rgba(81, 124, 178, 0.12) 0%,
            rgba(81, 124, 178, 0.02) 80%
          ),
          var(--card);
        box-shadow: 0 18px 38px rgba(15, 23, 42, 0.18);
        transition: transform var(--fade) ease, box-shadow var(--fade) ease,
          border-color var(--fade) ease;
      }
      :root[data-theme='dark'] .card.app-card {
        border-color: rgba(122, 162, 255, 0.42);
        background: linear-gradient(135deg, rgba(90, 130, 210, 0.18) 0%, rgba(17, 29, 54, 0.92) 68%),
          var(--card);
        box-shadow: 0 22px 52px rgba(4, 10, 26, 0.7);
      }
      .card.app-card:hover,
      .card.app-card:focus-within {
        transform: translateY(-3px);
        box-shadow: 0 26px 58px rgba(15, 23, 42, 0.2);
        border-color: rgba(81, 124, 178, 0.32);
      }
      :root[data-theme='dark'] .card.app-card:hover,
      :root[data-theme='dark'] .card.app-card:focus-within {
        box-shadow: 0 28px 66px rgba(4, 10, 26, 0.82);
        border-color: rgba(90, 122, 196, 0.72);
      }
      .app-card-body {
        padding: 14px 18px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
        min-width: 0;
      }
      .app-card-main {
        flex: 1 1 auto;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .app-card-meta {
        flex: 0 0 auto;
        min-width: 96px;
        text-align: right;
        font-size: 0.9rem;
        color: var(--muted);
      }
      @media (max-width: 640px) {
        .app-card-body {
          gap: 10px;
        }
        .app-card-meta {
          width: 100%;
          text-align: left;
        }
      }
      .section-head {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .section-head .section-head-icon {
        color: var(--on-primary);
        background: var(--primary);
        width: 26px;
        height: 26px;
        border-radius: 8px;
        font-size: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      /* Home view */
      .home-hero {
        position: relative;
        overflow: hidden;
        margin: 4px 0 18px;
        padding: 20px 20px 18px;
        border-radius: 22px;
        background: linear-gradient(135deg, rgba(81, 124, 178, 0.94), rgba(53, 86, 127, 0.88));
        color: #f8fbff;
        box-shadow: 0 30px 54px rgba(15, 23, 42, 0.28);
        border: 1px solid rgba(255, 255, 255, 0.12);
        isolation: isolate;
      }
      :root[data-theme='dark'] .home-hero {
        background: radial-gradient(circle at 22% 16%, rgba(255, 255, 255, 0.08), transparent 42%),
          linear-gradient(130deg, rgba(75, 118, 195, 0.8), rgba(10, 18, 40, 0.88));
        border-color: rgba(157, 182, 255, 0.32);
        box-shadow: 0 32px 68px rgba(3, 9, 24, 0.65);
      }
      .home-hero::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 78% 10%, rgba(255, 255, 255, 0.18), transparent 42%);
        opacity: 0.8;
        z-index: -1;
      }
      .home-hero__grid {
        display: grid;
        gap: 16px;
      }
      @media (min-width: 992px) {
        .home-hero__grid {
          grid-template-columns: 1.2fr 1fr;
          align-items: center;
        }
      }
      .home-hero__grid > * {
        min-width: 0;
      }
      .home-hero__intro {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .home-hero__title {
        margin: 0;
        font-size: clamp(1.6rem, 2.4vw, 2.1rem);
        line-height: 1.3;
        font-weight: 800;
      }
      .home-hero__lead {
        margin: 0;
        opacity: 0.96;
        font-size: 1rem;
      }
      .home-hero__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 4px;
      }
      .home-hero__action {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.28);
        background: rgba(255, 255, 255, 0.12);
        color: #f8fbff;
        font-weight: 700;
        box-shadow: 0 14px 28px rgba(0, 0, 0, 0.18);
      }
      .home-hero__action .material-icons-outlined,
      .home-hero__action .material-icons {
        font-size: 20px;
      }
      .home-hero__action--primary {
        background: #f8fbff;
        color: #1c2c4a;
        border-color: #f8fbff;
        box-shadow: 0 14px 32px rgba(15, 23, 42, 0.24);
      }
      .home-hero__action:hover,
      .home-hero__action:focus-visible {
        text-decoration: none;
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2));
        outline: none;
      }
      .home-hero__stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
      }
      .home-stat-card {
        background: rgba(255, 255, 255, 0.14);
        border: 1px solid rgba(255, 255, 255, 0.22);
        border-radius: 14px;
        padding: 12px 14px;
        color: #f8fbff;
        box-shadow: 0 14px 28px rgba(0, 0, 0, 0.18);
      }
      .home-panel,
      .home-stat-card {
        min-width: 0;
        max-width: 100%;
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      :root[data-theme='dark'] .home-stat-card {
        background: rgba(7, 16, 36, 0.45);
        border-color: rgba(157, 182, 255, 0.4);
      }
      .home-stat-card__label {
        margin: 0 0 4px;
        font-size: 0.95rem;
        opacity: 0.88;
      }
      .home-stat-card__value {
        display: flex;
        align-items: baseline;
        gap: 6px;
        font-size: 1.6rem;
        font-weight: 800;
        flex-wrap: wrap;
      }
      .home-stat-card__value small {
        font-size: 0.9rem;
        opacity: 0.82;
      }
      .home-stat-card__hint {
        margin: 4px 0 0;
        font-size: 0.85rem;
        opacity: 0.8;
      }
      .home-panel-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 992px) {
        .home-panel-grid {
          grid-template-columns: 1.3fr 1fr;
        }
      }
      .standalone-condensed .home-hero {
        display: none;
      }
      .standalone-condensed .home-panel-grid {
        grid-template-columns: 1fr;
      }
      .home-panel {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 18px;
        box-shadow: 0 14px 28px rgba(15, 23, 42, 0.12);
        padding: 16px;
      }
      .home-panel .text-muted,
      .home-panel .form-text,
      .home-panel small {
        color: var(--text-700) !important;
        opacity: 0.9;
      }
      .home-panel__head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 6px;
      }
      .link-soft {
        color: var(--primary);
        font-weight: 700;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .link-soft .material-icons-outlined {
        font-size: 18px;
      }
      .link-soft:hover,
      .link-soft:focus-visible {
        color: var(--primary-700);
        text-decoration: underline;
      }

      /* Task / Message */
      .card.app-card.task-card {
        border-left: 4px solid rgba(81, 124, 178, 0.4);
        background: var(--card);
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.14);
      }
      :root[data-theme='dark'] .card.app-card.task-card {
        border-left-color: rgba(102, 135, 214, 0.6);
        box-shadow: 0 16px 34px rgba(3, 9, 24, 0.58);
      }
      .card.app-card.task-card .app-card-body {
        align-items: center;
      }
      .card.app-card.task-card .task-title-line strong {
        font-size: 1.05rem;
      }
      .card.app-card.task-card.task-card-attention {
        border-left-width: 5px;
        border-left-color: rgba(98, 129, 255, 0.78);
        background: linear-gradient(
            135deg,
            rgba(98, 129, 255, 0.16) 0%,
            rgba(98, 129, 255, 0.05) 70%
          ),
          var(--card);
        box-shadow: 0 24px 52px rgba(54, 83, 168, 0.18);
      }
      :root[data-theme='dark'] .card.app-card.task-card.task-card-attention {
        border-left-color: rgba(153, 173, 255, 0.92);
        background: linear-gradient(135deg, rgba(92, 118, 255, 0.32) 0%, rgba(14, 22, 40, 0.92) 76%),
          var(--card);
        box-shadow: 0 30px 60px rgba(3, 7, 18, 0.78);
      }
      .task-card .card-body,
      .msg-card .card-body {
        color: var(--text-900);
      }
      :root[data-theme='dark'] .task-card .card-body,
      :root[data-theme='dark'] .msg-card .card-body {
        color: var(--text-700);
      }
      .card.app-card.task-card.task-card-attention::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 18px;
        pointer-events: none;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }
      .card.app-card.task-card-completed {
        border-left-color: rgba(148, 163, 184, 0.9);
        background: linear-gradient(
            135deg,
            rgba(148, 163, 184, 0.18),
            rgba(148, 163, 184, 0.04) 70%
          ),
          var(--card);
        opacity: 0.92;
      }
      .card.app-card.task-card-completed .task-title-line strong {
        color: var(--muted);
        text-decoration: line-through;
      }
      .card.app-card.task-card.task-card-overdue {
        border-left-width: 5px;
      }
      .card.app-card.task-card.task-card-overdue-pending {
        border-left-color: #e34b43;
        background: linear-gradient(135deg, rgba(227, 75, 67, 0.22), rgba(227, 75, 67, 0.06) 70%),
          var(--card);
        box-shadow: 0 16px 40px rgba(227, 75, 67, 0.18);
      }
      :root[data-theme='dark'] .card.app-card.task-card.task-card-overdue-pending {
        background: linear-gradient(135deg, rgba(229, 98, 82, 0.42), rgba(17, 29, 54, 0.88) 74%),
          var(--card);
      }
      .card.app-card.task-card.task-card-overdue-inprogress {
        border-left-color: #f49d3f;
        background: linear-gradient(135deg, rgba(244, 157, 63, 0.22), rgba(244, 157, 63, 0.06) 70%),
          var(--card);
        box-shadow: 0 16px 38px rgba(244, 157, 63, 0.16);
      }
      :root[data-theme='dark'] .card.app-card.task-card.task-card-overdue-inprogress {
        background: linear-gradient(135deg, rgba(244, 157, 63, 0.35), rgba(17, 29, 54, 0.86) 78%),
          var(--card);
      }
      .card.app-card.msg-card {
        border-left: 6px solid rgba(81, 124, 178, 0.45);
        background: linear-gradient(135deg, rgba(122, 157, 231, 0.18), rgba(81, 124, 178, 0.06) 72%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(246, 249, 255, 0.94)), var(--card);
        box-shadow: 0 14px 34px rgba(15, 23, 42, 0.22);
      }
      .card.app-card.msg-card.msg-card--pinned {
        border-left-color: rgba(251, 188, 5, 0.75);
        background: linear-gradient(135deg, rgba(251, 188, 5, 0.18), rgba(255, 248, 224, 0.4) 70%),
          var(--card);
      }
      :root[data-theme='dark'] .card.app-card.msg-card {
        border-left-color: rgba(153, 187, 255, 0.7);
        background: linear-gradient(135deg, rgba(122, 157, 231, 0.34), rgba(68, 103, 177, 0.2) 72%),
          linear-gradient(180deg, rgba(24, 38, 78, 0.92), rgba(17, 29, 54, 0.88)), var(--card);
        box-shadow: 0 20px 46px rgba(4, 10, 26, 0.6);
      }
      :root[data-theme='dark'] .card.app-card.msg-card.msg-card--pinned {
        background: linear-gradient(135deg, rgba(251, 188, 5, 0.35), rgba(17, 29, 54, 0.88) 76%),
          var(--card);
      }
      .card.app-card.msg-card.unread {
        border-left-color: rgba(255, 111, 97, 0.85);
        background: linear-gradient(
            135deg,
            rgba(255, 139, 120, 0.28),
            rgba(255, 188, 141, 0.14) 70%
          ),
          linear-gradient(180deg, rgba(255, 247, 241, 0.78), rgba(255, 252, 246, 0.72)), var(--card);
        box-shadow: 0 26px 58px rgba(255, 139, 120, 0.26);
        position: relative;
      }
      :root[data-theme='dark'] .card.app-card.msg-card.unread {
        background: linear-gradient(135deg, rgba(255, 149, 128, 0.52), rgba(114, 156, 233, 0.2) 70%),
          linear-gradient(180deg, rgba(26, 42, 82, 0.94), rgba(17, 29, 54, 0.9)), var(--card);
        box-shadow: 0 28px 62px rgba(255, 149, 128, 0.32);
      }
      .card.app-card.msg-card.unread::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 18px;
        pointer-events: none;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
      }
      .msg-card .priority-pill {
        font-size: 0.7rem;
        padding: 2px 8px;
      }

      .msg-lines {
        display: flex;
        flex-direction: column;
        gap: 6px;
        line-height: 1.35;
        min-width: 0;
      }
      .msg-preview {
        color: var(--muted);
        font-size: 0.95rem;
        line-height: 1.35;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .msg-link {
        display: flex;
        flex-direction: column;
        gap: 10px;
        text-decoration: none;
      }
      .msg-link:hover,
      .msg-link:focus {
        text-decoration: none;
      }
      .msg-title-line {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .msg-title-line .msg-title {
        font-weight: 700;
      }
      .msg-meta-line {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .msg-meta-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
        line-height: 1.2;
      }
      .msg-meta-author {
        font-weight: 600;
        color: var(--text-900);
      }
      :root[data-theme='dark'] .msg-meta-author {
        color: var(--text-700);
      }
      .msg-meta-time {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .msg-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        overflow: hidden;
        background: rgba(81, 124, 178, 0.18);
        color: var(--text-900);
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
      }
      :root[data-theme='dark'] .msg-avatar {
        background: rgba(255, 255, 255, 0.16);
        color: #f8fafc;
      }
      .msg-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .msg-avatar--lg {
        width: 44px;
        height: 44px;
      }
      .msg-avatar--initials {
        letter-spacing: 0.05em;
      }
      .msg-card .pin-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        color: #fbbc05;
      }
      .msg-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: auto;
        flex-shrink: 0;
        align-self: center;
      }
      .msg-actions .btn {
        border-radius: 999px;
        padding-inline: 18px;
        font-weight: 600;
      }
      .msg-actions .btn.msg-action-btn--icon {
        position: relative;
        width: 38px;
        height: 38px;
        padding: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .msg-actions .btn.msg-action-btn--icon .spinner-border {
        position: absolute;
        inset: 50% auto auto 50%;
        transform: translate(-50%, -50%);
        margin: 0;
        width: 1rem;
        height: 1rem;
      }
      .pin-toggle-icon {
        font-size: 18px;
        color: var(--muted);
        position: relative;
      }
      .pin-toggle-icon--on {
        color: var(--primary);
      }
      .pin-toggle-icon--off {
        color: var(--muted);
      }
      .pin-toggle-icon--off::after {
        content: '';
        position: absolute;
        width: 140%;
        height: 2px;
        background: currentColor;
        top: 50%;
        left: -20%;
        transform: translateY(-50%) rotate(-45deg);
        opacity: 0.9;
        pointer-events: none;
      }
      .msg-actions .spinner-border {
        margin-left: 8px;
      }
      .template-chip-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .template-chip-row small {
        color: var(--muted);
      }
      .template-chip-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .template-chip {
        border: 1px solid rgba(81, 124, 178, 0.3);
        border-radius: 999px;
        padding: 3px 12px;
        font-size: 0.82rem;
        background: transparent;
        cursor: pointer;
      }
      .template-chip:hover,
      .template-chip:focus-visible {
        background: rgba(81, 124, 178, 0.12);
      }
      :root[data-theme='dark'] .template-chip {
        border-color: rgba(255, 255, 255, 0.25);
      }
      .msg-content {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        min-width: 0;
      }
      .msg-card-compact .app-card-body {
        padding: 14px 18px;
      }
      .msg-card-compact .msg-preview {
        -webkit-line-clamp: 1;
      }

      /* Fade / Shimmer */
      .fade-container {
        opacity: 0;
        transition: opacity var(--fade) ease;
      }
      .fade-container.show {
        opacity: 1;
      }
      .skeleton {
        border-radius: 14px;
        background: linear-gradient(
          90deg,
          var(--skeleton-1) 25%,
          var(--skeleton-2) 50%,
          var(--skeleton-1) 75%
        );
        background-size: 200% 100%;
        animation: shim 2.6s infinite;
        min-height: 72px;
      }
      .skeleton.sm {
        min-height: 50px;
      }
      .skeleton.text {
        height: 16px;
        width: 70%;
        min-height: 16px;
      }
      @keyframes shim {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      /* Swipe views (px aligned) */
      .views-wrapper {
        position: relative;
        overflow: hidden;
        touch-action: pan-y;
      }
      .views-track {
        display: flex;
        transition: transform 650ms cubic-bezier(0.25, 0.8, 0.25, 1);
        will-change: transform;
      }
      .view-panel {
        flex: 0 0 100%;
        min-width: 0;
      }
      .view-panel.is-hidden {
        visibility: hidden;
        pointer-events: none;
        height: 0 !important;
        overflow: hidden !important;
      }
      .view-panel.show {
        height: auto !important;
        overflow: visible !important;
      }
      .pull-to-refresh {
        position: fixed;
        top: calc(var(--safe-top) + var(--header-h) - 24px);
        left: 50%;
        transform: translate(-50%, 0);
        transition: opacity 0.2s ease;
        padding: 8px 16px;
        border-radius: 999px;
        background: var(--card);
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        gap: 10px;
        pointer-events: none;
        z-index: 2050;
        opacity: 0;
        visibility: hidden;
        color: var(--text-900);
      }
      .pull-to-refresh.show {
        opacity: 1;
        visibility: visible;
      }
      .pull-to-refresh.ready .pull-to-refresh__icon {
        transform: rotate(180deg);
      }
      .pull-to-refresh.refreshing .pull-to-refresh__icon {
        transform: none;
        animation: ptr-spin 0.8s linear infinite;
      }
      .pull-to-refresh__icon {
        font-size: 20px;
        transition: transform 0.2s ease;
      }
      .pull-to-refresh__text {
        font-size: 0.9rem;
        font-weight: 600;
      }
      @keyframes ptr-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @media (min-width: 768px) {
        .pull-to-refresh {
          display: none;
        }
      }

      /* FAB */
      .fab.dropup-center {
        position: fixed;
        left: 50%;
        bottom: calc(var(--footer-h) + var(--footer-extra) + var(--safe-bottom) - 28px);
        transform: translateX(-50%);
        z-index: 1030;
      }
      .fab .btn {
        width: 66px;
        height: 66px;
        border-radius: 50%;
        padding: 0;
        border: none;
        background: linear-gradient(140deg, #ff97ab 0%, #ff5d7d 55%, #ff1f68 100%);
        box-shadow: 0 24px 36px rgba(255, 95, 125, 0.45), 0 10px 20px rgba(255, 95, 125, 0.28);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        transition: transform 0.24s ease, box-shadow 0.24s ease;
      }
      .fab .btn::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: radial-gradient(
          130% 130% at 25% 20%,
          rgba(255, 255, 255, 0.55),
          rgba(255, 255, 255, 0)
        );
        pointer-events: none;
        opacity: 0.85;
      }
      .fab .btn::after {
        content: '';
        position: absolute;
        inset: -25%;
        border-radius: inherit;
        background: radial-gradient(
          120% 120% at 50% 50%,
          rgba(255, 255, 255, 0.2),
          rgba(255, 255, 255, 0)
        );
        opacity: 0;
        transition: opacity 0.24s ease;
        pointer-events: none;
      }
      :root[data-theme='dark'] .fab .btn {
        background: linear-gradient(140deg, #ff6f90 0%, #ff3771 55%, #e01c5f 100%);
        box-shadow: 0 24px 34px rgba(224, 28, 95, 0.5), 0 12px 22px rgba(224, 28, 95, 0.28);
      }
      :root[data-theme='dark'] .fab .btn::before {
        opacity: 0.7;
      }
      .fab .btn:hover,
      .fab .btn:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 20px 34px rgba(232, 93, 106, 0.4);
      }
      .fab .btn:focus-visible {
        outline: none;
        box-shadow: 0 20px 34px rgba(232, 93, 106, 0.45), 0 0 0 4px rgba(255, 255, 255, 0.35);
      }
      .fab .btn:hover::after,
      .fab .btn:focus-visible::after {
        opacity: 0.35;
      }
      .fab .btn:active {
        transform: translateY(1px);
        box-shadow: 0 14px 24px rgba(232, 93, 106, 0.32);
      }
      .fab .btn .material-icons {
        font-size: 34px;
        color: var(--on-primary);
        position: relative;
        z-index: 1;
      }
      .fab .dropdown-toggle::after {
        display: none !important;
      }
      .fab .dropdown-menu {
        display: none;
        padding: 8px 12px;
        border-radius: 14px;
        box-shadow: var(--dropdown-shadow);
        gap: 12px;
        background: var(--card);
        border: 1px solid var(--card-border);
      }
      .fab .dropdown-menu .dropdown-item {
        border-radius: 999px;
        padding: 0.55rem 1.1rem;
        font-weight: 600;
        color: var(--text-900);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .fab .dropdown-menu .dropdown-item .material-icons-outlined {
        color: var(--text-900);
      }
      .fab .dropdown-menu .dropdown-item:hover,
      .fab .dropdown-menu .dropdown-item:focus {
        background: var(--tab-hover-bg);
        color: var(--text-900);
      }
      :root[data-theme='dark'] .fab .dropdown-menu .dropdown-item {
        color: #f5f8ff;
      }
      :root[data-theme='dark'] .fab .dropdown-menu .dropdown-item .material-icons-outlined {
        color: #f5f8ff;
      }
      .fab .dropdown-menu.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      @media (min-width: 992px) {
        .fab.dropup-center {
          left: auto;
          right: 26px;
          bottom: 26px;
          transform: none;
        }
        .fab .btn {
          width: 62px;
          height: 62px;
          box-shadow: 0 22px 32px rgba(255, 95, 125, 0.35), 0 8px 18px rgba(255, 95, 125, 0.24);
        }
      }
      body.admin-view-active .fab {
        display: none !important;
      }

      @media (max-width: 576px) {
        .page-body {
          padding-left: 12px;
          padding-right: 12px;
        }
      }

      /* 検索バー */
      .subhead-bar .input-group-text {
        background: var(--input-bg);
        border-right: 0;
        border-color: var(--input-border);
        color: var(--text-700);
      }
      .subhead-bar .form-control {
        border-left: 0;
        background: var(--input-bg);
        border-color: var(--input-border);
        color: var(--text-900);
      }
      .subhead-bar .form-control::placeholder {
        color: var(--muted);
      }

      /* 設定ビュー - ユーザー表 */
      .role-badge {
        font-size: 0.85rem;
      }

      /* 担当者選択UI */
      .assignees-wrap {
        border: 1px solid var(--assignee-border);
        border-radius: 12px;
        padding: 10px;
        background: var(--assignee-bg);
      }
      .assignees-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .assignees-list {
        max-height: 260px;
        overflow: auto;
        border-top: 1px dashed var(--assignee-divider);
        padding-top: 8px;
      }
      .assignees-list .form-check {
        margin-bottom: 6px;
      }
      .badge-counter {
        background: var(--badge-counter-bg);
        color: var(--badge-counter-fg);
        border: 1px solid transparent;
      }

      /* 添付表示 */
      .attach-list .list-group-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .attach-meta {
        font-size: 0.9rem;
        color: var(--attach-meta);
      }
      .attach-icon {
        color: var(--muted);
        font-size: 1.5rem;
      }
      .image-preview-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 12px;
      }
      @media (min-width: 768px) {
        .image-preview-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }
      }
      .image-preview-grid__item {
        position: relative;
        display: flex;
        flex-direction: column;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--card-border);
        background: var(--card);
        box-shadow: var(--card-shadow);
        padding: 0;
        text-align: left;
        cursor: pointer;
        transition: transform 120ms ease;
      }
      .image-preview-grid__item:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }
      .image-preview-grid__item:active {
        transform: scale(0.99);
      }
      .image-preview-grid__item img {
        display: block;
        width: 100%;
        height: auto;
        max-height: 65vh;
        object-fit: contain;
        background: #000;
      }
      .image-preview-grid__caption {
        position: relative;
        display: block;
        padding: 10px 14px;
        font-size: 0.9rem;
        color: var(--text-900);
        background: var(--card);
      }
      body.image-viewer-open {
        overflow: hidden;
      }
      .image-viewer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(5, 11, 24, 0.95);
        z-index: 1080;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--fade);
        display: flex;
        flex-direction: column;
      }
      .image-viewer-overlay.is-open {
        opacity: 1;
        pointer-events: auto;
      }
      .image-viewer__panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
      }
      .image-viewer__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        color: #fff;
      }
      .image-viewer__header .btn {
        color: #fff;
      }
      .image-viewer__meta {
        text-align: right;
      }
      .image-viewer__title {
        font-weight: 600;
        display: block;
      }
      .image-viewer__counter {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
      }
      .image-viewer__body {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
      }
      .image-viewer__body img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        background: #000;
      }
      .image-viewer__nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: rgba(5, 11, 24, 0.6);
        color: #fff;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .image-viewer__nav.d-none {
        display: none;
      }
      .image-viewer__nav--prev {
        left: 16px;
      }
      .image-viewer__nav--next {
        right: 16px;
      }
      .image-viewer__nav:disabled {
        opacity: 0.4;
      }
      .image-viewer__footer {
        padding: 16px 20px 24px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
      }
      .user-chip-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .user-chip {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        border-radius: 999px;
        padding: 6px 18px 6px 10px;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.01em;
        position: relative;
        min-height: 40px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .user-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(15, 15, 15, 0.08);
      }
      .user-chip__avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.3);
        color: #fff;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
      }
      .user-chip__avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .user-chip__avatar--initials {
        background: linear-gradient(135deg, #607d8b, #455a64);
      }
      .user-chip__label {
        white-space: nowrap;
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #msgReadUsers .user-chip {
        background: linear-gradient(135deg, rgba(46, 204, 113, 0.25), rgba(39, 174, 96, 0.35));
        border: 1px solid rgba(46, 204, 113, 0.6);
        color: #0c4422;
      }
      #msgReadUsers .user-chip .user-chip__avatar {
        background: rgba(33, 150, 83, 0.9);
      }
      #msgUnreadUsers .user-chip {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.25), rgba(255, 152, 0, 0.35));
        border: 1px solid rgba(255, 152, 0, 0.6);
        color: #5b2a00;
      }
      #msgUnreadUsers .user-chip .user-chip__avatar {
        background: rgba(255, 152, 0, 0.85);
      }
      :root[data-theme='dark'] #msgReadUsers .user-chip {
        background: linear-gradient(135deg, rgba(46, 204, 113, 0.4), rgba(15, 111, 43, 0.65));
        border-color: rgba(180, 255, 200, 0.65);
        color: #eafff1;
      }
      :root[data-theme='dark'] #msgReadUsers .user-chip .user-chip__avatar {
        background: rgba(46, 204, 113, 0.95);
      }
      :root[data-theme='dark'] #msgUnreadUsers .user-chip {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.4), rgba(191, 87, 0, 0.65));
        border-color: rgba(255, 224, 178, 0.7);
        color: #fff2e0;
      }
      :root[data-theme='dark'] #msgUnreadUsers .user-chip .user-chip__avatar {
        background: rgba(255, 167, 38, 0.95);
      }

      .list-group-item {
        background: var(--card);
        border-color: var(--card-border);
        color: var(--text-900);
      }
      .text-muted {
        color: var(--muted) !important;
      }
      .task-title-line {
        color: var(--text-900);
      }
      .task-title-line strong {
        color: var(--text-900);
      }
      .link-surface {
        color: var(--text-900) !important;
      }
      .link-surface:hover,
      .link-surface:focus {
        color: var(--text-900) !important;
      }
      .link-surface .text-muted {
        color: var(--muted) !important;
      }
      .task-meta {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .alert-info {
        background: var(--alert-info-bg);
        color: var(--alert-info-text);
        border-color: var(--alert-info-border);
      }

      .priority-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .priority-pill.priority-high {
        background: var(--priority-high-bg);
        color: var(--priority-high-text);
      }
      .priority-pill.priority-middle {
        background: var(--priority-middle-bg);
        color: var(--priority-middle-text);
      }
      .priority-pill.priority-low {
        background: var(--priority-low-bg);
        color: var(--priority-low-text);
      }

      .task-assignee-line {
        color: var(--text-700);
        font-size: 0.86rem;
      }
      .task-meta-line {
        color: var(--muted);
        font-size: 0.82rem;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 4px;
      }
      .task-meta-line--author .material-icons-outlined {
        font-size: 18px;
      }
      .msg-detail-meta {
        color: var(--muted);
      }
      .badge-soft {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(81, 124, 178, 0.12);
        color: var(--text-700);
        border: none;
        border-radius: 999px;
        font-size: 0.74rem;
        font-weight: 600;
        padding: 2px 10px;
      }
      .badge-soft .material-icons {
        font-size: 14px;
      }
      :root[data-theme='dark'] .badge-soft {
        background: rgba(122, 162, 255, 0.24);
        color: #e0e7ff;
      }
      .card.app-card.task-card-completed {
        border-left-color: rgba(148, 163, 184, 0.9);
        background: linear-gradient(
            135deg,
            rgba(148, 163, 184, 0.18),
            rgba(148, 163, 184, 0.04) 70%
          ),
          var(--card);
        opacity: 0.92;
      }
      .card.app-card.task-card-completed .task-title-line strong {
        text-decoration: line-through;
        color: var(--muted);
      }
      .badge-soft.badge-completed {
        background: rgba(148, 163, 184, 0.16);
        color: rgba(71, 85, 105, 0.92);
      }
      :root[data-theme='dark'] .badge-soft.badge-completed {
        background: rgba(148, 163, 184, 0.24);
        color: #e2e8f0;
      }
      .badge-soft.badge-overdue {
        background: rgba(227, 75, 67, 0.14);
        color: #d13d36;
      }
      :root[data-theme='dark'] .badge-soft.badge-overdue {
        background: rgba(229, 98, 82, 0.34);
        color: #fecaca;
      }

      .modal-modern {
        border-radius: 18px;
        border: 1px solid var(--card-border);
        background: var(--card);
        overflow: hidden;
      }
      .modal-modern .modal-header {
        border-bottom: 1px solid var(--divider);
        padding: 18px 22px;
        background: linear-gradient(135deg, rgba(81, 124, 178, 0.08), transparent);
      }
      :root[data-theme='dark'] .modal-modern .modal-header {
        background: linear-gradient(135deg, rgba(95, 125, 255, 0.22), rgba(16, 26, 53, 0.4));
      }
      .modal-modern .modal-title,
      .modal-modern h6 {
        font-weight: 700;
      }
      .modal-modern .modal-body {
        padding: 22px;
        background: linear-gradient(180deg, rgba(148, 163, 184, 0.04), transparent 24%);
      }
      .modal-modern .modal-footer {
        border-top: 1px solid var(--divider);
        padding: 16px 22px;
        background: var(--card);
      }
      .modal-modern .btn {
        border-radius: 999px;
      }
      .modal-modern .btn.btn-link {
        border-radius: 50px;
        padding: 6px 10px;
      }

      .form-section {
        border: 1px solid var(--card-border);
        border-radius: 14px;
        padding: 16px 18px;
        background: var(--card);
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.05);
        margin-bottom: 18px;
      }
      :root[data-theme='dark'] .form-section {
        box-shadow: 0 18px 32px rgba(2, 8, 20, 0.35);
      }
      .form-section-title {
        font-size: 0.9rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 8px;
      }
      .form-section .form-label {
        font-weight: 600;
      }
      .form-section .section-note {
        font-size: 0.85rem;
        color: var(--muted);
        margin-top: 4px;
      }
      .form-section .section-body {
        color: var(--text-900);
      }
      .settings-layout {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }
      .settings-block-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 16px;
      }
      .settings-block-header .settings-block-icon {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(81, 124, 178, 0.12);
        color: var(--primary);
      }
      :root[data-theme='dark'] .settings-block-header .settings-block-icon {
        background: rgba(122, 162, 255, 0.18);
        color: #dbe4ff;
      }
      .settings-block-header h5 {
        font-weight: 700;
        margin: 0;
      }
      .settings-block-header p {
        margin: 2px 0 0;
        color: var(--muted);
        font-size: 0.9rem;
      }
      .settings-profile-body {
        display: grid;
        grid-template-columns: minmax(0, 180px) minmax(0, 1fr);
        gap: 18px;
        align-items: start;
      }
      @media (max-width: 576px) {
        .settings-profile-body {
          grid-template-columns: 1fr;
        }
      }
      .settings-avatar-shell {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .settings-avatar {
        width: 96px;
        height: 96px;
        border-radius: 30px;
        object-fit: cover;
        box-shadow: 0 10px 32px rgba(15, 23, 42, 0.15);
        border: 3px solid rgba(81, 124, 178, 0.2);
        background: var(--card);
      }
      :root[data-theme='dark'] .settings-avatar {
        box-shadow: 0 16px 40px rgba(2, 8, 20, 0.55);
        border-color: rgba(122, 162, 255, 0.28);
      }
      .settings-avatar.is-pending {
        box-shadow: 0 0 0 3px rgba(81, 124, 178, 0.35);
      }
      :root[data-theme='dark'] .settings-avatar.is-pending {
        box-shadow: 0 0 0 3px rgba(122, 162, 255, 0.45);
      }
      .settings-image-meta {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .settings-image-meta.is-pending {
        color: var(--primary-700);
        font-weight: 600;
      }
      :root[data-theme='dark'] .settings-image-meta.is-pending {
        color: #dbe4ff;
      }
      .settings-upload-note {
        display: inline-flex;
        align-items: flex-start;
        gap: 6px;
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(81, 124, 178, 0.1);
        color: var(--text-900);
        font-size: 0.85rem;
      }
      .settings-upload-note .material-icons,
      .settings-upload-note .material-icons-outlined {
        font-size: 18px;
        margin-top: -2px;
      }
      :root[data-theme='dark'] .settings-upload-note {
        background: rgba(122, 162, 255, 0.18);
        color: #e8edff;
      }
      .settings-theme-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .theme-status {
        margin-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(81, 124, 178, 0.12);
        color: var(--primary-700);
        font-weight: 600;
        font-size: 0.85rem;
      }
      :root[data-theme='dark'] .theme-status {
        background: rgba(122, 162, 255, 0.22);
        color: #dbe4ff;
      }
      .settings-theme-guide {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .settings-theme-guide ul {
        margin: 0;
        padding-left: 1.15rem;
      }
      .settings-theme-guide li {
        margin-bottom: 4px;
      }
      .settings-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      .admin-shell {
        display: none;
        padding: 12px 0 64px;
      }
      .admin-shell.is-hidden {
        display: none !important;
      }
      body.admin-view-active .views-wrapper {
        display: none !important;
      }
      body.admin-view-active .admin-shell {
        display: block;
        padding-top: calc(var(--safe-top, 0px) + 4px);
      }
      .admin-top-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .admin-org-dropdown {
        position: relative;
      }
      .admin-org-trigger {
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #ffffff;
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.16);
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      }
      :root[data-theme='dark'] .admin-org-trigger {
        background: rgba(255, 255, 255, 0.92);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.2);
      }
      .admin-org-trigger .material-icons-outlined {
        font-size: 18px;
      }
      .admin-org-menu {
        width: 280px;
        padding: 8px 0;
      }
      .admin-org-menu-header {
        padding: 4px 16px 8px;
        font-size: 0.85rem;
        color: var(--muted);
      }
      .admin-org-list {
        max-height: 260px;
        overflow-y: auto;
      }
      .admin-org-item {
        width: 100%;
        border: none;
        background: transparent;
        padding: 8px 16px;
        display: flex;
        gap: 10px;
        align-items: center;
        text-align: left;
      }
      .admin-org-item .material-icons-outlined {
        font-size: 20px;
        color: var(--primary);
      }
      .admin-org-item small {
        display: block;
        color: var(--muted);
      }
      .admin-org-item.active {
        background: rgba(81, 124, 178, 0.12);
      }
      .admin-view-title {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }
      .admin-view-title-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: rgba(81, 124, 178, 0.18);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        font-size: 26px;
      }
      .admin-view-heading {
        margin: 0;
        font-size: clamp(1.4rem, 2vw, 1.8rem);
      }
      .admin-view-desc {
        margin: 4px 0 0;
        color: var(--text-700);
      }
      .admin-header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      .admin-tabs {
        display: none;
      }
      .admin-tab {
        border: none;
        border-radius: 999px;
        padding: 10px 16px;
        font-weight: 600;
        color: var(--text-900);
        background: rgba(81, 124, 178, 0.12);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .admin-tab .material-icons-outlined {
        font-size: 20px;
      }
      .admin-tab {
        display: none;
      }
      .admin-panels-wrapper {
        overflow: hidden;
        position: relative;
      }
      .admin-track {
        display: flex;
        width: 100%;
        transition: transform 320ms cubic-bezier(0.22, 0.61, 0.36, 1);
        will-change: transform;
      }
      .admin-panel {
        flex: 0 0 100%;
        min-width: 0;
        padding: 20px 0 40px;
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        margin-bottom: 14px;
      }
      .admin-panel.is-active .admin-panel-body {
        animation: fadeUp 0.35s ease;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .admin-panel-header {
        display: none;
      }
      .admin-panel-body {
        padding: 10px 12px 6px;
      }
      .admin-card-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      .admin-card {
        border: 1px solid var(--card-border);
        border-radius: 18px;
        padding: 18px;
        background: var(--card);
        box-shadow: 0 14px 28px rgba(15, 23, 42, 0.12);
        min-height: 120px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .admin-kpi-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      .admin-card--kpi {
        background: linear-gradient(135deg, rgba(81, 124, 178, 0.14), rgba(81, 124, 178, 0.02));
        border: none;
      }
      .admin-card-label {
        margin: 0;
        font-size: 0.85rem;
        color: var(--muted);
      }
      .admin-kpi-value {
        font-size: 2.4rem;
        font-weight: 700;
        color: var(--text-900);
      }
      .admin-kpi-value span {
        font-size: 1rem;
        margin-left: 6px;
        color: var(--muted);
      }
      .admin-kpi-trend {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-weight: 600;
        color: var(--muted);
      }
      .admin-kpi-trend.positive {
        color: #0f9d58;
      }
      .admin-kpi-trend.warning {
        color: var(--warn);
      }
      .admin-card--chart {
        min-height: 220px;
      }
      .admin-chart {
        margin-top: 14px;
      }
      .admin-chart--bar {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .admin-chart-bar {
        --value: 30%;
        position: relative;
        background: rgba(81, 124, 178, 0.12);
        border-radius: 999px;
        overflow: hidden;
        height: 38px;
      }
      .admin-chart-bar::before {
        content: '';
        position: absolute;
        inset: 4px;
        border-radius: 999px;
        background: var(--primary);
        width: var(--value);
        transition: width 0.3s ease;
      }
      .admin-chart-bar span {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        padding-left: 14px;
        font-weight: 600;
        color: var(--on-primary);
      }
      .admin-card h4,
      .admin-card h5 {
        margin: 0;
        font-size: 1rem;
        color: var(--text-900);
      }
      .admin-card p {
        margin: 0;
        color: var(--muted);
      }
      .admin-card .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
      }
      :root[data-theme='dark'] .admin-card .metric-value {
        color: #cbd5ff;
      }
      .admin-stats {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
      }
      .admin-stats li {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid var(--divider);
      }
      .admin-stats li:last-child {
        border-bottom: none;
      }
      .admin-log-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .admin-log-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .admin-log-item strong {
        color: var(--text-900);
      }
      .admin-org-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        list-style: none;
        padding: 0;
        margin: 0 0 1rem;
      }
      .admin-org-meta-item {
        border: 1px dashed var(--card-border);
        border-radius: 12px;
        padding: 0.75rem;
        background: var(--surface);
      }
      .admin-org-meta-item small {
        display: block;
        color: var(--muted);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .admin-org-meta-item strong {
        font-size: 1rem;
        color: var(--text-900);
        word-break: break-all;
      }
      .admin-org-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
      }
      .admin-org-stats-item {
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 0.75rem;
        background: rgba(81, 124, 178, 0.05);
      }
      :root[data-theme='dark'] .admin-org-stats-item {
        background: rgba(122, 162, 255, 0.08);
      }
      .admin-org-stats-item small {
        display: block;
        color: var(--muted);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.04em;
      }
      .admin-org-stats-item strong {
        font-size: 1.4rem;
        color: var(--text-900);
      }
      .admin-org-color-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .admin-org-color-chip span {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        display: inline-block;
        background: #517cb2;
      }
      .admin-placeholder-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      .admin-placeholder-table th,
      .admin-placeholder-table td {
        padding: 10px 8px;
        border-bottom: 1px solid var(--divider);
        text-align: left;
      }
      .admin-placeholder {
        padding: 16px;
        border-radius: 16px;
        background: rgba(81, 124, 178, 0.1);
        color: var(--muted);
        font-size: 0.9rem;
      }
      :root[data-theme='dark'] .admin-placeholder {
        background: rgba(122, 162, 255, 0.12);
        color: #cbd5ff;
      }
      .admin-filter-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
      }
      .admin-filter-item .form-label {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .admin-users-table {
        width: 100%;
        border-collapse: collapse;
      }
      .admin-users-table th,
      .admin-users-table td {
        vertical-align: middle;
        white-space: nowrap;
      }
      .admin-user-cell {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 220px;
      }
      .admin-user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 20px;
        object-fit: cover;
        border: 1px solid var(--card-border);
      }
      .admin-users-summary {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin: 12px 0;
      }
      .admin-users-summary-item {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 10px 16px;
        box-shadow: var(--card-shadow);
        min-width: 120px;
      }
      .admin-users-summary-item strong {
        display: block;
        font-size: 1.15rem;
      }
      .admin-table-light,
      .admin-table-light th,
      .admin-table-light td {
        background-color: #ffffff !important;
        color: #0f172a !important;
      }
      :root[data-theme='dark'] .admin-table-light,
      :root[data-theme='dark'] .admin-table-light th,
      :root[data-theme='dark'] .admin-table-light td {
        background-color: #f9fbff !important;
        color: #0f172a !important;
      }
      .admin-folder-table {
        width: 100%;
        border-collapse: collapse;
        background: transparent;
      }
      .admin-folder-table thead th {
        font-size: 0.85rem;
        letter-spacing: 0.02em;
        color: var(--muted);
        border-bottom: 1px solid var(--card-border);
        padding: 10px 8px;
        white-space: nowrap;
      }
      .admin-folder-table tbody td {
        padding: 12px 8px;
        vertical-align: middle;
        border-top: 1px solid var(--card-border);
      }
      .admin-folder-table tbody tr:hover td {
        background: rgba(81, 124, 178, 0.06);
      }
      :root[data-theme='dark'] .admin-folder-table tbody tr:hover td {
        background: rgba(122, 162, 255, 0.09);
      }
      .folder-name-cell {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .folder-color-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.48);
        box-shadow: 0 0 0 2px var(--card);
      }
      .folder-name-body strong {
        display: block;
        font-weight: 700;
      }
      .folder-meta-badges {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 2px;
      }
      .folder-state-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.78rem;
        border: 1px solid var(--card-border);
        color: var(--muted);
        background: rgba(15, 23, 42, 0.03);
      }
      :root[data-theme='dark'] .folder-state-badge {
        background: rgba(255, 255, 255, 0.05);
        color: #dbe4ff;
      }
      .folder-state-badge.is-system {
        border-color: rgba(81, 124, 178, 0.45);
        color: var(--primary);
        background: rgba(81, 124, 178, 0.08);
      }
      .folder-state-badge.is-inactive {
        border-color: rgba(148, 163, 184, 0.6);
        color: #64748b;
        background: rgba(148, 163, 184, 0.12);
      }
      :root[data-theme='dark'] .folder-state-badge.is-inactive {
        color: #cbd5e1;
      }
      .folder-visibility-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 10px;
        background: rgba(81, 124, 178, 0.08);
        color: var(--primary);
        font-weight: 600;
        border: 1px solid rgba(81, 124, 178, 0.22);
        white-space: nowrap;
      }
      .folder-visibility-chip.is-private {
        background: rgba(255, 193, 7, 0.12);
        color: #c77b00;
        border-color: rgba(255, 193, 7, 0.32);
      }
      :root[data-theme='dark'] .folder-visibility-chip.is-private {
        color: #ffd166;
      }
      .folder-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 44px;
        padding: 6px 10px;
        border-radius: 10px;
        background: rgba(148, 163, 184, 0.12);
        color: var(--text-900);
        font-weight: 700;
      }
      :root[data-theme='dark'] .folder-pill {
        color: #e6ecff;
        background: rgba(148, 163, 184, 0.24);
      }
      .folder-updated {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--muted);
        font-size: 0.92rem;
      }
      .admin-role-label {
        font-weight: 600;
        color: #0f172a !important;
        text-transform: capitalize;
      }
      :root[data-theme='dark'] .admin-role-label {
        color: #0f172a !important;
      }
      .admin-dashboard-kpi-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }
      .admin-dashboard-kpi {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 16px 20px;
        box-shadow: var(--card-shadow);
      }
      .admin-dashboard-kpi-label {
        margin-bottom: 4px;
        color: var(--muted);
        font-size: 0.9rem;
      }
      .admin-dashboard-kpi-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-900);
      }
      .admin-dashboard-kpi-meta {
        font-size: 0.85rem;
        color: var(--muted);
        margin-top: 6px;
      }
      .admin-dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
      }
      .admin-dashboard-card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 16px;
        box-shadow: var(--card-shadow);
        min-height: 220px;
      }
      .admin-dashboard-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .admin-dashboard-list li {
        padding: 12px 0;
        border-bottom: 1px solid var(--divider);
      }
      .admin-dashboard-list li:last-child {
        border-bottom: none;
      }
      .admin-dashboard-list .title {
        font-weight: 600;
        color: var(--text-900);
      }
      .admin-dashboard-list .meta {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .admin-dashboard-empty {
        text-align: center;
        color: var(--muted);
        padding: 20px 0;
        font-size: 0.9rem;
      }
      .admin-users-loading {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        color: var(--muted);
      }
      .admin-filter-actions {
        align-self: flex-end;
      }
      .admin-bottom-meta {
        margin-top: 20px;
      }
      .admin-shell .container-xl {
        max-width: 1760px;
        width: 100%;
      }

      .modal-content {
        background: var(--card);
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
        color: var(--text-900);
      }
      .modal-header,
      .modal-footer {
        background: var(--card);
        border-color: var(--divider);
      }
      .modal-backdrop.show {
        opacity: 1;
        background: rgba(5, 10, 20, 0.6);
      }
      :root[data-theme='light'] .modal-backdrop.show {
        background: rgba(15, 23, 42, 0.35);
      }

      .form-label,
      .modal-title {
        color: var(--text-900);
      }
      .form-control,
      .form-select,
      textarea.form-control {
        background: var(--input-bg);
        border-color: var(--input-border);
        color: var(--text-900);
      }
      .form-control:focus,
      .form-select:focus,
      textarea.form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem var(--focus-ring);
      }
      .form-control::placeholder,
      textarea.form-control::placeholder {
        color: var(--muted);
      }
      .form-control:disabled,
      .form-select:disabled {
        opacity: 0.8;
      }
      .form-control-plaintext {
        color: var(--muted);
      }

      .btn-outline-primary {
        color: var(--primary);
        border-color: var(--primary);
      }
      .btn-outline-primary:hover,
      .btn-outline-primary:focus {
        background: var(--primary);
        color: var(--on-primary);
      }
      [data-theme='dark'] .btn-secondary {
        background: rgba(148, 163, 184, 0.18);
        border-color: rgba(148, 163, 184, 0.35);
        color: var(--text-900);
      }
      [data-theme='dark'] .btn-secondary:hover,
      [data-theme='dark'] .btn-secondary:focus {
        background: rgba(148, 163, 184, 0.28);
        border-color: rgba(148, 163, 184, 0.48);
      }

      /* 認証ゲート（削除） */
      .text-truncate-container {
        min-width: 0;
      }
      .auth-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(24px, 5vw, 64px);
        background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.26), transparent 55%),
          radial-gradient(circle at bottom left, rgba(14, 165, 233, 0.18), transparent 45%),
          linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.75));
        backdrop-filter: blur(16px);
        z-index: 3000;
      }
      .auth-overlay.d-none {
        display: none !important;
      }
      .auth-shell {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: min(640px, 90vh);
        padding: clamp(16px, 4vw, 40px);
      }
      .auth-card {
        width: min(360px, 100%);
        margin: 0 auto;
        background: rgba(15, 23, 42, 0.92);
        border-radius: 24px;
        padding: clamp(28px, 4vw, 40px);
        box-shadow: 0 28px 72px rgba(2, 6, 23, 0.55);
        display: flex;
        flex-direction: column;
        gap: 20px;
        backdrop-filter: blur(12px);
      }
      .auth-card__title {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 600;
        color: #f8fafc;
        text-align: center;
      }
      .auth-card__subtitle {
        margin: 0;
        font-size: 0.96rem;
        color: rgba(226, 232, 240, 0.75);
        text-align: center;
        line-height: 1.6;
      }
      .auth-card__version {
        margin: 0;
        font-size: 0.78rem;
        color: rgba(226, 232, 240, 0.55);
        text-align: center;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      .auth-card__hint {
        font-size: 0.82rem;
        color: rgba(226, 232, 240, 0.6);
        text-align: center;
        line-height: 1.6;
      }
      .auth-card__actions {
        display: grid;
        gap: 12px;
      }

      .auth-session {
        display: none;
        align-items: center;
        gap: 16px;
      }
      .auth-session.is-visible {
        display: flex;
      }
      .auth-session__avatar {
        width: 52px;
        height: 52px;
        border-radius: 18px;
        object-fit: cover;
        background: rgba(148, 163, 184, 0.25);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .auth-session__meta {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .auth-session__name {
        font-weight: 600;
        font-size: 1rem;
      }
      .auth-session__email {
        font-size: 0.9rem;
        color: rgba(226, 232, 240, 0.7);
      }
      .auth-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        width: 100%;
        border-radius: 16px;
        padding: 14px 18px;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      .auth-button .material-icons,
      .auth-button .material-icons-outlined {
        font-size: 1.3rem;
      }
      .auth-button--primary {
        background: linear-gradient(135deg, #2563eb, #38bdf8);
        color: #f8fafc;
        box-shadow: 0 18px 36px rgba(37, 99, 235, 0.35);
      }
      .auth-button--primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 20px 45px rgba(37, 99, 235, 0.4);
      }
      .auth-button--secondary {
        background: rgba(148, 163, 184, 0.15);
        color: #e2e8f0;
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      .auth-button--secondary:hover {
        transform: translateY(-1px);
        border-color: rgba(148, 163, 184, 0.38);
      }
      .auth-button--ghost {
        background: transparent;
        color: rgba(226, 232, 240, 0.85);
        border: 1px dashed rgba(226, 232, 240, 0.45);
      }
      .auth-button--ghost:hover,
      .auth-button--ghost:focus {
        color: #fff;
        border-color: rgba(255, 255, 255, 0.85);
        background: rgba(148, 163, 184, 0.12);
      }
      .auth-meta {
        display: none;
      }
      .auth-meta strong {
        color: #f8fafc;
      }
      .auth-error {
        display: none;
        font-size: 0.88rem;
        line-height: 1.6;
        color: #fff8eb;
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.28), rgba(217, 119, 6, 0.28));
        border: 1px solid rgba(251, 191, 36, 0.7);
        border-radius: 14px;
        padding: 12px 16px;
        box-shadow: 0 12px 28px rgba(217, 119, 6, 0.35), inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }
      .auth-error.is-visible {
        display: block;
      }
      .auth-request-id {
        margin-top: 10px;
        padding: 10px 14px;
        border-radius: 14px;
        font-size: 0.9rem;
        background: rgba(15, 23, 42, 0.05);
        color: #0f172a;
      }
      .auth-request-id__label {
        font-weight: 600;
        margin-right: 8px;
      }
      .auth-request-id__hint {
        display: block;
        margin-top: 4px;
        font-size: 0.8rem;
        color: rgba(15, 23, 42, 0.6);
      }
      :root[data-theme='dark'] .auth-request-id {
        background: rgba(226, 232, 240, 0.08);
        color: rgba(248, 250, 252, 0.94);
      }
      :root[data-theme='dark'] .auth-request-id__hint {
        color: rgba(226, 232, 240, 0.7);
      }
      @media (max-width: 920px) {
        .auth-shell {
          min-height: auto;
          padding: 24px;
        }
      }
      #notification-area {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        width: 92%;
        max-width: 520px;
      }
      #notification-area.is-centered {
        top: 50%;
        transform: translate(-50%, -50%);
      }
      body.bootstrapping header.navbar,
      body.bootstrapping nav.topbar,
      body.bootstrapping .footer-nav,
      body.bootstrapping main.page-body,
      body.bootstrapping .fab,
      body.bootstrapping #notification-area {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .auth-backdrop {
        position: fixed;
        inset: 0;
        background: var(--body-bg);
        background-color: var(--surface);
        background-repeat: no-repeat;
        background-size: cover;
        background-attachment: fixed;
        z-index: 1500;
        pointer-events: none;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
      }
      :root[data-theme='dark'] .auth-backdrop {
        background: var(--body-bg);
        background-color: var(--surface);
      }
      body.auth-screen .auth-backdrop {
        opacity: 1;
        visibility: visible;
      }
      body.auth-screen {
        overflow: hidden;
      }
      body.auth-screen [data-app-shell] {
        opacity: 0;
        pointer-events: none !important;
        visibility: hidden;
      }
      body.auth-screen .bootstrap-loading {
        display: none !important;
      }
      .bootstrap-loading {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: rgba(10, 18, 40, 0.55);
        backdrop-filter: blur(8px);
        z-index: 2500;
      }
      body.bootstrapping .bootstrap-loading {
        display: flex;
      }
      .bootstrap-loading__card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 20px;
        padding: 32px 28px;
        box-shadow: 0 28px 60px rgba(15, 23, 42, 0.32);
        text-align: center;
        max-width: 320px;
        width: 100%;
      }
      :root[data-theme='dark'] .bootstrap-loading__card {
        background: rgba(9, 17, 35, 0.9);
        box-shadow: 0 28px 60px rgba(2, 8, 20, 0.6);
      }
      .bootstrap-loading__card .spinner-border {
        width: 3rem;
        height: 3rem;
        margin-bottom: 18px;
      }
      .bootstrap-loading__text {
        margin: 0;
        font-weight: 600;
        color: var(--text-900);
      }
    </style>
  </head>
  <body class="auth-screen">
    <!-- ===== Inline SVG sprite for reusable icons ===== -->
    <svg width="0" height="0" style="position: absolute">
      <symbol id="plane" viewBox="0 0 24 24">
        <path
          d="M2.2 11.2L20.6 2.6c.9-.4 1.8.6 1.3 1.5l-6.3 11.6c-.2.4-.7.6-1.1.5l-4.1-1.1a.8.8 0 0 1-.2-1.5l6.7-4.3-8.2 3.5c-.2.1-.5.1-.7-.1L2 12.3c-.6-.4-.5-1.2.2-1.6zM9.6 14.6l-.6 5a.8.8 0 0 0 1.3.7l3.9-3.4-4.6-1.3z"
        />
      </symbol>
    </svg>
    <!-- ===== Authentication backdrop and overlay ===== -->
    <div id="auth-backdrop" class="auth-backdrop" aria-hidden="true"></div>
    <div id="auth-overlay" class="auth-overlay d-none" aria-hidden="true">
      <div class="auth-shell">
        <section class="auth-card">
          <div id="auth-session" class="auth-session">
            <img id="auth-session-avatar" class="auth-session__avatar" alt="プロフィール" />
            <div class="auth-session__meta">
              <span id="auth-session-name" class="auth-session__name"></span>
              <span id="auth-session-email" class="auth-session__email"></span>
            </div>
          </div>
          <h1 class="auth-card__title">サインイン</h1>
          <p class="auth-card__subtitle">Google アカウントで認証します。</p>
          <p class="auth-card__version" id="authVersionText" aria-live="polite"></p>
          <div class="auth-error" id="auth-error"></div>
          <div class="auth-request-id" id="auth-request-id" hidden>
            <span class="auth-request-id__label">エラー ID:</span>
            <code id="auth-request-id-value">—</code>
            <span class="auth-request-id__hint"
              >問題が続く場合は管理者にこの ID を共有してください。</span
            >
          </div>
          <div class="auth-card__actions">
            <button id="btn-auth-google" class="auth-button auth-button--primary" type="button">
              <span class="material-icons">login</span>
              <span>Google でログイン</span>
            </button>
            <button
              id="btn-auth-logout"
              class="auth-button auth-button--secondary d-none"
              type="button"
            >
              <span class="material-icons-outlined">logout</span>
              <span>サインアウト</span>
            </button>
            <button id="btn-auth-demo" class="auth-button auth-button--ghost" type="button">
              <span class="material-icons-outlined">play_circle</span>
              <span>テストログイン</span>
            </button>
          </div>
        </section>
      </div>
    </div>

    <!-- COMPONENT: 通知エリア（トースト表示） -->
    <div id="notification-area" data-app-shell hidden></div>
    <!-- /COMPONENT: 通知エリア -->

    <!-- ===== Pull-to-refresh indicator ===== -->
    <div
      class="pull-to-refresh"
      id="pullToRefresh"
      role="status"
      aria-hidden="true"
      data-app-shell
      hidden
    >
      <span class="material-icons pull-to-refresh__icon" id="pullToRefreshIcon" aria-hidden="true"
        >expand_more</span
      >
      <span class="pull-to-refresh__text" id="pullToRefreshText">下に引っ張って更新</span>
    </div>

    <!-- ===== Initial bootstrap loading mask ===== -->
    <div id="bootstrap-loading" class="bootstrap-loading" aria-hidden="true" data-app-shell hidden>
      <div class="bootstrap-loading__card" role="status" aria-live="polite">
        <div class="spinner-border text-primary" role="presentation"></div>
        <p class="bootstrap-loading__text">読み込み中…</p>
      </div>
    </div>

    <!-- ===== Static PWA preview shell (hidden until UI integration) ===== -->
    <!-- TODO: 既存UIと統合 -->
    <section
      class="pwa-preview-shell"
      aria-label="ShiftFlow モバイルプレビュー"
      data-app-shell
      hidden
    >
      <header class="pwa-header" aria-label="アプリ共通ヘッダー">
        <div class="pwa-header__title">ShiftFlow</div>
        <button
          type="button"
          class="pwa-header__sync"
          id="pwaSyncPreview"
          aria-label="最新情報を同期"
        >
          <span class="material-icons-outlined" aria-hidden="true">sync</span>
        </button>
      </header>
      <main class="pwa-main" aria-label="ホームカード">
        <article class="pwa-card" aria-labelledby="pwa-card-title">
          <h2 id="pwa-card-title" class="h5 mb-2">今日のタスク</h2>
          <p class="pwa-card__meta">進行中のタスクや共有メモの更新状況がここに表示されます。</p>
          <ul class="pwa-list" aria-label="ダミータスクリスト">
            <li>
              <span class="pwa-list__dot" aria-hidden="true"></span>
              朝礼メモを確認し、チームに共有する
            </li>
            <li>
              <span class="pwa-list__dot" aria-hidden="true"></span>
              交代スタッフの引き継ぎ事項をチェック
            </li>
            <li>
              <span class="pwa-list__dot" aria-hidden="true"></span>
              ヒヤリハットの報告をレビュー
            </li>
          </ul>
        </article>
      </main>
      <footer class="pwa-footer" aria-label="アプリ共通フッター">
        <nav class="pwa-footer__nav" aria-label="メインナビゲーション">
          <button
            type="button"
            class="pwa-footer__button pwa-footer__button--active"
            aria-label="ホーム"
          >
            <span class="material-icons-outlined" aria-hidden="true">home</span>
            <span>ホーム</span>
          </button>
          <button type="button" class="pwa-footer__button" aria-label="タスク">
            <span class="material-icons-outlined" aria-hidden="true">checklist</span>
            <span>タスク</span>
          </button>
          <button type="button" class="pwa-footer__button" aria-label="メッセージ">
            <span class="material-icons-outlined" aria-hidden="true">mail</span>
            <span>メッセ</span>
          </button>
          <button
            type="button"
            class="pwa-footer__button d-none"
            data-admin-target="dashboard"
            data-manager-only
            aria-label="管理"
          >
            <span class="material-icons-outlined" aria-hidden="true">shield</span>
            <span>管理</span>
          </button>
          <button
            type="button"
            class="pwa-footer__button is-disabled"
            id="btn-mobile-logout"
            aria-label="ログアウト"
            disabled
          >
            <span class="material-icons-outlined" aria-hidden="true">logout</span>
            <span>ログアウト</span>
          </button>
        </nav>
      </footer>
    </section>

    <!-- SECTION: ヘッダー（ブランド・ユーザーメニュー） -->
    <header class="navbar navbar-expand-md d-print-none" data-app-shell hidden>
      <div class="container-xl">
        <a href="#" class="navbar-brand app-brand" data-view="home" title="" data-bind-user-email>
          <span class="brand-mark">
            <span class="brand-ring"></span>
            <img src="/icons/icon-192.png" alt="ShiftFlow" class="brand-icon" />
          </span>
          <span class="brand-title">
            <span class="brand-text-main">ShiftFlow</span>
          </span>
        </a>
        <div class="navbar-nav ms-auto flex-row align-items-center gap-2 order-md-last">
          <div class="dropdown user-menu-dropdown">
            <button
              type="button"
              class="user-menu-trigger d-flex align-items-center gap-2"
              id="btn-user-menu"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              aria-haspopup="true"
            >
              <img
                src="/icons/icon-192.png"
                class="avatar avatar-sm js-user-avatar user-menu-avatar"
                data-avatar-url="/icons/icon-192.png"
                data-bind-user-avatar
                alt="ユーザー"
              />
              <span class="d-none d-xl-inline-flex flex-column text-start lh-1">
                <strong class="user-menu-name" data-bind-user-name>ゲストユーザー</strong>
                <small class="opacity-75">ログイン中</small>
              </span>
              <span class="material-icons-outlined">expand_more</span>
            </button>
            <div
              class="dropdown-menu dropdown-menu-end user-menu shadow"
              aria-labelledby="btn-user-menu"
            >
              <div class="user-menu-meta">
                <strong data-bind-user-name>ゲストユーザー</strong>
                <small class="d-block text-muted" data-bind-user-email>guest@example.com</small>
              </div>
              <div class="dropdown-divider"></div>
              <button
                class="dropdown-item d-flex align-items-center gap-2"
                type="button"
                data-user-menu="admin"
                data-manager-only
              >
                <span class="material-icons-outlined">admin_panel_settings</span>
                管理メニュー
              </button>
              <button
                class="dropdown-item d-flex align-items-center gap-2 d-none"
                type="button"
                data-user-menu="admin-demo"
                id="btn-user-menu-admin-demo"
                hidden
              >
                <span class="material-icons-outlined">shield</span>
                管理者テストに切替
              </button>
              <button
                class="dropdown-item d-flex align-items-center gap-2"
                type="button"
                data-user-menu="settings"
              >
                <span class="material-icons-outlined">settings</span>
                <span data-i18n="user_menu_profile">ユーザー設定</span>
              </button>
              <button
                class="dropdown-item d-flex align-items-center gap-2"
                type="button"
                data-user-menu="logout"
              >
                <span class="material-icons-outlined">logout</span>
                <span data-i18n="user_menu_logout">サインアウト</span>
              </button>
              <div class="dropdown-divider"></div>
              <div class="px-3 py-2">
                <small
                  class="text-muted d-block mt-1"
                  data-app-version-label
                  title="現在のアプリバージョン: dev"
                  style="font-size: 0.75rem; font-weight: 700; opacity: 0.8"
                  >v. dev</small
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <!-- /SECTION: ヘッダー -->

    <div class="app-shell-grid" data-app-shell hidden>
      <!-- SECTION: サイドバー（デスクトップ ビュー切替ナビゲーション） -->
      <nav class="navbar navbar-expand-md topbar d-none d-md-block" data-app-shell hidden>
        <div class="container-xl">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-view="home" title="Home">
                <span class="material-icons-outlined" aria-hidden="true">home</span>
                <span class="nav-label" data-i18n="nav_home">ホーム</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link nav-icon" href="#" data-view="tasks" title="Tasks">
                <span class="material-icons-outlined" aria-hidden="true">send</span>
                <span class="nav-label" data-i18n="nav_tasks">タスク</span>
                <span
                  class="badge badge-overdue nav-icon-badge d-none"
                  id="badge-task-overdue-top"
                  aria-label="期限超過件数"
                  >0</span
                >
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link nav-icon" href="#" data-view="messages" title="Messages">
                <span class="material-icons-outlined" aria-hidden="true">mail</span>
                <span class="nav-label" data-i18n="nav_messages">メッセージ</span>
                <span
                  class="badge badge-unread nav-icon-badge d-none"
                  id="badge-unread-top"
                  aria-label="未読件数"
                  >0</span
                >
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-view="settings" title="Settings">
                <span class="material-icons-outlined" aria-hidden="true">settings</span>
                <span class="nav-label" data-i18n="nav_settings">設定</span>
              </a>
            </li>
            <li class="nav-item d-none" data-manager-only>
              <a class="nav-link nav-icon" href="#" data-admin-target="dashboard" title="Admin">
                <span class="material-icons-outlined" aria-hidden="true">shield</span>
                <span class="nav-label">管理</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>
      <!-- /SECTION: サイドバー（デスクトップ） -->

      <!-- 認証ゲート（ログイン画面）はGASが自動で表示するため、HTMLからは削除 -->

      <!-- ===== Main application view panels ===== -->
      <main class="page-body" data-app-shell hidden>
        <div class="views-wrapper container-xl" id="viewsWrapper">
          <div class="views-track" id="viewsTrack">
            <!-- ----- Home view panel ----- -->
            <section class="view-panel fade-container show" id="view-home">
              <section class="home-hero" aria-label="ホームのハイライト">
                <div class="home-hero__grid">
                  <div class="home-hero__intro">
                    <h2 class="home-hero__title">
                      <span data-bind-user-name>ゲストユーザー</span>
                      <span data-i18n="home_welcome_suffix">さん、おかえりなさい。</span>
                    </h2>
                    <div class="home-hero__actions">
                      <button
                        class="home-hero__action home-hero__action--primary"
                        type="button"
                        data-view="tasks"
                      >
                        <span class="material-icons" aria-hidden="true">checklist</span>
                        <span data-i18n="home_action_open_tasks">タスクを開く</span>
                      </button>
                      <button class="home-hero__action" type="button" id="home-quick-new-task">
                        <span class="material-icons-outlined" aria-hidden="true">add_task</span>
                        <span data-i18n="home_action_new_task">新規タスク</span>
                      </button>
                      <button class="home-hero__action" type="button" id="home-quick-new-msg">
                        <span class="material-icons-outlined" aria-hidden="true">mail</span>
                        <span data-i18n="home_action_new_message">新規メッセージ</span>
                      </button>
                    </div>
                  </div>
                  <div class="home-hero__stats" aria-live="polite">
                    <div class="home-stat-card">
                      <p class="home-stat-card__label" data-i18n="home_stat_today_label">
                        今日のタスク
                      </p>
                      <div class="home-stat-card__value">
                        <span id="home-stat-today">0</span><small data-i18n="unit_items">件</small>
                      </div>
                      <p class="home-stat-card__hint" data-i18n="home_stat_today_hint">
                        直近のカードがここに並びます
                      </p>
                    </div>
                    <div class="home-stat-card">
                      <p class="home-stat-card__label" data-i18n="home_stat_unread_label">未読</p>
                      <div class="home-stat-card__value">
                        <span id="home-stat-unread">0</span><small data-i18n="unit_items">件</small>
                      </div>
                      <p class="home-stat-card__hint" data-i18n="home_stat_unread_hint">
                        未読メッセージの合計
                      </p>
                    </div>
                    <div class="home-stat-card">
                      <p class="home-stat-card__label" data-i18n="home_stat_overdue_label">
                        期限超過リスク
                      </p>
                      <div class="home-stat-card__value">
                        <span id="home-stat-overdue">0</span
                        ><small data-i18n="unit_items">件</small>
                      </div>
                      <p class="home-stat-card__hint" data-i18n="home_stat_overdue_hint">
                        今日時点での見逃せない件数
                      </p>
                    </div>
                  </div>
                </div>
              </section>

              <div class="home-panel-grid">
                <article class="home-panel">
                  <div class="home-panel__head">
                    <div class="section-head">
                      <span class="section-head-icon material-icons-outlined" aria-hidden="true"
                        >calendar_month</span
                      >
                      <h3 class="m-0" data-i18n="home_recent_tasks_title">直近のタスク</h3>
                    </div>
                    <a href="#" class="link-soft" data-view="tasks">
                      <span class="material-icons-outlined" aria-hidden="true">open_in_new</span>
                      <span data-i18n="link_view_all">一覧へ</span>
                    </a>
                  </div>
                  <!-- Mount point for the "today's tasks" card list -->
                  <div id="home-today-tasks" class="mt-2"></div>
                </article>

                <article class="home-panel">
                  <div class="home-panel__head">
                    <div class="section-head">
                      <span class="section-head-icon material-icons-outlined" aria-hidden="true"
                        >mark_email_unread</span
                      >
                      <h3 class="m-0" data-i18n="home_recent_messages_title">新着メッセージ</h3>
                    </div>
                    <a href="#" class="link-soft" data-view="messages">
                      <span class="material-icons-outlined" aria-hidden="true">open_in_new</span>
                      <span data-i18n="link_view_all">一覧へ</span>
                    </a>
                  </div>
                  <!-- Mount point for unread message cards -->
                  <div id="home-unread" class="mt-2"></div>
                </article>
              </div>
            </section>

            <!-- COMPONENT: シフト一覧（タスク表示パネル） -->
            <section class="view-panel fade-container is-hidden" id="view-tasks">
              <div class="task-header mt-0">
                <div class="task-title-wrap">
                  <span class="material-icons-outlined task-title-icon">send</span>
                  <h3 class="view-title" data-i18n="nav_tasks">タスク</h3>
                </div>
                <button
                  class="btn btn-outline-primary d-flex align-items-center gap-1"
                  id="task-reload"
                  type="button"
                >
                  <span class="material-icons align-middle">refresh</span>
                  <span data-i18n="btn_reload">再読込</span>
                </button>
              </div>

              <div class="task-tabs" id="taskTabs">
                <button class="task-tab-btn active" data-task-tab="my" type="button">
                  <span data-i18n="task_tab_my">あなたのタスク</span>
                </button>
                <button class="task-tab-btn" data-task-tab="from" type="button">
                  <span data-i18n="task_tab_created">依頼したタスク</span>
                </button>
                <button
                  class="task-tab-btn d-none"
                  data-task-tab="all"
                  data-manager-only="true"
                  type="button"
                >
                  <span class="material-icons-outlined">admin_panel_settings</span>
                  <span data-i18n="task_tab_all">全タスク</span>
                </button>
              </div>

              <div class="task-panels">
                <div class="task-panel active" data-task-panel="my">
                  <div class="task-controls">
                    <div class="task-search">
                      <span class="material-icons-outlined">search</span>
                      <input
                        type="search"
                        id="task-search-my"
                        placeholder="キーワード検索"
                        aria-label="自分のタスクを検索"
                        data-i18n="placeholder_keyword_search"
                      />
                    </div>
                  </div>
                  <!-- Results container for "My Tasks" -->
                  <div class="task-list mt-3" id="task-list-my"></div>
                </div>

                <div class="task-panel" data-task-panel="from">
                  <div class="task-controls">
                    <div class="task-search">
                      <span class="material-icons-outlined">search</span>
                      <input
                        type="search"
                        id="task-search-from"
                        placeholder="キーワード検索"
                        aria-label="自分が依頼したタスクを検索"
                        data-i18n="placeholder_keyword_search"
                      />
                    </div>
                    <div class="task-filter-row">
                      <select class="task-filter-select" id="task-filter-from-assignee">
                        <option value="" data-i18n="task_filter_assignee">担当者で絞り込み</option>
                      </select>
                    </div>
                  </div>
                  <!-- Results container for "From Me" tasks -->
                  <div class="task-list mt-3" id="task-list-from"></div>
                </div>

                <div class="task-panel d-none" data-task-panel="all" data-manager-only="true">
                  <div class="task-controls">
                    <div class="task-search">
                      <span class="material-icons-outlined">search</span>
                      <input
                        type="search"
                        id="task-search-all"
                        placeholder="キーワード検索"
                        aria-label="すべてのタスクを検索"
                        data-i18n="placeholder_keyword_search"
                      />
                    </div>
                    <div class="task-filter-row">
                      <select class="task-filter-select" id="task-filter-all-assignee">
                        <option value="" data-i18n="task_filter_assignee">担当者で絞り込み</option>
                      </select>
                    </div>
                  </div>
                  <!-- Results container for "All Tasks" (manager only) -->
                  <div class="task-list mt-3" id="task-list-all"></div>
                </div>
              </div>
            </section>
            <!-- /COMPONENT: シフト一覧 -->

            <!-- ----- Messages view panel ----- -->
            <section class="view-panel fade-container is-hidden" id="view-messages">
              <div class="task-header mt-0">
                <div class="task-title-wrap">
                  <span class="material-icons-outlined task-title-icon">mail</span>
                  <h3 class="view-title" data-i18n="nav_messages">メッセージ</h3>
                </div>
              </div>
              <div class="subhead-bar mt-2">
                <div class="input-group">
                  <span class="input-group-text material-icons-outlined">search</span>
                  <input
                    type="text"
                    class="form-control"
                    id="msg-search-box"
                    placeholder="キーワード検索"
                    data-i18n="placeholder_keyword_search"
                  />
                </div>
              </div>
              <div class="row g-2 align-items-end mt-2">
                <div class="col-auto">
                  <label class="form-label" data-i18n="messages_filter_folder">フォルダ</label>
                  <select id="flt-msg-folder" class="form-select" data-folder-select="filter">
                    <option value="" data-i18n="filter_all">全て</option>
                  </select>
                </div>
                <div class="col-auto">
                  <label class="form-label d-block">&nbsp;</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="flt-msg-unread" />
                    <label
                      class="form-check-label"
                      for="flt-msg-unread"
                      data-i18n="messages_filter_unread_only"
                      >未読のみ</label
                    >
                  </div>
                </div>
                <div class="col-auto">
                  <label class="form-label d-block">&nbsp;</label>
                  <button
                    class="btn btn-outline-success"
                    id="btn-msg-markall"
                    type="button"
                    aria-label="未読をすべて既読にする"
                  >
                    <span class="material-icons align-middle me-1">done_all</span>
                    <span data-i18n="messages_mark_all_read">全て既読にする</span>
                  </button>
                </div>
              </div>
              <!-- Message card list mount point -->
              <div id="msg-list" class="mt-2"></div>
            </section>

            <!-- ----- Settings view panel ----- -->
            <section class="view-panel fade-container is-hidden" id="view-settings">
              <h3 class="mt-0">
                <span class="material-icons align-middle me-1">settings</span>
                <span data-i18n="nav_settings">設定</span>
              </h3>
              <!-- Settings form wrapper (profile, appearance, etc.) -->
              <form class="settings-layout" id="form-settings">
                <div class="form-section settings-block">
                  <div class="settings-block-header">
                    <div class="settings-block-icon">
                      <span class="material-icons-outlined">badge</span>
                    </div>
                    <div>
                      <h5 data-i18n="settings_profile_title">プロフィール</h5>
                      <p data-i18n="settings_profile_desc">
                        メンバーに表示される名前とプロフィール画像を管理します。
                      </p>
                    </div>
                  </div>
                  <div class="settings-profile-body">
                    <div class="settings-avatar-shell">
                      <img
                        class="settings-avatar js-user-avatar"
                        id="setting-avatar-preview"
                        src="/icons/icon-192.png"
                        data-avatar-url="/icons/icon-192.png"
                        data-placeholder="https://placehold.jp/150x150.png"
                        data-bind-user-avatar
                        alt="プロフィール画像のプレビュー"
                      />
                      <button
                        class="btn btn-outline-secondary w-100"
                        type="button"
                        id="btn-setting-image"
                      >
                        <span class="material-icons-outlined align-middle me-1">image</span>
                        <span data-i18n="settings_profile_choose_image">画像を選択</span>
                      </button>
                      <div
                        class="settings-image-meta"
                        id="setting-image-name"
                        data-i18n="settings_profile_image_empty"
                      >
                        未設定
                      </div>
                      <input
                        type="file"
                        accept="image/*"
                        class="d-none"
                        id="setting-image-file"
                        aria-label="プロフィール画像を選択"
                      />
                    </div>
                    <div>
                      <label
                        class="form-label"
                        for="setting-name"
                        data-i18n="settings_profile_display_name_label"
                        >表示名</label
                      >
                      <input
                        class="form-control"
                        id="setting-name"
                        placeholder="チームで表示される名前"
                        data-i18n="settings_profile_display_name_placeholder"
                      />
                      <div class="settings-upload-note">
                        <span class="material-icons-outlined align-middle">info</span>
                        <span data-i18n="settings_profile_image_note"
                          >最大8MBの画像ファイルがアップロードされ、ドライブに安全に保存されます。</span
                        >
                      </div>
                      <div class="mt-3">
                        <label
                          class="form-label"
                          for="setting-language"
                          data-i18n="settings_language_label"
                          >表示言語</label
                        >
                        <select class="form-select" id="setting-language">
                          <option value="ja" data-i18n="settings_language_option_ja">日本語</option>
                          <option value="en" data-i18n="settings_language_option_en">
                            English
                          </option>
                        </select>
                        <div class="settings-upload-note">
                          <span class="material-icons-outlined align-middle">translate</span>
                          <span data-i18n="settings_language_note"
                            >保存すると、次回以降もこの言語で表示されます。</span
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-section settings-block">
                  <div class="settings-block-header">
                    <div class="settings-block-icon">
                      <span class="material-icons-outlined">dark_mode</span>
                    </div>
                    <div>
                      <h5 data-i18n="settings_theme_title">外観設定</h5>
                      <p data-i18n="settings_theme_desc">
                        アプリの配色テーマを切り替えて見やすさを調整します。
                      </p>
                    </div>
                  </div>
                  <div class="settings-theme-grid">
                    <div>
                      <label class="form-label" for="setting-theme" data-i18n="settings_theme_label"
                        >テーマ</label
                      >
                      <select class="form-select" id="setting-theme">
                        <option value="light" data-i18n="settings_theme_option_light">
                          ライト
                        </option>
                        <option value="dark" data-i18n="settings_theme_option_dark">ダーク</option>
                        <option value="system" data-i18n="settings_theme_option_system">
                          システムに合わせる
                        </option>
                      </select>
                      <div class="theme-status" id="setting-theme-display">
                        <span class="material-icons-outlined align-middle">light_mode</span>
                        <span data-i18n="settings_theme_status_light">ライトテーマを適用中</span>
                      </div>
                    </div>
                    <div class="settings-theme-guide">
                      <p class="mb-2" data-i18n="settings_theme_guide_intro">
                        選択したテーマはすぐに反映されます。
                      </p>
                      <ul class="mb-0">
                        <li>
                          <strong data-i18n="settings_theme_option_light">ライト</strong>:
                          <span data-i18n="settings_theme_light_desc"
                            >明るく爽やかなトーンで日中の作業に最適。</span
                          >
                        </li>
                        <li>
                          <strong data-i18n="settings_theme_option_dark">ダーク</strong>:
                          <span data-i18n="settings_theme_dark_desc"
                            >暗い環境や長時間の閲覧で目を保護。</span
                          >
                        </li>
                        <li>
                          <strong data-i18n="settings_theme_option_system">システム</strong>:
                          <span data-i18n="settings_theme_system_desc"
                            >ご利用端末のテーマ設定に自動追従します。</span
                          >
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="settings-actions">
                  <button class="btn btn-primary" type="button" id="btn-settings-save">
                    <span class="label">
                      <span class="material-icons align-middle me-1">save</span>
                      <span data-i18n="btn_save_changes">変更を保存</span>
                    </span>
                    <span
                      class="spinner-border spinner-border-sm d-none"
                      role="status"
                      aria-hidden="true"
                    ></span>
                  </button>
                </div>
              </form>
            </section>
          </div>
        </div>
        <section class="admin-shell" id="view-admin" hidden aria-labelledby="adminViewTitle">
          <div class="container-xl">
            <div class="admin-top-actions">
              <button
                class="btn btn-outline-secondary btn-sm admin-exit-btn"
                type="button"
                id="btn-exit-admin"
              >
                <span class="material-icons-outlined align-middle me-1">arrow_back</span
                >一般画面へ戻る
              </button>
              <div class="dropdown admin-org-dropdown" id="adminOrgDropdown">
                <button
                  class="btn btn-sm btn-outline-light admin-org-trigger"
                  type="button"
                  id="btn-admin-org"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <span class="material-icons-outlined align-middle me-1">apartment</span>
                  <span id="adminOrgLabel">現在の組織</span>
                  <span class="material-icons-outlined ms-1">expand_more</span>
                </button>
                <div
                  class="dropdown-menu dropdown-menu-end admin-org-menu shadow"
                  aria-labelledby="btn-admin-org"
                >
                  <div class="admin-org-menu-header">
                    <strong>管理対象の組織</strong>
                  </div>
                  <div class="admin-org-list" id="adminOrgList">
                    <div class="px-3 py-2 text-muted small">読み込み中...</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="admin-view-title">
              <div class="admin-view-title-icon" aria-hidden="true">
                <span class="material-icons-outlined" id="adminSectionIcon">dashboard</span>
              </div>
              <div>
                <h2 class="admin-view-heading" id="admin-section-label">管理トップ</h2>
                <p class="admin-view-desc" id="admin-section-desc">
                  現在の状況を一覧で把握し、アクションにつなげます。
                </p>
              </div>
            </div>
            <div class="admin-panels-wrapper" id="adminPanelsWrapper">
              <div class="admin-track" id="adminTrack">
                <section
                  class="admin-panel is-active"
                  data-admin-panel="dashboard"
                  aria-labelledby="adminDashboardTitle"
                >
                  <div class="admin-panel-header">
                    <h3 id="adminDashboardTitle">管理トップ</h3>
                    <p>組織の承認状況と直近の操作ログをダッシュボードで把握します。</p>
                  </div>
                  <div class="admin-panel-body">
                    <div class="admin-placeholder" id="adminDashboardNotice" hidden></div>
                    <div class="admin-dashboard-kpi-grid">
                      <article class="admin-dashboard-kpi">
                        <p class="admin-dashboard-kpi-label">承認待ち</p>
                        <div class="admin-dashboard-kpi-value" id="adminDashboardPendingCount">
                          —
                        </div>
                        <div class="admin-dashboard-kpi-meta">
                          最終更新: <span id="adminDashboardKpiUpdated">—</span>
                        </div>
                      </article>
                      <article class="admin-dashboard-kpi">
                        <p class="admin-dashboard-kpi-label">有効ユーザー</p>
                        <div class="admin-dashboard-kpi-value" id="adminDashboardActiveCount">
                          —
                        </div>
                        <div class="admin-dashboard-kpi-meta">
                          停止中 <span id="adminDashboardSuspendedMeta">—</span>
                        </div>
                      </article>
                      <article class="admin-dashboard-kpi">
                        <p class="admin-dashboard-kpi-label">停止中 / 剥奪</p>
                        <div class="admin-dashboard-kpi-value" id="adminDashboardSuspendedCount">
                          —
                        </div>
                        <div class="admin-dashboard-kpi-meta">
                          差分を確認し、復帰判断に活用してください
                        </div>
                      </article>
                      <article class="admin-dashboard-kpi">
                        <p class="admin-dashboard-kpi-label">監査イベント (24h)</p>
                        <div class="admin-dashboard-kpi-value" id="adminDashboardAuditCount">—</div>
                        <div class="admin-dashboard-kpi-meta">
                          ダッシュボードは最新 5 件を表示します
                        </div>
                      </article>
                    </div>
                    <div class="admin-dashboard-grid">
                      <article class="admin-dashboard-card" aria-live="polite">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h4 class="mb-0">承認待ちユーザー</h4>
                          <button
                            class="btn btn-sm btn-outline-primary"
                            type="button"
                            data-admin-target="users"
                          >
                            一覧を見る
                          </button>
                        </div>
                        <p class="text-muted small mb-2">最新 5 件を表示しています。</p>
                        <ul class="admin-dashboard-list" id="adminDashboardPendingList">
                          <li class="admin-dashboard-empty">読み込み中...</li>
                        </ul>
                      </article>
                      <article class="admin-dashboard-card" aria-live="polite">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h4 class="mb-0">最近の操作ログ</h4>
                          <button
                            class="btn btn-sm btn-outline-secondary"
                            type="button"
                            data-admin-target="audit"
                          >
                            ログを見る
                          </button>
                        </div>
                        <p class="text-muted small mb-2">最新 5 件を表示しています。</p>
                        <ul class="admin-dashboard-list" id="adminDashboardAuditList">
                          <li class="admin-dashboard-empty">読み込み中...</li>
                        </ul>
                      </article>
                    </div>
                    <article class="admin-dashboard-card">
                      <h4 class="mb-2">管理メニュー</h4>
                      <p class="text-muted small">主要な管理機能へすぐに移動できます。</p>
                      <div class="list-group admin-menu-quick">
                        <button
                          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                          type="button"
                          data-admin-target="folders"
                        >
                          <span
                            ><span class="material-icons-outlined align-middle me-2"
                              >folder_shared</span
                            >フォルダ管理</span
                          >
                          <span class="material-icons-outlined text-muted">chevron_right</span>
                        </button>
                        <button
                          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                          type="button"
                          data-admin-target="folders"
                        >
                          <span
                            ><span class="material-icons-outlined align-middle me-2">note_alt</span
                            >定型文設定</span
                          >
                          <span class="material-icons-outlined text-muted">chevron_right</span>
                        </button>
                        <button
                          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                          type="button"
                          data-admin-target="users"
                        >
                          <span
                            ><span class="material-icons-outlined align-middle me-2"
                              >verified_user</span
                            >ユーザー承認・管理</span
                          >
                          <span class="material-icons-outlined text-muted">chevron_right</span>
                        </button>
                        <button
                          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                          type="button"
                          data-admin-target="audit"
                        >
                          <span
                            ><span class="material-icons-outlined align-middle me-2"
                              >fact_check</span
                            >監査ログ</span
                          >
                          <span class="material-icons-outlined text-muted">chevron_right</span>
                        </button>
                      </div>
                    </article>
                    <article class="admin-dashboard-card">
                      <h4 class="mb-3">システムメモ</h4>
                      <dl class="row small mb-0">
                        <dt class="col-4 col-md-3">対象組織</dt>
                        <dd class="col-8 col-md-9" id="adminDashboardOrgLabel">現在の組織</dd>
                        <dt class="col-4 col-md-3">組織 ID</dt>
                        <dd class="col-8 col-md-9" id="adminDashboardOrgId">—</dd>
                        <dt class="col-4 col-md-3">更新</dt>
                        <dd class="col-8 col-md-9" id="adminDashboardUpdatedAt">—</dd>
                      </dl>
                    </article>
                  </div>
                </section>
                <section
                  class="admin-panel"
                  data-admin-panel="users"
                  aria-labelledby="adminUsersTitle"
                >
                  <div class="admin-panel-header">
                    <h3 id="adminUsersTitle">ユーザー管理</h3>
                    <p>ステータス・ロール・組織を横断して管理します。</p>
                  </div>
                  <div class="admin-panel-body">
                    <div class="admin-filter-bar" id="adminUsersFilters">
                      <div class="admin-filter-item">
                        <label class="form-label" for="adminUsersSearch">キーワード</label>
                        <input
                          type="search"
                          class="form-control"
                          id="adminUsersSearch"
                          placeholder="名前・メールで検索"
                        />
                      </div>
                      <div class="admin-filter-item">
                        <label class="form-label" for="adminUsersStatus">ステータス</label>
                        <select class="form-select" id="adminUsersStatus">
                          <option value="">すべて</option>
                          <option value="pending">承認待ち</option>
                          <option value="active">有効</option>
                          <option value="suspended">停止中</option>
                          <option value="revoked">剥奪</option>
                        </select>
                      </div>
                      <div class="admin-filter-item">
                        <label class="form-label" for="adminUsersRole">ロール</label>
                        <select class="form-select" id="adminUsersRole">
                          <option value="">すべて</option>
                          <option value="admin">管理者</option>
                          <option value="manager">マネージャー</option>
                          <option value="member">一般</option>
                          <option value="guest">ゲスト</option>
                        </select>
                      </div>
                      <div class="admin-filter-item admin-filter-actions">
                        <label class="form-label d-none d-md-block">&nbsp;</label>
                        <button
                          class="btn btn-outline-secondary w-100"
                          type="button"
                          id="btnAdminUsersReload"
                        >
                          <span class="material-icons-outlined align-middle me-1">refresh</span
                          >再読込
                        </button>
                      </div>
                    </div>
                    <div class="admin-users-meta">
                      <div class="admin-users-summary" id="adminUsersSummary"></div>
                      <div class="small text-muted" id="adminUsersUpdatedAt"></div>
                    </div>
                    <div class="admin-placeholder" id="adminUsersNotice" hidden></div>
                    <div
                      class="table-responsive"
                      id="adminUsersTableWrap"
                      aria-live="polite"
                      data-prevent-admin-swipe="true"
                    >
                      <table class="table admin-users-table admin-table-light">
                        <thead>
                          <tr>
                            <th scope="col">ユーザー</th>
                            <th scope="col">メール</th>
                            <th scope="col">ロール</th>
                            <th scope="col">ステータス</th>
                            <th scope="col">最終ログイン</th>
                            <th scope="col" class="text-end">操作</th>
                          </tr>
                        </thead>
                        <tbody id="adminUsersTableBody">
                          <tr>
                            <td colspan="6">
                              <div class="admin-users-loading">
                                <span class="material-icons-outlined align-middle"
                                  >hourglass_top</span
                                >
                                読み込み中...
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="admin-placeholder text-center" id="adminUsersEmpty" hidden>
                      条件に一致するユーザーがいません。
                    </div>
                  </div>
                </section>
                <section
                  class="admin-panel"
                  data-admin-panel="folders"
                  aria-labelledby="adminFoldersTitle"
                >
                  <div class="admin-panel-header">
                    <h3 id="adminFoldersTitle">フォルダ管理</h3>
                    <p>公開設定や限定メンバー、定型文をまとめて管理します。</p>
                  </div>
                  <div class="admin-panel-body">
                    <article class="admin-card">
                      <div
                        class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2"
                      >
                        <div>
                          <h4 class="mb-1">フォルダ一覧</h4>
                          <p class="text-muted small mb-0">
                            名称・公開設定・メンバー数を確認します。
                          </p>
                        </div>
                        <div class="d-flex gap-2">
                          <button
                            class="btn btn-sm btn-outline-secondary"
                            type="button"
                            id="btnAdminFolderReload"
                          >
                            <span class="material-icons-outlined align-middle me-1">refresh</span
                            >再読込
                          </button>
                          <button
                            class="btn btn-sm btn-outline-primary"
                            type="button"
                            id="btnAdminNewFolder"
                            data-manager-only
                          >
                            <span class="material-icons-outlined align-middle me-1">add</span
                            >フォルダ作成
                          </button>
                        </div>
                      </div>
                      <div class="table-responsive" data-prevent-admin-swipe="true">
                        <table class="table table-sm align-middle admin-folder-table">
                          <thead>
                            <tr>
                              <th scope="col">名称</th>
                              <th scope="col">公開</th>
                              <th scope="col">メンバー数</th>
                              <th scope="col">更新</th>
                              <th scope="col" class="text-end">操作</th>
                            </tr>
                          </thead>
                          <tbody id="adminFolderList">
                            <tr>
                              <td colspan="5" class="text-muted">フォルダ情報を読み込み中...</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </article>
                    <article class="admin-card mt-3">
                      <div
                        class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2"
                      >
                        <div>
                          <h4 class="mb-1">定型文設定</h4>
                          <p class="text-muted small mb-0">
                            フォルダごとの件名・本文の雛形を管理します。
                          </p>
                        </div>
                        <div class="d-flex gap-2">
                          <button
                            class="btn btn-sm btn-outline-secondary"
                            type="button"
                            id="btnAdminTemplateReload"
                          >
                            <span class="material-icons-outlined align-middle me-1">refresh</span
                            >再読込
                          </button>
                        </div>
                      </div>
                      <div class="row g-3 align-items-end">
                        <div class="col-12 col-lg-4">
                          <label class="form-label" for="adminTemplateFolder">対象フォルダ</label>
                          <select class="form-select" id="adminTemplateFolder">
                            <option value="">フォルダを選択</option>
                          </select>
                          <div class="form-text">限定公開フォルダは管理者のみ表示されます。</div>
                        </div>
                        <div class="col-12 col-lg-8">
                          <form class="card border-0 shadow-sm h-100" id="adminTemplateForm">
                            <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">新規定型文</h6>
                                <span class="badge bg-light text-dark" id="adminTemplateFolderHint"
                                  >フォルダ未選択</span
                                >
                              </div>
                              <div class="alert alert-danger d-none" id="adminTemplateAlert"></div>
                              <div class="row g-3">
                                <div class="col-12 col-md-6">
                                  <label class="form-label" for="adminTemplateName">名称</label>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="adminTemplateName"
                                    placeholder="例: 早番共有"
                                  />
                                </div>
                                <div class="col-12 col-md-6">
                                  <label class="form-label" for="adminTemplateTitle"
                                    >件名雛形</label
                                  >
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="adminTemplateTitle"
                                    placeholder="例: 【共有】"
                                  />
                                </div>
                                <div class="col-12">
                                  <label class="form-label" for="adminTemplateBody">本文雛形</label>
                                  <textarea
                                    class="form-control"
                                    id="adminTemplateBody"
                                    rows="3"
                                    placeholder="本文のひな形を入力"
                                  ></textarea>
                                </div>
                              </div>
                              <div class="d-flex align-items-center gap-2 mt-3">
                                <button
                                  class="btn btn-primary"
                                  type="submit"
                                  id="btnAdminTemplateSave"
                                >
                                  <span class="label">
                                    <span class="material-icons-outlined align-middle me-1"
                                      >save</span
                                    >保存
                                  </span>
                                  <span
                                    class="spinner-border spinner-border-sm d-none"
                                    role="status"
                                    aria-hidden="true"
                                  ></span>
                                </button>
                                <span class="small text-muted" id="adminTemplateStatus"
                                  >フォルダを選択してください。</span
                                >
                              </div>
                            </div>
                          </form>
                        </div>
                      </div>
                      <div class="mt-3">
                        <div class="admin-placeholder" id="adminTemplateEmpty">
                          フォルダを選択すると定型文が表示されます。
                        </div>
                        <div class="list-group" id="adminTemplateList"></div>
                      </div>
                    </article>
                  </div>
                </section>
                <section
                  class="admin-panel"
                  data-admin-panel="orgs"
                  aria-labelledby="adminOrgsTitle"
                >
                  <div class="admin-panel-header">
                    <h3 id="adminOrgsTitle">組織管理</h3>
                    <p>名称・テーマ・メンバー構成を編集します。</p>
                  </div>
                  <div class="admin-panel-body">
                    <div class="admin-placeholder" id="adminOrgNotice" hidden></div>
                    <p class="small text-muted mb-3" id="adminOrgRefreshedAt">最終更新: —</p>
                    <form id="adminOrgForm">
                      <div class="admin-card-grid">
                        <article class="admin-card">
                          <h4>組織基本情報</h4>
                          <p>正式名称・略称・カラーを編集します。</p>
                          <div class="admin-org-meta">
                            <div class="admin-org-meta-item">
                              <small>組織名</small>
                              <strong id="adminOrgNameDisplay">—</strong>
                            </div>
                            <div class="admin-org-meta-item">
                              <small>略称</small>
                              <strong id="adminOrgShortDisplay">—</strong>
                            </div>
                            <div class="admin-org-meta-item">
                              <small>ブランドカラー</small>
                              <strong class="admin-org-color-chip">
                                <span id="adminOrgColorPreview"></span>
                                <span id="adminOrgColorDisplay">#517CB2</span>
                              </strong>
                            </div>
                          </div>
                          <div class="row g-3">
                            <div class="col-12 col-md-6">
                              <label class="form-label" for="adminOrgName">組織名</label>
                              <input
                                class="form-control"
                                id="adminOrgName"
                                placeholder="例: ShiftFlow Café"
                              />
                            </div>
                            <div class="col-12 col-md-6">
                              <label class="form-label" for="adminOrgShortName">略称</label>
                              <input
                                class="form-control"
                                id="adminOrgShortName"
                                placeholder="例: SFC"
                              />
                            </div>
                            <div class="col-12 col-md-6">
                              <label class="form-label" for="adminOrgColor">表示カラー</label>
                              <div class="input-group">
                                <input
                                  type="color"
                                  class="form-control form-control-color"
                                  id="adminOrgColor"
                                  value="#517cb2"
                                  title="ブランドカラーを選択"
                                />
                                <span class="input-group-text" id="adminOrgColorText">#517CB2</span>
                              </div>
                            </div>
                            <div class="col-12 col-md-6">
                              <label class="form-label" for="adminOrgTimezone">タイムゾーン</label>
                              <select class="form-select" id="adminOrgTimezone"></select>
                            </div>
                          </div>
                        </article>
                        <article class="admin-card">
                          <h4>通知・ラベル</h4>
                          <p>Slack / メール通知や印刷物に使う識別情報をここで調整します。</p>
                          <div class="mb-3">
                            <label class="form-label" for="adminOrgNotifyEmail">通知メール</label>
                            <input
                              type="email"
                              class="form-control"
                              id="adminOrgNotifyEmail"
                              placeholder="ops@example.com"
                            />
                            <div class="form-text">
                              システム通知や Slack
                              リレーをメールで受け取る場合に利用します（任意）。
                            </div>
                          </div>
                          <div class="admin-org-meta">
                            <div class="admin-org-meta-item">
                              <small>通知メール</small>
                              <strong id="adminOrgNotifyDisplay">—</strong>
                            </div>
                            <div class="admin-org-meta-item">
                              <small>組織 ID</small>
                              <strong id="adminOrgIdDisplay">—</strong>
                            </div>
                          </div>
                        </article>
                      </div>
                      <div class="admin-bottom-meta flex-column flex-md-row gap-3">
                        <div>
                          <small class="text-muted d-block">最終更新</small>
                          <span id="adminOrgUpdatedAt">—</span>
                        </div>
                        <button
                          class="btn btn-primary ms-md-auto"
                          type="button"
                          id="btnAdminOrgSave"
                        >
                          <span class="label">
                            <span class="material-icons-outlined align-middle me-1">save</span
                            >更新を保存
                          </span>
                          <span
                            class="spinner-border spinner-border-sm d-none"
                            role="status"
                            aria-hidden="true"
                          ></span>
                        </button>
                      </div>
                    </form>
                    <article class="admin-card mt-3">
                      <h4>メンバー概要</h4>
                      <p>この組織に所属するユーザーのロール・ステータスを把握できます。</p>
                      <div class="admin-org-stats mb-3">
                        <div class="admin-org-stats-item">
                          <small>総メンバー</small>
                          <strong id="adminOrgStatsTotal">0</strong>
                        </div>
                        <div class="admin-org-stats-item">
                          <small>承認待ち</small>
                          <strong id="adminOrgStatsPending">0</strong>
                        </div>
                        <div class="admin-org-stats-item">
                          <small>有効</small>
                          <strong id="adminOrgStatsActive">0</strong>
                        </div>
                        <div class="admin-org-stats-item">
                          <small>停止中</small>
                          <strong id="adminOrgStatsSuspended">0</strong>
                        </div>
                      </div>
                      <div class="admin-org-stats mb-3">
                        <div class="admin-org-stats-item">
                          <small>Admin</small>
                          <strong id="adminOrgStatsAdmins">0</strong>
                        </div>
                        <div class="admin-org-stats-item">
                          <small>Manager</small>
                          <strong id="adminOrgStatsManagers">0</strong>
                        </div>
                        <div class="admin-org-stats-item">
                          <small>Member</small>
                          <strong id="adminOrgStatsMembers">0</strong>
                        </div>
                        <div class="admin-org-stats-item">
                          <small>Guest</small>
                          <strong id="adminOrgStatsGuests">0</strong>
                        </div>
                      </div>
                      <button
                        class="btn btn-sm btn-outline-primary align-self-start mt-auto"
                        type="button"
                        data-admin-target="users"
                      >
                        <span class="material-icons-outlined align-middle me-1">groups</span
                        >ユーザー一覧を開く
                      </button>
                    </article>
                  </div>
                </section>
                <section
                  class="admin-panel"
                  data-admin-panel="audit"
                  aria-labelledby="adminAuditTitle"
                >
                  <div class="admin-panel-header">
                    <h3 id="adminAuditTitle">監査ログ</h3>
                    <p>ログインや管理操作の履歴を確認します。</p>
                  </div>
                  <div class="admin-panel-body">
                    <div class="admin-filter-bar">
                      <div class="admin-filter-item">
                        <label class="form-label" for="adminAuditRange">期間</label>
                        <select class="form-select" id="adminAuditRange">
                          <option value="24h" selected>24時間</option>
                          <option value="7d">7日間</option>
                          <option value="30d">30日間</option>
                        </select>
                      </div>
                      <div class="admin-filter-item">
                        <label class="form-label" for="adminAuditType">イベント種別</label>
                        <select class="form-select" id="adminAuditType">
                          <option value="all" selected>全て</option>
                          <option value="admin">管理操作</option>
                          <option value="login">ログイン</option>
                          <option value="api">API</option>
                        </select>
                      </div>
                      <div class="admin-filter-item admin-filter-actions">
                        <label class="form-label d-none d-md-block">&nbsp;</label>
                        <button
                          class="btn btn-outline-secondary w-100"
                          type="button"
                          id="btnAdminAuditReload"
                        >
                          <span class="material-icons-outlined align-middle me-1">refresh</span
                          >再読込
                        </button>
                      </div>
                    </div>
                    <div
                      class="d-flex flex-column flex-md-row justify-content-between gap-2 mb-3 admin-audit-meta"
                    >
                      <div class="small text-muted" id="adminAuditSummary">—</div>
                      <div class="small text-muted" id="adminAuditUpdatedAt">最終更新: —</div>
                    </div>
                    <div class="admin-placeholder" id="adminAuditNotice" hidden></div>
                    <div
                      class="table-responsive"
                      id="adminAuditTableWrap"
                      aria-live="polite"
                      data-prevent-admin-swipe="true"
                    >
                      <table class="table admin-audit-table admin-table-light">
                        <thead>
                          <tr>
                            <th scope="col">時刻</th>
                            <th scope="col">ユーザー</th>
                            <th scope="col">イベント</th>
                            <th scope="col">概要</th>
                          </tr>
                        </thead>
                        <tbody id="adminAuditTableBody">
                          <tr>
                            <td colspan="4">
                              <div class="admin-users-loading">
                                <span class="material-icons-outlined align-middle"
                                  >hourglass_top</span
                                >
                                読み込み中...
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="admin-placeholder text-center" id="adminAuditEmpty" hidden>
                      条件に一致するログがありません。
                    </div>
                  </div>
                </section>
              </div>
            </div>
          </div>
          <div class="admin-bottom-meta text-center">
            <p class="text-muted small mb-0">UI 全体は順次ブラッシュアップ予定です</p>
            <small class="text-muted">スワイプまたは下部ナビでセクションを切り替えられます</small>
          </div>
        </section>
      </main>
    </div>

    <div
      class="modal fade"
      id="adminAuditDetailModal"
      tabindex="-1"
      aria-labelledby="adminAuditDetailTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="adminAuditDetailTitle">ログ詳細</h5>
            <button
              class="btn-close"
              type="button"
              data-bs-dismiss="modal"
              aria-label="閉じる"
            ></button>
          </div>
          <div class="modal-body">
            <dl class="row small mb-3">
              <dt class="col-sm-4">時刻</dt>
              <dd class="col-sm-8" id="adminAuditDetailTime">—</dd>
              <dt class="col-sm-4">種別</dt>
              <dd class="col-sm-8" id="adminAuditDetailType">—</dd>
              <dt class="col-sm-4">ユーザー</dt>
              <dd class="col-sm-8" id="adminAuditDetailUser">—</dd>
              <dt class="col-sm-4">ステータス</dt>
              <dd class="col-sm-8" id="adminAuditDetailStatus">—</dd>
              <dt class="col-sm-4">リクエストID</dt>
              <dd class="col-sm-8" id="adminAuditDetailRequest">—</dd>
              <dt class="col-sm-4">ターゲット / ルート</dt>
              <dd class="col-sm-8" id="adminAuditDetailRoute">—</dd>
              <dt class="col-sm-4">概要</dt>
              <dd class="col-sm-8" id="adminAuditDetailSummary">—</dd>
            </dl>
            <p class="text-muted small mb-1">詳細 JSON</p>
            <pre class="bg-light rounded p-3 small" id="adminAuditDetailMeta">{}</pre>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="offcanvas offcanvas-end"
      tabindex="-1"
      id="adminUserDrawer"
      aria-labelledby="adminUserDrawerTitle"
    >
      <div class="offcanvas-header">
        <div>
          <h5 class="offcanvas-title" id="adminUserDrawerTitle">ユーザー管理</h5>
          <p class="small text-muted mb-0" id="adminUserDrawerEmail">—</p>
        </div>
        <button
          class="btn-close"
          type="button"
          data-bs-dismiss="offcanvas"
          aria-label="閉じる"
        ></button>
      </div>
      <div class="offcanvas-body">
        <form id="adminUserDetailForm">
          <div class="mb-3">
            <label class="form-label" for="adminUserDetailRole">ロール</label>
            <select class="form-select" id="adminUserDetailRole">
              <option value="admin">Admin</option>
              <option value="manager">Manager</option>
              <option value="member">Member</option>
              <option value="guest">Guest</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="adminUserDetailStatus">組織ステータス</label>
            <select class="form-select" id="adminUserDetailStatus">
              <option value="pending">承認待ち</option>
              <option value="active">有効</option>
              <option value="suspended">停止中</option>
              <option value="revoked">剥奪</option>
            </select>
            <div class="form-text">
              ここで変更すると組織内のステータスに加え、ユーザー全体のステータスも同じ値に揃えられます。
            </div>
          </div>
          <div class="alert alert-info small" id="adminUserDetailRestriction" hidden>
            このユーザーは管理者のため、ロールやステータスを変更できません。
          </div>
          <dl class="row small admin-user-detail-meta">
            <dt class="col-4">組織</dt>
            <dd class="col-8" id="adminUserDetailOrg">—</dd>
            <dt class="col-4">組織内ステータス</dt>
            <dd class="col-8" id="adminUserDetailMembershipStatus">—</dd>
            <dt class="col-4">アカウント全体</dt>
            <dd class="col-8" id="adminUserDetailAccountStatus">—</dd>
            <dt class="col-4">最終ログイン</dt>
            <dd class="col-8" id="adminUserDetailLastLogin">—</dd>
            <dt class="col-4">承認者</dt>
            <dd class="col-8" id="adminUserDetailApproved">—</dd>
            <dt class="col-4">メモ</dt>
            <dd class="col-8" id="adminUserDetailNotes">—</dd>
          </dl>
          <div class="d-flex gap-2">
            <button class="btn btn-primary flex-grow-1" type="submit" id="adminUserDetailSave">
              <span class="label">変更を保存</span>
              <span
                class="spinner-border spinner-border-sm d-none"
                role="status"
                aria-hidden="true"
              ></span>
            </button>
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="offcanvas">
              閉じる
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ===== Floating action button for quick actions ===== -->
    <div class="fab dropup dropup-center" data-app-shell hidden>
      <button
        class="btn dropdown-toggle"
        id="fabButton"
        data-bs-toggle="dropdown"
        data-bs-auto-close="outside"
        data-bs-offset="10,10"
        aria-expanded="false"
        aria-label="作成"
      >
        <span class="material-icons">add</span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="fabButton">
        <li>
          <button class="dropdown-item" type="button" id="btn-open-new-task">
            <span class="material-icons-outlined">send</span>
            <span data-i18n="fab_task">タスク</span>
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="button" id="btn-open-new-msg">
            <span class="material-icons-outlined">mail</span>
            <span data-i18n="fab_message">メッセージ</span>
          </button>
        </li>
      </ul>
    </div>

    <!-- SECTION: サイドバー（モバイル下部ナビゲーション） -->
    <nav class="navbar navbar-expand footer-nav d-md-none" data-app-shell hidden>
      <div class="container-fluid">
        <ul class="navbar-nav w-100 justify-content-around">
          <li class="nav-item">
            <a
              class="nav-link text-center active"
              href="#"
              data-view="home"
              aria-label="ホーム"
              title="ホーム"
            >
              <span class="material-icons-outlined" aria-hidden="true">home</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center nav-icon"
              href="#"
              data-view="tasks"
              aria-label="タスク"
              title="タスク"
            >
              <span class="material-icons-outlined" aria-hidden="true">send</span>
              <span class="badge badge-overdue nav-icon-badge d-none" id="badge-task-overdue-bottom"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center nav-icon"
              href="#"
              data-view="messages"
              aria-label="メッセージ"
              title="メッセージ"
            >
              <span class="material-icons-outlined" aria-hidden="true">mail</span>
              <span class="badge badge-unread nav-icon-badge d-none" id="badge-unread-bottom"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center"
              href="#"
              data-view="settings"
              aria-label="設定"
              title="設定"
            >
              <span class="material-icons-outlined" aria-hidden="true">settings</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>
    <nav class="navbar navbar-expand footer-nav admin-footer-nav d-md-none" data-app-shell hidden>
      <div class="container-fluid">
        <ul class="navbar-nav w-100 justify-content-around">
          <li class="nav-item">
            <a
              class="nav-link text-center active"
              href="#"
              data-admin-target="dashboard"
              data-admin-nav-link
              aria-label="管理トップ"
              title="管理トップ"
            >
              <span class="material-icons-outlined" aria-hidden="true">dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center"
              href="#"
              data-admin-target="users"
              data-admin-nav-link
              aria-label="ユーザー管理"
              title="ユーザー管理"
            >
              <span class="material-icons-outlined" aria-hidden="true">groups</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center"
              href="#"
              data-admin-target="folders"
              data-admin-nav-link
              aria-label="フォルダ管理"
              title="フォルダ管理"
            >
              <span class="material-icons-outlined" aria-hidden="true">folder_shared</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center"
              href="#"
              data-admin-target="orgs"
              data-admin-nav-link
              aria-label="組織管理"
              title="組織管理"
            >
              <span class="material-icons-outlined" aria-hidden="true">apartment</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-center"
              href="#"
              data-admin-target="audit"
              data-admin-nav-link
              aria-label="監査ログ"
              title="監査ログ"
            >
              <span class="material-icons-outlined" aria-hidden="true">fact_check</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>
    <!-- /SECTION: サイドバー（モバイル） -->

    <!-- ===== Modal dialogs ===== -->
    <!-- ----- New Task modal ----- -->
    <div class="modal" id="newTaskModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="modal-title m-0" data-i18n="modal_task_new_title">新しいタスク</h6>
          </div>
          <div class="modal-body">
            <!-- COMPONENT: 申請フォーム（新規タスク作成） -->
            <form id="newTaskForm" class="modal-form">
              <div class="form-section">
                <div
                  id="taskFromMsgHint"
                  class="alert alert-info py-2 px-3 d-none mb-3"
                  role="alert"
                  style="border-radius: 10px"
                >
                  <span class="material-icons align-middle me-1">link</span>
                  <strong data-i18n="label_source_message">元メッセージ：</strong
                  ><a href="#" id="backToMsgLink" class="text-decoration-none">—</a>
                </div>
                <div class="form-section-title" data-i18n="section_basic_info">基本情報</div>
                <div class="mb-3">
                  <label class="form-label" data-i18n="label_title">タイトル</label>
                  <input type="text" class="form-control" id="taskTitle" required />
                </div>
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label" data-i18n="label_due">期限</label>
                    <input type="date" class="form-control" id="taskDueDate" required />
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label" data-i18n="label_priority">優先度</label>
                    <select class="form-select" id="taskPriority">
                      <option data-i18n="priority_medium">中</option>
                      <option data-i18n="priority_high">高</option>
                      <option data-i18n="priority_low">低</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="form-section">
                <div class="form-section-title d-flex align-items-center justify-content-between">
                  <span data-i18n="label_assignees">担当者</span>
                  <span class="ms-2 badge badge-counter" id="assignee-count-badge">選択 0 件</span>
                </div>
                <div class="assignees-wrap">
                  <div class="assignees-toolbar">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary"
                      id="btn-assignee-selectall"
                    >
                      <span data-i18n="assignee_select_all">すべて選択</span>
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-secondary"
                      id="btn-assignee-clear"
                    >
                      <span data-i18n="assignee_clear_all">すべて解除</span>
                    </button>
                  </div>
                  <div id="assignee-list" class="assignees-list"></div>
                </div>
                <div class="section-note">
                  <span data-i18n="assignee_note"
                    >タスクの担当者を1名以上選択してください。自分自身も選択できます。</span
                  >
                </div>
              </div>

              <div class="form-section">
                <div class="form-section-title" data-i18n="label_recurrence">繰り返し</div>
                <div class="mb-3">
                  <label class="form-label" data-i18n="label_pattern">パターン</label>
                  <select class="form-select" id="taskRepeatType">
                    <option value="none" data-i18n="repeat_none">単発（繰り返しなし）</option>
                    <option value="daily" data-i18n="repeat_daily">毎日</option>
                    <option value="weekly" data-i18n="repeat_weekly">毎週</option>
                    <option value="monthly" data-i18n="repeat_monthly">毎月</option>
                  </select>
                  <div class="section-note" data-i18n="repeat_note">
                    完了時に次回タスクを自動で生成します。
                  </div>
                </div>
              </div>
            </form>
            <!-- /COMPONENT: 申請フォーム -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <span data-i18n="btn_cancel">キャンセル</span>
            </button>
            <button type="button" class="btn btn-primary" id="saveTaskButton">
              <span class="label" data-i18n="btn_save">保存する</span>
              <span
                class="spinner-border spinner-border-sm d-none"
                role="status"
                aria-hidden="true"
              ></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ----- Compose Message modal ----- -->
    <div class="modal" id="newMessageModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="modal-title m-0" data-i18n="modal_message_new_title">新しいメッセージ</h6>
          </div>
          <div class="modal-body">
            <form id="newMessageForm" class="modal-form">
              <div class="form-section">
                <label class="form-label" data-i18n="messages_filter_folder">フォルダ</label>
                <div class="input-group">
                  <select class="form-select" id="messageFolder" data-folder-select="compose">
                    <option value="" data-i18n="messages_select_folder">フォルダを選択</option>
                  </select>
                  <button
                    class="btn btn-outline-secondary d-none"
                    type="button"
                    id="btnQuickFolder"
                    data-manager-only
                    title="フォルダを作成"
                  >
                    <span class="material-icons-outlined" aria-hidden="true">add</span>
                  </button>
                </div>
              </div>
              <div class="form-section">
                <div class="template-chip-row d-none" id="templateChipRow">
                  <small data-i18n="label_templates">定型文</small>
                  <div class="template-chip-list" id="templateChipList"></div>
                </div>
                <div class="mb-3">
                  <label class="form-label" data-i18n="label_subject">件名</label>
                  <input type="text" class="form-control" id="messageTitle" required />
                </div>
                <div class="mb-3">
                  <label class="form-label" data-i18n="label_body">本文</label>
                  <textarea class="form-control" id="messageBody" rows="5" required></textarea>
                </div>
                <div class="d-flex justify-content-end">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-message-clear">
                    件名・本文をクリア
                  </button>
                </div>
              </div>
              <div class="form-section">
                <label class="form-label d-block" for="message-attachment-input" data-i18n="label_attachments"
                  >添付画像</label
                >
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <button class="btn btn-outline-secondary" type="button" id="btn-message-attach">
                    <span data-i18n="attachments_add">画像を追加</span>
                  </button>
                  <span
                    class="small text-muted"
                    id="message-attach-hint"
                    data-i18n="attachments_hint"
                    >最大5件・各10MBまで</span
                  >
                </div>
                <input
                  type="file"
                  accept="image/*"
                  class="d-none"
                  id="message-attachment-input"
                  multiple
                  aria-label="添付画像を選択"
                />
                <ul class="list-unstyled small mb-0 mt-2" id="message-attachment-list"></ul>
              </div>
              <div class="form-section">
                <label class="form-label" data-i18n="label_priority">優先度</label>
                <select class="form-select" id="messagePriority">
                  <option data-i18n="priority_medium">中</option>
                  <option data-i18n="priority_high">高</option>
                  <option data-i18n="priority_low">低</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <span data-i18n="btn_cancel">キャンセル</span>
            </button>
            <button type="button" class="btn btn-primary" id="saveMessageButton">
              <span class="label" data-i18n="btn_post">投稿する</span>
              <span
                class="spinner-border spinner-border-sm d-none"
                role="status"
                aria-hidden="true"
              ></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- COMPONENT: 承認モーダル（タスク詳細・更新） -->
    <div class="modal" id="taskDetailModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="m-0" data-i18n="modal_task_detail_title">タスク詳細</h6>
          </div>
          <div class="modal-body">
            <div id="task-detail-loading" class="skeleton mb-3"></div>
            <div id="task-detail-content" class="d-none">
              <h4 id="detailTaskTitle" class="mb-3"></h4>
              <div id="taskDetailBody" class="form-section mb-3"></div>
              <div id="taskAttachments" class="mb-3 d-none">
                <div class="form-section">
                  <h6 class="mb-2">
                    <span class="material-icons align-middle me-1">attach_file</span>
                    <span data-i18n="label_attachments">添付画像</span>
                  </h6>
                  <ul class="list-group attach-list" id="taskAttachList"></ul>
                </div>
              </div>
              <div class="form-section mb-2">
                <div class="row g-2">
                  <div class="col-12 col-md-4">
                    <label class="form-label" data-i18n="label_status">ステータス</label>
                    <select id="detailStatus" class="form-select">
                      <option data-i18n="status_todo">未着手</option>
                      <option data-i18n="status_doing">進行中</option>
                      <option data-i18n="status_done">完了</option>
                    </select>
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label" data-i18n="label_due">期限</label>
                    <input id="detailDue" type="date" class="form-control" />
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label" data-i18n="label_priority">優先度</label>
                    <select id="detailPriority" class="form-select">
                      <option data-i18n="priority_medium">中</option>
                      <option data-i18n="priority_high">高</option>
                      <option data-i18n="priority_low">低</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2 flex-wrap">
                  <button class="btn btn-primary" id="btnTaskQuickSave">
                    <span class="label" data-i18n="task_update_now">この内容で更新</span>
                    <span
                      class="spinner-border spinner-border-sm d-none"
                      role="status"
                      aria-hidden="true"
                    ></span>
                  </button>
                  <button class="btn btn-success" id="btnTaskComplete">
                    <span class="label">
                      <span class="material-icons align-middle me-1">task_alt</span>
                      <span data-i18n="task_mark_complete">完了にする</span>
                    </span>
                    <span
                      class="spinner-border spinner-border-sm d-none"
                      role="status"
                      aria-hidden="true"
                    ></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger me-auto d-none" id="deleteTaskButton">
              <span data-i18n="btn_delete">削除</span>
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <span data-i18n="btn_close">閉じる</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- /COMPONENT: 承認モーダル -->

    <!-- ----- Message detail modal ----- -->
    <div class="modal" id="messageDetailModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="m-0" data-i18n="modal_message_detail_title">メッセージ詳細</h6>
          </div>
          <div class="modal-body">
            <div id="msg-detail-loading" class="skeleton mb-3"></div>
            <div id="msg-detail-content" class="d-none">
              <h4 id="msgDetailTitle" class="mb-3"></h4>
              <div class="msg-detail-meta mb-3 d-none" id="msgDetailMeta">
                <div class="msg-meta-line">
                  <div id="msgDetailAvatar"></div>
                  <div class="msg-meta-text">
                    <div class="msg-meta-author" id="msgDetailAuthor"></div>
                    <div class="msg-meta-time" id="msgDetailTimestamp"></div>
                  </div>
                </div>
              </div>
              <div id="msgDetailBody" class="form-section mb-3">
                <div class="section-body"></div>
              </div>
              <div id="msgAttachments" class="mb-3 d-none">
                <div class="form-section">
                  <h6 class="mb-2">
                    <span class="material-icons align-middle me-1">attach_file</span>
                    <span data-i18n="label_attachments">添付画像</span>
                  </h6>
                  <div class="image-preview-grid d-none" id="msgImagePreview"></div>
                  <ul class="list-group attach-list" id="msgAttachList"></ul>
                </div>
              </div>
              <div class="d-flex flex-wrap gap-2 mb-3">
                <button class="btn btn-outline-primary" id="btnMsgToTask">
                  <span class="label">
                    <span class="material-icons align-middle me-1">send</span>
                    <span data-i18n="message_convert_task">この内容でタスク</span>
                  </span>
                  <span
                    class="spinner-border spinner-border-sm d-none"
                    role="status"
                    aria-hidden="true"
                  ></span>
                </button>
                <button
                  class="btn btn-outline-secondary d-none"
                  id="btnUnreadStatus"
                  data-manager-only
                  type="button"
                >
                  <span class="material-icons align-middle me-1">visibility</span>
                  <span data-i18n="message_unread_status">未読状況確認</span>
                </button>
              </div>
              <h5 class="mt-4" data-i18n="label_comments">コメント</h5>
              <div id="comments-list" class="mb-2"></div>
              <textarea
                id="newCommentBody"
                class="form-control"
                rows="3"
                placeholder="コメントを入力..."
                data-i18n="comments_placeholder"
              ></textarea>
              <button class="btn btn-secondary mt-2" id="btnCommentPost" data-i18n="comments_post">
                コメントを投稿
              </button>
              <div class="mt-4">
                <p class="mb-2"><strong data-i18n="label_read">既読</strong></p>
                <div class="user-chip-list" id="msgReadUsers"></div>
                <p class="mb-2 mt-3"><strong data-i18n="label_unread">未読</strong></p>
                <div class="user-chip-list" id="msgUnreadUsers"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger me-auto d-none" id="deleteMessageButton">
              <span data-i18n="btn_delete">削除</span>
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <span data-i18n="btn_close">閉じる</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="quickFolderModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="m-0" id="quickFolderModalTitle" data-i18n="modal_folder_create_title">
              フォルダを作成
            </h6>
          </div>
          <div class="modal-body">
            <div class="alert alert-danger d-none" id="quickFolderError"></div>
            <div class="mb-3">
              <label class="form-label" for="quickFolderName" data-i18n="label_name">名称</label>
              <input
                type="text"
                class="form-control"
                id="quickFolderName"
                placeholder="メイン"
                data-i18n="folder_name_placeholder"
              />
            </div>
            <div class="mb-3">
              <label class="form-label" for="quickFolderColor" data-i18n="label_color"
                >カラー</label
              >
              <input
                type="color"
                class="form-control form-control-color"
                id="quickFolderColor"
                value="#517cb2"
              />
            </div>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="quickFolderPublic" checked />
              <label
                class="form-check-label"
                for="quickFolderPublic"
                data-i18n="folder_public_label"
                >全員に公開</label
              >
            </div>
            <div class="mb-3" id="quickFolderMemberWrap">
              <label class="form-label" data-i18n="folder_members_label"
                >メンバー (限定公開時)</label
              >
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">
                  <span class="material-icons-outlined fs-6" aria-hidden="true">search</span>
                </span>
                <input
                  type="search"
                  class="form-control"
                  id="quickFolderMemberSearch"
                  placeholder="名前・メールで絞り込み"
                  data-i18n="folder_member_placeholder"
                />
              </div>
              <div class="border rounded p-2 member-list" id="quickFolderMemberList"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <span data-i18n="btn_cancel">キャンセル</span>
            </button>
            <button type="button" class="btn btn-primary" id="btnQuickFolderSave">
              <span class="label" data-i18n="btn_save">保存する</span>
              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="unreadStatusModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content modal-modern">
          <div class="modal-header">
            <button type="button" class="btn btn-link" data-bs-dismiss="modal">
              <span class="material-icons">arrow_back</span>
            </button>
            <h6 class="m-0" data-i18n="modal_unread_status_title">未読状況</h6>
          </div>
          <div class="modal-body">
            <div id="unreadStatusLoading" class="skeleton"></div>
            <div id="unreadStatusContent" class="d-none">
              <p class="text-muted small mb-2" id="unreadStatusSummary"></p>
              <ul class="list-group" id="unreadStatusList"></ul>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <span data-i18n="btn_close">閉じる</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="image-viewer-overlay"
      id="imageViewer"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="image-viewer__panel">
        <div class="image-viewer__header">
          <button
            type="button"
            class="btn btn-link text-white d-inline-flex align-items-center gap-1 px-0"
            data-image-viewer-close
          >
            <span class="material-icons">arrow_back</span>
            <span data-i18n="btn_back">戻る</span>
          </button>
          <div class="image-viewer__meta">
            <span class="image-viewer__title" id="imageViewerTitle"></span>
            <span class="image-viewer__counter" id="imageViewerCounter"></span>
          </div>
        </div>
        <div class="image-viewer__body">
          <button
            type="button"
            class="image-viewer__nav image-viewer__nav--prev"
            id="imageViewerPrev"
            data-image-viewer-prev
          >
            <span class="material-icons">chevron_left</span>
          </button>
          <img src="" alt="" id="imageViewerImage" />
          <button
            type="button"
            class="image-viewer__nav image-viewer__nav--next"
            id="imageViewerNext"
            data-image-viewer-next
          >
            <span class="material-icons">chevron_right</span>
          </button>
        </div>
        <div class="image-viewer__footer">
          <a class="btn btn-light" target="_blank" rel="noopener" id="imageViewerOpen"
            >別タブで開く</a
          >
          <a class="btn btn-outline-light" download id="imageViewerDownload">ダウンロード</a>
        </div>
      </div>
    </div>

    <!-- ===== Vendor bundle: Bootstrap components ===== -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>

    <!-- ===== Application runtime logic ===== -->
    <script>
      // ===== サーバー埋め込みデータ =====
      const __BOOT__ = (function () {
        const bootstrap = window.__SHIFT_FLOW_BOOTSTRAP__ || {};
        const user = bootstrap.userInfo || {};
        return {
          users: Array.isArray(bootstrap.users) ? bootstrap.users : [],
          currentEmail: typeof user.email === 'string' ? user.email : '',
          theme: user.theme || bootstrap.theme || 'light',
          imageUrl: typeof user.imageUrl === 'string' ? user.imageUrl : '',
          role: typeof user.role === 'string' ? user.role : '',
          isManager: !!bootstrap.isManager,
          myTasks:
            bootstrap.myTasks && typeof bootstrap.myTasks === 'object'
              ? bootstrap.myTasks
              : { tasks: [], meta: {} },
          folders: Array.isArray(bootstrap.folders) ? bootstrap.folders : [],
          pinnedMessages:
            bootstrap.pinnedMessages && typeof bootstrap.pinnedMessages === 'object'
              ? bootstrap.pinnedMessages
              : {},
        };
      })();
      let ACTIVE_USERS = Array.isArray(__BOOT__.users) ? __BOOT__.users : [];
      let CURRENT_USER_EMAIL = String(__BOOT__.currentEmail || '');
      let HAS_ACTIVE_EMAIL = CURRENT_USER_EMAIL.length > 0;
      let USER_IMAGE_URL = typeof __BOOT__.imageUrl === 'string' ? __BOOT__.imageUrl : '';
      let INITIAL_MY_TASK_PAYLOAD =
        __BOOT__.myTasks && typeof __BOOT__.myTasks === 'object'
          ? __BOOT__.myTasks
          : { tasks: [], meta: {} };
      let IS_MANAGER = !!__BOOT__.isManager;
      const CURRENT_USER_ROLE = typeof __BOOT__.role === 'string' ? __BOOT__.role : '';
      const IS_ADMIN = String(CURRENT_USER_ROLE || '').toLowerCase() === 'admin';
      let ADMIN_STATE = {
        active: false,
        section: 'dashboard',
        orgId: 'current',
        orgLabel: '現在の組織',
      };
      const ADMIN_SECTION_LISTENERS = [];
      const ADMIN_ORG_LISTENERS = [];
      function addAdminSectionListener(fn) {
        if (typeof fn === 'function') {
          ADMIN_SECTION_LISTENERS.push(fn);
        }
      }
      function notifyAdminSectionListeners(section) {
        ADMIN_SECTION_LISTENERS.forEach(function (fn) {
          try {
            fn(section);
          } catch (err) {
            console.warn('Admin section listener failed:', err);
          }
        });
      }
      function addAdminOrgListener(fn) {
        if (typeof fn === 'function') {
          ADMIN_ORG_LISTENERS.push(fn);
        }
      }
      function notifyAdminOrgListeners(orgId) {
        ADMIN_ORG_LISTENERS.forEach(function (fn) {
          try {
            fn(orgId);
          } catch (err) {
            console.warn('Admin org listener failed:', err);
          }
        });
      }
      let FOLDERS = Array.isArray(__BOOT__.folders) ? __BOOT__.folders : [];
      let PINNED_MESSAGES =
        __BOOT__.pinnedMessages && typeof __BOOT__.pinnedMessages === 'object'
          ? __BOOT__.pinnedMessages
          : {};
      const SHIFT_FLOW_CONFIG = window.SHIFT_FLOW_CONFIG || {};
      const {
        BOOTSTRAP_CACHE_PREFIX,
        BOOTSTRAP_CACHE_RECENT_KEY,
        BOOTSTRAP_CACHE_DEFAULT_EMAIL,
        BOOTSTRAP_CACHE_MAX_AGE_MS,
        AUTH_NOTICE_MESSAGE,
        PROFILE_PLACEHOLDER_URL,
        PROFILE_IMAGE_MAX_BYTES,
        MESSAGE_ATTACHMENT_MAX_BYTES,
        MESSAGE_ATTACHMENT_LIMIT,
        API_BASE_PATH,
      } = SHIFT_FLOW_CONFIG;
      const APP_VERSION_LABEL = SHIFT_FLOW_CONFIG.APP_VERSION || 'dev';
      const APP_UPDATE_DISMISS_PREFIX = 'shiftflow-update-dismiss:';
      const TEST_USER_EMAIL = 'tester.member@shiftflow.dev';
      const TEST_MANAGER_EMAIL = 'tester.manager@shiftflow.dev';
      const TEST_MANAGER_NAME = 'テストマネージャー';
      const TEST_DEMO_ORG_ID = 'demo-org';
      const TEST_DEMO_ORG_LABEL = 'ShiftFlow Demo';
      const TEST_AVATAR_URL = 'https://placehold.jp/3d4070/ffffff/160x160.png?text=TEST';
      const TEST_THUMB_URL = 'https://placehold.jp/2c3d55/ffffff/96x96.png?text=UI';
      const TEST_ATTACHMENT_IMAGE =
        'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=800&q=80';
      const TEST_ATTACHMENT_MENU =
        'https://images.unsplash.com/photo-1529042410759-befb1204b468?auto=format&fit=crop&w=800&q=80';
      let TEST_MODE_STATE =
        window.__SHIFT_FLOW_TEST_MODE__ && typeof window.__SHIFT_FLOW_TEST_MODE__ === 'object'
          ? window.__SHIFT_FLOW_TEST_MODE__
          : { active: false, profile: 'member' };
      window.__SHIFT_FLOW_TEST_MODE__ = TEST_MODE_STATE;
      let APP_UPDATE_PROMPTED = false;
      let APP_UPDATE_REFRESHING = false;

      function markUpdateDismissed(key) {
        if (!key) return;
        try {
          localStorage.setItem(key, '1');
        } catch (_err) {
          /* noop */
        }
      }

      function cloneDeep(value) {
        try {
          return JSON.parse(JSON.stringify(value));
        } catch (_err) {
          return value;
        }
      }

      function createTestTask(options) {
        options = options || {};
        var now = Date.now();
        var due = new Date();
        due.setHours(0, 0, 0, 0);
        due.setDate(due.getDate() + (options.dueOffsetDays || 0));
        var createdAt = now - (options.createdOffsetHours || 0) * 3600 * 1000;
        var repeatRule = options.repeatRule || '';
        var task = {
          id: options.id || 'TASK-' + Math.floor(Math.random() * 10000),
          title: options.title || 'テストタスク',
          assignees: Array.isArray(options.assignees)
            ? options.assignees.slice()
            : [TEST_USER_EMAIL],
          assignee:
            Array.isArray(options.assignees) && options.assignees.length
              ? options.assignees[0]
              : TEST_USER_EMAIL,
          dueDate: due.toISOString().slice(0, 10),
          dueValue: due.getTime(),
          status: options.status || '対応中',
          priority: options.priority || '中',
          createdBy: options.createdBy || 'manager@shiftflow.dev',
          createdAt: createdAt,
          createdAtRaw: new Date(createdAt).toLocaleString('ja-JP', { hour12: false }),
          updatedAt: createdAt,
          updatedAtValue: createdAt,
          repeatRule: repeatRule,
          isCompleted: options.status === '完了',
          description: options.description || '',
          attachments: Array.isArray(options.attachments) ? options.attachments.slice() : [],
          canDelete: true,
        };
        return task;
      }

      function createTestMessage(options) {
        options = options || {};
        var createdAt = Date.now() - (options.createdOffsetHours || 0) * 3600 * 1000;
        var body = options.body || 'テスト用のメッセージ本文です。ここに連絡事項が入ります。';
        var createdBy = options.createdBy || TEST_USER_EMAIL;
        var createdByLabel =
          options.createdByLabel || options.createdByName || (createdBy ? createdBy : '');
        var createdAtLabel = new Date(createdAt).toLocaleString('ja-JP', { hour12: false });
        var summary = {
          id: options.id || 'MSG-' + Math.floor(Math.random() * 10000),
          title: options.title || 'テストのお知らせ',
          body: body,
          preview: body.length > 80 ? body.slice(0, 78) + '…' : body,
          priority: options.priority || '中',
          folderId: options.folderId || '全体',
          isRead: !!options.isRead,
          isPinned: !!options.isPinned,
          createdAt: createdAt,
          createdAtLabel: createdAtLabel,
          createdBy: createdBy,
          createdByLabel: createdByLabel,
        };
        summary.detail = {
          id: summary.id,
          title: summary.title,
          body: summary.body,
          attachments: Array.isArray(options.attachments) ? options.attachments.slice() : [],
          comments: Array.isArray(options.comments) ? options.comments.slice() : [],
          readUsers: Array.isArray(options.readUsers) ? options.readUsers.slice() : [],
          unreadUsers: Array.isArray(options.unreadUsers) ? options.unreadUsers.slice() : [],
          readEmails: Array.isArray(options.readEmails) ? options.readEmails.slice() : [],
          canDelete: true,
          priority: summary.priority,
          folderId: summary.folderId,
          isPinned: summary.isPinned,
          createdAt: summary.createdAt,
          createdAtLabel: summary.createdAtLabel,
          createdBy: summary.createdBy,
          createdByLabel: summary.createdByLabel,
        };
        return summary;
      }

      function buildTestModeDataset(options) {
        options = options || {};
        var profile = options.profile === 'manager' ? 'manager' : 'member';
        var isManagerProfile = profile === 'manager';
        var testEmail = isManagerProfile ? TEST_MANAGER_EMAIL : TEST_USER_EMAIL;
        var testName = isManagerProfile ? TEST_MANAGER_NAME : 'テストユーザー';
        var testAvatar = isManagerProfile ? TEST_THUMB_URL : TEST_AVATAR_URL;
        var now = Date.now();
        var teamManager = {
          email: 'manager@shiftflow.dev',
          name: '山田マネージャー',
          role: 'manager',
          imageUrl: TEST_THUMB_URL,
        };
        var users = [
          { email: testEmail, name: testName, role: profile, imageUrl: testAvatar },
          teamManager,
          {
            email: 'kitchen.lead@shiftflow.dev',
            name: '厨房リード',
            role: 'manager',
            imageUrl: TEST_THUMB_URL,
          },
          {
            email: 'guest.temp@shiftflow.dev',
            name: 'スポットワーカー',
            role: 'guest',
            imageUrl: TEST_AVATAR_URL,
          },
        ];

        var tasks = [
          createTestTask({
            id: 'TASK-101',
            title: '【テスト】開店前チェックリスト',
            priority: '高',
            status: '対応中',
            dueOffsetDays: 0,
            assignees: [testEmail, 'kitchen.lead@shiftflow.dev'],
            description: 'ホール・厨房の温度と備品を確認してください。',
            createdBy: teamManager.email,
          }),
          createTestTask({
            id: 'TASK-102',
            title: '【テスト】夕方の追加シフト確認',
            priority: '中',
            status: '未着手',
            dueOffsetDays: 1,
            assignees: [testEmail],
            createdBy: teamManager.email,
          }),
          createTestTask({
            id: 'TASK-103',
            title: '【テスト】備品の在庫共有',
            priority: '低',
            status: '完了',
            dueOffsetDays: -1,
            assignees: ['kitchen.lead@shiftflow.dev'],
            createdBy: testEmail,
          }),
        ];
        if (isManagerProfile) {
          tasks.push(
            createTestTask({
              id: 'TASK-201',
              title: '【管理】承認待ちユーザー確認',
              priority: '高',
              status: '対応中',
              dueOffsetDays: 0,
              assignees: [testEmail],
              createdBy: testEmail,
              description: '管理画面で承認待ち 2 件を確認してください。',
            })
          );
        }

        var baseComments = [
          {
            id: 'CMT-1',
            body: 'テストコメント: 進捗を確認しました。',
            authorEmail: teamManager.email,
            createdAt: '2024/06/30 09:10',
          },
        ];
        var messages = [
          createTestMessage({
            id: 'MSG-201',
            title: '【テスト】7/1 ホール連絡事項',
            priority: '高',
            isRead: false,
            isPinned: isManagerProfile,
            attachments: [
              {
                name: 'ホール配置図.jpg',
                url: TEST_ATTACHMENT_IMAGE,
                mimeType: 'image/jpeg',
                size: 180245,
              },
            ],
            comments: baseComments,
            readUsers: [{ email: teamManager.email, label: teamManager.name }],
            unreadUsers: [{ email: testEmail, label: testName }],
          }),
          createTestMessage({
            id: 'MSG-202',
            title: '【テスト】厨房シフトの共有',
            priority: '中',
            folderId: 'キッチン',
            isRead: true,
            attachments: [
              {
                name: '仕込み手順.pdf',
                url: TEST_ATTACHMENT_MENU,
                mimeType: 'application/pdf',
                size: 24000,
              },
            ],
            comments: [],
          }),
          createTestMessage({
            id: 'MSG-203',
            title: '【管理】承認待ちの確認と通知設定',
            priority: '中',
            folderId: '全体',
            isRead: isManagerProfile,
            isPinned: isManagerProfile,
            body: '管理者向けのテスト通知です。ユーザー承認とフォルダ管理のテストにご利用ください。',
            comments: [],
          }),
        ];
        var folders = [
          {
            id: '全体',
            name: '全体共有',
            color: '#517cb2',
            isPublic: true,
            isActive: true,
            isSystem: true,
            memberUserIds: [],
            memberCount: users.length,
            updatedAt: now - 60 * 60 * 1000,
          },
          {
            id: 'ホール',
            name: 'ホール',
            color: '#f59e0b',
            isPublic: false,
            isActive: true,
            memberUserIds: [testEmail, teamManager.email],
            memberCount: 2,
            updatedAt: now - 2 * 60 * 60 * 1000,
          },
          {
            id: 'キッチン',
            name: 'キッチン',
            color: '#06b6d4',
            isPublic: false,
            isActive: true,
            memberUserIds: ['kitchen.lead@shiftflow.dev'],
            memberCount: 1,
            updatedAt: now - 3 * 60 * 60 * 1000,
          },
          {
            id: 'バックヤード',
            name: 'バックヤード',
            color: '#8b5cf6',
            isPublic: false,
            isActive: true,
            memberUserIds: [testEmail],
            memberCount: 2,
            updatedAt: now - 24 * 60 * 60 * 1000,
          },
        ];
        var templates = {
          全体: [
            {
              id: 'TPL-1',
              name: '朝会アジェンダ',
              titleFormat: '【共有】本日の朝会',
              bodyFormat: '・新人共有\n・安全確認\n・今日の重点',
              updatedAt: now - 30 * 60 * 1000,
            },
          ],
          ホール: [
            {
              id: 'TPL-2',
              name: 'ヘルプ依頼',
              titleFormat: '【ヘルプ】ピーク対応お願い',
              bodyFormat: '◯◯席で応援お願いします。完了したらメモに記録してください。',
              updatedAt: now - 2 * 60 * 60 * 1000,
            },
          ],
        };
        var adminUsers = [
          {
            userId: 'user-test',
            email: testEmail,
            name: testName,
            role: profile,
            status: 'active',
            avatarUrl: testAvatar,
            orgName: TEST_DEMO_ORG_LABEL,
            orgId: TEST_DEMO_ORG_ID,
            lastLoginLabel: '今日 09:15',
            membershipStatus: 'active',
            userStatus: 'active',
            approvedBy: teamManager.name,
            approvedAtLabel: '今日 09:10',
            notes: isManagerProfile ? 'マネージャーモード（テスト）' : 'メンバーモード（テスト）',
            isActive: true,
          },
          {
            userId: 'user-001',
            email: teamManager.email,
            name: teamManager.name,
            role: 'manager',
            status: 'active',
            avatarUrl: TEST_THUMB_URL,
            orgName: TEST_DEMO_ORG_LABEL,
            orgId: TEST_DEMO_ORG_ID,
            lastLoginLabel: '昨日 18:20',
            membershipStatus: 'active',
            userStatus: 'active',
            approvedBy: 'system',
            approvedAtLabel: '昨日',
            notes: '店舗責任者',
            isActive: true,
          },
          {
            userId: 'user-002',
            email: 'crew.one@shiftflow.dev',
            name: 'ホール担当A',
            role: 'member',
            status: 'pending',
            avatarUrl: TEST_AVATAR_URL,
            orgName: TEST_DEMO_ORG_LABEL,
            orgId: TEST_DEMO_ORG_ID,
            lastLoginLabel: '—',
            membershipStatus: 'pending',
            userStatus: 'pending',
            approvedBy: '',
            approvedAtLabel: '',
            notes: '入社手続き待ち',
            isActive: false,
          },
          {
            userId: 'user-003',
            email: 'kitchen.lead@shiftflow.dev',
            name: '厨房リード',
            role: 'manager',
            status: 'active',
            avatarUrl: TEST_THUMB_URL,
            orgName: TEST_DEMO_ORG_LABEL,
            orgId: TEST_DEMO_ORG_ID,
            lastLoginLabel: '今日 08:45',
            membershipStatus: 'active',
            userStatus: 'active',
            approvedBy: teamManager.name,
            approvedAtLabel: '1日前',
            notes: '厨房の安全担当',
            isActive: true,
          },
          {
            userId: 'user-004',
            email: 'guest.temp@shiftflow.dev',
            name: 'スポットワーク',
            role: 'guest',
            status: 'revoked',
            avatarUrl: TEST_AVATAR_URL,
            orgName: TEST_DEMO_ORG_LABEL,
            orgId: TEST_DEMO_ORG_ID,
            lastLoginLabel: '先週',
            membershipStatus: 'revoked',
            userStatus: 'revoked',
            approvedBy: '',
            approvedAtLabel: '',
            notes: '一時停止中',
            isActive: false,
          },
          {
            userId: 'user-005',
            email: 'hq.admin@shiftflow.dev',
            name: '本部管理',
            role: 'admin',
            status: 'active',
            avatarUrl: TEST_THUMB_URL,
            orgName: '本部',
            orgId: 'hq',
            lastLoginLabel: '今日 07:30',
            membershipStatus: 'active',
            userStatus: 'active',
            approvedBy: 'system',
            approvedAtLabel: '先月',
            notes: '本部アカウント',
            isActive: true,
          },
        ];
        var auditLogs = [
          {
            id: 'AUD-1',
            type: 'admin',
            typeLabel: '管理操作',
            eventLabel: 'ユーザー更新',
            statusLabel: '成功',
            severity: 'success',
            summary: '役割を Manager に変更しました。',
            occurredAt: now - 45 * 60 * 1000,
            occurredLabel: new Date(now - 45 * 60 * 1000).toLocaleString('ja-JP', {
              hour12: false,
            }),
            userLabel: testName,
            userEmail: testEmail,
            meta: { route: 'adminUpdateUser', requestId: 'TEST-AUD-1' },
          },
          {
            id: 'AUD-2',
            type: 'login',
            typeLabel: 'ログイン',
            eventLabel: 'Google Sign-In',
            statusLabel: '成功',
            severity: 'info',
            summary: 'ShiftFlow へサインインしました。',
            occurredAt: now - 2 * 60 * 60 * 1000,
            occurredLabel: new Date(now - 2 * 60 * 60 * 1000).toLocaleString('ja-JP', {
              hour12: false,
            }),
            userLabel: teamManager.name,
            userEmail: teamManager.email,
            meta: { route: 'getBootstrapData', requestId: 'TEST-AUD-2' },
          },
          {
            id: 'AUD-3',
            type: 'api',
            typeLabel: 'API',
            eventLabel: 'メッセージ作成',
            statusLabel: '成功',
            severity: 'info',
            summary: '掲示板に連絡事項を投稿しました。',
            occurredAt: now - 6 * 60 * 60 * 1000,
            occurredLabel: new Date(now - 6 * 60 * 60 * 1000).toLocaleString('ja-JP', {
              hour12: false,
            }),
            userLabel: testName,
            userEmail: testEmail,
            meta: { route: 'addNewMessage', requestId: 'TEST-AUD-3' },
          },
        ];
        var orgs = [
          {
            orgId: TEST_DEMO_ORG_ID,
            name: TEST_DEMO_ORG_LABEL,
            shortName: 'SFDemo',
            displayColor: '#517CB2',
            notificationEmail: 'alerts@shiftflow.dev',
            timezone: 'Asia/Tokyo',
            updatedAt: '2024/07/01 09:00',
          },
          {
            orgId: 'east-cafe',
            name: 'East Cafe',
            shortName: 'East',
            displayColor: '#16a34a',
            notificationEmail: 'east@shiftflow.dev',
            timezone: 'Asia/Tokyo',
            updatedAt: '2024/07/01 08:45',
          },
        ];
        var orgStats = {};
        orgStats[TEST_DEMO_ORG_ID] = {
          totalMembers: adminUsers.length,
          statusCounts: { pending: 1, active: 3, suspended: 0, revoked: 1 },
          roleCounts: { admin: 1, manager: 2, member: 1, guest: 1 },
        };
        orgStats['east-cafe'] = {
          totalMembers: 12,
          statusCounts: { pending: 1, active: 9, suspended: 1, revoked: 1 },
          roleCounts: { admin: 1, manager: 2, member: 7, guest: 2 },
        };
        var userInfo = {
          email: testEmail,
          name: testName,
          imageUrl: testAvatar,
          theme: 'light',
          role: profile,
          language: 'ja',
        };
        var pinnedMap = {};
        messages.forEach(function (msg) {
          if (msg && msg.isPinned) {
            pinnedMap[msg.id] = { pinnedAt: new Date().toISOString(), title: msg.title };
          }
        });
        var bootstrap = {
          userInfo: cloneDeep(userInfo),
          users: cloneDeep(users),
          folders: cloneDeep(folders),
          pinnedMessages: pinnedMap,
          myTasks: {
            tasks: cloneDeep(tasks),
            meta: {
              totalTasks: tasks.length,
              matchedTasks: tasks.length,
              note: isManagerProfile
                ? 'テストデータ (管理モード / 永続化なし)'
                : 'テストデータ (ローカルのみ)',
            },
          },
          isManager: isManagerProfile,
          theme: 'light',
        };
        return {
          profile,
          userInfo,
          users,
          folders,
          tasks,
          messages,
          templates,
          adminUsers,
          auditLogs,
          orgs,
          orgStats,
          bootstrap,
          settings: {
            name: testName,
            imageUrl: testAvatar,
            imageName: 'test-avatar.png',
            role: profile,
            email: testEmail,
            theme: 'light',
            language: 'ja',
          },
          counters: {
            task: 1000 + tasks.length,
            message: 200 + messages.length,
            comment: 10,
            folder: folders.length,
            template: Object.keys(templates).reduce(function (sum, key) {
              var arr = templates[key];
              return sum + (Array.isArray(arr) ? arr.length : 0);
            }, 0),
            audit: 50 + auditLogs.length,
          },
        };
      }

      function isTestModeActive() {
        return !!(TEST_MODE_STATE && TEST_MODE_STATE.active);
      }

      function getTestModeState() {
        return TEST_MODE_STATE && TEST_MODE_STATE.active ? TEST_MODE_STATE : null;
      }

      function updateTestMenuShortcut() {
        var btn = byId('btn-user-menu-admin-demo');
        if (!btn) return;
        var state = getTestModeState();
        var show = !!(state && state.profile === 'member');
        btn.classList.toggle('d-none', !show);
        if (show) btn.removeAttribute('hidden');
        else btn.setAttribute('hidden', 'hidden');
      }

      function syncTestMyTasks(state) {
        if (!state || !state.data) return;
        var tasks = state.data.tasks || [];
        var note =
          state.data.bootstrap &&
          state.data.bootstrap.myTasks &&
          state.data.bootstrap.myTasks.meta &&
          state.data.bootstrap.myTasks.meta.note
            ? state.data.bootstrap.myTasks.meta.note
            : 'テストデータ (永続化されません)';
        state.data.bootstrap.myTasks = {
          tasks: cloneDeep(tasks),
          meta: {
            totalTasks: tasks.length,
            matchedTasks: tasks.length,
            note: note,
          },
        };
      }

      function createTestModeController(options) {
        var dataset = buildTestModeDataset(options || {});
        var controller = {
          active: true,
          profile: dataset.profile,
          networkDelayMs: 240,
          data: dataset,
          handleRoute: function (route, args) {
            return Promise.resolve(executeTestRoute(controller, route, args));
          },
        };
        syncTestMyTasks(controller);
        return controller;
      }

      function ensureTestModeController(options) {
        var requestedProfile =
          (options && options.profile) || (TEST_MODE_STATE && TEST_MODE_STATE.profile) || 'member';
        if (
          TEST_MODE_STATE &&
          TEST_MODE_STATE.active &&
          TEST_MODE_STATE.profile === requestedProfile
        ) {
          return TEST_MODE_STATE;
        }
        TEST_MODE_STATE = createTestModeController({ profile: requestedProfile });
        window.__SHIFT_FLOW_TEST_MODE__ = TEST_MODE_STATE;
        return TEST_MODE_STATE;
      }

      function cloneTasksForResponse(tasks) {
        return cloneDeep(tasks || []);
      }

      function findTestTask(state, id) {
        if (!state || !state.data) return null;
        return (state.data.tasks || []).find(function (task) {
          return task.id === id;
        });
      }

      function findTestMessage(state, id) {
        if (!state || !state.data) return null;
        return (state.data.messages || []).find(function (msg) {
          return msg.id === id;
        });
      }

      function toTestPayloadSuccess(message) {
        return {
          success: true,
          message: message || 'テストモードで完了しました。',
        };
      }

      function executeTestRoute(state, route, args) {
        if (!state || !state.data) {
          throw new Error('テストデータが初期化されていません。');
        }
        var data = state.data;
        switch (route) {
          case 'getBootstrapData':
            return cloneDeep(data.bootstrap);
          case 'getHomeContent':
            return {
              tasks: cloneTasksForResponse(data.tasks).slice(0, 3),
              messages: cloneDeep(data.messages || []).slice(0, 3),
            };
          case 'listMyTasks':
          case 'listAllTasks':
            syncTestMyTasks(state);
            return cloneDeep(data.bootstrap.myTasks);
          case 'listCreatedTasks': {
            var normalized = normalizeEmailValue(data.userInfo.email);
            var created = (data.tasks || []).filter(function (task) {
              return normalizeEmailValue(task.createdBy) === normalized;
            });
            return {
              tasks: cloneDeep(created),
              meta: {
                totalTasks: data.tasks.length,
                matchedTasks: created.length,
                note: 'テスト用データ (作成者フィルタ)',
              },
            };
          }
          case 'getTaskById': {
            var taskId = Array.isArray(args) ? args[0] : args;
            var found = findTestTask(state, taskId);
            if (!found) throw new Error('テストタスクが見つかりません: ' + taskId);
            return cloneDeep(found);
          }
          case 'addNewTask': {
            var payload = Array.isArray(args) && args[0] ? args[0] : {};
            var nextId = 'TASK-' + ++state.data.counters.task;
            var newTask = createTestTask({
              id: nextId,
              title: payload.title || '新規タスク',
              priority: payload.priority || '中',
              status: '未着手',
              dueOffsetDays: 0,
              assignees:
                Array.isArray(payload.assignees) && payload.assignees.length
                  ? payload.assignees
                  : [data.userInfo.email],
              createdBy: data.userInfo.email,
            });
            if (payload.dueDate) {
              newTask.dueDate = payload.dueDate;
              var dueDateObj = new Date(payload.dueDate);
              if (!isNaN(dueDateObj.getTime())) {
                newTask.dueValue = dueDateObj.getTime();
              }
            }
            if (payload.repeatRule) newTask.repeatRule = payload.repeatRule;
            data.tasks.unshift(newTask);
            syncTestMyTasks(state);
            return {
              success: true,
              message: 'テストデータにタスクを追加しました。',
              taskId: nextId,
            };
          }
          case 'updateTask': {
            var updatePayload = Array.isArray(args) && args[0] ? args[0] : {};
            var target = findTestTask(state, updatePayload.id);
            if (!target) throw new Error('対象タスクが見つかりません。');
            if (updatePayload.title) target.title = updatePayload.title;
            if (updatePayload.dueDate) {
              target.dueDate = updatePayload.dueDate;
              var dueObj = new Date(updatePayload.dueDate);
              if (!isNaN(dueObj.getTime())) target.dueValue = dueObj.getTime();
            }
            if (updatePayload.status) {
              target.status = updatePayload.status;
              target.isCompleted = updatePayload.status === '完了';
            }
            if (updatePayload.priority) target.priority = updatePayload.priority;
            target.updatedAt = Date.now();
            target.updatedAtValue = target.updatedAt;
            syncTestMyTasks(state);
            return toTestPayloadSuccess('タスクを更新しました (テスト)');
          }
          case 'completeTask': {
            var completeId = Array.isArray(args) ? args[0] : args;
            var completeTask = findTestTask(state, completeId);
            if (!completeTask) throw new Error('対象タスクが見つかりません。');
            completeTask.status = '完了';
            completeTask.isCompleted = true;
            completeTask.updatedAt = Date.now();
            completeTask.updatedAtValue = completeTask.updatedAt;
            syncTestMyTasks(state);
            return toTestPayloadSuccess('完了状態に変更しました (テスト)');
          }
          case 'deleteTaskById': {
            var deleteId = Array.isArray(args) ? args[0] : args;
            data.tasks = (data.tasks || []).filter(function (task) {
              return task.id !== deleteId;
            });
            syncTestMyTasks(state);
            return toTestPayloadSuccess('タスクを削除しました (テスト)');
          }
          case 'getMessages': {
            var rows = cloneDeep(data.messages || []);
            return rows;
          }
          case 'toggleMemoRead': {
            var memoId = Array.isArray(args) ? args[0] : null;
            var shouldRead = Array.isArray(args) ? !!args[1] : false;
            var toggleTarget = findTestMessage(state, memoId);
            if (!toggleTarget) throw new Error('メッセージが見つかりません。');
            toggleTarget.isRead = shouldRead;
            updateMessageReadState(data, toggleTarget, shouldRead);
            return toTestPayloadSuccess('既読状態を更新しました (テスト)');
          }
          case 'markMemoAsRead': {
            var memoIdForMark = Array.isArray(args) ? args[0] : args;
            var markTarget = findTestMessage(state, memoIdForMark);
            if (!markTarget) throw new Error('メッセージが見つかりません。');
            markTarget.isRead = true;
            updateMessageReadState(data, markTarget, true);
            return toTestPayloadSuccess('既読化しました (テスト)');
          }
          case 'markMemosReadBulk': {
            var idList = Array.isArray(args) && Array.isArray(args[0]) ? args[0] : [];
            idList.forEach(function (memoId) {
              var tgt = findTestMessage(state, memoId);
              if (!tgt) return;
              tgt.isRead = true;
              updateMessageReadState(data, tgt, true);
            });
            return toTestPayloadSuccess('未読メッセージを既読にしました (テスト)');
          }
          case 'getMessageById': {
            var memoId = Array.isArray(args) ? args[0] : args;
            var memo = findTestMessage(state, memoId);
            if (!memo) throw new Error('メッセージが見つかりません。');
            return cloneDeep(memo.detail || memo);
          }
          case 'addNewMessage': {
            var messagePayload = Array.isArray(args) && args[0] ? args[0] : {};
            var newId = 'MSG-' + ++state.data.counters.message;
            var entry = createTestMessage({
              id: newId,
              title: messagePayload.title || '新規のお知らせ',
              body: messagePayload.body || '',
              priority: messagePayload.priority || '中',
              folderId: messagePayload.folderId || '全体',
              isRead: false,
              attachments: messagePayload.attachments || [],
            });
            data.messages.unshift(entry);
            return {
              success: true,
              message: 'メッセージを追加しました (テスト)',
            };
          }
          case 'deleteMessageById': {
            var msgId = Array.isArray(args) ? args[0] : args;
            data.messages = (data.messages || []).filter(function (msg) {
              return msg.id !== msgId;
            });
            return toTestPayloadSuccess('メッセージを削除しました (テスト)');
          }
          case 'addNewComment': {
            var commentPayload = Array.isArray(args) && args[0] ? args[0] : {};
            var memoForComment = findTestMessage(state, commentPayload.memoId);
            if (!memoForComment) throw new Error('メッセージが見つかりません。');
            memoForComment.detail = memoForComment.detail || {};
            var comments = memoForComment.detail.comments || [];
            var label = commentPayload.body || '';
            comments.unshift({
              id: 'CMT-' + ++state.data.counters.comment,
              body: label,
              authorEmail: data.userInfo.email,
              authorName: data.userInfo.name,
              createdAt: new Date().toLocaleString('ja-JP', { hour12: false }),
            });
            memoForComment.detail.comments = comments;
            return toTestPayloadSuccess('コメントを追加しました (テスト)');
          }
          case 'getUserSettings':
            return cloneDeep(data.settings);
          case 'saveUserSettings': {
            var settingsPayload = Array.isArray(args) && args[0] ? args[0] : {};
            if (settingsPayload.name) data.settings.name = settingsPayload.name;
            if (settingsPayload.theme) data.settings.theme = settingsPayload.theme;
            if (settingsPayload.language) {
              data.settings.language = settingsPayload.language;
              data.userInfo.language = settingsPayload.language;
              if (data.bootstrap && data.bootstrap.userInfo) {
                data.bootstrap.userInfo.language = settingsPayload.language;
              }
            }
            if (settingsPayload.imageData) {
              data.settings.imageUrl = settingsPayload.imageData;
              data.settings.imageName = 'uploaded-from-test.png';
            }
            return {
              success: true,
              message: 'テストユーザー設定を保存しました。',
              imageUrl: data.settings.imageUrl,
              imageName: data.settings.imageName,
              theme: data.settings.theme,
              language: data.settings.language,
            };
          }
          case 'adminListUsers': {
            if (!data.bootstrap.isManager) {
              return { rows: [], meta: { managerOnly: true, reason: '管理者権限が必要です。' } };
            }
            var filters = Array.isArray(args) && args[0] ? args[0] : {};
            var keyword = (filters.search || '').toLowerCase();
            var statusFilter = (filters.status || '').toLowerCase();
            var roleFilter = (filters.role || '').toLowerCase();
            var rows = Array.isArray(data.adminUsers) ? data.adminUsers.slice() : [];
            if (keyword) {
              rows = rows.filter(function (row) {
                return (
                  String(row.name || '')
                    .toLowerCase()
                    .indexOf(keyword) !== -1 ||
                  String(row.email || '')
                    .toLowerCase()
                    .indexOf(keyword) !== -1
                );
              });
            }
            if (statusFilter) {
              rows = rows.filter(function (row) {
                return String(row.status || '').toLowerCase() === statusFilter;
              });
            }
            if (roleFilter) {
              rows = rows.filter(function (row) {
                return String(row.role || '').toLowerCase() === roleFilter;
              });
            }
            var stats = (data.adminUsers || []).reduce(
              function (acc, row) {
                var status = String(row.status || '').toLowerCase();
                if (status === 'pending') acc.pending += 1;
                else if (status === 'active') acc.active += 1;
                else acc.suspended += 1;
                acc.total += 1;
                return acc;
              },
              { total: 0, pending: 0, active: 0, suspended: 0 }
            );
            return {
              rows: cloneDeep(rows),
              meta: {
                refreshedAt: new Date().toLocaleString('ja-JP', { hour12: false }),
                stats: stats,
                managerOnly: false,
              },
            };
          }
          case 'adminUpdateUser': {
            if (!data.bootstrap.isManager) {
              return { success: false, message: '管理者権限が必要です。' };
            }
            var update = Array.isArray(args) && args[0] ? args[0] : {};
            var targetId = update.userId || update.email;
            var targetUser = (data.adminUsers || []).find(function (row) {
              return row.userId === targetId || row.email === targetId;
            });
            if (!targetUser) throw new Error('対象ユーザーが見つかりません。');
            if (update.role) targetUser.role = update.role;
            if (update.status) {
              targetUser.status = update.status;
              targetUser.membershipStatus = update.status;
              targetUser.userStatus = update.status;
              targetUser.isActive = update.status === 'active';
            }
            if (update.action) {
              if (update.action === 'activate') targetUser.status = 'active';
              if (update.action === 'suspend') targetUser.status = 'suspended';
              if (update.action === 'resume') targetUser.status = 'active';
              targetUser.membershipStatus = targetUser.status;
              targetUser.userStatus = targetUser.status;
              targetUser.isActive = targetUser.status === 'active';
            }
            var auditId = 'AUD-' + ++state.data.counters.audit;
            data.auditLogs.unshift({
              id: auditId,
              type: 'admin',
              typeLabel: '管理操作',
              eventLabel: 'ユーザー更新',
              statusLabel: '成功',
              severity: 'success',
              summary: 'ユーザー情報を更新しました。',
              occurredAt: Date.now(),
              occurredLabel: new Date().toLocaleString('ja-JP', { hour12: false }),
              userLabel: data.userInfo.name,
              userEmail: data.userInfo.email,
              meta: { route: 'adminUpdateUser', targetId: targetId, requestId: auditId },
            });
            return toTestPayloadSuccess('ユーザーを更新しました (テスト)');
          }
          case 'getAuditLogs': {
            if (!data.bootstrap.isManager) {
              return { rows: [], meta: { managerOnly: true, reason: '管理者権限が必要です。' } };
            }
            var limit = Array.isArray(args) && typeof args[0] === 'number' ? args[0] : 150;
            var auditFilter = Array.isArray(args) && args[1] ? args[1] : {};
            var eventType = (auditFilter.eventType || '').toLowerCase();
            var rows = Array.isArray(data.auditLogs) ? data.auditLogs.slice() : [];
            if (eventType && eventType !== 'all') {
              rows = rows.filter(function (row) {
                return String(row.type || '').toLowerCase() === eventType;
              });
            }
            var trimmed = rows.slice(0, limit);
            var stats = rows.reduce(function (acc, row) {
              var typeKey = String(row.type || 'admin').toLowerCase();
              acc[typeKey] = (acc[typeKey] || 0) + 1;
              return acc;
            }, {});
            return {
              rows: cloneDeep(trimmed),
              meta: {
                refreshedAt: new Date().toLocaleString('ja-JP', { hour12: false }),
                rangeLabel: auditFilter.range ? '期間: ' + auditFilter.range : '',
                availableRows: rows.length,
                filters: { limit: limit },
                stats: stats,
                managerOnly: false,
                truncated: rows.length > trimmed.length,
              },
            };
          }
          case 'adminListOrganizations': {
            if (!data.bootstrap.isManager) {
              return { orgs: [], meta: { managerOnly: true, reason: '管理者権限が必要です。' } };
            }
            var defaultOrgId =
              (data.orgs && data.orgs[0] && data.orgs[0].orgId) || TEST_DEMO_ORG_ID;
            return {
              orgs: cloneDeep(data.orgs),
              meta: { defaultOrgId: defaultOrgId, managerOnly: false },
            };
          }
          case 'adminGetOrganization': {
            if (!data.bootstrap.isManager) {
              return {
                org: null,
                stats: null,
                meta: { managerOnly: true, reason: '管理者権限が必要です。' },
              };
            }
            var orgArgs = Array.isArray(args) && args[0] ? args[0] : {};
            var orgId = orgArgs.orgId || TEST_DEMO_ORG_ID;
            var org = (data.orgs || []).find(function (entry) {
              return entry.orgId === orgId;
            });
            if (!org && data.orgs && data.orgs.length) org = data.orgs[0];
            if (!org) throw new Error('組織情報が見つかりません。');
            var stats = data.orgStats && data.orgStats[org.orgId] ? data.orgStats[org.orgId] : null;
            return {
              org: cloneDeep(org),
              stats: stats ? cloneDeep(stats) : null,
              refreshedAt: new Date().toLocaleString('ja-JP', { hour12: false }),
            };
          }
          case 'adminUpdateOrganization': {
            if (!data.bootstrap.isManager) {
              return { success: false, message: '管理者権限が必要です。' };
            }
            var orgPayload = Array.isArray(args) && args[0] ? args[0] : {};
            var targetOrg = (data.orgs || []).find(function (entry) {
              return entry.orgId === orgPayload.orgId;
            });
            if (!targetOrg) throw new Error('組織が見つかりません。');
            if (orgPayload.name) targetOrg.name = orgPayload.name;
            if (orgPayload.shortName) targetOrg.shortName = orgPayload.shortName;
            if (orgPayload.displayColor) targetOrg.displayColor = orgPayload.displayColor;
            if (orgPayload.timezone) targetOrg.timezone = orgPayload.timezone;
            if (orgPayload.notificationEmail)
              targetOrg.notificationEmail = orgPayload.notificationEmail;
            targetOrg.updatedAt = new Date().toLocaleString('ja-JP', { hour12: false });
            return {
              success: true,
              message: '組織情報を更新しました (テスト)',
              org: cloneDeep(targetOrg),
            };
          }
          default:
            throw new Error('テストモードでは未対応の操作です: ' + route);
        }
      }

      function updateMessageReadState(data, summary, isRead) {
        if (!summary) return;
        summary.detail = summary.detail || {};
        var email = data.userInfo.email;
        summary.detail.readEmails = summary.detail.readEmails || [];
        var normalized = normalizeEmailValue(email);
        if (isRead) {
          if (
            !summary.detail.readEmails.some(function (value) {
              return normalizeEmailValue(value) === normalized;
            })
          ) {
            summary.detail.readEmails.push(email);
          }
          summary.detail.readUsers = summary.detail.readUsers || [];
          if (
            !summary.detail.readUsers.some(function (entry) {
              return entry && normalizeEmailValue(entry.email) === normalized;
            })
          ) {
            summary.detail.readUsers.push({ email: email, label: data.userInfo.name });
          }
          summary.detail.unreadUsers = (summary.detail.unreadUsers || []).filter(function (entry) {
            return entry && normalizeEmailValue(entry.email) !== normalized;
          });
        } else {
          summary.detail.readEmails = (summary.detail.readEmails || []).filter(function (value) {
            return normalizeEmailValue(value) !== normalized;
          });
          summary.detail.readUsers = (summary.detail.readUsers || []).filter(function (entry) {
            return entry && normalizeEmailValue(entry.email) !== normalized;
          });
          summary.detail.unreadUsers = summary.detail.unreadUsers || [];
          if (
            !summary.detail.unreadUsers.some(function (entry) {
              return entry && normalizeEmailValue(entry.email) === normalized;
            })
          ) {
            summary.detail.unreadUsers.push({ email: email, label: data.userInfo.name });
          }
        }
      }

      const AUTH_PENDING_FLAG_KEY = 'SHIFT_FLOW_AUTH_PENDING';
      const GAS_WEB_APP_URL =
        typeof window.__GAS_WEB_APP_URL__ === 'string' ? window.__GAS_WEB_APP_URL__ : '';
      const HAS_GAS_WEB_APP_URL = GAS_WEB_APP_URL.length > 0;
      const GOOGLE_CLIENT_ID =
        typeof window.__GOOGLE_CLIENT_ID__ === 'string' ? window.__GOOGLE_CLIENT_ID__ : '';
      window.__SHIFT_FLOW_AUTH_TOKEN__ = window.__SHIFT_FLOW_AUTH_TOKEN__ || '';
      let AUTH_TOKEN_PAYLOAD = null;
      let AUTH_READY = false;
      let BOOTSTRAP_STARTED = false;
      let RESTORED_BOOTSTRAP_FROM_CACHE = false;
      const USER_AGENT = (navigator && navigator.userAgent) || '';
      const IS_IOS = /iphone|ipad|ipod/i.test(USER_AGENT) && !(window && window.MSStream);
      const IS_ANDROID = /android/i.test(USER_AGENT);
      const IS_MOBILE = IS_IOS || IS_ANDROID;
      const IS_SAFARI =
        /safari/i.test(USER_AGENT || '') &&
        !/chrome|crios|fxios|edgios|firefox/i.test(USER_AGENT || '');
      const IS_STANDALONE =
        (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
        (typeof navigator !== 'undefined' && navigator.standalone === true);
      const NEEDS_MANUAL_SIGNIN = IS_IOS && IS_STANDALONE;
      let AUTH_NOTICE_SHOWN = false;
      let MANAGER_NOTICE_SHOWN = false;
      let AUTH_HELP_REQUESTED = false;
      let TASKS_BOOTSTRAPPED = false;
      var _rszTimer = null;
      let ACTIVE_TASK_TAB = 'my';
      let AUTH_SESSION = { authenticated: false, user: null, expiresAt: 0 };
      if (!HAS_GAS_WEB_APP_URL) {
        console.warn(
          '[ShiftFlow] GAS_WEB_APP_URL is not defined. Set the Environment Variable on Cloudflare Pages.'
        );
      }

      var syncThemeMeta =
        typeof window.__SHIFT_FLOW_SYNC_THEME_META__ === 'function'
          ? window.__SHIFT_FLOW_SYNC_THEME_META__
          : function (theme) {
              var palette = window.__SHIFT_FLOW_THEME_META__ || {
                light: { statusBar: 'default' },
                dark: { statusBar: 'black-translucent' },
              };
              var getPrimary =
                typeof window.__SHIFT_FLOW_GET_PRIMARY__ === 'function'
                  ? window.__SHIFT_FLOW_GET_PRIMARY__
                  : function (mode) {
                      if (mode === 'dark') return '#4b67b3';
                      return '#517cb2';
                    };
              var resolvedTheme = theme === 'dark' ? 'dark' : 'light';
              var statusBar =
                (palette[resolvedTheme] && palette[resolvedTheme].statusBar) ||
                (resolvedTheme === 'dark' ? 'black-translucent' : 'default');
              var metaTheme = document.querySelector('meta[name="theme-color"]');
              if (metaTheme) {
                metaTheme.setAttribute('content', getPrimary(resolvedTheme));
              }
              var appleStatus = document.querySelector(
                'meta[name="apple-mobile-web-app-status-bar-style"]'
              );
              if (appleStatus && statusBar) {
                appleStatus.setAttribute('content', statusBar);
              }
            };
      if (typeof window.__SHIFT_FLOW_SYNC_THEME_META__ !== 'function') {
        window.__SHIFT_FLOW_SYNC_THEME_META__ = syncThemeMeta;
      }

      // ===== テーマ適用 =====
      const THEME_MEDIA = window.matchMedia
        ? window.matchMedia('(prefers-color-scheme: dark)')
        : null;
      let themePreference =
        (typeof document.documentElement.dataset.themePref === 'string' &&
          document.documentElement.dataset.themePref) ||
        'light';
      let pendingProfileImage = null;
      let pendingMessageAttachments = [];
      if (__BOOT__.theme) themePreference = __BOOT__.theme || themePreference;

      function applyBootstrapBindings(bootstrap) {
        const source = bootstrap || window.__SHIFT_FLOW_BOOTSTRAP__ || {};
        const user = source.userInfo || {};
        const email = typeof user.email === 'string' ? user.email : '';
        const name = user.name || 'ゲストユーザー';
        const avatar = user.imageUrl || '/icons/icon-192.png';
        document.querySelectorAll('[data-bind-user-email]').forEach(function (el) {
          if (email) {
            el.setAttribute('title', email);
          } else {
            el.removeAttribute('title');
          }
          if (email) {
            if (el.tagName === 'A' && el.textContent.trim() === '') {
              el.textContent = email;
            } else if (el.tagName !== 'A') {
              el.textContent = email;
            }
          } else if (el.tagName !== 'A') {
            el.textContent = '';
          }
        });
        document.querySelectorAll('[data-bind-user-name]').forEach(function (el) {
          el.textContent = name;
        });
        document.querySelectorAll('[data-bind-user-avatar]').forEach(function (el) {
          el.setAttribute('src', avatar);
          el.setAttribute('data-avatar-url', avatar);
        });
      }
      applyBootstrapBindings(window.__SHIFT_FLOW_BOOTSTRAP__);

      function toggleManagerUI() {
        var shouldShow = !!IS_MANAGER;
        document.querySelectorAll('[data-manager-only]').forEach(function (el) {
          el.classList.toggle('d-none', !shouldShow);
          if (!shouldShow) {
            el.setAttribute('aria-hidden', 'true');
          } else {
            el.removeAttribute('aria-hidden');
          }
        });
        if (!shouldShow && typeof ACTIVE_TASK_TAB !== 'undefined' && ACTIVE_TASK_TAB === 'all') {
          ACTIVE_TASK_TAB = 'my';
        }
        if (!shouldShow) {
          ensureAdminViewHidden();
        }
      }

      function populateAssigneeFilters() {
        var selects = [byId('task-filter-from-assignee'), byId('task-filter-all-assignee')];
        var rows = ACTIVE_USERS.slice().sort(function (a, b) {
          return String(a.name || a.email || '').localeCompare(
            String(b.name || b.email || ''),
            'ja'
          );
        });
        selects.forEach(function (select) {
          if (!select) return;
          var previous = select.value;
          select.innerHTML = '';
          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = '担当者で絞り込み';
          select.appendChild(placeholder);
          rows.forEach(function (user) {
            if (!user || !user.email) return;
            var option = document.createElement('option');
            option.value = user.email;
            option.textContent = user.name || user.email;
            select.appendChild(option);
          });
          if (
            previous &&
            rows.some(function (u) {
              return u.email === previous;
            })
          ) {
            select.value = previous;
          }
        });
      }

      function getDefaultFolderId() {
        if (!Array.isArray(FOLDERS) || FOLDERS.length === 0) return '';
        var systemFolder = FOLDERS.find(function (folder) {
          return folder && (folder.isSystem || folder.name === 'Main' || folder.id === 'Main');
        });
        if (systemFolder && systemFolder.id) return systemFolder.id;
        var fallback = FOLDERS[0] && FOLDERS[0].id ? FOLDERS[0].id : '';
        return fallback;
      }

      function populateFolderSelects() {
        var folders = Array.isArray(FOLDERS) ? FOLDERS : [];
        var filterSelect = byId('flt-msg-folder');
        if (filterSelect) {
          var prev = filterSelect.value;
          filterSelect.innerHTML = '';
          var allOption = document.createElement('option');
          allOption.value = '';
          allOption.textContent = '全て';
          filterSelect.appendChild(allOption);
          folders.forEach(function (folder) {
            if (!folder || !folder.id) return;
            var option = document.createElement('option');
            option.value = folder.id;
            option.textContent = folder.name || folder.id;
            filterSelect.appendChild(option);
          });
          if (
            prev &&
            folders.some(function (f) {
              return f.id === prev;
            })
          ) {
            filterSelect.value = prev;
          }
        }

        var composeSelect = byId('messageFolder');
        if (composeSelect) {
          var prevCompose =
            composeSelect.value && composeSelect.value !== '' ? composeSelect.value : null;
          composeSelect.innerHTML = '';
          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'フォルダを選択';
          composeSelect.appendChild(placeholder);
          folders.forEach(function (folder) {
            if (!folder || !folder.id) return;
            var option = document.createElement('option');
            option.value = folder.id;
            option.textContent = folder.name || folder.id;
            composeSelect.appendChild(option);
          });
          var defaultId = prevCompose || getDefaultFolderId();
          if (
            defaultId &&
            folders.some(function (f) {
              return f.id === defaultId;
            })
          ) {
            composeSelect.value = defaultId;
          } else {
            composeSelect.value = '';
          }
          MessageDraftController.handleFolderChange(composeSelect.value || '');
        }
        renderAdminFolderList();
      }

      const MessageDraftController = (function () {
        const STORAGE_PREFIX = 'shiftflow_draft_';
        let activeFolderId = '';
        let saveTimer = null;

        function getKey(folderId) {
          return STORAGE_PREFIX + (folderId || 'default');
        }

        function readDraft(folderId) {
          try {
            const raw = localStorage.getItem(getKey(folderId));
            return raw ? JSON.parse(raw) : null;
          } catch (_err) {
            return null;
          }
        }

        function saveDraft() {
          const folderId = byId('messageFolder') ? byId('messageFolder').value : '';
          if (!folderId) return;
          const payload = {
            folderId,
            title: (byId('messageTitle') && byId('messageTitle').value) || '',
            body: (byId('messageBody') && byId('messageBody').value) || '',
            savedAt: Date.now(),
          };
          try {
            localStorage.setItem(getKey(folderId), JSON.stringify(payload));
          } catch (_err) {
            /* ignore quota errors */
          }
        }

        function scheduleSave() {
          clearTimeout(saveTimer);
          saveTimer = setTimeout(saveDraft, 300);
        }

        function clearDraft(folderId) {
          try {
            localStorage.removeItem(getKey(folderId));
          } catch (_err) {
            /* ignore */
          }
        }

        function restoreDraft(folderId) {
          const draft = readDraft(folderId);
          if (!draft) return false;
          if (!draft.title && !draft.body) return false;
          const shouldRestore = confirm('フォルダに保存された下書きを復元しますか？');
          if (!shouldRestore) return false;
          const titleEl = byId('messageTitle');
          const bodyEl = byId('messageBody');
          if (titleEl) titleEl.value = draft.title || '';
          if (bodyEl) bodyEl.value = draft.body || '';
          return true;
        }

        function handleFolderChange(folderId) {
          activeFolderId = folderId || '';
          TemplateController.renderForFolder(folderId);
          if (!folderId) return;
          restoreDraft(folderId);
        }

        function init() {
          const titleEl = byId('messageTitle');
          const bodyEl = byId('messageBody');
          const folderEl = byId('messageFolder');
          if (titleEl) titleEl.addEventListener('input', scheduleSave);
          if (bodyEl) bodyEl.addEventListener('input', scheduleSave);
          if (folderEl) {
            folderEl.addEventListener('change', function () {
              scheduleSave();
              handleFolderChange(folderEl.value || '');
            });
          }
        }

        return {
          init,
          save: scheduleSave,
          clear: clearDraft,
          handleFolderChange,
        };
      })();

      const TemplateController = (function () {
        const cache = new Map();

        function fetchTemplates(folderId) {
          if (!folderId) return Promise.resolve([]);
          if (cache.has(folderId)) {
            return Promise.resolve(cache.get(folderId));
          }
          const url = `${API_BASE_PATH}/templates?folderId=${encodeURIComponent(folderId)}`;
          return apiRequest(url, { method: 'GET' })
            .then(function (result) {
              const list = Array.isArray(result) ? result : [];
              cache.set(folderId, list);
              return list;
            })
            .catch(function (err) {
              console.warn('Failed to load templates:', err);
              return [];
            });
        }

        function renderForFolder(folderId) {
          const row = byId('templateChipRow');
          const listEl = byId('templateChipList');
          if (!row || !listEl) return;
          if (!folderId) {
            row.classList.add('d-none');
            listEl.innerHTML = '';
            return;
          }
          fetchTemplates(folderId).then(function (templates) {
            if (!templates.length) {
              row.classList.add('d-none');
              listEl.innerHTML = '';
              return;
            }
            listEl.innerHTML = templates
              .map(function (tpl, index) {
                return (
                  '<button type="button" class="template-chip" data-template-index="' +
                  index +
                  '">' +
                  esc(tpl.name || '定型文') +
                  '</button>'
                );
              })
              .join('');
            listEl.querySelectorAll('.template-chip').forEach(function (chip) {
              chip.addEventListener('click', function () {
                const idx = Number(chip.getAttribute('data-template-index') || '0');
                const template = templates[idx];
                if (!template) return;
                applyTemplate(template);
              });
            });
            row.classList.remove('d-none');
          });
        }

        function applyTemplate(template) {
          const titleEl = byId('messageTitle');
          const bodyEl = byId('messageBody');
          if (titleEl && typeof template.titleFormat === 'string') {
            titleEl.value = template.titleFormat;
          }
          if (bodyEl && typeof template.bodyFormat === 'string') {
            bodyEl.value = template.bodyFormat;
          }
          MessageDraftController.save();
          notify('定型文を適用しました。', true);
        }

        return {
          renderForFolder,
          clearCache: function () {
            cache.clear();
          },
        };
      })();

      const QuickFolderController = (function () {
        const MODAL_ID = 'quickFolderModal';
        const state = {
          editingId: '',
          selectedMembers: new Set(),
          memberFilter: '',
        };

        function setSelectedMembers(list) {
          state.selectedMembers = new Set(
            Array.isArray(list)
              ? list
                  .map(function (id) {
                    return typeof id === 'string' ? id : '';
                  })
                  .filter(Boolean)
              : []
          );
        }

        function memberMatchesKeyword(user, keyword) {
          if (!keyword) return true;
          var label = String(user.name || user.email || '').toLowerCase();
          return label.indexOf(keyword) !== -1;
        }

        function renderMembers() {
          const list = byId('quickFolderMemberList');
          if (!list) return;
          const keyword = (state.memberFilter || '').toLowerCase();
          const sorted = ACTIVE_USERS.slice().sort(function (a, b) {
            return String(a.name || a.email || '').localeCompare(
              String(b.name || b.email || ''),
              'ja'
            );
          });
          const filtered = sorted.filter(function (user) {
            return memberMatchesKeyword(user, keyword);
          });
          if (!filtered.length) {
            list.innerHTML =
              '<div class="text-muted small px-2">一致するメンバーがいません。</div>';
            return;
          }
          list.innerHTML = filtered
            .map(function (user, index) {
              const id = user && (user.userId || user.email || '');
              const inputId = `quick-folder-member-${index}`;
              const checked = state.selectedMembers.has(id);
              return (
                '<div class="form-check form-check-sm">' +
                '<input class="form-check-input" type="checkbox" id="' +
                inputId +
                '" value="' +
                esc(id) +
                '"' +
                (checked ? ' checked' : '') +
                '>' +
                '<label class="form-check-label" for="' +
                inputId +
                '">' +
                esc(user.name || user.email || '') +
                '</label>' +
                '</div>'
              );
            })
            .join('');
          list.querySelectorAll('input[type="checkbox"]').forEach(function (input) {
            input.addEventListener('change', function () {
              if (!input.value) return;
              if (input.checked) {
                state.selectedMembers.add(input.value);
              } else {
                state.selectedMembers.delete(input.value);
              }
            });
          });
        }

        function toggleMemberVisibility() {
          const wrap = byId('quickFolderMemberWrap');
          const checkbox = byId('quickFolderPublic');
          const search = byId('quickFolderMemberSearch');
          if (!wrap || !checkbox) return;
          const hidden = checkbox.checked;
          wrap.classList.toggle('d-none', hidden);
          if (search) {
            search.disabled = hidden;
          }
          if (!hidden) {
            renderMembers();
          }
        }

        function resetModalState(folder) {
          const modalTitle = byId('quickFolderModalTitle');
          const nameInput = byId('quickFolderName');
          const colorInput = byId('quickFolderColor');
          const publicSwitch = byId('quickFolderPublic');
          const saveLabel =
            byId('btnQuickFolderSave') && byId('btnQuickFolderSave').querySelector('.label');
          const searchInput = byId('quickFolderMemberSearch');
          state.editingId = folder && folder.id ? folder.id : '';
          state.memberFilter = '';
          setSelectedMembers(
            folder && Array.isArray(folder.memberUserIds) ? folder.memberUserIds : []
          );
          if (modalTitle) {
            modalTitle.textContent = state.editingId ? 'フォルダを編集' : 'フォルダを作成';
          }
          if (saveLabel) {
            saveLabel.textContent = state.editingId ? '更新' : '保存';
          }
          if (nameInput) nameInput.value = (folder && folder.name) || '';
          if (colorInput) colorInput.value = (folder && folder.color) || '#517cb2';
          if (publicSwitch) {
            publicSwitch.checked =
              folder && Object.prototype.hasOwnProperty.call(folder, 'isPublic')
                ? !!folder.isPublic
                : true;
          }
          if (searchInput) {
            searchInput.value = '';
          }
        }

        function open(targetFolderId) {
          if (!IS_MANAGER) {
            notify('フォルダを作成できるのは管理者のみです。', false);
            return;
          }
          const modalEl = byId(MODAL_ID);
          if (!modalEl) return;
          const folder =
            targetFolderId && Array.isArray(FOLDERS)
              ? FOLDERS.find(function (f) {
                  return f && f.id === targetFolderId;
                })
              : null;
          showError('');
          resetModalState(folder || {});
          toggleMemberVisibility();
          renderMembers();
          const searchInput = byId('quickFolderMemberSearch');
          if (searchInput) {
            searchInput.oninput = function () {
              state.memberFilter = searchInput.value || '';
              renderMembers();
            };
          }
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }

        function setSavingState(isSaving) {
          const btn = byId('btnQuickFolderSave');
          if (!btn) return;
          const label = btn.querySelector('.label');
          const spinner = btn.querySelector('.spinner-border');
          btn.disabled = !!isSaving;
          if (label) label.classList.toggle('d-none', !!isSaving);
          if (spinner) spinner.classList.toggle('d-none', !isSaving);
        }

        function showError(message) {
          const box = byId('quickFolderError');
          if (!box) return;
          if (!message) {
            box.classList.add('d-none');
            box.textContent = '';
            return;
          }
          box.textContent = message;
          box.classList.remove('d-none');
        }

        function upsertFolder(folder) {
          const normalMemberIds = Array.isArray(folder?.memberUserIds)
            ? folder.memberUserIds.filter(Boolean)
            : Array.isArray(folder?.member_user_ids)
            ? folder.member_user_ids.filter(Boolean)
            : [];
          const normalized = {
            id: folder.id,
            orgId: folder.orgId || folder.org_id,
            name: folder.name || folder.id,
            color: folder.color || null,
            isPublic:
              Object.prototype.hasOwnProperty.call(folder, 'isPublic') && folder.isPublic != null
                ? !!folder.isPublic
                : folder.is_public === 1,
            isActive:
              Object.prototype.hasOwnProperty.call(folder, 'isActive') && folder.isActive != null
                ? !!folder.isActive
                : folder.is_active !== 0,
            isSystem:
              Object.prototype.hasOwnProperty.call(folder, 'isSystem') && folder.isSystem != null
                ? !!folder.isSystem
                : folder.is_system === 1,
            sortOrder:
              Object.prototype.hasOwnProperty.call(folder, 'sortOrder') && folder.sortOrder != null
                ? folder.sortOrder
                : folder.sort_order,
            memberUserIds: normalMemberIds,
            memberCount:
              folder.memberCount != null
                ? folder.memberCount
                : normalMemberIds.length > 0
                ? normalMemberIds.length
                : null,
            createdAt: folder.createdAt || folder.created_at_ms || folder.createdAtMs || null,
            updatedAt:
              folder.updatedAt ||
              folder.updated_at_ms ||
              folder.updatedAtMs ||
              (typeof folder.updatedAt === 'number' ? folder.updatedAt : Date.now()),
          };
          const idx = Array.isArray(FOLDERS)
            ? FOLDERS.findIndex(function (f) {
                return f && f.id === normalized.id;
              })
            : -1;
          if (idx >= 0) {
            FOLDERS[idx] = Object.assign({}, FOLDERS[idx], normalized);
          } else {
            FOLDERS.push(normalized);
          }
          window.folders = FOLDERS.slice();
          populateFolderSelects();
          TemplateController.clearCache();
          renderAdminFolderList();
          if (
            globalThis.AdminTemplateController &&
            typeof globalThis.AdminTemplateController.refreshFolders === 'function'
          ) {
            globalThis.AdminTemplateController.refreshFolders();
          }
          if (!state.editingId) {
            const select = byId('messageFolder');
            if (select) {
              select.value = normalized.id;
              MessageDraftController.handleFolderChange(normalized.id);
            }
          }
        }

        async function saveFolder() {
          const name = (byId('quickFolderName') && byId('quickFolderName').value.trim()) || '';
          if (!name) {
            showError('フォルダ名を入力してください。');
            return;
          }
          const color = (byId('quickFolderColor') && byId('quickFolderColor').value) || '#517cb2';
          const isPublic =
            byId('quickFolderPublic') && byId('quickFolderPublic').checked ? true : false;
          const members = isPublic ? [] : Array.from(state.selectedMembers);
          setSavingState(true);
          showError('');
          try {
            const result = await apiRequest(
              state.editingId
                ? `${API_BASE_PATH}/folders/${encodeURIComponent(state.editingId)}`
                : `${API_BASE_PATH}/folders`,
              {
                method: state.editingId ? 'PATCH' : 'POST',
                body: {
                  name,
                  color,
                  isPublic,
                  memberUserIds: members,
                },
              }
            );
            if (result && result.id) {
              upsertFolder(result);
            }
            const modalEl = byId(MODAL_ID);
            if (modalEl) {
              const modal = bootstrap.Modal.getInstance(modalEl);
              if (modal) modal.hide();
            }
            notify(state.editingId ? 'フォルダを更新しました。' : 'フォルダを作成しました。', true);
          } catch (err) {
            console.warn('Failed to save folder:', err);
            showError(err && err.message ? err.message : 'フォルダの保存に失敗しました。');
          } finally {
            state.editingId = '';
            setSavingState(false);
          }
        }

        return {
          open,
          save: saveFolder,
          toggleMembers: toggleMemberVisibility,
        };
      })();
      on('btnAdminNewFolder', 'click', function (event) {
        event.preventDefault();
        QuickFolderController.open();
      });
      on('btnAdminFolderReload', 'click', function (event) {
        event.preventDefault();
        reloadFoldersFromApi();
      });

      async function reloadFoldersFromApi() {
        var tbody = byId('adminFolderList');
        if (tbody) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-muted">フォルダを再読込中...</td></tr>';
        }
        try {
          const list = await apiRequest(`${API_BASE_PATH}/folders?includeMembers=1`, {
            method: 'GET',
          });
          if (Array.isArray(list)) {
            FOLDERS = list;
            window.folders = FOLDERS.slice();
            populateFolderSelects();
            TemplateController.clearCache();
            if (
              globalThis.AdminTemplateController &&
              typeof globalThis.AdminTemplateController.refreshFolders === 'function'
            ) {
              globalThis.AdminTemplateController.refreshFolders();
            }
            if (
              globalThis.AdminTemplateController &&
              typeof globalThis.AdminTemplateController.refreshTemplates === 'function'
            ) {
              globalThis.AdminTemplateController.refreshTemplates();
            }
            renderAdminFolderList();
            return;
          }
        } catch (err) {
          console.warn('Failed to reload folders:', err);
          notify('フォルダ一覧の再読込に失敗しました: ' + (err.message || ''), false);
        }
        renderAdminFolderList();
      }

      function renderAdminFolderList() {
        var tbody = byId('adminFolderList');
        if (!tbody) return;
        if (!IS_MANAGER) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-muted">管理者のみ利用できます。</td></tr>';
          return;
        }
        if (!Array.isArray(FOLDERS) || !FOLDERS.length) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-muted">フォルダがまだありません。</td></tr>';
          return;
        }
        tbody.innerHTML = FOLDERS.map(function (folder) {
          var isPublic =
            Object.prototype.hasOwnProperty.call(folder, 'isPublic') && folder.isPublic != null
              ? !!folder.isPublic
              : folder.is_public === 1;
          var isActive =
            Object.prototype.hasOwnProperty.call(folder, 'isActive') && folder.isActive != null
              ? !!folder.isActive
              : folder.is_active !== 0;
          var isSystem =
            Object.prototype.hasOwnProperty.call(folder, 'isSystem') && folder.isSystem != null
              ? !!folder.isSystem
              : folder.is_system === 1;
          var badge = isPublic ? '公開' : '限定';
          var icon = isPublic ? 'lock_open' : 'lock';
          var colorDot =
            '<span class="folder-color-dot" style="background:' +
            esc(folder.color || '#517cb2') +
            '"></span>';
          var memberCount =
            folder.memberCount != null
              ? folder.memberCount
              : Array.isArray(folder.memberUserIds)
              ? folder.memberUserIds.length
              : '—';
          var memberCountLabel = esc(String(memberCount));
          var stateBadges = [];
          if (!isActive)
            stateBadges.push('<span class="folder-state-badge is-inactive">無効</span>');
          if (isSystem) stateBadges.push('<span class="folder-state-badge is-system">固定</span>');
          var stateBadgeHtml = stateBadges.length
            ? '<div class="folder-meta-badges">' + stateBadges.join('') + '</div>'
            : '';
          var updatedLabel = folder.updatedAt ? new Date(folder.updatedAt).toLocaleString() : '—';
          var actions =
            IS_MANAGER && !isSystem
              ? '<button class="btn btn-sm btn-outline-secondary" type="button" data-folder-edit="' +
                esc(folder.id) +
                '">' +
                '<span class="material-icons-outlined align-middle me-1">edit</span>編集' +
                '</button>'
              : '';
          return (
            '<tr>' +
            '<td>' +
            '<div class="folder-name-cell">' +
            colorDot +
            '<div class="folder-name-body">' +
            '<strong>' +
            esc(folder.name || folder.id) +
            '</strong>' +
            stateBadgeHtml +
            '</div>' +
            '</div>' +
            '</td>' +
            '<td><span class="folder-visibility-chip ' +
            (isPublic ? 'is-public' : 'is-private') +
            '">' +
            '<span class="material-icons-outlined align-middle" aria-hidden="true">' +
            icon +
            '</span>' +
            badge +
            '</span></td>' +
            '<td><span class="folder-pill">' +
            memberCountLabel +
            '</span></td>' +
            '<td><div class="folder-updated">' +
            '<span class="material-icons-outlined align-middle" aria-hidden="true">schedule</span>' +
            '<span>' +
            esc(updatedLabel) +
            '</span>' +
            '</div></td>' +
            '<td class="text-end">' +
            actions +
            '</td>' +
            '</tr>'
          );
        }).join('');
        tbody.querySelectorAll('[data-folder-edit]').forEach(function (btn) {
          btn.addEventListener('click', function (event) {
            event.preventDefault();
            var targetId = btn.getAttribute('data-folder-edit');
            if (targetId) {
              QuickFolderController.open(targetId);
            }
          });
        });
      }

      function setBootstrapLoading(isLoading) {
        var body = document.body;
        if (body) {
          body.classList.toggle('bootstrapping', !!isLoading);
        }
        var metaTheme = document.querySelector('meta[name="theme-color"]');
        var appleStatus = document.querySelector(
          'meta[name="apple-mobile-web-app-status-bar-style"]'
        );
        var pref = document.documentElement.dataset.themePref || 'light';
        var resolvedPref =
          typeof resolveThemePreference === 'function' ? resolveThemePreference(pref) : pref;
        if (isLoading) {
          var getPrimary =
            typeof window.__SHIFT_FLOW_GET_PRIMARY__ === 'function'
              ? window.__SHIFT_FLOW_GET_PRIMARY__
              : function (mode) {
                  if (mode === 'dark') return '#4b67b3';
                  return '#517cb2';
                };
          var primaryColor = getPrimary(resolvedPref);
          if (metaTheme && primaryColor) {
            metaTheme.setAttribute('content', primaryColor);
          }
          if (appleStatus) {
            appleStatus.setAttribute(
              'content',
              resolvedPref === 'dark' ? 'black-translucent' : 'default'
            );
          }
        } else if (typeof syncThemeMeta === 'function') {
          syncThemeMeta(resolvedPref);
        }
        var loadingEl = byId('bootstrap-loading');
        if (!loadingEl) return;
        if (isLoading) {
          loadingEl.setAttribute('aria-hidden', 'false');
          loadingEl.setAttribute('aria-busy', 'true');
        } else {
          loadingEl.setAttribute('aria-hidden', 'true');
          loadingEl.removeAttribute('aria-busy');
        }
      }

      function isAuthError(err) {
        if (!err) return false;
        if (err.authRequired === true) return true;
        if (err.status === 401 || err.status === 403) return true;
        var msg = String(err.message || '');
        return msg.indexOf('Non-JSON response from backend') !== -1;
      }

      function applyBootstrapState(bootstrap) {
        var normalized = bootstrap || {};
        window.__SHIFT_FLOW_BOOTSTRAP__ = normalized;
        window.userInfo = normalized.userInfo || {};
        window.users = Array.isArray(normalized.users) ? normalized.users : [];
        window.folders = Array.isArray(normalized.folders) ? normalized.folders : [];
        window.pinnedMessages =
          normalized.pinnedMessages && typeof normalized.pinnedMessages === 'object'
            ? normalized.pinnedMessages
            : {};
        window.initialTasks =
          normalized.myTasks && typeof normalized.myTasks === 'object'
            ? normalized.myTasks
            : { tasks: [], meta: {} };
        window.isManager = !!normalized.isManager;

        ACTIVE_USERS = Array.isArray(window.users) ? window.users : [];
        FOLDERS = Array.isArray(window.folders) ? window.folders : [];
        PINNED_MESSAGES =
          normalized.pinnedMessages && typeof normalized.pinnedMessages === 'object'
            ? normalized.pinnedMessages
            : {};
        renderAdminFolderList();
        IS_MANAGER = !!normalized.isManager;

        var userInfo = normalized.userInfo || {};
        CURRENT_USER_EMAIL = String(userInfo.email || '');
        HAS_ACTIVE_EMAIL = CURRENT_USER_EMAIL.length > 0;
        USER_IMAGE_URL = typeof userInfo.imageUrl === 'string' ? userInfo.imageUrl : USER_IMAGE_URL;
        TASKS_BOOTSTRAPPED = false;
        INITIAL_MY_TASK_PAYLOAD = window.initialTasks;

        rebuildUserMap();
        applyBootstrapBindings(normalized);
        applyUserAvatar(userInfo.imageUrl || '');
        var themeValue = userInfo.theme || normalized.theme || themePreference;
        applyThemePreference(themeValue);
        updateThemeStatus(themeValue);
        if (
          userInfo.language &&
          window.I18n &&
          typeof window.I18n.setLanguage === 'function' &&
          window.I18n.currentLang !== userInfo.language
        ) {
          window.I18n.setLanguage(userInfo.language);
        }

        toggleManagerUI();
        updateTestMenuShortcut();
        if (typeof TASK_STATE !== 'undefined' && TASK_STATE.all) {
          TASK_STATE.all.restricted = !IS_MANAGER;
        }
        populateAssigneeFilters();
        renderAssigneeList();
        populateFolderSelects();
        TemplateController.clearCache();
        if (
          globalThis.AdminTemplateController &&
          typeof globalThis.AdminTemplateController.refreshFolders === 'function'
        ) {
          globalThis.AdminTemplateController.refreshFolders();
        }
        if (
          globalThis.AdminTemplateController &&
          typeof globalThis.AdminTemplateController.refreshTemplates === 'function'
        ) {
          globalThis.AdminTemplateController.refreshTemplates();
        }
        var shouldCacheBootstrap = true;
        var responseMeta =
          (typeof window !== 'undefined' && window.__SHIFT_FLOW_RESPONSE_META__) || {};
        var bootstrapMeta = responseMeta && responseMeta.getBootstrapData;
        if (
          bootstrapMeta &&
          bootstrapMeta.status === 'STALE' &&
          typeof RESTORED_BOOTSTRAP_FROM_CACHE === 'boolean' &&
          RESTORED_BOOTSTRAP_FROM_CACHE
        ) {
          shouldCacheBootstrap = false;
          console.info('[ShiftFlow] Skipped caching stale bootstrap payload.');
        }
        if (shouldCacheBootstrap) {
          cacheBootstrapSnapshot(normalized);
        }
      }

      function hydrateBootstrap() {
        if (!window.__SHIFT_FLOW_AUTH_TOKEN__) {
          return Promise.reject({ authRequired: true, message: 'Auth token missing' });
        }
        if (
          !(
            globalThis.google &&
            google.script &&
            google.script.run &&
            typeof google.script.run.getBootstrapData === 'function'
          )
        ) {
          toggleManagerUI();
          populateAssigneeFilters();
          populateFolderSelects();
          renderAssigneeList();
          return Promise.resolve();
        }
        return new Promise(function (resolve, reject) {
          google.script.run
            .withSuccessHandler(function (payload) {
              if (payload && typeof payload === 'object') {
                applyBootstrapState(payload);
              } else {
                toggleManagerUI();
                populateAssigneeFilters();
                populateFolderSelects();
                renderAssigneeList();
              }
              resolve();
            })
            .withFailureHandler(function (err) {
              console.error('Bootstrap fetch failed:', err);
              var authError = isAuthError(err);
              if (!authError) {
                notify(
                  '初期データの取得に失敗しました: ' +
                    (err && err.message ? err.message : '原因不明のエラー'),
                  false
                );
              }
              toggleManagerUI();
              populateAssigneeFilters();
              populateFolderSelects();
              renderAssigneeList();
              if (authError) {
                reject(err || { authRequired: true });
              } else {
                resolve();
              }
            })
            .getBootstrapData();
        });
      }

      function refreshDataAfterBootstrap() {
        if (!HAS_ACTIVE_EMAIL) {
          return;
        }
        loadHome();
        loadMessages();
        if (typeof TASK_STATE !== 'undefined') {
          if (TASK_STATE.my) {
            TASK_STATE.my.loaded = false;
            loadMyTasks();
          }
          if (TASK_STATE.from) {
            TASK_STATE.from.loaded = false;
            loadCreatedTasks();
          }
          if (TASK_STATE.all && IS_MANAGER) {
            TASK_STATE.all.loaded = false;
            loadAllTasks();
          }
        }
      }

      document.addEventListener('click', function (event) {
        var target =
          typeof event.target.closest === 'function'
            ? event.target.closest('[data-action="auth-retry"]')
            : null;
        if (!target) return;
        event.preventDefault();
        target.disabled = true;
        target.setAttribute('aria-busy', 'true');
        setBootstrapLoading(true);
        hydrateBootstrap()
          .then(function () {
            refreshDataAfterBootstrap();
          })
          .catch(function (err) {
            console.error('Auth retry failed:', err);
          })
          .then(function () {
            setBootstrapLoading(false);
            target.disabled = false;
            target.removeAttribute('aria-busy');
          });
      });

      toggleManagerUI();
      populateAssigneeFilters();
      populateFolderSelects();

      // ----- Bridge google.script.run calls when Apps Script runtime is unavailable -----
      (function ensureGoogleScriptRun() {
        if (!globalThis.google) globalThis.google = {};
        if (!globalThis.google.script) globalThis.google.script = {};
        var existing = globalThis.google.script.run;
        if (existing && !existing.__isStub) {
          return;
        }

        var chainState = {
          success: null,
          failure: null,
          userObject: undefined,
        };

        function resetChain() {
          chainState.success = null;
          chainState.failure = null;
          chainState.userObject = undefined;
        }

        function deliver(handler, payload, userObject) {
          if (typeof handler !== 'function') {
            return;
          }
          try {
            if (userObject !== undefined) handler(payload, userObject);
            else handler(payload);
          } catch (handlerErr) {
            console.error('[ShiftFlow] handler execution failed', handlerErr);
          }
        }

        function deliverFailure(handler, error, userObject) {
          var requestId = extractRequestIdFromError(error);
          if (typeof handler === 'function') {
            if (requestId) {
              announceRequestId(requestId);
            }
            deliver(handler, error, userObject);
            return;
          }
          if (error && (error.authRequired || error.status === 401 || error.status === 403)) {
            console.info('[ShiftFlow] auth required, prompting authentication.');
            clearAuthToken();
            var overlayMessage = '再度 Google でログインしてください。';
            if (error && error.response && error.response.reason) {
              overlayMessage = String(error.response.reason);
            } else if (error && error.response && error.response.error) {
              overlayMessage = String(error.response.error);
            }
            showAuthOverlay({ message: overlayMessage, requestId: requestId });
            if (requestId) {
              announceRequestId(requestId, { duration: 8000 });
            }
            syncAuthSession({ silent: true }).catch(function () {});
            return;
          }
          console.error('[ShiftFlow] backend request failed', error);
          if (requestId) {
            announceRequestId(requestId);
          }
        }

        function createError(message, extra) {
          var err = new Error(message || 'Request failed');
          if (extra && typeof extra === 'object') {
            Object.keys(extra).forEach(function (key) {
              if (key === 'message') return;
              err[key] = extra[key];
            });
          }
          return err;
        }

        function handleTestRoute(route, argsSnapshot, handlers) {
          var testState = globalThis.__SHIFT_FLOW_TEST_MODE__;
          if (!testState || !testState.active || typeof testState.handleRoute !== 'function') {
            return false;
          }
          var delayMs = Number(testState.networkDelayMs || 200);
          setTimeout(
            function () {
              Promise.resolve()
                .then(function () {
                  return testState.handleRoute(route, argsSnapshot || []);
                })
                .then(function (payload) {
                  deliver(handlers.success, payload, handlers.userObject);
                })
                .catch(function (err) {
                  var normalized =
                    err instanceof Error
                      ? err
                      : createError(String(err || 'Test mode failure'), { route: route });
                  deliverFailure(handlers.failure, normalized, handlers.userObject);
                });
            },
            delayMs >= 0 ? delayMs : 0
          );
          return true;
        }

        // === Helpers ===
        let _lastSessionCheck = 0;
        async function _ensureSessionToken(forceReload) {
          if (!forceReload && AUTH_READY && window.__SHIFT_FLOW_AUTH_TOKEN__) {
            return window.__SHIFT_FLOW_AUTH_TOKEN__;
          }
          const now = Date.now();
          if (!forceReload && now - _lastSessionCheck < 500) {
            return window.__SHIFT_FLOW_AUTH_TOKEN__;
          }
          _lastSessionCheck = now;
          const session = await syncAuthSession({ silent: true });
          if (session && session.authenticated && window.__SHIFT_FLOW_AUTH_TOKEN__) {
            return window.__SHIFT_FLOW_AUTH_TOKEN__;
          }
          throw new Error('NO_SESSION');
        }

        function _rid() {
          return createRequestId();
        }

        function invokeRemote(route, argsSnapshot, handlers) {
          var url = API_BASE_PATH + '/' + encodeURIComponent(route);

          async function _doFetch(forceRefresh) {
            await _ensureSessionToken(forceRefresh);
            const init = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Accept: 'application/json',
                'X-ShiftFlow-Request-Id': _rid(),
              },
              credentials: 'include',
              body: JSON.stringify({ route: route, args: argsSnapshot }),
            };

            const res = await fetch(url, init);
            const ctype = res.headers.get('content-type') || '';
            if (ctype.indexOf('application/json') === -1) {
              const text = await res.text();
              const authRequired =
                res.status === 200 &&
                (text.includes('accounts.google.com') ||
                  text.includes('google-signin') ||
                  text.includes('<form'));
              throw createError('Non-JSON response from backend', {
                status: res.status,
                statusText: res.statusText,
                route,
                raw: text,
                authRequired,
              });
            }
            const body = await res.json();
            return { res, body };
          }

          (async () => {
            try {
              if (handleTestRoute(route, argsSnapshot, handlers)) {
                return;
              }
              let packet = await _doFetch(false);
              if (!packet.res.ok && packet.res.status === 401) {
                clearAuthToken();
                await syncAuthSession({ silent: false });
                packet = await _doFetch(true);
              }

              const res = packet.res,
                body = packet.body || {};
              const { success: successHandler, failure: failureHandler, userObject } = handlers;

              if (!res.ok) {
                const reason = typeof body?.reason === 'string' ? body.reason : '';
                const msg = reason || `HTTP ${res.status} calling ${route}`;
                const httpError = createError(msg, {
                  status: res.status,
                  statusText: res.statusText,
                  route,
                  code: body?.code,
                  where: body?.where,
                  requestId: body?.requestId,
                  response: body,
                });
                const extractedRequestId = extractRequestIdFromPayload(body);
                if (extractedRequestId) {
                  announceRequestId(extractedRequestId);
                }
                if (res.status === 403 && body?.code === 'shared_secret_mismatch') {
                  httpError.hint =
                    'Shared secret はブラウザではなく Functions→GAS 間で一致させてください。';
                }
                deliverFailure(failureHandler, httpError, userObject);
                return;
              }

              if (body.ok === false) {
                const reason =
                  typeof body.reason === 'string' ? body.reason : 'Unknown backend error';
                const backendError = createError(reason, {
                  route,
                  code: body?.code,
                  where: body?.where,
                  requestId: body?.requestId,
                  response: body,
                });
                const bodyRequestId = extractRequestIdFromPayload(body);
                if (bodyRequestId) {
                  announceRequestId(bodyRequestId);
                }
                deliverFailure(failureHandler, backendError, userObject);
                return;
              }

              const cacheStatusHeader = res.headers.get('x-shiftflow-cache') || '';
              const cacheAgeHeader = res.headers.get('x-shiftflow-cache-age') || '';
              if (typeof window !== 'undefined') {
                if (!window.__SHIFT_FLOW_RESPONSE_META__) {
                  window.__SHIFT_FLOW_RESPONSE_META__ = {};
                }
                var ageMs = Number(cacheAgeHeader);
                if (!Number.isFinite(ageMs) || ageMs < 0) {
                  ageMs = null;
                }
                window.__SHIFT_FLOW_RESPONSE_META__[route] = {
                  status: cacheStatusHeader ? cacheStatusHeader.toUpperCase() : '',
                  ageMs: ageMs,
                  receivedAt: Date.now(),
                };
                if (
                  route === 'getBootstrapData' &&
                  cacheStatusHeader &&
                  cacheStatusHeader.toUpperCase() === 'STALE'
                ) {
                  if (!window.__SHIFT_FLOW_PENDING_BOOTSTRAP_REFRESH__) {
                    window.__SHIFT_FLOW_PENDING_BOOTSTRAP_REFRESH__ = true;
                    setTimeout(function () {
                      window.__SHIFT_FLOW_PENDING_BOOTSTRAP_REFRESH__ = false;
                      if (typeof bootstrapAfterAuth === 'function') {
                        try {
                          bootstrapAfterAuth({ silent: true });
                        } catch (refreshErr) {
                          console.warn(
                            '[ShiftFlow] bootstrap refresh after stale cache failed',
                            refreshErr
                          );
                        }
                      }
                    }, 1800);
                  }
                }
              }

              var payload =
                body && Object.prototype.hasOwnProperty.call(body, 'result') ? body.result : body;
              deliver(successHandler, payload, userObject);
            } catch (err) {
              const wrapped =
                err instanceof Error ? err : createError('Network error', { cause: err });
              wrapped.route = route;
              deliverFailure(handlers.failure, wrapped, handlers.userObject);
            }
          })();
        }

        var runProxy = new Proxy(function () {}, {
          get: function (target, prop) {
            if (prop === '__isStub') return false;
            if (prop === '__bridge') return 'fetch';
            if (prop === 'withSuccessHandler') {
              return function (fn) {
                chainState.success = typeof fn === 'function' ? fn : null;
                return runProxy;
              };
            }
            if (prop === 'withFailureHandler') {
              return function (fn) {
                chainState.failure = typeof fn === 'function' ? fn : null;
                return runProxy;
              };
            }
            if (prop === 'withUserObject') {
              return function (obj) {
                chainState.userObject = obj;
                return runProxy;
              };
            }
            if (prop === 'toString') {
              return function () {
                return '[object GoogleScriptRunBridge]';
              };
            }
            if (prop === 'then') {
              return undefined;
            }
            return function () {
              var argsSnapshot = Array.prototype.slice.call(arguments || []);
              var handlers = {
                success: chainState.success,
                failure: chainState.failure,
                userObject: chainState.userObject,
              };
              resetChain();
              invokeRemote(String(prop), argsSnapshot, handlers);
              return runProxy;
            };
          },
          apply: function (target, thisArg, argList) {
            if (!argList || argList.length === 0) {
              throw new Error('google.script.run requires a target function name.');
            }
            var route = String(argList[0] || '').trim();
            if (!route) {
              throw new Error('google.script.run requires a non-empty function name.');
            }
            var argsSnapshot = Array.prototype.slice.call(argList, 1);
            var handlers = {
              success: chainState.success,
              failure: chainState.failure,
              userObject: chainState.userObject,
            };
            resetChain();
            invokeRemote(route, argsSnapshot, handlers);
            return runProxy;
          },
        });

        globalThis.google.script.run = runProxy;
      })();

      function resolveThemePreference(pref) {
        if (pref === 'system') {
          return THEME_MEDIA && THEME_MEDIA.matches ? 'dark' : 'light';
        }
        return pref || 'light';
      }
      function createRequestId() {
        if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
          return crypto.randomUUID();
        }
        return 'req_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function applyResolvedTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        syncThemeMeta(theme);
      }
      function applyThemePreference(pref) {
        themePreference = pref || 'light';
        document.documentElement.dataset.themePref = themePreference;
        applyResolvedTheme(resolveThemePreference(themePreference));
      }
      function applyUserAvatar(url) {
        var candidate = typeof url === 'string' ? url.trim() : '';
        document.querySelectorAll('.js-user-avatar').forEach(function (el) {
          var fallback = String(el.getAttribute('data-avatar-url') || '').trim();
          var selected = candidate || fallback || PROFILE_PLACEHOLDER_URL;
          el.src = selected;
          el.setAttribute('data-avatar-url', selected);
        });
      }

      function buildGasAuthUrl(returnTo) {
        if (!GAS_WEB_APP_URL) return '';
        var base = GAS_WEB_APP_URL;
        var separator = base.indexOf('?') >= 0 ? '&' : '?';
        var target = String(returnTo || window.location.href || '').trim();
        return base + separator + 'return=' + encodeURIComponent(target);
      }

      applyThemePreference(themePreference);
      applyUserAvatar(USER_IMAGE_URL);

      if (THEME_MEDIA) {
        var themeMediaListener = function () {
          if (themePreference === 'system') {
            applyResolvedTheme(resolveThemePreference(themePreference));
          }
        };
        if (typeof THEME_MEDIA.addEventListener === 'function') {
          THEME_MEDIA.addEventListener('change', themeMediaListener);
        } else if (typeof THEME_MEDIA.addListener === 'function') {
          THEME_MEDIA.addListener(themeMediaListener);
        }
      }

      function describeThemeValue(value) {
        var key;
        switch ((value || '').toLowerCase()) {
          case 'dark':
            key = 'settings_theme_option_dark';
            break;
          case 'system':
            key = 'settings_theme_option_system';
            break;
          default:
            key = 'settings_theme_option_light';
            break;
        }
        if (globalThis.I18n && typeof globalThis.I18n.t === 'function') {
          return globalThis.I18n.t(key);
        }
        switch (key) {
          case 'settings_theme_option_dark':
            return 'ダーク';
          case 'settings_theme_option_system':
            return 'システム';
          default:
            return 'ライト';
        }
      }
      function getThemeStatusIcon(value) {
        switch ((value || '').toLowerCase()) {
          case 'dark':
            return 'dark_mode';
          case 'system':
            return 'contrast';
          default:
            return 'light_mode';
        }
      }
      function getThemeStatusLabel(value) {
        var key;
        switch ((value || '').toLowerCase()) {
          case 'dark':
            key = 'settings_theme_status_dark';
            break;
          case 'system':
            key = 'settings_theme_status_system';
            break;
          default:
            key = 'settings_theme_status_light';
            break;
        }
        if (globalThis.I18n && typeof globalThis.I18n.t === 'function') {
          return globalThis.I18n.t(key);
        }
        switch (key) {
          case 'settings_theme_status_dark':
            return 'ダークテーマを適用中';
          case 'settings_theme_status_system':
            return 'システム設定に連動中';
          default:
            return 'ライトテーマを適用中';
        }
      }
      function updateThemeStatus(value) {
        var display = byId('setting-theme-display');
        if (!display) return;
        var icon = getThemeStatusIcon(value);
        var label = getThemeStatusLabel(value);
        display.innerHTML =
          '<span class="material-icons-outlined align-middle">' +
          esc(icon) +
          '</span><span>' +
          esc(label) +
          '</span>';
      }
      document.addEventListener('shiftflow:languagechange', function () {
        var select = byId('setting-theme');
        var current = select ? select.value : themePreference;
        updateThemeStatus(current || themePreference);
      });

      // ===== ヘルパ =====
      function $$(selector, root) {
        return Array.prototype.slice.call((root || document).querySelectorAll(selector));
      }
      function byId(id) {
        return document.getElementById(id);
      }
      let userMap = new Map();

      function rebuildUserMap() {
        userMap = new Map(
          ACTIVE_USERS.filter(function (u) {
            return u && typeof u.email === 'string';
          }).map(function (u) {
            var normalized = normalizeEmailValue(u.email);
            return [
              normalized,
              {
                email: u.email,
                name: u.name || u.displayName || u.email || '',
                imageUrl:
                  typeof u.imageUrl === 'string' && u.imageUrl
                    ? u.imageUrl
                    : PROFILE_PLACEHOLDER_URL,
              },
            ];
          })
        );
      }
      rebuildUserMap();

      function getUserProfile(email) {
        if (!email) return null;
        var normalized = normalizeEmailValue(email);
        return userMap.get(normalized) || null;
      }

      function getNameByEmail(email) {
        var profile = getUserProfile(email);
        if (profile && profile.name) return profile.name;
        return email;
      }
      function on(id, ev, fn) {
        var el = byId(id);
        if (el) {
          el.addEventListener(ev, fn);
        }
      }
      function notify(msg, ok, options) {
        options = options || {};
        var wrap = byId('notification-area');
        if (!wrap) return;
        wrap.removeAttribute('hidden');
        var isCentered = options.position === 'center';
        wrap.classList.toggle('is-centered', !!isCentered);
        var el = document.createElement('div');
        el.className =
          'alert ' +
          (ok !== false ? 'alert-success' : 'alert-danger') +
          ' alert-dismissible fade show';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'space-between';
        el.style.gap = '12px';
        var textSpan = document.createElement('div');
        textSpan.className = 'flex-grow-1';
        textSpan.textContent = msg;
        el.appendChild(textSpan);
        if (options.actionLabel && typeof options.onAction === 'function') {
          var actionBtn = document.createElement('button');
          actionBtn.type = 'button';
          actionBtn.className = 'btn btn-sm btn-primary';
          actionBtn.textContent = options.actionLabel;
          actionBtn.addEventListener('click', function () {
            options.onAction();
            dismiss();
          });
          el.appendChild(actionBtn);
        }
        var closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'btn-close';
        closeBtn.setAttribute('aria-label', 'Close');
        closeBtn.addEventListener('click', function () {
          if (typeof options.onClose === 'function') {
            try {
              options.onClose();
            } catch (_err) {
              /* noop */
            }
          }
          dismiss();
        });
        el.appendChild(closeBtn);
        wrap.appendChild(el);
        var ttl = typeof options.duration === 'number' ? options.duration : 2200;
        if (ttl > 0) {
          setTimeout(dismiss, ttl);
        }
        function dismiss() {
          el.classList.remove('show');
          setTimeout(function () {
            el.remove();
            if (!wrap.children.length) {
              wrap.setAttribute('hidden', 'hidden');
            }
          }, 150);
        }
      }

      var LAST_ERROR_REQUEST_ID = '';
      var LAST_ERROR_REQUEST_AT = 0;

      function normalizeRequestId(value) {
        if (!value) return '';
        var text = String(value).trim();
        return text;
      }

      function extractRequestIdFromPayload(payload) {
        if (!payload || typeof payload !== 'object') return '';
        if (typeof payload.requestId === 'string' && payload.requestId.trim()) {
          return payload.requestId.trim();
        }
        if (typeof payload.request_id === 'string' && payload.request_id.trim()) {
          return payload.request_id.trim();
        }
        if (typeof payload.requestID === 'string' && payload.requestID.trim()) {
          return payload.requestID.trim();
        }
        return '';
      }

      function extractRequestIdFromError(error) {
        if (!error) return '';
        if (typeof error.requestId === 'string' && error.requestId.trim()) {
          return error.requestId.trim();
        }
        if (error.response && typeof error.response === 'object') {
          var embedded = extractRequestIdFromPayload(error.response);
          if (embedded) return embedded;
        }
        return '';
      }

      function announceRequestId(requestId, options) {
        var normalized = normalizeRequestId(requestId);
        if (!normalized) return;
        var now = Date.now();
        if (LAST_ERROR_REQUEST_ID === normalized && now - LAST_ERROR_REQUEST_AT < 2000) {
          return;
        }
        LAST_ERROR_REQUEST_ID = normalized;
        LAST_ERROR_REQUEST_AT = now;
        var message = 'エラー ID: ' + normalized + '（管理者に共有してください）';
        notify(message, false, {
          duration: (options && options.duration) || 6000,
        });
      }

      function promptForAppUpdate(data) {
        var pendingVersion = (data && data.version) || APP_VERSION_LABEL || 'unknown';
        var dismissKey = APP_UPDATE_DISMISS_PREFIX + pendingVersion;
        try {
          if (localStorage.getItem(dismissKey)) {
            return;
          }
        } catch (_err) {
          /* noop */
        }
        if (APP_UPDATE_PROMPTED) return;
        APP_UPDATE_PROMPTED = true;
        var versionLabel = data && data.version ? '（' + data.version + '）' : '';
        notify('最新版がリリースされました' + versionLabel + '。更新しますか？', true, {
          actionLabel: '更新する',
          onAction: function () {
            markUpdateDismissed(dismissKey);
            applyAppShellUpdate();
          },
          duration: 0,
          position: 'center',
          onClose: function () {
            markUpdateDismissed(dismissKey);
          },
        });
      }

      function applyAppShellUpdate() {
        if (APP_UPDATE_REFRESHING) return;
        if (!navigator.serviceWorker || !navigator.serviceWorker.getRegistration) {
          window.location.reload();
          return;
        }
        navigator.serviceWorker.getRegistration().then(function (registration) {
          if (!registration) {
            window.location.reload();
            return;
          }
          var waitingWorker = registration.waiting;
          if (waitingWorker) {
            requestSkipWaiting(waitingWorker);
            return;
          }
          var installingWorker = registration.installing;
          if (installingWorker) {
            if (installingWorker.state === 'installed' && registration.waiting) {
              requestSkipWaiting(registration.waiting);
              return;
            }
            var handleStateChange = function () {
              if (installingWorker.state === 'installed' && registration.waiting) {
                installingWorker.removeEventListener('statechange', handleStateChange);
                requestSkipWaiting(registration.waiting);
              } else if (installingWorker.state === 'redundant') {
                installingWorker.removeEventListener('statechange', handleStateChange);
                window.location.reload();
              }
            };
            installingWorker.addEventListener('statechange', handleStateChange);
            return;
          }
          window.location.reload();
        });
      }

      function requestSkipWaiting(worker) {
        try {
          worker.postMessage({ type: 'SKIP_WAITING' });
        } catch (_err) {
          window.location.reload();
          return;
        }
        waitForControllerChange();
      }

      function waitForControllerChange() {
        function onControllerChange() {
          navigator.serviceWorker.removeEventListener('controllerchange', onControllerChange);
          if (APP_UPDATE_REFRESHING) return;
          APP_UPDATE_REFRESHING = true;
          window.location.reload();
        }
        navigator.serviceWorker.addEventListener('controllerchange', onControllerChange);
      }
      var HISTORY_GUARD_ACTIVE = false;
      var OVERLAY_HISTORY_STACK = [];
      var MESSAGE_MODAL_HISTORY_ACTIVE = false;
      var MESSAGE_MODAL_CLOSING_FROM_HISTORY = false;
      function ensureBaseHistoryState(view) {
        if (!window.history || typeof window.history.replaceState !== 'function') return;
        var state = window.history.state || {};
        if (state && state.shiftflowBase) return;
        var next = Object.assign({}, state, {
          shiftflowBase: true,
          shiftflowView: view || (typeof CURRENT_VIEW === 'string' ? CURRENT_VIEW : 'home'),
          ts: Date.now(),
        });
        try {
          window.history.replaceState(next, document.title, window.location.href);
        } catch (_err) {
          /* noop */
        }
      }
      function pushOverlayHistory(tag) {
        if (!window.history || typeof window.history.pushState !== 'function') return;
        ensureBaseHistoryState();
        var marker = {
          shiftflowModal: true,
          tag: tag,
          id: Date.now() + Math.random(),
        };
        OVERLAY_HISTORY_STACK.push(marker);
        window.history.pushState(marker, document.title, window.location.href);
      }
      function peekOverlayHistoryTag() {
        if (!OVERLAY_HISTORY_STACK.length) return null;
        return OVERLAY_HISTORY_STACK[OVERLAY_HISTORY_STACK.length - 1].tag;
      }
      function popOverlayHistory(tag) {
        if (!OVERLAY_HISTORY_STACK.length) return;
        var last = OVERLAY_HISTORY_STACK[OVERLAY_HISTORY_STACK.length - 1];
        if (tag && last.tag !== tag) return;
        OVERLAY_HISTORY_STACK.pop();
        if (!window.history || typeof window.history.back !== 'function') return;
        HISTORY_GUARD_ACTIVE = true;
        window.history.back();
      }
      ensureBaseHistoryState(CURRENT_VIEW);
      LAST_VIEW_HISTORY = typeof CURRENT_VIEW === 'string' ? CURRENT_VIEW : 'home';
      if (VIEW_HISTORY_SUPPORTED) {
        pushViewHistoryState(LAST_VIEW_HISTORY, true);
      }
      window.addEventListener('popstate', function () {
        if (HISTORY_GUARD_ACTIVE) {
          HISTORY_GUARD_ACTIVE = false;
          return;
        }
        if (!OVERLAY_HISTORY_STACK.length) return;
        var last = OVERLAY_HISTORY_STACK.pop();
        if (!last || !last.tag) return;
        if (last.tag === 'image-viewer') {
          closeImageViewer(true);
          return;
        }
        if (last.tag === 'message-detail') {
          MESSAGE_MODAL_HISTORY_ACTIVE = false;
          MESSAGE_MODAL_CLOSING_FROM_HISTORY = true;
          var modalEl = byId('messageDetailModal');
          var inst =
            modalEl &&
            window.bootstrap &&
            (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl));
          if (inst) inst.hide();
          return;
        }
        if (last.tag === 'admin-view') {
          closeAdminView(true);
          return;
        }
      });
      function setupMessageModalHistoryHooks() {
        var modalEl = byId('messageDetailModal');
        if (!modalEl) return;
        modalEl.addEventListener('show.bs.modal', function () {
          if (!MESSAGE_MODAL_HISTORY_ACTIVE) {
            pushOverlayHistory('message-detail');
            MESSAGE_MODAL_HISTORY_ACTIVE = true;
          }
        });
        modalEl.addEventListener('hidden.bs.modal', function () {
          if (MESSAGE_MODAL_CLOSING_FROM_HISTORY) {
            MESSAGE_MODAL_CLOSING_FROM_HISTORY = false;
            return;
          }
          if (MESSAGE_MODAL_HISTORY_ACTIVE) {
            MESSAGE_MODAL_HISTORY_ACTIVE = false;
            popOverlayHistory('message-detail');
          }
        });
      }
      setupMessageModalHistoryHooks();
      function setAppShellHidden(hidden) {
        $$('[data-app-shell]').forEach(function (el) {
          if (hidden) {
            if (!el.hasAttribute('hidden')) el.setAttribute('hidden', '');
          } else {
            el.removeAttribute('hidden');
          }
        });
      }
      function requestAuthHelp() {
        if (AUTH_HELP_REQUESTED) return;
        AUTH_HELP_REQUESTED = true;
        if (
          !(
            globalThis.google &&
            google.script &&
            google.script.run &&
            typeof google.script.run.getAuthStatus === 'function' &&
            !google.script.run.__isStub
          )
        ) {
          renderAuthHelpDetails(null, true);
          return;
        }
        google.script.run
          .withSuccessHandler(renderAuthHelpDetails)
          .withFailureHandler(function (err) {
            var box = byId('auth-help-details');
            if (!box) return;
            if (isAuthError(err)) {
              box.innerHTML =
                '<div class="alert alert-warning small mb-0">Google アカウントでサインインすると診断情報が表示されます。' +
                '<a class="btn btn-sm btn-primary ms-2" href="' +
                esc(GAS_WEB_APP_URL) +
                '" target="_blank" rel="noopener">Google にサインイン</a></div>';
              return;
            }
            var msg = err && err.message ? err.message : err;
            box.innerHTML =
              '<div class="alert alert-danger small mb-0">診断情報の取得に失敗しました: ' +
              esc(msg || '不明なエラー') +
              '</div>';
          })
          .getAuthStatus();
      }
      function renderAuthHelpDetails(info, isStub) {
        var box = byId('auth-help-details');
        if (!box) return;
        if (isStub) {
          box.innerHTML =
            '<div class="alert alert-info small mb-0">Cloudflare Pages から直接診断詳細を取得することはできません。<br>Google にサインインしてから再読み込みすると、状態が自動で取得されます。</div>';
          return;
        }
        if (!info) {
          box.innerHTML =
            '<div class="alert alert-danger small mb-0">診断データが取得できませんでした。</div>';
          return;
        }
        var parts = [];
        parts.push('<div class="alert alert-info small mb-2">');
        parts.push('<div class="fw-bold mb-1">現在の診断結果</div>');
        parts.push('<ul class="mb-2 ps-3">');
        parts.push(
          '<li>ActiveUser: ' +
            (info.activeEmail
              ? esc(info.activeEmail)
              : '<span class="text-danger">取得不可</span>') +
            '</li>'
        );
        parts.push(
          '<li>EffectiveUser: ' +
            (info.effectiveUserEmail
              ? esc(info.effectiveUserEmail)
              : '<span class="text-muted">不明</span>') +
            '</li>'
        );
        parts.push(
          '<li>スプレッドシートアクセス: ' +
            (info.hasSpreadsheetAccess ? 'OK' : '<span class="text-danger">権限不足</span>') +
            '</li>'
        );
        if (info.userRecord) {
          parts.push(
            '<li>ユーザー登録: ' +
              (info.userRecord.isActive
                ? 'アクティブ'
                : '<span class="text-danger">停止中</span>') +
              '</li>'
          );
        } else if (info.normalizedActiveEmail) {
          parts.push('<li>ユーザー登録: <span class="text-danger">未登録</span></li>');
        }
        parts.push('</ul>');
        if (info.error) {
          parts.push('<div class="text-danger mb-2">エラー: ' + esc(info.error) + '</div>');
        }
        if (info.sheetUrl) {
          parts.push(
            '<div class="mb-1"><a class="link-primary" href="' +
              esc(info.sheetUrl) +
              '" target="_blank" rel="noopener">シートの共有設定を確認</a></div>'
          );
        }
        parts.push(
          '<div class="mb-0">サインインした Google アカウントで ShiftFlow を利用できます。401 が続く場合は再ログインし、Cloudflare 環境変数（GAS_WEB_APP_URL / GOOGLE_CLIENT_ID）が最新か確認してください。</div>'
        );
        parts.push('</div>');
        box.innerHTML = parts.join('');
      }
      function authRequiredCard() {
        requestAuthHelp();
        var signInButton = HAS_GAS_WEB_APP_URL
          ? '<a class="btn btn-primary" href="' +
            esc(GAS_WEB_APP_URL) +
            '" target="_blank" rel="noopener">Google にサインイン</a>'
          : '<button type="button" class="btn btn-primary" disabled>Google にサインイン (未設定)</button>';
        return (
          '<div class="card border-warning"><div class="card-body">' +
          '<p class="mb-2 text-warning"><span class="material-icons align-middle me-1">lock</span>Google アカウントへのサインインが必要です。</p>' +
          '<p class="mb-2">以下の手順を実行してください。</p>' +
          '<ol class="mb-3 ps-3">' +
          '<li>「Google にサインイン」を押して Apps Script Web アプリを開き、組織の Google アカウントで認証します。</li>' +
          '<li>サインイン完了後、このページに戻って「接続を再チェック」を押すか、ページを再読み込みします。</li>' +
          '</ol>' +
          '<div class="d-flex flex-wrap gap-2">' +
          signInButton +
          '<button type="button" class="btn btn-outline-primary" data-action="auth-retry">接続を再チェック</button>' +
          '</div>' +
          '<div id="auth-help-details" class="mt-3"></div>' +
          '</div></div>'
        );
      }

      function setAuthToken(token) {
        window.__SHIFT_FLOW_AUTH_TOKEN__ = token || '';
        AUTH_TOKEN_PAYLOAD = null;
        AUTH_READY = !!token;
        try {
          sessionStorage.removeItem('SHIFT_FLOW_ID_TOKEN');
        } catch (_err) {
          /* ignore storage exceptions */
        }
      }

      function clearAuthToken() {
        setAuthToken('');
        BOOTSTRAP_STARTED = false;
      }

      function setAuthOverlayMessage(text) {
        const errorEl = byId('auth-error');
        if (!errorEl) return;
        if (text) {
          errorEl.textContent = text;
          errorEl.classList.add('is-visible');
        } else {
          errorEl.textContent = '';
          errorEl.classList.remove('is-visible');
        }
      }

      function setAuthOverlayRequestId(requestId) {
        const wrap = byId('auth-request-id');
        const valueEl = byId('auth-request-id-value');
        if (!wrap || !valueEl) return;
        const normalized =
          typeof requestId === 'string' && requestId.trim() ? requestId.trim() : '';
        if (normalized) {
          valueEl.textContent = normalized;
          wrap.removeAttribute('hidden');
        } else {
          valueEl.textContent = '';
          wrap.setAttribute('hidden', 'hidden');
        }
      }

      function showAuthOverlay(messageOrOptions, maybeOptions) {
        var overlayOpts = {};
        var resolvedMessage = messageOrOptions;
        if (
          messageOrOptions &&
          typeof messageOrOptions === 'object' &&
          !Array.isArray(messageOrOptions)
        ) {
          overlayOpts = messageOrOptions;
          resolvedMessage = overlayOpts.message;
        } else if (maybeOptions && typeof maybeOptions === 'object') {
          overlayOpts = maybeOptions;
        }
        const overlayRequestId =
          typeof overlayOpts.requestId === 'string' && overlayOpts.requestId.trim()
            ? overlayOpts.requestId.trim()
            : '';
        setAuthOverlayRequestId(overlayRequestId);
        const overlay = byId('auth-overlay');
        var displayMessage = resolvedMessage;
        if (!displayMessage && IS_MOBILE) {
          displayMessage = 'ShiftFlow を利用するには Google アカウントでのサインインが必要です。';
        }
        if (document.body) {
          document.body.classList.add('auth-screen');
        }
        setAppShellHidden(true);
        if (overlay) {
          overlay.classList.remove('d-none');
          overlay.setAttribute('aria-hidden', 'false');
        }
        setAuthOverlayMessage(displayMessage);
        const primaryButton = byId('btn-auth-google');
        if (primaryButton && (!AUTH_SESSION || !AUTH_SESSION.authenticated)) {
          setTimeout(function () {
            try {
              primaryButton.focus();
            } catch (_err) {
              /* noop */
            }
          }, 50);
        }
      }

      function hideAuthOverlay(revealShell) {
        const overlay = byId('auth-overlay');
        const errorEl = byId('auth-error');
        if (overlay) {
          overlay.classList.add('d-none');
          overlay.setAttribute('aria-hidden', 'true');
        }
        if (errorEl) {
          errorEl.textContent = '';
          errorEl.classList.remove('is-visible');
        }
        setAuthOverlayRequestId('');
        if (revealShell === false) {
          if (document.body) {
            document.body.classList.add('auth-screen');
          }
          setAppShellHidden(true);
          return;
        }
        if (document.body) {
          document.body.classList.remove('auth-screen');
        }
        setAppShellHidden(false);
      }

      function updateAuthSessionUI(session) {
        AUTH_SESSION = session || { authenticated: false, user: null, expiresAt: 0 };
        const container = byId('auth-session');
        const nameEl = byId('auth-session-name');
        const emailEl = byId('auth-session-email');
        const avatarEl = byId('auth-session-avatar');
        const logoutBtn = byId('btn-auth-logout');
        const mobileLogoutBtn = byId('btn-mobile-logout');

        const isLoggedIn = !!(session && session.authenticated);
        if (container) {
          container.classList.toggle('is-visible', isLoggedIn);
        }
        if (logoutBtn) {
          logoutBtn.classList.toggle('d-none', !isLoggedIn);
        }
        if (mobileLogoutBtn) {
          mobileLogoutBtn.disabled = !isLoggedIn;
          mobileLogoutBtn.classList.toggle('is-disabled', !isLoggedIn);
        }
        if (isLoggedIn && session.user) {
          const name = session.user.name || '';
          const email = session.user.email || '';
          if (nameEl) nameEl.textContent = name;
          if (emailEl) emailEl.textContent = email;
          if (avatarEl) {
            avatarEl.src = session.user.picture || PROFILE_PLACEHOLDER_URL;
            avatarEl.alt = name || email || 'プロフィール';
          }
        } else {
          if (nameEl) nameEl.textContent = '';
          if (emailEl) emailEl.textContent = '';
          if (avatarEl) {
            avatarEl.src = PROFILE_PLACEHOLDER_URL;
            avatarEl.alt = 'プロフィール（プレースホルダ）';
          }
        }
      }

      const AUTH_SESSION_CACHE_MS = 3 * 60 * 1000;
      const AUTH_SESSION_EXPIRY_BUFFER_MS = 60 * 1000;
      let LAST_AUTH_SESSION = null;
      let LAST_AUTH_SESSION_AT = 0;
      const API_REFRESH_INTERVAL_MS = 7 * 60 * 1000;
      let LAST_HOME_FETCH_AT = 0;
      let LAST_MESSAGES_FETCH_AT = 0;
      const LAST_TASK_FETCH_AT = { my: 0, from: 0, all: 0 };
      let LAST_SETTINGS_FETCH_AT = 0;
      let LAST_SETTINGS_CACHE = null;
      let SETTINGS_INFLIGHT = null;

      function shouldThrottleFetch(lastRun, opts) {
        if (opts && opts.force) return false;
        if (!lastRun) return false;
        return Date.now() - lastRun < API_REFRESH_INTERVAL_MS;
      }

      async function syncAuthSession(options) {
        const opts = options || {};
        const now = Date.now();
        const cached = LAST_AUTH_SESSION;
        const cacheAge = now - LAST_AUTH_SESSION_AT;
        const cachedExpiry = Number(cached && cached.expiresAt ? cached.expiresAt : 0);
        const cachedNearExpiry =
          cachedExpiry && cachedExpiry <= now + AUTH_SESSION_EXPIRY_BUFFER_MS;
        if (cached && cacheAge < AUTH_SESSION_CACHE_MS && !cachedNearExpiry && !opts.force) {
          if (cached.authenticated) {
            setAuthToken('SESSION');
            clearAuthPendingFlag();
            hideAuthOverlay();
            updateAuthSessionUI(cached);
          } else {
            setAuthToken('');
            updateAuthSessionUI(null);
            if (!opts.silent) {
              var cachedReason = cached && typeof cached.reason === 'string' ? cached.reason : '';
              var cachedMessage = (function () {
                switch (cachedReason) {
                  case 'idle_timeout':
                    return '一定時間操作がなかったため認証を再取得する必要があります。もう一度 Google でログインしてください。';
                  case 'absolute_timeout':
                    return '長時間経過したため再度 Google でログインしてください。';
                  case 'no_session':
                    return NEEDS_MANUAL_SIGNIN
                      ? 'Google へサインインしてください。'
                      : 'Google でログインしてください。';
                  default:
                    return NEEDS_MANUAL_SIGNIN
                      ? 'Google へサインインしてください。'
                      : 'Google でログインしてください。';
                }
              })();
              showAuthOverlay(opts.message || cachedMessage);
            }
          }
          return cached;
        }
        const requestId = createRequestId();
        let response;
        try {
          response = await fetch('/auth/session', {
            method: 'GET',
            credentials: 'include',
            headers: {
              Accept: 'application/json',
              'X-ShiftFlow-Request-Id': requestId,
            },
          });
        } catch (err) {
          if (!opts.silent) {
            showAuthOverlay('認証状態を確認できませんでした。接続を確認してください。');
          }
          throw err;
        }
        if (!response.ok) {
          setAuthToken('');
          updateAuthSessionUI(null);
          if (!opts.silent) {
            showAuthOverlay('認証サーバーが応答しませんでした。時間をおいて再度お試しください。');
          }
          throw new Error('SESSION_STATUS_' + response.status);
        }
        const data = await response.json();
        LAST_AUTH_SESSION = data || null;
        LAST_AUTH_SESSION_AT = Date.now();
        if (data && data.authenticated) {
          updateAuthSessionUI(data);
          setAuthToken('SESSION');
          clearAuthPendingFlag();
          hideAuthOverlay();
        } else {
          setAuthToken('');
          updateAuthSessionUI(null);
          if (!opts.silent) {
            var reason = data && typeof data.reason === 'string' ? data.reason : '';
            var mappedMessage = (function () {
              switch (reason) {
                case 'idle_timeout':
                  return '一定時間操作がなかったため認証を再取得する必要があります。もう一度 Google でログインしてください。';
                case 'absolute_timeout':
                  return '長時間経過したため再度 Google でログインしてください。';
                case 'no_session':
                  return NEEDS_MANUAL_SIGNIN
                    ? 'Google へサインインしてください。'
                    : 'Google でログインしてください。';
                default:
                  return NEEDS_MANUAL_SIGNIN
                    ? 'Google へサインインしてください。'
                    : 'Google でログインしてください。';
              }
            })();
            showAuthOverlay(opts.message || mappedMessage);
          }
        }
        return data;
      }

      function handleTestApiRequest(path, init) {
        var state = getTestModeState();
        if (!state || !state.data) return null;
        var url = null;
        try {
          url = new URL(path, window.location.origin);
        } catch (_err) {
          return null;
        }
        var pathname = url.pathname;
        var method = (init && init.method ? String(init.method) : 'GET').toUpperCase();
        var data = state.data;
        if (!data) return null;
        if (!data.counters) data.counters = {};

        if (pathname.indexOf(API_BASE_PATH + '/templates') === 0) {
          if (!data.templates) data.templates = {};
          if (method === 'GET') {
            var folderIdForTpl = url.searchParams.get('folderId') || '';
            var list =
              (folderIdForTpl && data.templates[folderIdForTpl]) || data.templates[''] || [];
            return Promise.resolve(cloneDeep(list));
          }
          if (method === 'POST') {
            var tplPayload =
              init && init.body && typeof init.body === 'object' ? init.body : { folderId: '' };
            var targetFolder = tplPayload.folderId || url.searchParams.get('folderId') || '全体';
            data.templates[targetFolder] = data.templates[targetFolder] || [];
            if (typeof data.counters.template !== 'number') data.counters.template = 0;
            var newTplId = 'TPL-' + ++data.counters.template;
            data.templates[targetFolder].unshift({
              id: newTplId,
              name: tplPayload.name || '新規定型文',
              titleFormat: tplPayload.titleFormat || '',
              bodyFormat: tplPayload.bodyFormat || '',
              updatedAt: Date.now(),
            });
            return Promise.resolve({ success: true, id: newTplId });
          }
        }

        if (pathname.indexOf(API_BASE_PATH + '/folders') === 0) {
          if (!Array.isArray(data.folders)) data.folders = [];
          var folderMatch = pathname.match(new RegExp('^' + API_BASE_PATH + '/folders/([^/]+)$'));
          if (method === 'GET') {
            return Promise.resolve(cloneDeep(data.folders));
          }
          if (folderMatch && method === 'PATCH') {
            var folderId = decodeURIComponent(folderMatch[1]);
            var patchPayload = init && init.body && typeof init.body === 'object' ? init.body : {};
            var target = data.folders.find(function (entry) {
              return entry.id === folderId;
            });
            if (!target) return Promise.reject(new Error('フォルダが見つかりません。'));
            if (patchPayload.name) target.name = patchPayload.name;
            if (patchPayload.color) target.color = patchPayload.color;
            if (typeof patchPayload.isPublic === 'boolean') target.isPublic = patchPayload.isPublic;
            if (Array.isArray(patchPayload.memberUserIds))
              target.memberUserIds = patchPayload.memberUserIds.slice();
            target.memberCount = Array.isArray(target.memberUserIds)
              ? target.memberUserIds.length
              : target.memberCount;
            target.updatedAt = Date.now();
            return Promise.resolve(cloneDeep(target));
          }
          if (pathname === API_BASE_PATH + '/folders' && method === 'POST') {
            var folderPayload = init && init.body && typeof init.body === 'object' ? init.body : {};
            if (typeof data.counters.folder !== 'number')
              data.counters.folder = data.folders.length;
            var newFolderId =
              folderPayload.id || 'FOLDER-' + ++data.counters.folder || 'FOLDER-NEW';
            var entry = {
              id: newFolderId,
              name: folderPayload.name || '新規フォルダ',
              color: folderPayload.color || '#517cb2',
              isPublic: !!folderPayload.isPublic,
              isActive: true,
              memberUserIds: Array.isArray(folderPayload.memberUserIds)
                ? folderPayload.memberUserIds.slice()
                : [],
              memberCount: Array.isArray(folderPayload.memberUserIds)
                ? folderPayload.memberUserIds.length
                : 0,
              updatedAt: Date.now(),
            };
            data.folders.push(entry);
            return Promise.resolve(cloneDeep(entry));
          }
        }

        var pinMatch = pathname.match(new RegExp('^' + API_BASE_PATH + '/messages/([^/]+)/pin$'));
        if (pinMatch) {
          var memoIdForPin = decodeURIComponent(pinMatch[1]);
          var targetMsg = findTestMessage(state, memoIdForPin);
          if (!targetMsg) return Promise.reject(new Error('メッセージが見つかりません。'));
          var desiredPin =
            init &&
            init.body &&
            typeof init.body === 'object' &&
            Object.prototype.hasOwnProperty.call(init.body, 'pin')
              ? !!init.body.pin
              : !targetMsg.isPinned;
          targetMsg.isPinned = desiredPin;
          if (targetMsg.detail) targetMsg.detail.isPinned = desiredPin;
          if (data.bootstrap && data.bootstrap.pinnedMessages) {
            if (desiredPin) {
              data.bootstrap.pinnedMessages[targetMsg.id] = {
                pinnedAt: new Date().toISOString(),
                title: targetMsg.title,
              };
            } else {
              delete data.bootstrap.pinnedMessages[targetMsg.id];
            }
          }
          return Promise.resolve({ success: true, pinned: desiredPin });
        }

        var readMatch = pathname.match(
          new RegExp('^' + API_BASE_PATH + '/messages/([^/]+)/read_status$')
        );
        if (readMatch) {
          var memoIdForStatus = decodeURIComponent(readMatch[1]);
          var memo = findTestMessage(state, memoIdForStatus);
          if (!memo) return Promise.reject(new Error('メッセージが見つかりません。'));
          memo.detail = memo.detail || {};
          memo.detail.readUsers = memo.detail.readUsers || [];
          memo.detail.unreadUsers = memo.detail.unreadUsers || [];
          var unreadList = (memo.detail.unreadUsers || []).map(function (entry) {
            return {
              name: entry.label || entry.name || entry.email,
              email: entry.email,
            };
          });
          var totalCandidates = (memo.detail.readUsers || []).length + unreadList.length;
          return Promise.resolve({ unread: unreadList, totalCandidates: totalCandidates });
        }

        return null;
      }

      async function apiRequest(path, init) {
        if (isTestModeActive()) {
          var simulated = handleTestApiRequest(path, init);
          if (simulated) {
            return simulated;
          }
        }
        await syncAuthSession({ silent: true }).catch(function () {});
        const options = init || {};
        const headers = Object.assign(
          {
            Accept: 'application/json',
          },
          options.headers || {}
        );
        if (
          options.body &&
          typeof options.body === 'object' &&
          !(options.body instanceof FormData)
        ) {
          headers['Content-Type'] = headers['Content-Type'] || 'application/json';
        }
        const response = await fetch(path, {
          credentials: 'include',
          ...options,
          headers,
          body:
            options.body && typeof options.body === 'object' && !(options.body instanceof FormData)
              ? JSON.stringify(options.body)
              : options.body,
        });
        let payload = null;
        try {
          payload = await response.json();
        } catch (_err) {}
        if (!response.ok || (payload && payload.ok === false)) {
          const reason =
            (payload && payload.reason) ||
            (payload && payload.error) ||
            `API request failed (${response.status})`;
          const err = new Error(reason);
          err.code = (payload && payload.code) || 'api_error';
          err.status = response.status;
          throw err;
        }
        if (payload && Object.prototype.hasOwnProperty.call(payload, 'result')) {
          return payload.result;
        }
        return payload;
      }

      function normalizeReturnTo(rawValue) {
        var fallback = '/';
        var value = typeof rawValue === 'string' ? rawValue.trim() : '';
        if (!value) return fallback;
        try {
          var candidate = new URL(value, window.location.origin);
          if (candidate.origin !== window.location.origin) {
            return fallback;
          }
          var normalized =
            (candidate.pathname || '/') + (candidate.search || '') + (candidate.hash || '');
          return normalized || fallback;
        } catch (_err) {
          if (value.charAt(0) === '/') {
            return value;
          }
          return fallback;
        }
      }

      function buildAuthStartUrl(returnTo) {
        var normalized = normalizeReturnTo(returnTo);
        var url = new URL('/auth/start', window.location.origin);
        if (normalized) {
          url.searchParams.set('returnTo', normalized);
        }
        return url.toString();
      }

      function markAuthPending() {
        try {
          sessionStorage.setItem(AUTH_PENDING_FLAG_KEY, String(Date.now()));
        } catch (_err) {
          /* sessionStorage may be unavailable */
        }
      }
      function clearAuthPendingFlag() {
        try {
          sessionStorage.removeItem(AUTH_PENDING_FLAG_KEY);
        } catch (_err) {
          /* ignore */
        }
      }
      function isAuthPending() {
        try {
          var stored = sessionStorage.getItem(AUTH_PENDING_FLAG_KEY);
          if (!stored) return false;
          var timestamp = Number(stored);
          if (Number.isFinite(timestamp) && Date.now() - timestamp > 60 * 1000) {
            sessionStorage.removeItem(AUTH_PENDING_FLAG_KEY);
            return false;
          }
          return true;
        } catch (_err) {
          return false;
        }
      }

      function startAuthFlow(options) {
        const opts = { external: true, ...(options || {}) };
        const manualMode = NEEDS_MANUAL_SIGNIN && HAS_GAS_WEB_APP_URL;
        const shouldPreOpenWindow = manualMode || opts.external;
        const returnTo = opts.returnTo || window.location.href;
        const startUrl = buildAuthStartUrl(returnTo);
        const fallbackTarget = manualMode ? buildGasAuthUrl(returnTo) || GAS_WEB_APP_URL : '';
        setAuthOverlayMessage('');
        markAuthPending();
        if (shouldPreOpenWindow) {
          const authWindow = window.open(startUrl, '_blank', 'noopener');
          if (!authWindow) {
            if (manualMode && fallbackTarget) {
              showAuthOverlay('Google の認証ページからサインインしてください。');
              window.open(fallbackTarget, '_blank', 'noopener');
              return;
            }
            showAuthOverlay('Google の認証ページに移動します。自動で画面が切り替わります。');
            window.location.assign(startUrl);
            return;
          }
          try {
            authWindow.opener = null;
            authWindow.focus();
          } catch (_err) {}
          return;
        }
        setAuthOverlayMessage('');
        window.location.assign(startUrl);
      }

      function activateTestUserLogin(options) {
        options = options || {};
        var profile = options.profile === 'manager' ? 'manager' : 'member';
        var controller = ensureTestModeController({ profile: profile });
        if (!controller || !controller.data) {
          notify('テストユーザーを初期化できませんでした。', false);
          return;
        }
        controller.active = true;
        TEST_MODE_STATE = controller;
        window.__SHIFT_FLOW_TEST_MODE__ = controller;
        setAuthToken(profile === 'manager' ? 'TEST-MANAGER' : 'TEST');
        clearAuthPendingFlag();
        var session = {
          authenticated: true,
          user: controller.data.userInfo,
          expiresAt: Date.now() + 3600 * 1000,
        };
        AUTH_SESSION = session;
        HAS_ACTIVE_EMAIL = true;
        CURRENT_USER_EMAIL = controller.data.userInfo.email;
        USER_IMAGE_URL = controller.data.userInfo.imageUrl;
        applyBootstrapState(controller.data.bootstrap);
        updateAuthSessionUI(session);
        hideAuthOverlay();
        setAppShellHidden(false);
        setBootstrapLoading(false);
        updateTestMenuShortcut();
        notify(
          profile === 'manager'
            ? 'テストマネージャーでログインしました。'
            : 'テストユーザーでログインしました。',
          true
        );
        refreshDataAfterBootstrap();
      }

      async function performLogout() {
        try {
          const requestId = createRequestId();
          await fetch('/auth/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
              Accept: 'application/json',
              'X-ShiftFlow-Request-Id': requestId,
            },
          });
        } catch (err) {
          console.warn('[ShiftFlow] Logout request failed', err);
        }
        clearAuthToken();
        updateAuthSessionUI(null);
        clearAuthPendingFlag();
        showAuthOverlay('サインアウトしました。もう一度 Google でログインしてください。');
        updateTestMenuShortcut();
      }

      function confirmLogoutAction() {
        return window.confirm(
          'ShiftFlow からサインアウトします。未保存の変更は失われますがよろしいですか？'
        );
      }

      function attachAuthEventHandlers() {
        on('btn-auth-google', 'click', function (event) {
          event.preventDefault();
          startAuthFlow({ external: true, returnTo: window.location.href });
        });
        on('btn-mobile-logout', 'click', function (event) {
          event.preventDefault();
          if (event.currentTarget && event.currentTarget.disabled) return;
          if (!confirmLogoutAction()) return;
          performLogout();
        });
        on('btn-auth-logout', 'click', function (event) {
          event.preventDefault();
          if (!confirmLogoutAction()) return;
          performLogout();
        });
        on('btn-auth-demo', 'click', function (event) {
          event.preventDefault();
          activateTestUserLogin({ profile: 'member' });
        });
      }

      async function initializeAuthGateway() {
        attachAuthEventHandlers();
        const returningFromAuth = isAuthPending();
        if (returningFromAuth) {
          setBootstrapLoading(true);
          setAppShellHidden(true);
        }
        let session = null;
        try {
          session = await syncAuthSession({ silent: true });
          if ((!session || !session.authenticated) && returningFromAuth) {
            await delay(700);
            session = await syncAuthSession({ silent: true });
          }
        } catch (err) {
          console.warn('[ShiftFlow] Initial auth sync failed', err);
          setBootstrapLoading(false);
          showAuthOverlay('認証状態を確認できませんでした。時間をおいて再度お試しください。');
          return;
        }
        if (!session || !session.authenticated) {
          clearAuthPendingFlag();
          setBootstrapLoading(false);
          const retryMessage = returningFromAuth
            ? 'ログインの完了を確認できませんでした。ブラウザで再度 Google へサインインしてください。'
            : NEEDS_MANUAL_SIGNIN
            ? 'Google へサインインしてください。'
            : 'Google でログインしてください。';
          showAuthOverlay(retryMessage);
          return;
        }
        clearAuthPendingFlag();

        var restorePromise = Promise.resolve(false);
        var sessionEmail = session.user && session.user.email ? session.user.email : '';
        if (sessionEmail) {
          restorePromise = restoreBootstrapSnapshot(sessionEmail).then(function (record) {
            if (record && record.bootstrap) {
              applyBootstrapState(record.bootstrap);
              RESTORED_BOOTSTRAP_FROM_CACHE = true;
              ensureTaskBootstrap();
              return true;
            }
            return false;
          });
        }

        restorePromise.then(
          function () {
            bootstrapAfterAuth();
          },
          function (err) {
            console.warn('[ShiftFlow] bootstrap warm start failed', err);
            bootstrapAfterAuth();
          }
        );
      }

      function bootstrapAfterAuth(options) {
        if (!window.__SHIFT_FLOW_AUTH_TOKEN__) {
          showAuthOverlay();
          return;
        }
        if (BOOTSTRAP_STARTED) return;
        BOOTSTRAP_STARTED = true;
        var suppressLoading = (options && options.silent === true) || RESTORED_BOOTSTRAP_FROM_CACHE;
        var silentReload = options && options.silent === true;
        RESTORED_BOOTSTRAP_FROM_CACHE = false;
        if (suppressLoading) {
          setBootstrapLoading(false);
        } else {
          setBootstrapLoading(true);
        }
        hydrateBootstrap()
          .then(function () {
            try {
              ensureTaskBootstrap();
              if (silentReload) {
                try {
                  refreshCurrentView();
                } catch (refreshErr) {
                  console.warn('[ShiftFlow] refresh after silent bootstrap failed', refreshErr);
                }
              } else {
                navigateTo('home');
              }
            } finally {
              BOOTSTRAP_STARTED = false;
              setBootstrapLoading(false);
            }
          })
          .catch(function (err) {
            BOOTSTRAP_STARTED = false;
            setBootstrapLoading(false);
            if (isAuthError && isAuthError(err)) {
              clearAuthToken();
              updateAuthSessionUI(null);
              showAuthOverlay('セッションが切れました。もう一度 Google でログインしてください。');
              syncAuthSession({ silent: true }).catch(function () {});
              return;
            }
            console.error('Bootstrap load encountered an error:', err);
            notify(
              '初期データの取得に失敗しました: ' +
                (err && err.message ? err.message : '不明なエラー'),
              false
            );
          });
      }
      function managerRequiredCard(info) {
        info = info || {};
        var reason = esc(info.reason || '権限がありません。');
        var stats = '';
        if (typeof info.totalRows === 'number' || typeof info.returned === 'number') {
          var total = typeof info.totalRows === 'number' ? info.totalRows : '—';
          var returned = typeof info.returned === 'number' ? info.returned : '—';
          stats +=
            '<p class="mb-1 small text-muted">対象行数: 総数 ' +
            total +
            ' / 返却 ' +
            returned +
            '</p>';
        }
        return (
          '<div class="card border-warning"><div class="card-body">' +
          '<p class="mb-2 text-warning"><span class="material-icons align-middle me-1">admin_panel_settings</span>' +
          reason +
          '</p>' +
          stats +
          '</div></div>'
        );
      }
      function esc(s) {
        return String(s || '').replace(/[&<>"']/g, function (c) {
          return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
        });
      }
      function cssEscapeValue(value) {
        if (window.CSS && typeof window.CSS.escape === 'function') {
          return window.CSS.escape(value);
        }
        return String(value || '').replace(/[^a-zA-Z0-9_-]/g, '\\$&');
      }
      function scrollToTopNow() {
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        requestAnimationFrame(function () {
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
        });
      }
      function ensureAdminViewHidden() {
        if (!ADMIN_STATE.active) return;
        var adminView = byId('view-admin');
        if (adminView) {
          adminView.classList.add('is-hidden');
          adminView.setAttribute('hidden', 'hidden');
        }
        var adminPanels = byId('adminPanelsWrapper');
        if (adminPanels) {
          adminPanels.setAttribute('aria-hidden', 'true');
        }
        if (document.body) {
          document.body.classList.remove('admin-view-active');
        }
        ADMIN_STATE.active = false;
      }
      function setAdminSection(section) {
        var target = section || 'dashboard';
        ADMIN_STATE.section = target;
        document.querySelectorAll('[data-admin-panel]').forEach(function (panel) {
          var match = panel.getAttribute('data-admin-panel') === target;
          panel.classList.toggle('is-active', match);
        });
        document.querySelectorAll('[data-admin-nav-link]').forEach(function (link) {
          var match = link.getAttribute('data-admin-target') === target;
          link.classList.toggle('active', match);
          link.setAttribute('aria-current', match ? 'page' : 'false');
        });
        moveAdminTrack(target);
        var label = byId('admin-section-label');
        if (label) {
          var labelMap = {
            dashboard: '管理トップ',
            users: 'ユーザー管理',
            folders: 'フォルダ・定型文',
            orgs: '組織管理',
            audit: '監査ログ',
          };
          label.textContent = labelMap[target] || '管理メニュー';
        }
        var iconEl = byId('adminSectionIcon');
        if (iconEl) {
          var iconMap = {
            dashboard: 'dashboard',
            users: 'groups',
            folders: 'folder_shared',
            orgs: 'apartment',
            audit: 'fact_check',
          };
          iconEl.textContent = iconMap[target] || 'admin_panel_settings';
        }
        var descEl = byId('admin-section-desc');
        if (descEl) {
          var descMap = {
            dashboard: '現在の状況を一覧で把握し、アクションにつなげます。',
            users: 'ステータスやロールを横断してユーザーを管理します。',
            folders: 'フォルダの公開設定や定型文を管理します。',
            orgs: '組織設定とメンバー構成を編集できます。',
            audit: 'ログインや管理操作の履歴を確認します。',
          };
          descEl.textContent = descMap[target] || '';
        }
        notifyAdminSectionListeners(target);
      }
      function setAdminOrg(orgId, label) {
        ADMIN_STATE.orgId = orgId || 'current';
        ADMIN_STATE.orgLabel = label || '現在の組織';
        var labelEl = byId('adminOrgLabel');
        if (labelEl) labelEl.textContent = ADMIN_STATE.orgLabel;
        document.querySelectorAll('.admin-org-item').forEach(function (item) {
          var match = item.getAttribute('data-org-id') === ADMIN_STATE.orgId;
          item.classList.toggle('active', match);
        });
        notifyAdminOrgListeners(ADMIN_STATE.orgId);
      }
      function moveAdminTrack(section, opts) {
        var track = byId('adminTrack');
        if (!track) return;
        var idx = ADMIN_ORDER.indexOf(section);
        if (idx < 0) return;
        var animate = !opts || opts.animate !== false;
        if (!animate) {
          track.style.transition = 'none';
        } else {
          track.style.transition = 'transform 320ms cubic-bezier(0.22, 0.61, 0.36, 1)';
        }
        requestAnimationFrame(function () {
          track.style.transform = 'translateX(' + -idx * 100 + '%)';
          if (!animate) {
            requestAnimationFrame(function () {
              track.style.transition = 'transform 320ms cubic-bezier(0.22, 0.61, 0.36, 1)';
            });
          }
        });
      }
      function stepAdminSection(delta) {
        var current = ADMIN_ORDER.indexOf(ADMIN_STATE.section || 'dashboard');
        if (current < 0) current = 0;
        var next = ADMIN_ORDER[current + delta];
        if (!next) return;
        setAdminSection(next);
      }
      function openAdminView(section) {
        var adminView = byId('view-admin');
        if (!adminView) return;
        ADMIN_STATE.active = true;
        if (peekOverlayHistoryTag() !== 'admin-view') {
          pushOverlayHistory('admin-view');
        }
        if (document.body) {
          document.body.classList.add('admin-view-active');
        }
        adminView.classList.remove('is-hidden');
        adminView.removeAttribute('hidden');
        var adminPanels = byId('adminPanelsWrapper');
        if (adminPanels) {
          adminPanels.removeAttribute('aria-hidden');
        }
        setAdminSection(section || ADMIN_STATE.section || 'dashboard');
        moveAdminTrack(section || ADMIN_STATE.section || 'dashboard', { animate: false });
        scrollToTopNow();
        var menuButton = byId('btn-user-menu');
        if (menuButton) {
          try {
            var dropdownInst = bootstrap.Dropdown.getInstance(menuButton);
            if (dropdownInst) dropdownInst.hide();
          } catch (_err) {
            /* noop */
          }
        }
      }
      function closeAdminView(fromHistory) {
        ensureAdminViewHidden();
        navigateTo('home', { skipHistory: !!fromHistory });
        if (!fromHistory && peekOverlayHistoryTag() === 'admin-view') {
          popOverlayHistory('admin-view');
        }
      }
      function debounce(fn, ms) {
        var t = null;
        return function () {
          var ctx = this,
            args = arguments;
          clearTimeout(t);
          t = setTimeout(function () {
            fn.apply(ctx, args);
          }, ms);
        };
      }
      function delay(ms) {
        return new Promise(function (resolve) {
          setTimeout(resolve, typeof ms === 'number' && ms >= 0 ? ms : 0);
        });
      }
      function humanBytes(n) {
        n = Number(n || 0);
        if (n < 1024) return n + ' B';
        var u = ['KB', 'MB', 'GB', 'TB'],
          i = -1;
        do {
          n /= 1024;
          i++;
        } while (n >= 1024 && i < u.length - 1);
        return n.toFixed(n >= 10 ? 0 : 1) + ' ' + u[i];
      }

      function readFileAsDataUrl(file) {
        return new Promise(function (resolve, reject) {
          var reader = new FileReader();
          reader.onload = function (e) {
            resolve(e && e.target ? e.target.result : reader.result);
          };
          reader.onerror = function (err) {
            reject(err || new Error('FileReader error'));
          };
          reader.readAsDataURL(file);
        });
      }

      var CACHE_DB_NAME = 'shiftflow-cache';
      var CACHE_DB_VERSION = 1;
      var CACHE_STORE_NAME = 'datasets';
      var SUPPORTS_IDB = typeof indexedDB !== 'undefined' && !!indexedDB;
      var CACHE_DB_PROMISE = null;

      function openCacheDb() {
        if (!SUPPORTS_IDB) {
          return Promise.reject(new Error('IndexedDB not supported'));
        }
        if (CACHE_DB_PROMISE) return CACHE_DB_PROMISE;
        CACHE_DB_PROMISE = new Promise(function (resolve, reject) {
          var request = indexedDB.open(CACHE_DB_NAME, CACHE_DB_VERSION);
          request.onupgradeneeded = function (event) {
            var db = event.target && event.target.result;
            if (!db) return;
            if (!db.objectStoreNames.contains(CACHE_STORE_NAME)) {
              db.createObjectStore(CACHE_STORE_NAME, { keyPath: 'key' });
            }
          };
          request.onsuccess = function (event) {
            var db = event.target && event.target.result;
            if (!db) {
              reject(new Error('Failed to open cache DB'));
              return;
            }
            resolve(db);
          };
          request.onerror = function (event) {
            reject((event && event.target && event.target.error) || new Error('IndexedDB error'));
          };
        }).catch(function (err) {
          CACHE_DB_PROMISE = null;
          throw err;
        });
        return CACHE_DB_PROMISE;
      }

      function readCacheEntry(key) {
        if (!SUPPORTS_IDB) {
          return Promise.resolve(null);
        }
        return openCacheDb()
          .then(function (db) {
            return new Promise(function (resolve, reject) {
              var tx = db.transaction(CACHE_STORE_NAME, 'readonly');
              var store = tx.objectStore(CACHE_STORE_NAME);
              var req = store.get(key);
              req.onsuccess = function (event) {
                resolve((event && event.target && event.target.result) || null);
              };
              req.onerror = function (event) {
                reject((event && event.target && event.target.error) || new Error('read failed'));
              };
            });
          })
          .catch(function () {
            return null;
          });
      }

      function writeCacheEntry(key, value) {
        if (!SUPPORTS_IDB) {
          return Promise.resolve(false);
        }
        return openCacheDb()
          .then(function (db) {
            return new Promise(function (resolve, reject) {
              var tx = db.transaction(CACHE_STORE_NAME, 'readwrite');
              var store = tx.objectStore(CACHE_STORE_NAME);
              var req = store.put({
                key: key,
                value: value,
                updatedAt: Date.now(),
              });
              req.onsuccess = function () {
                resolve(true);
              };
              req.onerror = function (event) {
                reject((event && event.target && event.target.error) || new Error('write failed'));
              };
            });
          })
          .catch(function () {
            return false;
          });
      }

      function normalizeEmailValue(value) {
        if (!value) return '';
        return String(value).trim().toLowerCase();
      }

      function resolveUserCacheNamespace() {
        if (typeof CURRENT_USER_EMAIL === 'string' && CURRENT_USER_EMAIL) {
          return normalizeEmailValue(CURRENT_USER_EMAIL);
        }
        var fallbackEmail =
          (window.userInfo && typeof window.userInfo.email === 'string' && window.userInfo.email) ||
          '';
        return normalizeEmailValue(fallbackEmail || '');
      }

      function buildUserCacheKey(baseKey) {
        var ns = resolveUserCacheNamespace();
        if (ns) {
          return 'user:' + ns + ':' + baseKey;
        }
        return 'user:__guest__:' + baseKey;
      }

      function readUserCacheEntry(baseKey) {
        return readCacheEntry(buildUserCacheKey(baseKey));
      }

      function writeUserCacheEntry(baseKey, value) {
        return writeCacheEntry(buildUserCacheKey(baseKey), value);
      }

      function getBootstrapCacheKey(email) {
        var normalized = normalizeEmailValue(email || '');
        if (!normalized) {
          normalized = BOOTSTRAP_CACHE_DEFAULT_EMAIL;
        }
        return BOOTSTRAP_CACHE_PREFIX + normalized;
      }

      function cacheBootstrapSnapshot(snapshot) {
        if (!snapshot || typeof snapshot !== 'object') {
          return Promise.resolve(false);
        }
        var emailSource =
          (snapshot.userInfo && snapshot.userInfo.email) ||
          (AUTH_TOKEN_PAYLOAD && AUTH_TOKEN_PAYLOAD.email) ||
          CURRENT_USER_EMAIL ||
          '';
        var normalizedEmail = normalizeEmailValue(emailSource || '');
        if (!normalizedEmail) {
          normalizedEmail = BOOTSTRAP_CACHE_DEFAULT_EMAIL;
        }
        var record = {
          email: normalizedEmail,
          cachedAt: Date.now(),
          bootstrap: snapshot,
        };
        var primaryKey = getBootstrapCacheKey(normalizedEmail);
        return writeCacheEntry(primaryKey, record)
          .then(function () {
            return writeCacheEntry(BOOTSTRAP_CACHE_RECENT_KEY, record);
          })
          .catch(function (err) {
            console.warn('[ShiftFlow] failed to cache bootstrap snapshot', err);
            return false;
          });
      }

      function restoreBootstrapSnapshot(candidateEmail) {
        var normalizedCandidate = normalizeEmailValue(candidateEmail || '');
        var keys = [];
        if (normalizedCandidate) {
          keys.push(getBootstrapCacheKey(normalizedCandidate));
        }
        keys.push(BOOTSTRAP_CACHE_RECENT_KEY);
        var attempt = Promise.resolve(null);
        keys.forEach(function (key) {
          attempt = attempt.then(function (current) {
            if (current) return current;
            return readCacheEntry(key).then(function (entry) {
              if (!entry || !entry.value) {
                return null;
              }
              var record = entry.value;
              if (
                normalizedCandidate &&
                normalizeEmailValue(record.email || '') !== normalizedCandidate
              ) {
                return null;
              }
              if (!record.bootstrap || typeof record.bootstrap !== 'object') {
                return null;
              }
              var cachedAtMs = Number(record.cachedAt || 0);
              if (!cachedAtMs || Date.now() - cachedAtMs > BOOTSTRAP_CACHE_MAX_AGE_MS) {
                return null;
              }
              return record;
            });
          });
        });
        return attempt.catch(function () {
          return null;
        });
      }

      function priorityClassName(pr) {
        switch (String(pr || '中')) {
          case '高':
            return 'priority-high';
          case '低':
            return 'priority-low';
          default:
            return 'priority-middle';
        }
      }
      function formatDateLabel(iso) {
        if (!iso) return '—';
        var d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        var days = ['日', '月', '火', '水', '木', '金', '土'];
        var day = days[d.getDay()] || '';
        var monthDay = d.getMonth() + 1 + '/' + d.getDate();
        return day ? monthDay + '(' + day + ')' : monthDay;
      }
      function formatJst(input, includeTime) {
        if (input === null || input === undefined) return '—';
        var date = typeof input === 'number' ? new Date(input) : new Date(String(input));
        if (!(date instanceof Date) || isNaN(date.getTime())) {
          return '—';
        }
        var year = date.getFullYear();
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + date.getDate()).slice(-2);
        var base = year + '-' + month + '-' + day;
        if (!includeTime) return base;
        var hours = ('0' + date.getHours()).slice(-2);
        var minutes = ('0' + date.getMinutes()).slice(-2);
        return base + ' ' + hours + ':' + minutes;
      }
      function normalizeArray(data) {
        if (Array.isArray(data)) return data;
        if (!data) return [];
        if (typeof data.length === 'number') {
          try {
            return Array.prototype.slice.call(data);
          } catch (e) {}
        }
        if (typeof data === 'object') {
          return Object.keys(data)
            .filter(function (k) {
              return !isNaN(k);
            })
            .sort(function (a, b) {
              return Number(a) - Number(b);
            })
            .map(function (k) {
              return data[k];
            });
        }
        return [];
      }
      function extractTaskPayload(result) {
        var rows = [];
        var meta = {};
        if (result && typeof result === 'object' && !Array.isArray(result)) {
          if (Array.isArray(result.tasks)) rows = result.tasks;
          if (result.meta && typeof result.meta === 'object') meta = result.meta;
        } else if (Array.isArray(result)) {
          rows = result;
        } else {
          rows = normalizeArray(result);
        }
        return { rows: Array.isArray(rows) ? rows : [], meta: meta || {} };
      }

      (function syncThemeDisplayInitial() {
        var select = byId('setting-theme');
        if (select) {
          select.value = themePreference;
        }
        updateThemeStatus(themePreference);
      })();
      on('setting-theme', 'change', function () {
        var value = this.value || 'light';
        updateThemeStatus(value);
        applyThemePreference(value);
      });

      // ===== スワイプビュー =====
      var order = ['home', 'tasks', 'messages', 'settings'];
      var ADMIN_ORDER = ['dashboard', 'users', 'folders', 'orgs', 'audit'];
      var CURRENT_VIEW = 'home';
      var VIEW_HISTORY_SUPPORTED = !!(window.history && window.history.pushState);
      var VIEW_HISTORY_LOCK = false;
      var LAST_VIEW_HISTORY = 'home';
      var SWIPE_LOCK = false;
      var SWIPE_VERTICAL_TOLERANCE = 160;
      var SWIPE_ACTIVATION_DELTA = 14;
      var SWIPE_TRANSITION = 'transform 260ms cubic-bezier(0.22, 0.61, 0.36, 1)';
      var CURRENT_TRANSFORM = 0;

      window.__SHIFT_FLOW_GESTURE__ = null;

      function trackTo(view, opts) {
        var track = byId('viewsTrack');
        var idx = order.indexOf(view);
        var panel = byId('view-' + view);
        if (!track || !panel || idx < 0) return;
        var animate = !opts || opts.animate !== false;
        var offset = panel.offsetLeft;
        if (!animate) {
          track.style.transition = 'none';
          track.style.transform = 'translateX(' + -offset + 'px)';
          requestAnimationFrame(function () {
            track.style.transition = SWIPE_TRANSITION;
          });
        } else {
          track.style.transition = SWIPE_TRANSITION;
          requestAnimationFrame(function () {
            track.style.transform = 'translateX(' + -offset + 'px)';
          });
        }
        CURRENT_TRANSFORM = -offset;
      }

      function setActiveNav(view) {
        $$('.topbar .nav-link').forEach(function (a) {
          a.classList.toggle('active', a.getAttribute('data-view') === view);
        });
        $$('.footer-nav [data-view]').forEach(function (a) {
          a.classList.toggle('active', a.getAttribute('data-view') === view);
        });
      }
      function showPanel(view) {
        order.forEach(function (v) {
          var el = byId('view-' + v);
          if (!el) return;
          if (v === view) {
            el.classList.remove('is-hidden');
            el.classList.add('show');
          } else {
            el.classList.add('is-hidden');
            el.classList.remove('show');
          }
        });
      }

      function pushViewHistoryState(view, force) {
        if (!VIEW_HISTORY_SUPPORTED) return;
        if (VIEW_HISTORY_LOCK && !force) return;
        if (!force && LAST_VIEW_HISTORY === view) return;
        LAST_VIEW_HISTORY = view;
        try {
          window.history.pushState(
            { shiftflowView: view, ts: Date.now() },
            document.title,
            window.location.href
          );
        } catch (_err) {
          /* noop */
        }
      }

      function replaceBaseViewState(view) {
        if (!VIEW_HISTORY_SUPPORTED) return;
        ensureBaseHistoryState(view);
        LAST_VIEW_HISTORY = view;
      }
      function navigateTo(v, opts) {
        ensureAdminViewHidden();
        var options = opts || {};
        CURRENT_VIEW = v;
        setActiveNav(v);
        showPanel(v);
        trackTo(v, { animate: options.animate !== false });
        if (!options.skipScroll) {
          scrollToTopNow();
        }
        if (v === 'home') loadHome();
        if (v === 'tasks') {
          ensureTaskBootstrap();
          var activeTaskTab = ACTIVE_TASK_TAB || 'my';
          activateTaskTab(activeTaskTab, false);
          var needForceTasks = options.force === true || !hasTaskRows(activeTaskTab);
          reloadActiveTaskTab({ force: needForceTasks });
        }
        if (v === 'messages') loadMessages({ force: options.force === true });
        if (v === 'settings') loadSettings({ force: options.force === true });
        if (!options.skipHistory) {
          pushViewHistoryState(v);
        } else {
          LAST_VIEW_HISTORY = v;
        }
      }

      function handleViewHistoryPop(event) {
        if (!VIEW_HISTORY_SUPPORTED) return;
        if (VIEW_HISTORY_LOCK) return;
        if (HISTORY_GUARD_ACTIVE) return;
        var state = event && event.state;
        if (state && (state.shiftflowModal || state.modalLock)) {
          return;
        }
        if (state && state.shiftflowView) {
          if (state.shiftflowView === CURRENT_VIEW) {
            return;
          }
          VIEW_HISTORY_LOCK = true;
          navigateTo(state.shiftflowView, { animate: false, skipScroll: true, skipHistory: true });
          LAST_VIEW_HISTORY = state.shiftflowView;
          setTimeout(function () {
            VIEW_HISTORY_LOCK = false;
          }, 0);
          return;
        }
        if (!state || state.shiftflowBase) {
          VIEW_HISTORY_LOCK = true;
          var fallbackView =
            (state && state.shiftflowView) ||
            (typeof CURRENT_VIEW === 'string' ? CURRENT_VIEW : 'home');
          navigateTo(fallbackView, { animate: false, skipScroll: true, skipHistory: true });
          replaceBaseViewState(fallbackView);
          pushViewHistoryState(fallbackView, true);
          setTimeout(function () {
            VIEW_HISTORY_LOCK = false;
          }, 0);
        }
      }
      if (VIEW_HISTORY_SUPPORTED) {
        window.addEventListener('popstate', handleViewHistoryPop);
      }

      function refreshCurrentView(options) {
        const opts = options || {};
        if (CURRENT_VIEW === 'home') {
          return Promise.resolve(loadHome({ force: opts.force === true }));
        }
        if (CURRENT_VIEW === 'tasks') {
          ensureTaskBootstrap();
          return Promise.all([
            Promise.resolve(reloadActiveTaskTab({ force: opts.force === true })),
            Promise.resolve(loadHome({ force: opts.force === true })),
          ]).then(function () {});
        }
        if (CURRENT_VIEW === 'messages') {
          return Promise.all([
            Promise.resolve(loadMessages({ force: opts.force === true })),
            Promise.resolve(loadHome({ force: opts.force === true })),
          ]).then(function () {});
        }
        if (CURRENT_VIEW === 'settings') {
          return Promise.resolve(loadSettings({ force: opts.force === true }));
        }
        return Promise.resolve(loadHome({ force: opts.force === true }));
      }

      (function enableSwipe() {
        var wrap = byId('viewsWrapper');
        var track = byId('viewsTrack');
        var pageShell = document.querySelector('.page-body[data-app-shell]');
        if (!wrap || !track) return;
        var state = {
          active: false,
          dragging: false,
          startX: 0,
          startY: 0,
          startTime: 0,
          baseOffset: 0,
          rawDx: 0,
          rawDy: 0,
        };
        var activeTouchId = null;
        var unify = function (e) {
          if (e.changedTouches && e.changedTouches.length) return e.changedTouches[0];
          if (e.touches && e.touches.length) return e.touches[0];
          return e;
        };
        function getActiveTouch(e) {
          if (activeTouchId == null) {
            return unify(e);
          }
          if (e.changedTouches && e.changedTouches.length) {
            for (var i = 0; i < e.changedTouches.length; i++) {
              var changed = e.changedTouches[i];
              if (changed.identifier === activeTouchId) return changed;
            }
          }
          if (e.touches && e.touches.length) {
            for (var j = 0; j < e.touches.length; j++) {
              var touch = e.touches[j];
              if (touch.identifier === activeTouchId) return touch;
            }
          }
          return null;
        }
        function swipeThreshold() {
          var base =
            wrap.offsetWidth || window.innerWidth || document.documentElement.clientWidth || 360;
          return Math.max(48, Math.min(140, base * 0.18));
        }
        function isWithinSwipeArea(node) {
          if (!wrap || !node) return false;
          if (node.closest && node.closest('.modal.show')) return false;
          if (node === wrap) return true;
          if (node instanceof Node) {
            if (wrap.contains(node)) return true;
            if (node.closest) {
              var withinWrap = node.closest('#viewsWrapper');
              if (withinWrap) return true;
              var withinTrack = node.closest('#viewsTrack');
              if (withinTrack && wrap.contains(withinTrack)) return true;
              if (pageShell && node.closest('.page-body[data-app-shell]') === pageShell)
                return true;
            }
            return false;
          }
          return false;
        }
        function resetSwipe(shouldSnap) {
          state.active = false;
          state.dragging = false;
          state.startX = 0;
          state.startY = 0;
          state.startTime = 0;
          state.baseOffset = CURRENT_TRANSFORM;
          state.rawDx = 0;
          state.rawDy = 0;
          activeTouchId = null;
          if (shouldSnap !== false) {
            track.style.transition = SWIPE_TRANSITION;
            track.style.transform = 'translateX(' + CURRENT_TRANSFORM + 'px)';
          }
          window.__SHIFT_FLOW_GESTURE__ = null;
        }
        function handleSwipeStart(e) {
          if (ADMIN_STATE.active) return;
          if (SWIPE_LOCK) return;
          if (document.body && document.body.classList.contains('modal-open')) return;
          if (e.touches && e.touches.length > 1) {
            resetSwipe();
            return;
          }
          var t = unify(e);
          if (!t) return;
          var origin = t.target || e.target;
          if (!isWithinSwipeArea(origin)) return;
          state.active = true;
          state.dragging = false;
          state.startX = t.clientX;
          state.startY = t.clientY;
          state.startTime = Date.now();
          state.baseOffset = CURRENT_TRANSFORM;
          state.rawDx = 0;
          state.rawDy = 0;
          activeTouchId = typeof t.identifier === 'number' ? t.identifier : null;
          track.style.transition = 'none';
          window.__SHIFT_FLOW_GESTURE__ = null;
        }
        function handleSwipeMove(e) {
          if (!state.active) return;
          if (e.touches && e.touches.length > 1) {
            resetSwipe();
            return;
          }
          var t = getActiveTouch(e);
          if (!t) return;
          var dx = t.clientX - state.startX;
          var dy = t.clientY - state.startY;
          if (!state.dragging) {
            if (Math.abs(dx) >= SWIPE_ACTIVATION_DELTA && Math.abs(dx) > Math.abs(dy) + 10) {
              state.dragging = true;
              window.__SHIFT_FLOW_GESTURE__ = 'horizontal';
              track.style.transition = 'none';
            } else if (Math.abs(dy) >= SWIPE_ACTIVATION_DELTA && Math.abs(dy) > Math.abs(dx) + 10) {
              window.__SHIFT_FLOW_GESTURE__ = 'vertical';
              resetSwipe();
              return;
            } else {
              return;
            }
          }
          if (window.__SHIFT_FLOW_GESTURE__ !== 'horizontal') return;
          if (e.cancelable) e.preventDefault();
          state.rawDx = dx;
          state.rawDy = dy;
          var nextOffset = state.baseOffset + dx;
          track.style.transform = 'translateX(' + nextOffset + 'px)';
        }
        function handleSwipeEnd(e) {
          if (!state.active) {
            resetSwipe();
            return;
          }
          if (activeTouchId != null && !getActiveTouch(e)) {
            resetSwipe();
            return;
          }
          var triggered = false;
          if (state.dragging && !SWIPE_LOCK) {
            var dx = state.rawDx;
            var dy = state.rawDy;
            var dt = Date.now() - state.startTime;
            var threshold = swipeThreshold();
            var flickDistance = 42;
            var flickTime = 280;
            var withinVerticalGuard = Math.abs(dy) < SWIPE_VERTICAL_TOLERANCE;
            var distanceSatisfied = Math.abs(dx) >= threshold;
            var flickSatisfied = Math.abs(dx) >= flickDistance && dt < flickTime;
            if ((distanceSatisfied || flickSatisfied) && withinVerticalGuard) {
              var idx = order.indexOf(CURRENT_VIEW);
              var count = order.length;
              var lastIndex = count - 1;
              var target = null;
              if (dx < 0) {
                target = idx < lastIndex ? order[idx + 1] : order[0];
              } else if (dx > 0) {
                target = idx > 0 ? order[idx - 1] : order[lastIndex];
              }
              if (target && target !== CURRENT_VIEW) {
                SWIPE_LOCK = true;
                navigateTo(target, { animate: true });
                var targetPanel = byId('view-' + target);
                if (targetPanel) {
                  CURRENT_TRANSFORM = -targetPanel.offsetLeft;
                }
                setTimeout(function () {
                  SWIPE_LOCK = false;
                }, 360);
                triggered = true;
              }
            }
          }
          if (!triggered) {
            track.style.transition = SWIPE_TRANSITION;
            track.style.transform = 'translateX(' + state.baseOffset + 'px)';
            CURRENT_TRANSFORM = state.baseOffset;
          }
          resetSwipe(triggered ? false : true);
        }
        function handleSwipeCancel() {
          if (!state.active) return;
          track.style.transition = SWIPE_TRANSITION;
          track.style.transform = 'translateX(' + CURRENT_TRANSFORM + 'px)';
          resetSwipe();
        }

        document.addEventListener('touchstart', handleSwipeStart, { passive: true, capture: true });
        document.addEventListener('touchmove', handleSwipeMove, { passive: false, capture: true });
        document.addEventListener('touchend', handleSwipeEnd, { passive: true, capture: true });
        document.addEventListener('touchcancel', handleSwipeCancel, {
          passive: true,
          capture: true,
        });
      })();

      window.addEventListener('resize', function () {
        clearTimeout(_rszTimer);
        _rszTimer = setTimeout(function () {
          trackTo(CURRENT_VIEW, { animate: false });
        }, 120);
      });

      function initPullToRefresh() {
        var hasTouch = 'ontouchstart' in window || (navigator.maxTouchPoints || 0) > 0;
        if (!hasTouch) return;
        if (window.matchMedia) {
          var coarse = window.matchMedia('(pointer: coarse)');
          if (coarse && coarse.matches === false && (navigator.maxTouchPoints || 0) === 0) return;
        }
        var ptrEl = byId('pullToRefresh');
        if (!ptrEl) return;
        var iconEl = byId('pullToRefreshIcon');
        var textEl = byId('pullToRefreshText');
        var iconDefault = 'expand_more';
        var iconRefreshing = 'autorenew';
        var threshold = 110;
        var activationDelay = 90;
        var activationDistance = 32;
        var revealDistance = 20;
        var pulling = false;
        var ready = false;
        var refreshing = false;
        var startY = 0;
        var startX = 0;
        var interactionMode = null;
        var startedAt = 0;
        var scrollEl = document.scrollingElement || document.documentElement;
        var horizontalGuard = 12;
        var pullIntentAt = 0;

        function atTop() {
          var top =
            scrollEl && typeof scrollEl.scrollTop === 'number'
              ? scrollEl.scrollTop
              : window.pageYOffset ||
                document.documentElement.scrollTop ||
                document.body.scrollTop ||
                0;
          return top <= 0;
        }
        function setReady(flag) {
          ready = !!flag;
          ptrEl.classList.toggle('ready', ready);
          if (!refreshing && textEl) {
            textEl.textContent = ready ? '指を離すと更新' : '下に引っ張って更新';
          }
        }
        function show() {
          if (!ptrEl.classList.contains('show')) {
            ptrEl.classList.add('show');
          }
          ptrEl.setAttribute('aria-hidden', 'false');
        }
        function setRefreshing(flag) {
          refreshing = !!flag;
          ptrEl.classList.toggle('refreshing', refreshing);
          if (refreshing) {
            ptrEl.setAttribute('aria-busy', 'true');
            setReady(false);
            if (iconEl) {
              iconEl.textContent = iconRefreshing;
            }
          } else {
            ptrEl.setAttribute('aria-busy', 'false');
            if (iconEl) {
              iconEl.textContent = iconDefault;
            }
          }
          if (textEl) {
            textEl.textContent = refreshing
              ? '更新中…'
              : ready
              ? '指を離すと更新'
              : '下に引っ張って更新';
          }
        }
        function hide() {
          ptrEl.classList.remove('show', 'refreshing', 'ready');
          ptrEl.removeAttribute('aria-busy');
          ptrEl.setAttribute('aria-hidden', 'true');
          setReady(false);
          if (iconEl) {
            iconEl.textContent = iconDefault;
          }
          if (textEl) {
            textEl.textContent = '下に引っ張って更新';
          }
        }
        function resetPull() {
          pulling = false;
          startY = 0;
          startX = 0;
          interactionMode = null;
          pullIntentAt = 0;
          setReady(false);
        }
        function triggerRefresh() {
          if (refreshing) return;
          setRefreshing(true);
          show();
          startedAt = Date.now();
          var result;
          try {
            result = refreshCurrentView({ force: true });
          } catch (err) {
            result = Promise.reject(err);
          }
          Promise.resolve(result)
            .catch(function (err) {
              console.warn('Pull-to-refresh update failed:', err);
            })
            .then(function () {
              var elapsed = Date.now() - startedAt;
              var delay = elapsed < 500 ? 500 - elapsed : 0;
              setTimeout(function () {
                setRefreshing(false);
                hide();
              }, delay);
            });
        }

        hide();

        window.addEventListener(
          'touchstart',
          function (e) {
            if (refreshing) return;
            if (document.body.classList.contains('modal-open')) return;
            if (!atTop()) return;
            if (e.touches && e.touches.length > 1) return;
            if (window.__SHIFT_FLOW_GESTURE__ === 'horizontal') return;
            var touch = e.touches ? e.touches[0] : e;
            startY = touch.clientY;
            startX = touch.clientX;
            interactionMode = null;
            pullIntentAt = Date.now();
            pulling = true;
            setReady(false);
          },
          { passive: true }
        );
        window.addEventListener(
          'touchmove',
          function (e) {
            if (!pulling) return;
            if (e.touches && e.touches.length > 1) return;
            if (window.__SHIFT_FLOW_GESTURE__ === 'horizontal') {
              hide();
              resetPull();
              return;
            }
            if (!atTop()) {
              resetPull();
              hide();
              return;
            }
            var touch = e.touches ? e.touches[0] : e;
            var diffX = touch.clientX - startX;
            var diff = touch.clientY - startY;
            var absX = Math.abs(diffX);
            var absY = Math.abs(diff);
            var elapsed = Date.now() - pullIntentAt;
            if (interactionMode === null) {
              if (absX > horizontalGuard && absX > absY) {
                interactionMode = 'horizontal';
                hide();
                resetPull();
                return;
              }
              if (diff > 0 && (absY >= absX || absY > horizontalGuard)) {
                if (elapsed < activationDelay || diff < activationDistance) {
                  return;
                }
                interactionMode = 'vertical';
              }
            }
            if (interactionMode === 'horizontal') {
              return;
            }
            if (interactionMode === null) {
              if (diff <= 0) {
                setReady(false);
              }
              return;
            }
            if (diff <= 0) {
              setReady(false);
              return;
            }
            if (diff >= revealDistance) {
              show();
            }
            setReady(diff >= threshold);
          },
          { passive: true }
        );
        window.addEventListener(
          'touchend',
          function () {
            if (!pulling) return;
            if (refreshing) {
              resetPull();
              return;
            }
            if (ready) {
              triggerRefresh();
            } else {
              hide();
            }
            resetPull();
          },
          { passive: true }
        );
        window.addEventListener(
          'touchcancel',
          function () {
            if (refreshing) return;
            hide();
            resetPull();
          },
          { passive: true }
        );
      }

      var MIN_CONTENT_SKELETON_MS = 220;

      function revealAfterDelay(startedAt, minDuration, fn) {
        if (typeof fn !== 'function') return;
        var delay = 0;
        if (typeof startedAt === 'number' && startedAt > 0 && typeof minDuration === 'number') {
          var elapsed = Date.now() - startedAt;
          if (elapsed < minDuration) {
            delay = minDuration - elapsed;
          }
        }
        if (delay > 0) {
          setTimeout(fn, delay);
        } else {
          fn();
        }
      }

      function skel(n) {
        var h = '';
        for (var i = 0; i < (n || 4); i++) {
          h += '<div class="skeleton mb-2"></div>';
        }
        return h;
      }

      function renderHomeView(data) {
        var payload = data || {};
        var tasks = normalizeArray(payload.tasks);
        var tHTML = tasks.length
          ? tasks
              .map(function (t) {
                return rowTask(t, false);
              })
              .join('')
          : '<div class="card app-card task-card mb-2"><div class="card-body text-muted">直近のタスクはありません。</div></div>';
        byId('home-today-tasks').innerHTML = tHTML;

        var unread = normalizeArray(payload.messages).filter(function (x) {
          return !x.isRead;
        });
        [byId('badge-unread-top'), byId('badge-unread-bottom')].forEach(function (b) {
          if (!b) return;
          b.textContent = unread.length;
          b.classList.toggle('d-none', unread.length === 0);
        });

        var mHTML = unread.length
          ? unread
              .map(function (m) {
                return renderMessageCard(m, { compact: true, hideAction: true });
              })
              .join('')
          : '<div class="card app-card msg-card mb-2"><div class="card-body text-muted">未読のメッセージはありません。</div></div>';
        byId('home-unread').innerHTML = mHTML;
        var sourceRows =
          TASK_STATE &&
          TASK_STATE.my &&
          Array.isArray(TASK_STATE.my.rows) &&
          TASK_STATE.my.rows.length
            ? TASK_STATE.my.rows
            : tasks;
        var overdueCount = updateTaskOverdueBadge(sourceRows);
        var statPairs = [
          ['home-stat-overdue', overdueCount],
          ['home-stat-today', tasks.length],
          ['home-stat-unread', unread.length],
        ];
        statPairs.forEach(function (pair) {
          var el = byId(pair[0]);
          if (el) {
            el.textContent = pair[1];
          }
        });
        var ts = byId('home-last-updated');
        if (ts) {
          var now = new Date();
          ts.textContent =
            '更新: ' +
            now.toLocaleTimeString('ja-JP', {
              hour: '2-digit',
              minute: '2-digit',
            });
        }
      }

      function collectActiveTaskRows() {
        var state = window.TASK_STATE;
        var scopes = ['my', 'from', 'all'];
        var seen = Object.create(null);
        var collected = [];
        scopes.forEach(function (scope) {
          var list = state && state[scope] && state[scope].rows;
          normalizeArray(list).forEach(function (task) {
            if (!task) return;
            var key =
              task.id != null
                ? 'id:' + task.id
                : 'hash:' + [task.title, task.dueDate, task.status].join('|');
            if (seen[key]) return;
            seen[key] = true;
            collected.push(task);
          });
        });
        return collected;
      }

      function computeOverdueTaskCount(rows) {
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        return normalizeArray(rows).reduce(function (count, task) {
          if (!task) return count;
          if (task.isCompleted || String(task.status || '').trim() === '完了') {
            return count;
          }
          var status = String(task.status || '').trim();
          if (status && status !== '未着手' && status !== '対応中') {
            return count;
          }
          if (!task.dueDate) {
            return count;
          }
          var due = new Date(task.dueDate);
          if (isNaN(due.getTime())) {
            return count;
          }
          due.setHours(0, 0, 0, 0);
          return due.getTime() <= today.getTime() ? count + 1 : count;
        }, 0);
      }

      function updateTaskOverdueBadge(rows) {
        var source = normalizeArray(rows);
        if (!source.length) {
          source = collectActiveTaskRows();
        }
        var count = computeOverdueTaskCount(source);
        [byId('badge-task-overdue-top'), byId('badge-task-overdue-bottom')].forEach(function (el) {
          if (!el) return;
          el.textContent = count;
          el.classList.toggle('d-none', count === 0);
        });
        return count;
      }

      function loadHomeFromCache() {
        return readUserCacheEntry('home').then(function (entry) {
          if (!entry || !entry.value) return null;
          var value = entry.value || {};
          return {
            tasks: normalizeArray(value.tasks),
            messages: normalizeArray(value.messages),
          };
        });
      }

      function cacheHomePayload(data) {
        return writeUserCacheEntry('home', {
          tasks: normalizeArray(data && data.tasks),
          messages: normalizeArray(data && data.messages),
        });
      }

      // ===== Home =====
      function loadHome(options) {
        const opts = options || {};
        if (!HAS_ACTIVE_EMAIL) {
          var card = authRequiredCard();
          byId('home-today-tasks').innerHTML = card;
          byId('home-unread').innerHTML = card;
          if (!AUTH_NOTICE_SHOWN) {
            notify(AUTH_NOTICE_MESSAGE, false);
            AUTH_NOTICE_SHOWN = true;
          }
          return Promise.resolve(false);
        }
        const skipFetch = shouldThrottleFetch(LAST_HOME_FETCH_AT, opts);
        var skeletonRendered = false;
        var cachedPayload = null;
        var skeletonStartedAt = 0;
        function ensureSkeleton() {
          if (skeletonRendered) return;
          byId('home-today-tasks').innerHTML = skel(3);
          byId('home-unread').innerHTML = skel(3);
          skeletonRendered = true;
        }
        return loadHomeFromCache()
          .catch(function () {
            return null;
          })
          .then(function (cached) {
            if (cached) {
              cachedPayload = cached;
            }
            if (skipFetch && cachedPayload) {
              renderHomeView(cachedPayload);
              return false;
            }
            ensureSkeleton();
            skeletonStartedAt = Date.now();
            return new Promise(function (resolve) {
              if (!(globalThis.google && google.script && google.script.run)) {
                revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                  if (cachedPayload) {
                    renderHomeView(cachedPayload);
                  } else {
                    ensureSkeleton();
                  }
                });
                resolve(false);
                return;
              }
              google.script.run
                .withSuccessHandler(function (d) {
                  cacheHomePayload(d);
                  LAST_HOME_FETCH_AT = Date.now();
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    renderHomeView(d);
                  });
                  resolve(true);
                })
                .withFailureHandler(function (e) {
                  notify('ホーム読み込み失敗: ' + e.message, false);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (cachedPayload) {
                      renderHomeView(cachedPayload);
                    } else {
                      ensureSkeleton();
                    }
                  });
                  resolve(false);
                })
                .getHomeContent();
            });
          });
      }

      // ===== Tasks =====
      const TASK_STATE = {
        my: { rows: [], meta: {}, loaded: false, loading: false },
        from: { rows: [], meta: {}, loaded: false, loading: false },
        all: { rows: [], meta: {}, loaded: false, loading: false, restricted: !IS_MANAGER },
      };
      const TASK_FILTERS = {
        my: { search: '' },
        from: { search: '', assignee: '' },
        all: { search: '', assignee: '' },
      };

      function displayAssignees(r) {
        var assigneeEmails =
          Array.isArray(r.assignees) && r.assignees.length
            ? r.assignees
            : r.assignee
            ? [r.assignee]
            : [];
        if (!assigneeEmails.length) return '';
        return assigneeEmails
          .map(function (email) {
            return getNameByEmail(email);
          })
          .join(', ');
      }

      function rowTask(r, showAssignee) {
        var priority = r.priority || '中';
        var priorityCls = priorityClassName(priority);
        var priorityPill =
          '<span class="priority-pill ' + priorityCls + '">' + esc(priority) + '</span>';
        var dueLabel = formatDateLabel(r.dueDate);
        var isCompleted = !!r.isCompleted || String(r.status || '').trim() === '完了';
        var statusLabel = String(r.status || '').trim();
        var dueDateObj = r.dueDate ? new Date(r.dueDate) : null;
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var isOverdue = false;
        if (dueDateObj instanceof Date && !isNaN(dueDateObj.getTime())) {
          var dueStart = new Date(dueDateObj.getTime());
          dueStart.setHours(0, 0, 0, 0);
          isOverdue = !isCompleted && dueStart.getTime() < today.getTime();
        }

        var cardClass = 'card app-card task-card mb-2 text-decoration-none link-surface';
        if (isCompleted) cardClass += ' task-card-completed';
        else {
          cardClass += ' task-card-attention';
        }
        if (!isCompleted && isOverdue) {
          cardClass += ' task-card-overdue';
          if (statusLabel === '未着手') cardClass += ' task-card-overdue-pending';
          else if (statusLabel === '対応中') cardClass += ' task-card-overdue-inprogress';
        }
        var text =
          '<a href="#" class="' +
          cardClass +
          '" onclick="event.preventDefault(); openTaskDetail(\'' +
          r.id +
          '\')">' +
          '<div class="card-body app-card-body">' +
          '<div class="task-info-wrap app-card-main">' +
          '<div class="task-title-line d-flex align-items-center gap-2 flex-wrap">' +
          priorityPill +
          '<strong>' +
          esc(r.title) +
          '</strong>' +
          '</div>';
        var createdByMe =
          r.createdBy &&
          CURRENT_USER_EMAIL &&
          String(r.createdBy).toLowerCase() === CURRENT_USER_EMAIL.toLowerCase();
        var authorLabel = '';
        if (r.createdByLabel) authorLabel = r.createdByLabel;
        else if (r.createdBy) authorLabel = getNameByEmail(r.createdBy);
        if (showAssignee) {
          var assigneesText = displayAssignees(r);
          text +=
            '<div class="task-assignee-line">' +
            (assigneesText ? '@' + esc(assigneesText) : '担当者未設定') +
            '</div>';
        }
        if (authorLabel && !createdByMe) {
          text +=
            '<div class="task-meta-line task-meta-line--author">' +
            '<span class="material-icons-outlined" aria-hidden="true">person</span>' +
            '<span>' +
            esc(authorLabel) +
            ' からの依頼</span>' +
            '</div>';
        }
        if (createdByMe) {
          text +=
            '<div class="task-meta-line"><span class="badge-soft"><span class="material-icons">outgoing_mail</span>あなたが作成</span></div>';
        }
        if (isCompleted) {
          text +=
            '<div class="task-meta-line"><span class="badge-soft badge-completed"><span class="material-icons">task_alt</span>完了</span></div>';
        } else if (isOverdue) {
          text +=
            '<div class="task-meta-line"><span class="badge-soft badge-overdue"><span class="material-icons">warning</span>期限超過</span></div>';
        }
        text +=
          '</div>' +
          '<div class="task-meta app-card-meta text-end">' +
          '<div>期限 ' +
          esc(dueLabel) +
          '</div>' +
          (r.status ? '<div class="small text-muted">' + esc(r.status) + '</div>' : '') +
          '</div>' +
          '</div></a>';
        return text;
      }

      function getTaskContainerId(scope) {
        if (scope === 'from') return 'task-list-from';
        if (scope === 'all') return 'task-list-all';
        return 'task-list-my';
      }

      function setTaskContent(scope, html) {
        var el = byId(getTaskContainerId(scope));
        if (el) {
          el.innerHTML = html;
        }
      }

      function setTaskLoading(scope, loading) {
        var state = TASK_STATE[scope];
        if (!state) return;
        state.loading = !!loading;
        if (loading) {
          setTaskContent(scope, skel(6));
        }
      }

      function setTaskError(scope, message) {
        setTaskContent(
          scope,
          '<div class="task-empty text-danger">' +
            esc(message || 'タスクの表示中にエラーが発生しました。') +
            '</div>'
        );
      }

      function filterTaskRows(scope) {
        var state = TASK_STATE[scope];
        if (!state) return [];
        var rows = normalizeArray(state.rows).slice();
        var filters = TASK_FILTERS[scope] || {};
        var assigneeFilter = (filters.assignee || '').trim().toLowerCase();
        if (assigneeFilter) {
          rows = rows.filter(function (row) {
            var list = normalizeArray(
              row.assignees && row.assignees.length
                ? row.assignees
                : row.assignee
                ? [row.assignee]
                : []
            );
            if (!list.length) return false;
            return list.some(function (email) {
              return (
                String(email || '')
                  .trim()
                  .toLowerCase() === assigneeFilter
              );
            });
          });
        }
        var search = (filters.search || '').trim().toLowerCase();
        if (search) {
          rows = rows.filter(function (row) {
            var haystack = [
              row.title || '',
              row.status || '',
              row.priority || '',
              displayAssignees(row),
              row.createdBy || '',
              formatDateLabel(row.dueDate) || '',
            ]
              .join(' ')
              .toLowerCase();
            return haystack.indexOf(search) >= 0;
          });
        }
        return rows;
      }

      function renderTaskList(scope) {
        if (scope === 'all' && TASK_STATE.all.restricted) {
          setTaskContent(scope, '<div class="task-empty">管理者権限が必要です。</div>');
          return;
        }
        if (scope === 'my' && !HAS_ACTIVE_EMAIL) {
          setTaskContent(scope, authRequiredCard());
          return;
        }
        if (TASK_STATE[scope].loading) {
          setTaskContent(scope, skel(6));
          return;
        }
        var rows = filterTaskRows(scope);
        if (!rows.length) {
          setTaskContent(scope, '<div class="task-empty">表示できるタスクはありません。</div>');
          return;
        }
        setTaskContent(
          scope,
          rows
            .map(function (r) {
              return rowTask(r, true);
            })
            .join('')
        );
      }

      function loadTasksFromCache(scope, options) {
        var opts = options || {};
        var mutateState = opts.mutate !== false;
        var shouldRender = opts.render !== false;
        return readUserCacheEntry('tasks:' + scope).then(function (entry) {
          if (!entry || !entry.value) return null;
          var payload = entry.value || {};
          var rows = normalizeArray(payload.rows);
          var meta = payload.meta && typeof payload.meta === 'object' ? payload.meta : {};
          if (mutateState) {
            TASK_STATE[scope].rows = rows;
            TASK_STATE[scope].meta = meta;
            TASK_STATE[scope].loaded = true;
            TASK_STATE[scope].loading = false;
            if (shouldRender) {
              renderTaskList(scope);
              if (scope === 'my') {
                updateTaskOverdueBadge(rows);
              } else {
                updateTaskOverdueBadge();
              }
            }
          }
          return { rows: rows, meta: meta };
        });
      }

      function cacheTasks(scope, rows, meta) {
        return writeUserCacheEntry('tasks:' + scope, {
          rows: Array.isArray(rows) ? rows : [],
          meta: meta && typeof meta === 'object' ? meta : {},
        });
      }

      function ensureTaskBootstrap() {
        if (TASKS_BOOTSTRAPPED) return;
        TASKS_BOOTSTRAPPED = true;
        var initialRows = normalizeArray(INITIAL_MY_TASK_PAYLOAD && INITIAL_MY_TASK_PAYLOAD.tasks);
        TASK_STATE.my.rows = initialRows;
        TASK_STATE.my.meta = (INITIAL_MY_TASK_PAYLOAD && INITIAL_MY_TASK_PAYLOAD.meta) || {};
        TASK_STATE.my.loaded = initialRows.length > 0;
        renderTaskList('my');
        updateTaskOverdueBadge(initialRows);
        if (initialRows.length) {
          cacheTasks('my', initialRows, TASK_STATE.my.meta);
        }
      }

      function hasTaskRows(scope) {
        var state = TASK_STATE[scope];
        if (!state) return false;
        return Array.isArray(state.rows) && state.rows.length > 0;
      }

      function loadMyTasks(options) {
        const opts = options || {};
        var scope = 'my';
        if (!HAS_ACTIVE_EMAIL) {
          renderTaskList(scope);
          if (!AUTH_NOTICE_SHOWN) {
            notify(AUTH_NOTICE_MESSAGE, false);
            AUTH_NOTICE_SHOWN = true;
          }
          return Promise.resolve(false);
        }
        const now = Date.now();
        const lastFetch = LAST_TASK_FETCH_AT[scope] || 0;
        const hasRows = hasTaskRows(scope);
        if (TASK_STATE[scope].loaded && hasRows && shouldThrottleFetch(lastFetch, opts)) {
          renderTaskList(scope);
          updateTaskOverdueBadge(TASK_STATE[scope].rows);
          return Promise.resolve(true);
        }
        var cachedPayload = null;
        var skeletonStartedAt = Date.now();
        return loadTasksFromCache(scope, { render: false, mutate: false })
          .catch(function () {
            return null;
          })
          .then(function (cached) {
            if (cached && Array.isArray(cached.rows)) {
              cachedPayload = cached;
            }
            return new Promise(function (resolve) {
              setTaskLoading(scope, true);
              if (!(globalThis.google && google.script && google.script.run)) {
                TASK_STATE[scope].loading = false;
                revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                  if (cachedPayload) {
                    TASK_STATE[scope].rows = cachedPayload.rows;
                    TASK_STATE[scope].meta = cachedPayload.meta || {};
                    TASK_STATE[scope].loaded = true;
                    TASK_STATE[scope].loading = false;
                    renderTaskList(scope);
                    updateTaskOverdueBadge(cachedPayload.rows);
                  } else {
                    setTaskError(
                      scope,
                      'Google Apps Script のランタイムに接続できません。ページを再読み込みしてください。'
                    );
                  }
                });
                resolve(false);
                return;
              }
              google.script.run
                .withSuccessHandler(function (result) {
                  var payload = extractTaskPayload(result);
                  TASK_STATE.my.rows = payload.rows;
                  TASK_STATE.my.meta = payload.meta || {};
                  TASK_STATE.my.loaded = true;
                  TASK_STATE.my.loading = false;
                  LAST_TASK_FETCH_AT[scope] = Date.now();
                  cacheTasks(scope, payload.rows, payload.meta);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    renderTaskList(scope);
                    updateTaskOverdueBadge(payload.rows);
                  });
                  resolve(true);
                })
                .withFailureHandler(function (error) {
                  TASK_STATE.my.loading = false;
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (cachedPayload) {
                      TASK_STATE[scope].rows = cachedPayload.rows;
                      TASK_STATE[scope].meta = cachedPayload.meta || {};
                      TASK_STATE[scope].loaded = true;
                      TASK_STATE[scope].loading = false;
                      renderTaskList(scope);
                      updateTaskOverdueBadge(cachedPayload.rows);
                    } else {
                      setTaskError(scope, 'マイタスクの表示中にエラーが発生しました。');
                    }
                  });
                  notify(
                    'マイタスク取得失敗: ' + (error && error.message ? error.message : error),
                    false
                  );
                  resolve(false);
                })
                .listMyTasks();
            });
          });
      }

      function loadCreatedTasks(options) {
        const opts = options || {};
        var scope = 'from';
        var cachedPayload = null;
        const now = Date.now();
        const lastFetch = LAST_TASK_FETCH_AT[scope] || 0;
        const hasRows = hasTaskRows(scope);
        if (TASK_STATE[scope].loaded && hasRows && shouldThrottleFetch(lastFetch, opts)) {
          renderTaskList(scope);
          updateTaskOverdueBadge();
          return Promise.resolve(true);
        }
        var skeletonStartedAt = Date.now();
        return loadTasksFromCache(scope, { render: false, mutate: false })
          .catch(function () {
            return null;
          })
          .then(function (cached) {
            if (cached && Array.isArray(cached.rows)) {
              cachedPayload = cached;
            }
            return new Promise(function (resolve) {
              setTaskLoading(scope, true);
              if (!(globalThis.google && google.script && google.script.run)) {
                TASK_STATE[scope].loading = false;
                revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                  if (cachedPayload) {
                    TASK_STATE[scope].rows = cachedPayload.rows;
                    TASK_STATE[scope].meta = cachedPayload.meta || {};
                    TASK_STATE[scope].loaded = true;
                    TASK_STATE[scope].loading = false;
                    renderTaskList(scope);
                    updateTaskOverdueBadge();
                  } else {
                    setTaskError(
                      scope,
                      'Google Apps Script のランタイムに接続できません。ページを再読み込みしてください。'
                    );
                  }
                });
                resolve(false);
                return;
              }
              google.script.run
                .withSuccessHandler(function (result) {
                  var payload = extractTaskPayload(result);
                  TASK_STATE.from.rows = payload.rows;
                  TASK_STATE.from.meta = payload.meta || {};
                  TASK_STATE.from.loaded = true;
                  TASK_STATE.from.loading = false;
                  LAST_TASK_FETCH_AT[scope] = Date.now();
                  cacheTasks(scope, payload.rows, payload.meta);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    renderTaskList(scope);
                    updateTaskOverdueBadge();
                  });
                  resolve(true);
                })
                .withFailureHandler(function (error) {
                  TASK_STATE.from.loading = false;
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (cachedPayload) {
                      TASK_STATE[scope].rows = cachedPayload.rows;
                      TASK_STATE[scope].meta = cachedPayload.meta || {};
                      TASK_STATE[scope].loaded = true;
                      TASK_STATE[scope].loading = false;
                      renderTaskList(scope);
                      updateTaskOverdueBadge();
                    } else {
                      setTaskError(scope, 'タスクの表示中にエラーが発生しました。');
                    }
                  });
                  notify(
                    '作成したタスクの取得に失敗しました: ' +
                      (error && error.message ? error.message : error),
                    false
                  );
                  resolve(false);
                })
                .listCreatedTasks(null);
            });
          });
      }

      function loadAllTasks(options) {
        const opts = options || {};
        var scope = 'all';
        if (!IS_MANAGER) {
          TASK_STATE.all.restricted = true;
          renderTaskList(scope);
          return Promise.resolve(false);
        }
        const lastFetch = LAST_TASK_FETCH_AT[scope] || 0;
        const hasRows = hasTaskRows(scope);
        if (TASK_STATE[scope].loaded && hasRows && shouldThrottleFetch(lastFetch, opts)) {
          renderTaskList(scope);
          updateTaskOverdueBadge();
          return Promise.resolve(true);
        }
        var cachedPayload = null;
        var skeletonStartedAt = Date.now();
        return loadTasksFromCache(scope, { render: false, mutate: false })
          .catch(function () {
            return null;
          })
          .then(function (cached) {
            if (cached && Array.isArray(cached.rows)) {
              cachedPayload = cached;
            }
            return new Promise(function (resolve) {
              setTaskLoading(scope, true);
              if (!(globalThis.google && google.script && google.script.run)) {
                TASK_STATE[scope].loading = false;
                revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                  if (cachedPayload) {
                    TASK_STATE[scope].rows = cachedPayload.rows;
                    TASK_STATE[scope].meta = cachedPayload.meta || {};
                    TASK_STATE[scope].loaded = true;
                    TASK_STATE[scope].loading = false;
                    renderTaskList(scope);
                    updateTaskOverdueBadge();
                  } else {
                    setTaskError(
                      scope,
                      'Google Apps Script のランタイムに接続できません。ページを再読み込みしてください。'
                    );
                  }
                });
                resolve(false);
                return;
              }
              google.script.run
                .withSuccessHandler(function (result) {
                  var payload = extractTaskPayload(result);
                  if (payload.meta && payload.meta.managerOnly && !payload.meta.isManager) {
                    TASK_STATE.all.restricted = true;
                    TASK_STATE.all.loading = false;
                    revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                      renderTaskList(scope);
                    });
                    if (!MANAGER_NOTICE_SHOWN) {
                      notify('全体のタスク閲覧には管理者権限が必要です。', false);
                      MANAGER_NOTICE_SHOWN = true;
                    }
                    resolve(false);
                    return;
                  }
                  TASK_STATE.all.rows = payload.rows;
                  TASK_STATE.all.meta = payload.meta || {};
                  TASK_STATE.all.loaded = true;
                  TASK_STATE.all.restricted = false;
                  TASK_STATE.all.loading = false;
                  LAST_TASK_FETCH_AT[scope] = Date.now();
                  cacheTasks(scope, payload.rows, payload.meta);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    renderTaskList(scope);
                    updateTaskOverdueBadge();
                  });
                  resolve(true);
                })
                .withFailureHandler(function (error) {
                  TASK_STATE.all.loading = false;
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (cachedPayload) {
                      TASK_STATE[scope].rows = cachedPayload.rows;
                      TASK_STATE[scope].meta = cachedPayload.meta || {};
                      TASK_STATE[scope].loaded = true;
                      TASK_STATE[scope].loading = false;
                      renderTaskList(scope);
                      updateTaskOverdueBadge();
                    } else {
                      setTaskError(scope, 'タスクの表示中にエラーが発生しました。');
                    }
                  });
                  notify(
                    '全体タスクの取得に失敗しました: ' +
                      (error && error.message ? error.message : error),
                    false
                  );
                  resolve(false);
                })
                .listAllTasks(null);
            });
          });
      }

      function activateTaskTab(tab, shouldLoad) {
        if (tab === 'all' && !IS_MANAGER) {
          TASK_STATE.all.restricted = true;
          renderTaskList('all');
          return;
        }
        if (!tab) tab = 'my';
        ACTIVE_TASK_TAB = tab;
        $$('#taskTabs .task-tab-btn').forEach(function (btn) {
          btn.classList.toggle('active', btn.getAttribute('data-task-tab') === tab);
        });
        $$('.task-panels .task-panel').forEach(function (panel) {
          panel.classList.toggle('active', panel.getAttribute('data-task-panel') === tab);
        });
        if (shouldLoad) {
          if (tab === 'my') {
            loadMyTasks();
            return;
          }
          if (tab === 'from') {
            loadCreatedTasks();
            return;
          }
          if (tab === 'all') {
            loadAllTasks();
            return;
          }
        }
        renderTaskList(tab);
      }

      function reloadActiveTaskTab(options) {
        const opts = options || {};
        var active = ACTIVE_TASK_TAB || 'my';
        if (active === 'from') {
          return loadCreatedTasks(opts);
        }
        if (active === 'all') {
          return loadAllTasks(opts);
        }
        return loadMyTasks(opts);
      }

      var API_REFRESH_COOLDOWN_MS = 1500;
      var API_REFRESH_LAST_RUN = {};
      var API_REFRESH_PENDING = {};

      function isWithinApiCooldown(key) {
        var now = Date.now();
        var last = API_REFRESH_LAST_RUN[key] || 0;
        return now - last < API_REFRESH_COOLDOWN_MS;
      }

      function scheduleApiRefresh(key, fn) {
        if (typeof fn !== 'function') return;
        API_REFRESH_LAST_RUN[key] = Date.now();
        if (document.hidden) {
          API_REFRESH_PENDING[key] = fn;
          return;
        }
        try {
          fn();
        } catch (err) {
          console.warn('API refresh handler failed:', err);
        }
      }

      function flushPendingApiRefreshes() {
        var keys = Object.keys(API_REFRESH_PENDING);
        if (!keys.length) return;
        keys.forEach(function (key) {
          var fn = API_REFRESH_PENDING[key];
          delete API_REFRESH_PENDING[key];
          if (typeof fn === 'function') {
            try {
              fn();
            } catch (err) {
              console.warn('Pending API refresh failed:', err);
            }
          }
        });
      }

      document.addEventListener('visibilitychange', function () {
        if (!document.hidden) {
          flushPendingApiRefreshes();
        }
      });
      window.addEventListener('focus', flushPendingApiRefreshes);

      window.__SHIFT_FLOW_TRIGGER_REFRESH__ = function (message) {
        if (!message || !message.url) {
          return;
        }
        var pathname = '';
        try {
          pathname = new URL(message.url, window.location.origin).pathname || '';
        } catch (err) {
          pathname = String(message.url || '');
        }

        var handlerKey = '';
        var handler = null;

        if (pathname.indexOf('/api/tasks') === 0) {
          handlerKey = 'tasks';
          handler = function () {
            reloadActiveTaskTab();
          };
        } else if (pathname.indexOf('/api/messages') === 0) {
          handlerKey = 'messages';
          handler = function () {
            loadMessages();
          };
        } else if (pathname.indexOf('/api/home') === 0) {
          handlerKey = 'home';
          handler = function () {
            loadHome();
          };
        } else {
          return;
        }

        if (isWithinApiCooldown(handlerKey)) {
          return;
        }

        scheduleApiRefresh(handlerKey, handler);
      };

      const TaskViewController = (function () {
        const SEARCH_FIELDS = [
          { id: 'task-search-my', scope: 'my' },
          { id: 'task-search-from', scope: 'from' },
          { id: 'task-search-all', scope: 'all' },
        ];
        const ASSIGNEE_FIELDS = [
          { id: 'task-filter-from-assignee', scope: 'from' },
          { id: 'task-filter-all-assignee', scope: 'all' },
        ];

        function handleTabClick(event) {
          const btn = event && event.currentTarget;
          if (!btn) return;
          const tab = btn.getAttribute('data-task-tab');
          if (!tab) return;
          const state = TASK_STATE[tab] || {};
          const shouldLoad = tab !== ACTIVE_TASK_TAB || !state.loaded;
          activateTaskTab(tab, shouldLoad);
        }

        function attachTabHandlers() {
          $$('#taskTabs .task-tab-btn').forEach(function (btn) {
            btn.addEventListener('click', handleTabClick);
          });
        }

        function updateSearchFilter(scope, value) {
          if (!scope || !TASK_FILTERS[scope]) return;
          TASK_FILTERS[scope].search = (value || '').trim();
          renderTaskList(scope);
        }

        function attachSearchHandlers() {
          SEARCH_FIELDS.forEach(function (entry) {
            on(entry.id, 'input', function () {
              updateSearchFilter(entry.scope, this.value);
            });
          });
        }

        function updateAssigneeFilter(scope, value) {
          if (!scope || !TASK_FILTERS[scope]) return;
          TASK_FILTERS[scope].assignee = value || '';
          renderTaskList(scope);
        }

        function attachAssigneeHandlers() {
          ASSIGNEE_FIELDS.forEach(function (entry) {
            on(entry.id, 'change', function () {
              updateAssigneeFilter(entry.scope, this.value);
            });
          });
        }

        function attachReloadHandler() {
          on('task-reload', 'click', reloadActiveTaskTab);
        }

        function init() {
          attachTabHandlers();
          attachSearchHandlers();
          attachAssigneeHandlers();
          attachReloadHandler();
        }

        return {
          init,
        };
      })();

      const MessageViewController = (function () {
        const SELECTORS = {
          folder: 'flt-msg-folder',
          unread: 'flt-msg-unread',
          search: 'msg-search-box',
        };
        const debouncedSearch = debounce(function () {
          loadMessages();
        }, 400);

        function readFolderValue() {
          var select = byId(SELECTORS.folder);
          if (!select) return '';
          var value = String(select.value || '').trim();
          if (!value || value.toLowerCase() === 'all') {
            return '';
          }
          return value;
        }

        function readUnreadOnly() {
          var checkbox = byId(SELECTORS.unread);
          return checkbox ? !!checkbox.checked : false;
        }

        function readSearchKeyword() {
          var input = byId(SELECTORS.search);
          return input ? (input.value || '').trim() : '';
        }

        function getFilters() {
          return {
            folderId: readFolderValue(),
            unreadOnly: readUnreadOnly(),
            keyword: readSearchKeyword(),
          };
        }

        function handleFilterChange(event) {
          if (event) event.preventDefault();
          loadMessages();
        }

        function handleSearchInput(event) {
          if (event) event.preventDefault();
          debouncedSearch();
        }

        function attachFilterHandlers() {
          on(SELECTORS.folder, 'change', handleFilterChange);
          on(SELECTORS.unread, 'change', handleFilterChange);
          var searchInput = byId(SELECTORS.search);
          if (searchInput) {
            searchInput.addEventListener('input', handleSearchInput);
          }
        }

        function init() {
          attachFilterHandlers();
        }

        function buildCacheKey(filters) {
          var active = filters || getFilters();
          return getMessagesCacheKey(active.folderId, active.unreadOnly);
        }

        return {
          init,
          getFilters,
          buildCacheKey,
        };
      })();

      // ===== Messages =====
      function sanitizePersonLabel(value) {
        var text = typeof value === 'string' ? value.trim() : '';
        if (!text) return '';
        if (text.indexOf('@') !== -1) return '';
        return text;
      }
      function resolveMessageAuthorLabel(message) {
        if (!message) return '投稿者';
        var label = sanitizePersonLabel(message.createdByLabel);
        if (!label && message.createdBy) {
          var profile = getUserProfile(message.createdBy);
          if (profile) {
            label = sanitizePersonLabel(profile.name);
          }
        }
        if (!label) label = '投稿者';
        return label;
      }
      function resolveMessageTimestampLabel(message) {
        if (!message) return '';
        if (message.createdAtLabel) return message.createdAtLabel;
        if (message.createdAt) {
          return formatJst(message.createdAt, true);
        }
        return '';
      }
      function renderAuthorAvatar(email, label, options) {
        var variant = (options && options.variant) || 'md';
        var classes = ['msg-avatar'];
        if (variant === 'lg') classes.push('msg-avatar--lg');
        var profile = email ? getUserProfile(email) : null;
        var imageUrl = '';
        if (profile && profile.imageUrl && profile.imageUrl !== PROFILE_PLACEHOLDER_URL) {
          imageUrl = profile.imageUrl;
        }
        if (options && options.imageUrl) {
          imageUrl = options.imageUrl;
        }
        var safeLabel = sanitizePersonLabel(label) || '投稿者';
        var initialsSource = sanitizePersonLabel(label);
        if (!initialsSource && profile) {
          initialsSource = sanitizePersonLabel(profile.name);
        }
        var initials = (initialsSource || safeLabel).slice(0, 2) || '？';
        if (imageUrl) {
          return (
            '<span class="' +
            classes.join(' ') +
            '"><img src="' +
            esc(imageUrl) +
            '" alt="' +
            esc(safeLabel) +
            '" loading="lazy"></span>'
          );
        }
        classes.push('msg-avatar--initials');
        return (
          '<span class="' +
          classes.join(' ') +
          '" aria-label="' +
          esc(safeLabel) +
          '">' +
          esc(initials) +
          '</span>'
        );
      }
      function renderMessageCard(m, options) {
        var opts = options || {};
        var isRead = !!m.isRead;
        var authorLabel = resolveMessageAuthorLabel(m);
        var timestampLabel = resolveMessageTimestampLabel(m);
        var classes = ['card', 'app-card', 'msg-card', 'mb-2'];
        if (!isRead) classes.push('unread');
        if (m.isPinned) classes.push('msg-card--pinned');
        if (opts.compact) classes.push('msg-card-compact');
        var priority = m.priority || '中';
        var priorityPill =
          '<span class="priority-pill ' +
          priorityClassName(priority) +
          '">' +
          esc(priority) +
          '</span>';
        var pinIndicator = m.isPinned
          ? '<span class="pin-indicator material-icons-outlined" aria-hidden="true">push_pin</span>'
          : '';
        var preview = m.preview || m.body || '';
        var previewHtml = esc(preview || '').replace(/\n/g, '<br>');
        var linkClasses = ['msg-link', 'link-surface', 'flex-grow-1'];
        var bodyClasses = ['card-body', 'app-card-body'];
        var actionHtml = '';
        if (!opts.hideAction) {
          var actionButtons = [];
          if (IS_MANAGER) {
            actionButtons.push(
              '<button class="btn btn-outline-secondary btn-sm msg-action-btn msg-action-btn--icon" onclick="event.preventDefault(); togglePin(this,\'' +
                m.id +
                "'," +
                (m.isPinned ? 'false' : 'true') +
                ')" aria-label="' +
                (m.isPinned ? 'ピン解除' : 'ピン留め') +
                '" title="' +
                (m.isPinned ? 'ピン解除' : 'ピン留め') +
                '">' +
                '<span class="material-icons pin-toggle-icon ' +
                (m.isPinned ? 'pin-toggle-icon--off' : 'pin-toggle-icon--on') +
                '" aria-hidden="true">push_pin</span>' +
                '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>' +
                '</button>'
            );
          }
          if (actionButtons.length) {
            actionHtml = '<div class="msg-actions flex-shrink-0">' + actionButtons.join('') + '</div>';
          }
        }
        var metaHtml = '';
        if (authorLabel || timestampLabel) {
          var avatarHtml = renderAuthorAvatar(m.createdBy, authorLabel);
          metaHtml =
            '<div class="msg-meta-line">' +
            avatarHtml +
            '<div class="msg-meta-text">' +
            (authorLabel ? '<div class="msg-meta-author">' + esc(authorLabel) + '</div>' : '') +
            (timestampLabel ? '<div class="msg-meta-time">' + esc(timestampLabel) + '</div>' : '') +
            '</div>' +
            '</div>';
        }
        return (
          '<div class="' +
          classes.join(' ') +
          '" data-memo="' +
          m.id +
          '">' +
          '<div class="' +
          bodyClasses.join(' ') +
          '">' +
          '<a href="#" class="' +
          linkClasses.join(' ') +
          '" data-message-link="' +
          m.id +
          '">' +
          '<div class="msg-content">' +
          '<div class="msg-lines app-card-main flex-grow-1">' +
          '<div class="msg-title-line">' +
          pinIndicator +
          priorityPill +
          '<span class="msg-title ' +
          (isRead ? 'text-muted' : '') +
          '">' +
          esc(m.title) +
          '</span>' +
          '</div>' +
          '<div class="msg-preview">' +
          previewHtml +
          '</div>' +
          metaHtml +
          '</div>' +
          '</div>' +
          '</a>' +
          actionHtml +
          '</div>' +
          '</div>'
        );
      }

      function rowMsg(m) {
        return renderMessageCard(m, { hideAction: false });
      }
      function filterMessages(list, suppliedFilters) {
        var filters = suppliedFilters || MessageViewController.getFilters();
        var folderId = filters.folderId || '';
        var unreadOnly = !!filters.unreadOnly;
        var kw = filters.keyword || '';
        var rows = normalizeArray(list).slice();
        if (unreadOnly)
          rows = rows.filter(function (x) {
            return !x.isRead;
          });
        if (folderId) {
          var normalized = folderId.toLowerCase();
          rows = rows.filter(function (x) {
            var candidate = String(x && x.folderId != null ? x.folderId : '').trim();
            return candidate.toLowerCase() === normalized;
          });
        }
        if (kw) {
          rows = rows.filter(function (x) {
            return String(x.title || '').indexOf(kw) >= 0 || String(x.body || '').indexOf(kw) >= 0;
          });
        }
        return rows;
      }
      function getMessagesCacheKey(folderId, unreadOnly) {
        var folder = folderId ? String(folderId) : 'all';
        return 'messages:' + folder + ':unread:' + (unreadOnly ? '1' : '0');
      }
      function loadMessagesFromCache(cacheKey) {
        return readUserCacheEntry(cacheKey).then(function (entry) {
          if (!entry || !entry.value) return null;
          var rows = normalizeArray(entry.value.rows);
          return { rows: rows, empty: entry.value.empty };
        });
      }
      function cacheMessages(cacheKey, rows) {
        return writeUserCacheEntry(cacheKey, {
          rows: Array.isArray(rows) ? rows : [],
          empty: !rows || rows.length === 0,
        });
      }
      function renderMessageList(rows) {
        var list = Array.isArray(rows) ? rows : [];
        if (!list.length) {
          return '<div class="card app-card msg-card mb-2"><div class="card-body text-muted">メッセージはありません。</div></div>';
        }
        return list
          .map(function (m) {
            return rowMsg(m);
          })
          .join('');
      }
      function setMsgLoading(loading) {
        if (loading) byId('msg-list').innerHTML = skel(6);
        var btnAll = byId('btn-msg-markall');
        if (btnAll) btnAll.disabled = !!loading;
      }
      function loadMessages(options) {
        const opts = options || {};
        if (!HAS_ACTIVE_EMAIL) {
          byId('msg-list').innerHTML = authRequiredCard();
          if (!AUTH_NOTICE_SHOWN) {
            notify(AUTH_NOTICE_MESSAGE, false);
            AUTH_NOTICE_SHOWN = true;
          }
          return Promise.resolve(false);
        }
        var filters = MessageViewController.getFilters();
        var folderOpt = filters.folderId || '';
        var unreadOnlyFlag = !!filters.unreadOnly;
        var searchKeyword = filters.keyword || '';
        var useCache = !searchKeyword;
        var cacheKey = useCache ? MessageViewController.buildCacheKey(filters) : null;
        var cachedRows = null;
        const now = Date.now();
        const shouldSkipFetch = shouldThrottleFetch(LAST_MESSAGES_FETCH_AT, opts);
        var skeletonStartedAt = Date.now();
        var cachePromise = useCache
          ? loadMessagesFromCache(cacheKey).catch(function () {
              return null;
            })
          : Promise.resolve(null);
        return cachePromise
          .then(function (cached) {
            if (cached && Array.isArray(cached.rows)) {
              cachedRows = cached.rows;
            }
          })
          .then(function () {
            if (shouldSkipFetch && cachedRows) {
              byId('msg-list').innerHTML = renderMessageList(cachedRows);
              setMsgLoading(false);
              return false;
            }
            setMsgLoading(true);
            return new Promise(function (resolve) {
              google.script.run
                .withSuccessHandler(function (list) {
                  var rows = filterMessages(list);
                  if (useCache) {
                    cacheMessages(cacheKey, rows);
                  }
                  LAST_MESSAGES_FETCH_AT = Date.now();
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    byId('msg-list').innerHTML = renderMessageList(rows);
                    setMsgLoading(false);
                  });
                  resolve(true);
                })
                .withFailureHandler(function (e) {
                  notify('Failed to load messages: ' + e.message, false);
                  revealAfterDelay(skeletonStartedAt, MIN_CONTENT_SKELETON_MS, function () {
                    if (Array.isArray(cachedRows)) {
                      byId('msg-list').innerHTML = renderMessageList(cachedRows);
                    } else {
                      byId('msg-list').innerHTML =
                        '<div class="card app-card msg-card mb-2"><div class="card-body text-danger">メッセージの読み込みに失敗しました。</div></div>';
                    }
                    setMsgLoading(false);
                  });
                  resolve(false);
                })
                .getMessages({
                  folderId: folderOpt || undefined,
                  unreadOnly: unreadOnlyFlag,
                });
            });
          });
      }
      function handleMessageCardClick(event) {
        if (!event) return;
        if (event.target && event.target.closest('.msg-action-btn')) return;
        var card = event.target && event.target.closest('[data-memo]');
        if (!card) return;
        var memoId = card.getAttribute('data-memo');
        if (!memoId) return;
        var anchor = event.target.closest('.msg-link');
        if (anchor) {
          event.preventDefault();
        }
        openMessageModal(memoId);
      }
      function attachMessageCardNavigation(targetId) {
        var container = byId(targetId);
        if (!container) return;
        container.addEventListener('click', handleMessageCardClick);
      }
      attachMessageCardNavigation('msg-list');
      attachMessageCardNavigation('home-unread');
      function togglePin(btn, memoId, shouldPin) {
        if (!IS_MANAGER) {
          notify('ピン操作は管理者のみ可能です。', false);
          return;
        }
        setButtonLoading(btn, true);
        apiRequest(`${API_BASE_PATH}/messages/${encodeURIComponent(memoId)}/pin`, {
          method: 'POST',
        })
          .then(function (res) {
            setButtonLoading(btn, false);
            notify('ピン状態を更新しました。', true);
            loadMessages({ force: true });
            loadHome({ force: true });
          })
          .catch(function (err) {
            setButtonLoading(btn, false);
            notify('ピン更新に失敗しました: ' + (err.message || ''), false);
          });
      }
      on('btn-msg-markall', 'click', function () {
        var btn = byId('btn-msg-markall');
        if (!btn) return;
        btn.disabled = true;
        var originalHTML = btn.innerHTML;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>処理中...';
        var folderRef = byId('flt-msg-folder') ? byId('flt-msg-folder').value : '';
        if (folderRef != null) folderRef = String(folderRef).trim();
        if (!folderRef || folderRef.toLowerCase() === 'all') folderRef = '';
        google.script.run
          .withSuccessHandler(function (list) {
            var rows = filterMessages(list).filter(function (x) {
              return !x.isRead;
            });
            var ids = rows.map(function (x) {
              return x.id;
            });
            if (ids.length === 0) {
              notify('未読メッセージはありません', true);
              btn.disabled = false;
              btn.innerHTML = originalHTML;
              return;
            }
            google.script.run
              .withSuccessHandler(function (res) {
                notify(
                  res && res.message ? res.message : '既読にしました',
                  res && res.success !== false
                );
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                loadMessages({ force: true });
                loadHome({ force: true });
              })
              .withFailureHandler(function (e) {
                notify('Failed to mark messages as read: ' + e.message, false);
                btn.disabled = false;
                btn.innerHTML = originalHTML;
              })
              .markMemosReadBulk(ids);
          })
          .withFailureHandler(function (e) {
            notify('Failed to refresh messages: ' + e.message, false);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
          })
          .getMessages({
            folderId: folderRef || undefined,
            unreadOnly: !!(byId('flt-msg-unread') || {}).checked,
          });
      });

      // ===== Detail / Modal =====
      function filterImageAttachments(list) {
        if (!Array.isArray(list)) return [];
        return list.filter(function (item) {
          var hasImage = item && /^image\//i.test(String(item.mimeType || ''));
          return hasImage && item.url;
        });
      }
      function renderAttachList(list) {
        if (!Array.isArray(list) || list.length === 0) return '';
        return list
          .map(function (a) {
            var name = esc(a.name || '(不明)');
            var size = humanBytes(a.size || 0);
            var mime = esc(a.mimeType || '');
            var isImage = /^image\//i.test(String(a.mimeType || ''));
            var icon = isImage ? 'image' : 'insert_drive_file';
            var url = a.url ? esc(a.url) : '';
            var linkHtml = url
              ? '<a class="btn btn-sm btn-outline-primary" href="' +
                url +
                '" target="_blank" rel="noopener">開く</a>'
              : '<span class="text-muted small">リンクなし</span>';
            return (
              '<li class="list-group-item attach-item">' +
              '<span class="material-icons-outlined attach-icon" aria-hidden="true">' +
              icon +
              '</span>' +
              '<div class="flex-grow-1">' +
              '<div class="fw-semibold">' +
              name +
              '</div>' +
              '<div class="attach-meta">' +
              mime +
              (size ? ' ・ ' + size : '') +
              '</div>' +
              '</div>' +
              linkHtml +
              '</li>'
            );
          })
          .join('');
      }
      function renderImagePreviewGrid(images) {
        if (!Array.isArray(images) || images.length === 0) return '';
        return images
          .map(function (img, index) {
            var url = esc(img.url || '');
            var label = esc(img.name || '画像 ' + (index + 1));
            return (
              '<button type="button" class="image-preview-grid__item" data-image-viewer-index="' +
              index +
              '">' +
              '<img src="' +
              url +
              '" alt="' +
              label +
              '" loading="lazy">' +
              '<span class="image-preview-grid__caption">' +
              label +
              '</span>' +
              '</button>'
            );
          })
          .join('');
      }
      function formatUserLabel(entry) {
        if (!entry) return '';
        if (typeof entry === 'string') return entry;
        var label = entry.label || entry.displayName || entry.name || '';
        if (label) return label;
        return entry.email || entry.address || '';
      }
      function renderUserChips(targetId, entries) {
        var host = byId(targetId);
        if (!host) return;
        var chips = normalizeArray(entries)
          .map(function (entry) {
            if (!entry) return null;
            var email = '';
            var label = '';
            var imageUrl = '';
            if (typeof entry === 'string') {
              email = entry;
            } else if (typeof entry === 'object') {
              email = entry.email || entry.address || '';
              label = formatUserLabel(entry);
              imageUrl = entry.imageUrl || '';
            }
            var profile = getUserProfile(email);
            if (!label && profile && profile.name) {
              label = profile.name;
            }
            if (!imageUrl && profile && profile.imageUrl) {
              imageUrl = profile.imageUrl;
            }
            if (!label && email) {
              label = email.split('@')[0];
            }
            if (!label) return null;
            var initials = label.trim().slice(0, 2) || '?';
            return {
              label: label,
              avatar: imageUrl,
              initials: initials,
            };
          })
          .filter(function (entry) {
            return entry && entry.label;
          })
          .map(function (entry) {
            var avatarHtml;
            if (entry.avatar) {
              avatarHtml =
                '<span class="user-chip__avatar"><img src="' +
                esc(entry.avatar) +
                '" alt="' +
                esc(entry.label) +
                '" loading="lazy" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src=\'' +
                esc(PROFILE_PLACEHOLDER_URL) +
                '\';"></span>';
            } else {
              avatarHtml =
                '<span class="user-chip__avatar user-chip__avatar--initials">' +
                esc(entry.initials) +
                '</span>';
            }
            return (
              '<span class="user-chip">' +
              avatarHtml +
              '<span class="user-chip__label">' +
              esc(entry.label) +
              '</span>' +
              '</span>'
            );
          });
        host.innerHTML = chips.length ? chips.join('') : '<span class="text-muted">該当なし</span>';
      }
      var CURRENT_TASK_ID = null;
      function openTaskDetail(id) {
        CURRENT_TASK_ID = id;
        var modalEl = byId('taskDetailModal');
        if (!modalEl) {
          notify('タスク詳細モーダルが見つかりません', false);
          return;
        }
        var m = new bootstrap.Modal(modalEl);
        m.show();
        byId('task-detail-loading').classList.remove('d-none');
        byId('task-detail-content').classList.add('d-none');
        byId('deleteTaskButton').classList.add('d-none');
        byId('taskAttachments').classList.add('d-none');
        byId('taskAttachList').innerHTML = '';
        google.script.run
          .withSuccessHandler(function (t) {
            if (!t) {
              notify('タスクが見つかりませんでした', false);
              return;
            }
            byId('detailTaskTitle').textContent = t.title;
            var assigneeEmails =
              Array.isArray(t.assignees) && t.assignees.length
                ? t.assignees
                : t.assignee
                ? [t.assignee]
                : [];
            var assigneesText = assigneeEmails.map((email) => getNameByEmail(email)).join(', ');
            if (!assigneesText) assigneesText = '担当者未設定';
            var repeatLabel = 'なし';
            if (t.repeatRule) {
              var rule = String(t.repeatRule).toUpperCase();
              if (rule === 'DAILY') repeatLabel = '毎日';
              else if (rule === 'WEEKLY') repeatLabel = '毎週';
              else if (rule === 'MONTHLY') repeatLabel = '毎月';
              else repeatLabel = t.repeatRule;
            }
            var detailSection = byId('taskDetailBody');
            detailSection.innerHTML =
              '<div class="section-body">' +
              '<p class="mb-2"><strong>担当者:</strong> ' +
              esc(assigneesText) +
              '</p>' +
              '<p class="mb-0"><strong>繰り返し:</strong> ' +
              esc(repeatLabel) +
              '</p>' +
              '</div>';
            var att = Array.isArray(t.attachments) ? t.attachments : [];
            if (att.length) {
              byId('taskAttachList').innerHTML = renderAttachList(att);
              byId('taskAttachments').classList.remove('d-none');
            }
            byId('detailStatus').value = t.status || '未着手';
            byId('detailDue').value = t.dueDate || '';
            byId('detailPriority').value = t.priority || '中';
            if (t.canDelete) byId('deleteTaskButton').classList.remove('d-none');
            byId('task-detail-loading').classList.add('d-none');
            byId('task-detail-content').classList.remove('d-none');
          })
          .getTaskById(id);
      }
      on('btnTaskQuickSave', 'click', function () {
        if (!CURRENT_TASK_ID) return;
        var btn = byId('btnTaskQuickSave');
        var payload = {
          id: CURRENT_TASK_ID,
          title: byId('detailTaskTitle').textContent,
          dueDate: byId('detailDue').value,
          status: byId('detailStatus').value,
          priority: byId('detailPriority').value,
        };
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function (res) {
            setButtonLoading(btn, false);
            notify(res && res.message ? res.message : '更新しました', res && res.success !== false);
            var modalInst = bootstrap.Modal.getInstance(byId('taskDetailModal'));
            if (modalInst) modalInst.hide();
            loadHome({ force: true });
            loadMyTasks({ force: true });
            if (TASK_STATE.from && TASK_STATE.from.loaded) {
              loadCreatedTasks({ force: true });
            }
            if (IS_MANAGER && TASK_STATE.all && TASK_STATE.all.loaded) {
              loadAllTasks({ force: true });
            }
          })
          .withFailureHandler(function (e) {
            setButtonLoading(btn, false);
            notify('更新に失敗: ' + e.message, false);
          })
          .updateTask(payload);
      });
      on('btnTaskComplete', 'click', function () {
        if (!CURRENT_TASK_ID) return;
        var btn = byId('btnTaskComplete');
        if (!confirm('このタスクを完了にします。よろしいですか？')) return;
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function (res) {
            setButtonLoading(btn, false);
            notify(res && res.message ? res.message : '完了しました', res && res.success !== false);
            var inst = bootstrap.Modal.getInstance(byId('taskDetailModal'));
            if (inst) inst.hide();
            loadHome({ force: true });
            loadMyTasks({ force: true });
          })
          .withFailureHandler(function (e) {
            setButtonLoading(btn, false);
            notify('完了処理に失敗: ' + e.message, false);
          })
          .completeTask(CURRENT_TASK_ID);
      });
      on('deleteTaskButton', 'click', function () {
        if (!CURRENT_TASK_ID) return;
        if (!confirm('このタスクを削除します。よろしいですか？')) return;
        google.script.run
          .withSuccessHandler(function (res) {
            notify(res && res.message ? res.message : '削除しました', res && res.success !== false);
            var inst = bootstrap.Modal.getInstance(byId('taskDetailModal'));
            if (inst) inst.hide();
            loadHome({ force: true });
            loadMyTasks({ force: true });
          })
          .withFailureHandler(function (e) {
            notify('削除に失敗: ' + e.message, false);
          })
          .deleteTaskById(CURRENT_TASK_ID);
      });
      var CURRENT_MEMO_ID = null;
      var CURRENT_MESSAGE_ATTACHMENTS = [];
      var CURRENT_IMAGE_ATTACHMENTS = [];
      var CURRENT_IMAGE_INDEX = 0;
      function renderMessageDetail(data) {
        if (!data) return;
        var titleEl = byId('msgDetailTitle');
        if (titleEl) titleEl.textContent = data.title || '';
        var authorLabel = resolveMessageAuthorLabel(data);
        var timestampLabel = resolveMessageTimestampLabel(data);
        var avatarSlot = byId('msgDetailAvatar');
        if (avatarSlot) {
          avatarSlot.innerHTML = renderAuthorAvatar(data.createdBy, authorLabel, { variant: 'lg' });
        }
        var authorEl = byId('msgDetailAuthor');
        if (authorEl) authorEl.textContent = authorLabel || '投稿者';
        var timeEl = byId('msgDetailTimestamp');
        if (timeEl) timeEl.textContent = timestampLabel || '—';
        var metaWrap = byId('msgDetailMeta');
        if (metaWrap) metaWrap.classList.remove('d-none');
        var bodySlot = byId('msgDetailBody');
        if (bodySlot) {
          var section = bodySlot.querySelector('.section-body');
          if (section) {
            section.innerHTML = esc(data.body || '').replace(/\n/g, '<br>');
          }
        }
        var attachmentsWrap = byId('msgAttachments');
        var attachList = byId('msgAttachList');
        var previewWrap = byId('msgImagePreview');
        var att = Array.isArray(data.attachments) ? data.attachments : [];
        CURRENT_MESSAGE_ATTACHMENTS = att.slice();
        var imageAttachments = filterImageAttachments(att);
        CURRENT_IMAGE_ATTACHMENTS = imageAttachments;
        CURRENT_IMAGE_INDEX = 0;
        if (att.length) {
          if (attachList) attachList.innerHTML = renderAttachList(att);
          if (attachmentsWrap) attachmentsWrap.classList.remove('d-none');
          if (previewWrap) {
            var previewHtml = renderImagePreviewGrid(imageAttachments);
            previewWrap.innerHTML = previewHtml;
            previewWrap.classList.toggle('d-none', !previewHtml);
          }
        } else {
          if (attachmentsWrap) attachmentsWrap.classList.add('d-none');
          if (attachList) attachList.innerHTML = '';
          if (previewWrap) {
            previewWrap.innerHTML = '';
            previewWrap.classList.add('d-none');
          }
        }
        var commentsHtml = '';
        (data.comments || []).forEach(function (c) {
          var email = String(c.authorEmail || '').trim();
          var name = String(c.authorName || '').trim();
          if (!name && c.author) {
            name = String(c.author || '').trim();
          }
          if (!name && email) {
            var mapped = getNameByEmail(email);
            name = mapped !== email ? mapped : '';
          }
          var authorLabel = name;
          if (!authorLabel && c.author) {
            authorLabel = String(c.author || '').trim();
          }
          if (!authorLabel) {
            authorLabel = '投稿者不明';
          }
          var safeBody = esc(c.body || '')
            .replace(/&lt;br&gt;/gi, '<br>')
            .replace(/\n/g, '<br>');
          commentsHtml +=
            '<div class="card mb-2"><div class="card-body"><p class="mb-0">' +
            safeBody +
            '</p><small class="text-muted">' +
            esc(authorLabel) +
            ' - ' +
            esc(c.createdAt) +
            '</small></div></div>';
        });
        if (!data.comments || data.comments.length === 0) {
          commentsHtml = '<p class="text-muted">コメントはまだありません。</p>';
        }
        var commentsEl = byId('comments-list');
        if (commentsEl) commentsEl.innerHTML = commentsHtml;
        renderUserChips('msgReadUsers', data.readUsers);
        renderUserChips('msgUnreadUsers', data.unreadUsers);
        var deleteBtn = byId('deleteMessageButton');
        if (deleteBtn) deleteBtn.classList.toggle('d-none', !data.canDelete);
      }
      function openImageViewer(index) {
        if (!Array.isArray(CURRENT_IMAGE_ATTACHMENTS) || !CURRENT_IMAGE_ATTACHMENTS.length) return;
        var viewer = byId('imageViewer');
        if (!viewer) return;
        var safeIndex = Number(index);
        if (isNaN(safeIndex)) safeIndex = 0;
        safeIndex = Math.max(0, Math.min(safeIndex, CURRENT_IMAGE_ATTACHMENTS.length - 1));
        CURRENT_IMAGE_INDEX = safeIndex;
        renderActiveImage();
        if (!viewer.classList.contains('is-open')) {
          viewer.classList.add('is-open');
          viewer.setAttribute('aria-hidden', 'false');
          document.body.classList.add('image-viewer-open');
          if (peekOverlayHistoryTag() !== 'image-viewer') {
            pushOverlayHistory('image-viewer');
          }
        }
      }
      function closeImageViewer(fromHistory) {
        var viewer = byId('imageViewer');
        if (!viewer || !viewer.classList.contains('is-open')) return;
        viewer.classList.remove('is-open');
        viewer.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('image-viewer-open');
        if (!fromHistory && peekOverlayHistoryTag() === 'image-viewer') {
          popOverlayHistory('image-viewer');
        }
      }
      function renderActiveImage() {
        if (!Array.isArray(CURRENT_IMAGE_ATTACHMENTS) || !CURRENT_IMAGE_ATTACHMENTS.length) return;
        var item = CURRENT_IMAGE_ATTACHMENTS[CURRENT_IMAGE_INDEX];
        if (!item) return;
        var label = item.name || '画像 ' + (CURRENT_IMAGE_INDEX + 1);
        var viewerImage = byId('imageViewerImage');
        if (viewerImage) {
          viewerImage.src = item.url || '';
          viewerImage.alt = label;
        }
        var titleEl = byId('imageViewerTitle');
        if (titleEl) titleEl.textContent = label;
        var counterEl = byId('imageViewerCounter');
        if (counterEl) {
          counterEl.textContent =
            CURRENT_IMAGE_ATTACHMENTS.length > 1
              ? CURRENT_IMAGE_INDEX + 1 + ' / ' + CURRENT_IMAGE_ATTACHMENTS.length
              : '';
        }
        var openLink = byId('imageViewerOpen');
        if (openLink) openLink.href = item.url || '#';
        var downloadLink = byId('imageViewerDownload');
        if (downloadLink) {
          downloadLink.href = item.url || '#';
          downloadLink.download = item.name || '';
        }
        var prevBtn = byId('imageViewerPrev');
        var nextBtn = byId('imageViewerNext');
        var hasMultiple = CURRENT_IMAGE_ATTACHMENTS.length > 1;
        if (prevBtn) {
          prevBtn.classList.toggle('d-none', !hasMultiple);
          prevBtn.disabled = CURRENT_IMAGE_INDEX === 0;
        }
        if (nextBtn) {
          nextBtn.classList.toggle('d-none', !hasMultiple);
          nextBtn.disabled = CURRENT_IMAGE_INDEX >= CURRENT_IMAGE_ATTACHMENTS.length - 1;
        }
      }
      function stepImageViewer(delta) {
        if (!Array.isArray(CURRENT_IMAGE_ATTACHMENTS) || !CURRENT_IMAGE_ATTACHMENTS.length) return;
        var nextIndex = CURRENT_IMAGE_INDEX + delta;
        if (nextIndex < 0 || nextIndex >= CURRENT_IMAGE_ATTACHMENTS.length) return;
        CURRENT_IMAGE_INDEX = nextIndex;
        renderActiveImage();
      }
      function setupImageViewerControls() {
        on('msgImagePreview', 'click', function (event) {
          if (!event || !event.target || typeof event.target.closest !== 'function') return;
          var trigger = event.target.closest('[data-image-viewer-index]');
          if (!trigger) return;
          event.preventDefault();
          var idx = Number(trigger.getAttribute('data-image-viewer-index'));
          openImageViewer(idx);
        });
        var viewer = byId('imageViewer');
        if (!viewer) return;
        viewer.addEventListener('click', function (event) {
          var target = event.target;
          if (target && typeof target.closest === 'function') {
            if (target.closest('[data-image-viewer-close]')) {
              closeImageViewer(false);
              return;
            }
            if (target.closest('[data-image-viewer-prev]')) {
              event.stopPropagation();
              stepImageViewer(-1);
              return;
            }
            if (target.closest('[data-image-viewer-next]')) {
              event.stopPropagation();
              stepImageViewer(1);
              return;
            }
          }
          if (event.target === viewer) {
            closeImageViewer(false);
          }
        });
        document.addEventListener('keydown', function (event) {
          if (!viewer.classList.contains('is-open')) return;
          if (event.key === 'Escape') {
            event.preventDefault();
            closeImageViewer(false);
          } else if (event.key === 'ArrowLeft') {
            event.preventDefault();
            stepImageViewer(-1);
          } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            stepImageViewer(1);
          }
        });
      }
      setupImageViewerControls();
      function refreshMessageDetail() {
        if (!CURRENT_MEMO_ID) return;
        google.script.run
          .withSuccessHandler(function (data) {
            if (!data) return;
            renderMessageDetail(data);
          })
          .withFailureHandler(function (e) {
            notify('メッセージの再読み込みに失敗: ' + e.message, false);
          })
          .getMessageById(CURRENT_MEMO_ID);
      }
      const UnreadStatusController = (function () {
        const MODAL_ID = 'unreadStatusModal';
        function render(result) {
          const content = byId('unreadStatusContent');
          const loading = byId('unreadStatusLoading');
          const list = byId('unreadStatusList');
          const summary = byId('unreadStatusSummary');
          if (loading) loading.classList.add('d-none');
          if (!content || !list || !summary) return;
          const unread = Array.isArray(result?.unread) ? result.unread : [];
          summary.textContent =
            '未読 ' +
            unread.length +
            ' / 対象 ' +
            (typeof result?.totalCandidates === 'number' ? result.totalCandidates : unread.length);
          if (!unread.length) {
            list.innerHTML = '<li class="list-group-item text-muted">未読ユーザーはいません。</li>';
          } else {
            list.innerHTML = unread
              .map(function (entry) {
                return (
                  '<li class="list-group-item d-flex justify-content-between align-items-center">' +
                  '<span>' +
                  esc(entry.name || entry.email || '未設定') +
                  '</span>' +
                  '<span class="text-muted small">' +
                  esc(entry.email || '') +
                  '</span>' +
                  '</li>'
                );
              })
              .join('');
          }
          content.classList.remove('d-none');
        }

        function open(messageId) {
          if (!messageId || !IS_MANAGER) {
            notify('管理者のみ未読状況を確認できます。', false);
            return;
          }
          const modalEl = byId(MODAL_ID);
          if (!modalEl) return;
          const loading = byId('unreadStatusLoading');
          const content = byId('unreadStatusContent');
          if (loading) loading.classList.remove('d-none');
          if (content) content.classList.add('d-none');
          bootstrap.Modal.getOrCreateInstance(modalEl).show();
          apiRequest(`${API_BASE_PATH}/messages/${encodeURIComponent(messageId)}/read_status`, {
            method: 'GET',
          })
            .then(render)
            .catch(function (err) {
              console.warn('Failed to load unread status:', err);
              notify('未読状況の取得に失敗しました: ' + (err.message || ''), false);
              const loadingEl = byId('unreadStatusLoading');
              if (loadingEl) loadingEl.classList.add('d-none');
            });
        }

        return {
          open,
        };
      })();

      function openMessageModal(memoId) {
        CURRENT_MEMO_ID = memoId;
        var modalEl = byId('messageDetailModal');
        if (!modalEl) {
          notify('メッセージ詳細モーダルが見つかりません', false);
          return;
        }
        var m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        m.show();
        byId('msg-detail-loading').classList.remove('d-none');
        byId('msg-detail-content').classList.add('d-none');
        byId('deleteMessageButton').classList.add('d-none');
        byId('msgAttachments').classList.add('d-none');
        byId('msgAttachList').innerHTML = '';
        google.script.run
          .withSuccessHandler(function () {
            google.script.run
              .withSuccessHandler(function (data) {
                if (!data) {
                  notify('メッセージ取得失敗', false);
                  return;
                }
                renderMessageDetail(data);
                byId('msg-detail-loading').classList.add('d-none');
                byId('msg-detail-content').classList.remove('d-none');
                loadHome({ force: true });
              })
              .getMessageById(memoId);
          })
          .markMemoAsRead(memoId);
      }
      on('btnCommentPost', 'click', function () {
        var body = (byId('newCommentBody').value || '').trim();
        if (!body) {
          notify('コメントが未入力です', false);
          return;
        }
        google.script.run
          .withSuccessHandler(function (res) {
            if (res && res.success) {
              byId('newCommentBody').value = '';
              openMessageModal(CURRENT_MEMO_ID);
            }
            notify(res.message || '完了', res.success !== false);
          })
          .addNewComment({ memoId: CURRENT_MEMO_ID, body: body });
      });
      on('btnMsgToTask', 'click', function () {
        if (!CURRENT_MEMO_ID) return;
        var btn = byId('btnMsgToTask');
        if (!btn) return;
        setButtonLoading(btn, true);
        google.script.run
          .withSuccessHandler(function (data) {
            setButtonLoading(btn, false);
            if (!data) {
              notify('メッセージが取得できませんでした。', false);
              return;
            }
            var detailModalEl = byId('messageDetailModal');
            var detailModal =
              detailModalEl &&
              (bootstrap.Modal.getInstance(detailModalEl) || new bootstrap.Modal(detailModalEl));
            if (detailModal) detailModal.hide();
            var hint = byId('taskFromMsgHint');
            if (hint) hint.classList.remove('d-none');
            var backLink = byId('backToMsgLink');
            if (backLink) {
              backLink.textContent = data.title || '元メッセージ';
              backLink.onclick = function (e) {
                e.preventDefault();
                if (!detailModalEl) return;
                var modal =
                  bootstrap.Modal.getInstance(detailModalEl) || new bootstrap.Modal(detailModalEl);
                modal.show();
              };
            }
            var titleInput = byId('taskTitle');
            if (titleInput) titleInput.value = '[From Message] ' + (data.title || '');
            var today = new Date();
            var y = today.getFullYear(),
              m = ('0' + (today.getMonth() + 1)).slice(-2),
              d = ('0' + today.getDate()).slice(-2);
            var dueInput = byId('taskDueDate');
            if (dueInput) dueInput.value = y + '-' + m + '-' + d;
            var priorityInput = byId('taskPriority');
            if (priorityInput) priorityInput.value = data.priority || '中';
            resetAssigneeList();
            var taskModalEl = byId('newTaskModal');
            if (!taskModalEl) return;
            var taskModal =
              bootstrap.Modal.getInstance(taskModalEl) || new bootstrap.Modal(taskModalEl);
            taskModal.show();
            setTimeout(function () {
              if (titleInput) titleInput.focus();
            }, 120);
          })
          .withFailureHandler(function (e) {
            setButtonLoading(btn, false);
            notify('タスク作成用の情報取得に失敗しました: ' + e.message, false);
          })
          .getMessageById(CURRENT_MEMO_ID);
      });
      on('deleteMessageButton', 'click', function () {
        if (!CURRENT_MEMO_ID) return;
        if (!confirm('このメッセージを削除します。よろしいですか？')) return;
        google.script.run
          .withSuccessHandler(function (res) {
            notify(res && res.message ? res.message : '削除しました', res && res.success !== false);
            var inst = bootstrap.Modal.getInstance(byId('messageDetailModal'));
            if (inst) inst.hide();
            loadMessages({ force: true });
            loadHome({ force: true });
          })
          .withFailureHandler(function (e) {
            notify('削除に失敗: ' + e.message, false);
          })
          .deleteMessageById(CURRENT_MEMO_ID);
      });
      on('btnUnreadStatus', 'click', function () {
        if (!CURRENT_MEMO_ID) return;
        UnreadStatusController.open(CURRENT_MEMO_ID);
      });

      const ProfileImageController = (function () {
        const SELECTORS = {
          trigger: 'btn-setting-image',
          input: 'setting-image-file',
          label: 'setting-image-name',
          avatar: 'setting-avatar-preview',
        };

        function setLabel(text, pending) {
          var label = byId(SELECTORS.label);
          if (!label) return;
          var value = text && String(text).trim() ? String(text).trim() : '未設定';
          if (pending && value !== '未設定') {
            value += '（未保存）';
          }
          label.textContent = value;
          label.classList.toggle('is-pending', !!pending);
        }

        function updateAvatarPreview(url, opts) {
          var img = byId(SELECTORS.avatar);
          if (!img) return;
          var pending = !!(opts && opts.pending);
          var override = typeof url === 'string' ? url.trim() : '';
          if (!override) {
            var saved = String(img.getAttribute('data-avatar-url') || '').trim();
            var fallback = img.getAttribute('data-placeholder') || PROFILE_PLACEHOLDER_URL;
            img.src = saved || fallback;
            img.classList.remove('is-pending');
            return;
          }
          img.src = override;
          img.classList.toggle('is-pending', pending);
          if (!pending) {
            img.setAttribute('data-avatar-url', override);
          }
        }

        function resetFileInput() {
          var input = byId(SELECTORS.input);
          if (input) input.value = '';
        }

        function openPicker(event) {
          if (event) event.preventDefault();
          var input = byId(SELECTORS.input);
          if (input) input.click();
        }

        function handleFileSelection(event) {
          var input = event && event.currentTarget ? event.currentTarget : byId(SELECTORS.input);
          if (!input) return;
          var file = input.files && input.files[0];
          if (!file) return;
          if (!/^image\//i.test(file.type || '')) {
            notify('画像ファイルを選択してください。', false);
            resetFileInput();
            return;
          }
          if (file.size > PROFILE_IMAGE_MAX_BYTES) {
            notify(
              '画像サイズは最大 ' + humanBytes(PROFILE_IMAGE_MAX_BYTES) + ' までです。',
              false
            );
            resetFileInput();
            return;
          }
          readFileAsDataUrl(file)
            .then(function (data) {
              pendingProfileImage = { name: file.name, dataUri: data, size: file.size };
              setLabel(file.name, true);
              updateAvatarPreview(data, { pending: true });
              resetFileInput();
            })
            .catch(function () {
              notify('画像の読み込みに失敗しました。', false);
              resetFileInput();
            });
        }

        function resetPendingState() {
          pendingProfileImage = null;
          resetFileInput();
        }

        function applyLoadedSettings(settings) {
          settings = settings || {};
          resetPendingState();
          var labelText = '';
          if (settings.imageName) labelText = settings.imageName;
          else if (settings.imageUrl && settings.imageUrl !== PROFILE_PLACEHOLDER_URL)
            labelText = '設定済み';
          setLabel(labelText, false);
          updateAvatarPreview(settings.imageUrl || '', { pending: false });
          applyUserAvatar(settings.imageUrl || '');
        }

        function applySaveResult(result) {
          if (!result) return;
          var payload = result || {};
          var labelText = '';
          if (payload.imageName) labelText = payload.imageName;
          else if (payload.imageUrl && payload.imageUrl !== PROFILE_PLACEHOLDER_URL)
            labelText = '設定済み';
          setLabel(labelText, false);
          updateAvatarPreview(payload.imageUrl || '', { pending: false });
          applyUserAvatar(payload.imageUrl || '');
          resetPendingState();
        }

        function init() {
          on(SELECTORS.trigger, 'click', openPicker);
          var input = byId(SELECTORS.input);
          if (input) {
            input.addEventListener('change', handleFileSelection);
          }
        }

        return {
          init,
          applyLoadedSettings,
          applySaveResult,
          resetPendingState,
        };
      })();

      const MessageAttachmentController = (function () {
        const SELECTORS = {
          trigger: 'btn-message-attach',
          input: 'message-attachment-input',
          list: 'message-attachment-list',
        };

        function openPicker(event) {
          if (event) event.preventDefault();
          var input = byId(SELECTORS.input);
          if (input) input.click();
        }

        function renderList() {
          var list = byId(SELECTORS.list);
          if (!list) return;
          if (!Array.isArray(pendingMessageAttachments) || pendingMessageAttachments.length === 0) {
            list.innerHTML =
              '<li class="text-muted">添付はありません。必要に応じて画像を追加してください。</li>';
            return;
          }
          list.innerHTML = pendingMessageAttachments
            .map(function (att, idx) {
              var name = esc(att && att.name ? att.name : '画像');
              var size = humanBytes(att && att.size ? att.size : 0);
              return (
                '<li class="d-flex align-items-center justify-content-between gap-2 mb-1">' +
                '<span>' +
                name +
                ' (' +
                size +
                ')</span>' +
                '<button type="button" class="btn btn-link btn-sm text-danger p-0" data-attachment-remove="' +
                idx +
                '">削除</button>' +
                '</li>'
              );
            })
            .join('');
        }

        function handleInputChange(event) {
          var input = event && event.currentTarget ? event.currentTarget : byId(SELECTORS.input);
          if (!input) return;
          var files = Array.prototype.slice.call(input.files || []);
          if (!files.length) return;
          var slots = MESSAGE_ATTACHMENT_LIMIT - pendingMessageAttachments.length;
          if (slots <= 0) {
            notify('添付は最大 ' + MESSAGE_ATTACHMENT_LIMIT + ' 件までです。', false);
            input.value = '';
            return;
          }
          if (files.length > slots) {
            notify('添付は最大 ' + MESSAGE_ATTACHMENT_LIMIT + ' 件までです。', false);
            files = files.slice(0, slots);
          }
          var tasks = files.map(function (file) {
            if (!/^image\//i.test(file.type || '')) {
              notify(file.name + ' は画像ファイルではありません。', false);
              return Promise.resolve(null);
            }
            if (file.size > MESSAGE_ATTACHMENT_MAX_BYTES) {
              notify(
                file.name + ' は ' + humanBytes(MESSAGE_ATTACHMENT_MAX_BYTES) + ' を超えています。',
                false
              );
              return Promise.resolve(null);
            }
            return readFileAsDataUrl(file).then(function (data) {
              return { name: file.name, dataUri: data, size: file.size };
            });
          });
          Promise.all(tasks)
            .then(function (items) {
              items.forEach(function (item) {
                if (!item) return;
                if (pendingMessageAttachments.length >= MESSAGE_ATTACHMENT_LIMIT) return;
                pendingMessageAttachments.push(item);
              });
              renderList();
              input.value = '';
            })
            .catch(function () {
              notify('添付画像の読み込みに失敗しました。', false);
              input.value = '';
            });
        }

        function handleRemoveClick(event) {
          var target = event.target;
          if (!target) return;
          var btn =
            typeof target.closest === 'function'
              ? target.closest('[data-attachment-remove]')
              : null;
          if (!btn && target.getAttribute && target.hasAttribute('data-attachment-remove')) {
            btn = target;
          }
          if (!btn) return;
          event.preventDefault();
          var idx = Number(btn.getAttribute('data-attachment-remove'));
          if (Number.isNaN ? Number.isNaN(idx) : isNaN(idx)) return;
          pendingMessageAttachments.splice(idx, 1);
          renderList();
        }

        function reset() {
          pendingMessageAttachments = [];
          renderList();
          var input = byId(SELECTORS.input);
          if (input) input.value = '';
        }

        function init() {
          on(SELECTORS.trigger, 'click', openPicker);
          var input = byId(SELECTORS.input);
          if (input) {
            input.addEventListener('change', handleInputChange);
          }
          var list = byId(SELECTORS.list);
          if (list) {
            list.addEventListener('click', handleRemoveClick);
          }
          renderList();
        }

        return {
          init,
          reset,
          render: renderList,
        };
      })();

      const TaskFormController = (function () {
        const SELECTORS = {
          save: 'saveTaskButton',
          title: 'taskTitle',
          due: 'taskDueDate',
          priority: 'taskPriority',
          repeat: 'taskRepeatType',
        };
        const MODAL_ID = 'newTaskModal';

        function applyRepeatRule(repeatType) {
          switch (repeatType) {
            case 'daily':
              return 'DAILY';
            case 'weekly':
              return 'WEEKLY';
            case 'monthly':
              return 'MONTHLY';
            default:
              return '';
          }
        }

        function buildPayload() {
          var assignees = getSelectedAssignees();
          if (assignees.length === 0) {
            notify('担当者を1名以上選択してください。', false);
            return null;
          }
          var titleEl = byId(SELECTORS.title);
          var dueEl = byId(SELECTORS.due);
          var priorityEl = byId(SELECTORS.priority);
          var repeatEl = byId(SELECTORS.repeat);
          var title = titleEl ? titleEl.value : '';
          var dueDate = dueEl ? dueEl.value : '';
          if (!title || !dueDate) {
            notify('タイトルと期限は必須です。', false);
            return null;
          }
          return {
            title: title,
            dueDate: dueDate,
            priority: priorityEl ? priorityEl.value : '中',
            assignees: assignees,
            repeatRule: applyRepeatRule(repeatEl ? repeatEl.value : 'none'),
          };
        }

        function handleSuccess(btn) {
          return function (res) {
            setButtonLoading(btn, false);
            if (res && res.success) {
              var modalEl = byId(MODAL_ID);
              var modal =
                modalEl && (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl));
              if (modal) modal.hide();
              notify('タスクを作成しました。', true);
            } else {
              notify((res && res.message) || 'タスクの作成に失敗しました。', false);
            }
            loadHome({ force: true });
            loadMyTasks({ force: true });
            if (TASK_STATE.from.loaded) loadCreatedTasks({ force: true });
            if (IS_MANAGER && TASK_STATE.all.loaded) loadAllTasks({ force: true });
          };
        }

        function handleFailure(btn) {
          return function (err) {
            setButtonLoading(btn, false);
            notify('タスクの作成に失敗しました: ' + err.message, false);
          };
        }

        function handleSave(event) {
          if (event) event.preventDefault();
          var btn = byId(SELECTORS.save);
          if (!btn) return;
          var payload = buildPayload();
          if (!payload) return;
          setButtonLoading(btn, true);
          google.script.run
            .withSuccessHandler(handleSuccess(btn))
            .withFailureHandler(handleFailure(btn))
            .addNewTask(payload);
        }

        function init() {
          on(SELECTORS.save, 'click', handleSave);
        }

        return {
          init,
        };
      })();

      const MessageFormController = (function () {
        const SELECTORS = {
          save: 'saveMessageButton',
          title: 'messageTitle',
          body: 'messageBody',
          priority: 'messagePriority',
          folder: 'messageFolder',
          clear: 'btn-message-clear',
        };
        const MODAL_ID = 'newMessageModal';
        let lastFolderId = '';

        function buildPayload() {
          var titleEl = byId(SELECTORS.title);
          var bodyEl = byId(SELECTORS.body);
          var priorityEl = byId(SELECTORS.priority);
          var folderEl = byId(SELECTORS.folder);
          var title = titleEl ? titleEl.value : '';
          var body = bodyEl ? bodyEl.value : '';
          var folderId = folderEl ? folderEl.value : '';
          if (!title || !body) {
            notify('件名と本文は必須です。', false);
            return null;
          }
          if (!folderId) {
            notify('フォルダを選択してください。', false);
            return null;
          }
          return {
            title: title,
            body: body,
            priority: priorityEl ? priorityEl.value : '中',
            folderId: folderId,
            attachments: pendingMessageAttachments.slice(),
          };
        }

        function handleSuccess(btn) {
          return function (res) {
            setButtonLoading(btn, false);
            if (res && res.success) {
              var modalEl = byId(MODAL_ID);
              var modal =
                modalEl && (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl));
              if (modal) modal.hide();
              MessageAttachmentController.reset();
              if (lastFolderId) {
                MessageDraftController.clear(lastFolderId);
              }
            }
            notify(res && res.message ? res.message : '完了', res && res.success !== false);
            loadHome({ force: true });
            loadMessages({ force: true });
          };
        }

        function handleFailure(btn) {
          return function (err) {
            setButtonLoading(btn, false);
            notify('メッセージの投稿に失敗しました: ' + err.message, false);
          };
        }

        function handleSave(event) {
          if (event) event.preventDefault();
          var btn = byId(SELECTORS.save);
          if (!btn) return;
          var payload = buildPayload();
          if (!payload) return;
          lastFolderId = payload.folderId || '';
          setButtonLoading(btn, true);
          google.script.run
            .withSuccessHandler(handleSuccess(btn))
            .withFailureHandler(handleFailure(btn))
            .addNewMessage(payload);
        }

        function handleFolderChange() {
          var folderEl = byId(SELECTORS.folder);
          var folderId = folderEl ? folderEl.value : '';
          MessageDraftController.handleFolderChange(folderId);
        }

        function handleClearFields(event) {
          if (event) event.preventDefault();
          var titleEl = byId(SELECTORS.title);
          var bodyEl = byId(SELECTORS.body);
          if (!titleEl && !bodyEl) return;
          var shouldClear = confirm('件名と本文をクリアします。よろしいですか？');
          if (!shouldClear) return;
          if (titleEl) {
            titleEl.value = '';
            titleEl.focus();
          }
          if (bodyEl) {
            bodyEl.value = '';
          }
          var folderEl = byId(SELECTORS.folder);
          var folderId = folderEl ? folderEl.value : '';
          if (folderId) {
            MessageDraftController.clear(folderId);
          }
        }

        function bindTemplateRefresh() {
          const folderEl = byId(SELECTORS.folder);
          if (folderEl) {
            folderEl.addEventListener('change', function () {
              TemplateController.renderForFolder(folderEl.value || '');
            });
          }
        }

        function init() {
          on(SELECTORS.save, 'click', handleSave);
          on(SELECTORS.clear, 'click', handleClearFields);
          MessageDraftController.init();
          bindTemplateRefresh();
          const quickFolderBtn = byId('btnQuickFolder');
          if (quickFolderBtn) {
            quickFolderBtn.addEventListener('click', QuickFolderController.open);
          }
          const quickFolderSave = byId('btnQuickFolderSave');
          if (quickFolderSave) {
            quickFolderSave.addEventListener('click', QuickFolderController.save);
          }
          const quickFolderPublic = byId('quickFolderPublic');
          if (quickFolderPublic) {
            quickFolderPublic.addEventListener('change', QuickFolderController.toggleMembers);
          }
          handleFolderChange();
        }

        return {
          init,
        };
      })();

      // ===== 設定 =====
      function loadSettings(options) {
        const opts = options || {};
        return new Promise(function (resolve) {
          if (!HAS_ACTIVE_EMAIL) {
            notify(AUTH_NOTICE_MESSAGE, false);
            resolve(false);
            return;
          }
          const lastFetch = LAST_SETTINGS_FETCH_AT || 0;
          const cached = LAST_SETTINGS_CACHE;
          if (cached && shouldThrottleFetch(lastFetch, opts)) {
            applySettingsPayload(cached);
            resolve(true);
            return;
          }
          if (SETTINGS_INFLIGHT && !opts.force) {
            SETTINGS_INFLIGHT.then(function (s) {
              if (s) {
                applySettingsPayload(s);
              }
              resolve(Boolean(s));
            });
            return;
          }
          LAST_SETTINGS_FETCH_AT = Date.now();
          SETTINGS_INFLIGHT = new Promise(function (resFetch) {
            google.script.run
              .withSuccessHandler(function (s) {
                if (s) {
                  LAST_SETTINGS_CACHE = s;
                  LAST_SETTINGS_FETCH_AT = Date.now();
                  applySettingsPayload(s);
                  resFetch(s);
                  resolve(true);
                } else {
                  resFetch(null);
                  resolve(false);
                }
              })
              .withFailureHandler(function (e) {
                notify('設定読み込み失敗: ' + e.message, false);
                resFetch(null);
                resolve(false);
              })
              .getUserSettings();
          }).finally(function () {
            SETTINGS_INFLIGHT = null;
          });
        });
      }

      function applySettingsPayload(s) {
        byId('setting-name').value = s.name || '';
        ProfileImageController.applyLoadedSettings(s);
        var themeVal = String(s.theme || 'light').toLowerCase();
        if (['light', 'dark', 'system'].indexOf(themeVal) === -1) {
          themeVal = 'light';
        }
        var themeInput = byId('setting-theme');
        if (themeInput) {
          themeInput.value = themeVal;
          updateThemeStatus(themeVal);
          applyThemePreference(themeVal);
        } else {
          applyThemePreference(themeVal);
          updateThemeStatus(themeVal);
        }
        var langInput = byId('setting-language');
        var serverLang = typeof s.language === 'string' ? s.language.trim().toLowerCase() : '';
        var fallbackLang =
          (window.userInfo && window.userInfo.language) ||
          (window.I18n && window.I18n.currentLang) ||
          'ja';
        var langVal =
          serverLang && (serverLang === 'ja' || serverLang === 'en') ? serverLang : fallbackLang;
        if (langInput) {
          langInput.value = langVal;
        }
        if (
          window.I18n &&
          typeof window.I18n.setLanguage === 'function' &&
          langVal &&
          window.I18n.currentLang !== langVal
        ) {
          window.I18n.setLanguage(langVal);
        }
        if (window.userInfo) {
          window.userInfo.language = langVal;
        }
        if (window.__SHIFT_FLOW_BOOTSTRAP__ && window.__SHIFT_FLOW_BOOTSTRAP__.userInfo) {
          window.__SHIFT_FLOW_BOOTSTRAP__.userInfo.language = langVal;
        }
      }
      on('btn-settings-save', 'click', function () {
        var btn = byId('btn-settings-save');
        var lbl = btn.querySelector('.label');
        var sp = btn.querySelector('.spinner-border');
        btn.disabled = true;
        if (lbl) lbl.classList.add('d-none');
        if (sp) sp.classList.remove('d-none');
        var langInput = byId('setting-language');
        var selectedLang =
          (langInput && langInput.value) || (window.userInfo && window.userInfo.language) || 'ja';
        var payload = {
          name: byId('setting-name').value || '',
          imageData: pendingProfileImage ? pendingProfileImage.dataUri : '',
          theme: byId('setting-theme').value || 'light',
          language: selectedLang,
        };
        google.script.run
          .withSuccessHandler(function (res) {
            notify(res && res.message ? res.message : '保存しました', res && res.success !== false);
            btn.disabled = false;
            if (lbl) lbl.classList.remove('d-none');
            if (sp) sp.classList.add('d-none');
            if (res && res.success) {
              ProfileImageController.applySaveResult(res);
              var nextLanguage = res.language || payload.language;
              if (nextLanguage && window.I18n && typeof window.I18n.setLanguage === 'function') {
                window.I18n.setLanguage(nextLanguage);
              }
              if (window.userInfo) {
                window.userInfo.language = nextLanguage;
              }
              if (window.__SHIFT_FLOW_BOOTSTRAP__ && window.__SHIFT_FLOW_BOOTSTRAP__.userInfo) {
                window.__SHIFT_FLOW_BOOTSTRAP__.userInfo.language = nextLanguage;
              }
              var languageControl = byId('setting-language');
              if (languageControl) {
                languageControl.value = nextLanguage;
              }
            }
          })
          .withFailureHandler(function (e) {
            notify('保存に失敗: ' + e.message, false);
            btn.disabled = false;
            if (lbl) lbl.classList.remove('d-none');
            if (sp) sp.classList.add('d-none');
          })
          .saveUserSettings(payload);
      });

      // ===== 担当者選択（複数） =====
      var selectedAssignees = new Set();
      function renderAssigneeList() {
        var listEl = byId('assignee-list');
        if (!listEl) return;
        var rows = ACTIVE_USERS.slice().sort(function (a, b) {
          return String(a.name || '').localeCompare(String(b.name || ''), 'ja');
        });
        var html = rows
          .map(function (u) {
            var id = 'assignee__' + (u.email || '').replace(/[^a-z0-9]/gi, '_');
            var checked = selectedAssignees.has(u.email) ? ' checked' : '';
            return (
              '<div class="form-check">' +
              '<input class="form-check-input assignee-chk" type="checkbox" id="' +
              id +
              '" data-email="' +
              esc(u.email) +
              '"' +
              checked +
              '>' +
              '<label class="form-check-label" for="' +
              id +
              '">' +
              esc(u.name) +
              '</label>' +
              '</div>'
            );
          })
          .join('');
        listEl.innerHTML = html;
        updateSelectedCount();
      }
      function toggleSelectAll(toSelect) {
        ACTIVE_USERS.forEach(function (u) {
          if (toSelect) {
            selectedAssignees.add(u.email);
          } else {
            selectedAssignees.delete(u.email);
          }
        });
        renderAssigneeList();
      }
      function updateSelectedCount() {
        var cnt = selectedAssignees.size;
        var badge = byId('assignee-count-badge');
        if (!badge) return;
        var hasI18n = globalThis.I18n && typeof globalThis.I18n.t === 'function';
        var prefix = hasI18n ? globalThis.I18n.t('assignee_count_prefix') : '選択 ';
        var suffix = hasI18n ? globalThis.I18n.t('assignee_count_suffix') : ' 件';
        badge.textContent = prefix + cnt + suffix;
      }
      function getSelectedAssignees() {
        return Array.from(selectedAssignees);
      }
      function resetAssigneeList() {
        selectedAssignees.clear();
        renderAssigneeList();
      }
      (function bindAssigneeHandlers() {
        var listEl = byId('assignee-list');
        if (listEl) {
          listEl.addEventListener('change', function (e) {
            var target = e.target;
            if (target.matches('.assignee-chk')) {
              var email = target.getAttribute('data-email');
              if (!email) return;
              if (target.checked) {
                selectedAssignees.add(email);
              } else {
                selectedAssignees.delete(email);
              }
              updateSelectedCount();
            }
          });
        }
        on('btn-assignee-selectall', 'click', function () {
          toggleSelectAll(true);
        });
        on('btn-assignee-clear', 'click', function () {
          toggleSelectAll(false);
        });
      })();
      document.addEventListener('shiftflow:languagechange', function () {
        updateSelectedCount();
      });

      function setButtonLoading(btn, loading) {
        if (!btn) return;
        var label = btn.querySelector('.label');
        var spinner = btn.querySelector('.spinner-border');
        btn.disabled = !!loading;
        btn.setAttribute('aria-busy', loading ? 'true' : 'false');
        if (label) {
          label.classList.toggle('d-none', !!loading);
        }
        if (spinner) {
          spinner.classList.toggle('d-none', !loading);
        }
      }

      const AdminTemplateController = (function () {
        const state = {
          folderId: '',
          templates: [],
          loading: false,
        };

        function setStatus(text) {
          var el = byId('adminTemplateStatus');
          if (el) el.textContent = text || '';
        }

        function setAlert(message) {
          var box = byId('adminTemplateAlert');
          if (!box) return;
          if (!message) {
            box.classList.add('d-none');
            box.textContent = '';
            return;
          }
          box.textContent = message;
          box.classList.remove('d-none');
        }

        function setSaving(flag) {
          setButtonLoading(byId('btnAdminTemplateSave'), flag);
        }

        function updateFolderHint() {
          var hint = byId('adminTemplateFolderHint');
          if (!hint) return;
          hint.textContent = state.folderId ? 'ID: ' + state.folderId : 'フォルダ未選択';
        }

        function syncFolderOptions() {
          var select = byId('adminTemplateFolder');
          if (!select) return;
          var previous = state.folderId || select.value || '';
          select.innerHTML = '';
          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'フォルダを選択';
          select.appendChild(placeholder);
          (Array.isArray(FOLDERS) ? FOLDERS : []).forEach(function (folder) {
            if (!folder || !folder.id || folder.isActive === false) return;
            var option = document.createElement('option');
            option.value = folder.id;
            option.textContent = folder.name || folder.id;
            select.appendChild(option);
          });
          var next = '';
          if (
            previous &&
            Array.from(select.options).some(function (opt) {
              return opt.value === previous;
            })
          ) {
            next = previous;
          } else {
            var def = getDefaultFolderId();
            if (
              def &&
              Array.from(select.options).some(function (opt) {
                return opt.value === def;
              })
            ) {
              next = def;
            }
          }
          select.value = next;
          state.folderId = next;
          updateFolderHint();
          renderTemplates();
        }

        function renderTemplates() {
          var list = byId('adminTemplateList');
          var empty = byId('adminTemplateEmpty');
          if (!list || !empty) return;
          if (!state.folderId) {
            list.innerHTML = '';
            empty.textContent = 'フォルダを選択すると定型文が表示されます。';
            empty.removeAttribute('hidden');
            return;
          }
          if (!state.templates.length) {
            list.innerHTML = '';
            empty.textContent = '定型文がまだありません。';
            empty.removeAttribute('hidden');
            return;
          }
          empty.setAttribute('hidden', 'hidden');
          list.innerHTML = state.templates
            .map(function (tpl) {
              var updated =
                tpl.updatedAt && Number.isFinite(tpl.updatedAt)
                  ? new Date(tpl.updatedAt).toLocaleString()
                  : '';
              var titlePreview = esc(tpl.titleFormat || '件名なし');
              var bodyPreview = esc((tpl.bodyFormat || '').slice(0, 120));
              return (
                '<div class="list-group-item">' +
                '<div class="d-flex justify-content-between align-items-start gap-2">' +
                '<div>' +
                '<div class="fw-bold">' +
                esc(tpl.name || '定型文') +
                '</div>' +
                '<div class="small text-muted">件名: ' +
                titlePreview +
                '</div>' +
                '<div class="small text-muted text-wrap">本文: ' +
                (bodyPreview || '—') +
                '</div>' +
                '</div>' +
                '<div class="text-muted small text-end">' +
                (updated || '') +
                '</div>' +
                '</div>' +
                '</div>'
              );
            })
            .join('');
        }

        async function loadTemplates(folderId) {
          if (!folderId) {
            state.templates = [];
            renderTemplates();
            return;
          }
          setStatus('読み込み中...');
          setAlert('');
          var list = byId('adminTemplateList');
          if (list) {
            list.innerHTML = '<div class="list-group-item text-muted">読み込み中...</div>';
          }
          state.loading = true;
          try {
            const res = await apiRequest(
              `${API_BASE_PATH}/templates?folderId=${encodeURIComponent(folderId)}`,
              {
                method: 'GET',
              }
            );
            state.templates = Array.isArray(res) ? res : [];
            renderTemplates();
            setStatus('定型文 ' + state.templates.length + ' 件');
          } catch (err) {
            console.warn('Failed to load templates:', err);
            setStatus('読み込みに失敗しました。');
            setAlert(err && err.message ? err.message : '定型文の取得に失敗しました。');
          } finally {
            state.loading = false;
          }
        }

        function handleFolderChange() {
          var select = byId('adminTemplateFolder');
          state.folderId = select ? select.value : '';
          updateFolderHint();
          setAlert('');
          if (!state.folderId) {
            state.templates = [];
            setStatus('フォルダを選択してください。');
            renderTemplates();
            return;
          }
          loadTemplates(state.folderId);
        }

        async function handleSubmit(event) {
          if (event) event.preventDefault();
          if (!IS_MANAGER) {
            notify('定型文の管理は管理者のみ可能です。', false);
            return;
          }
          if (!state.folderId) {
            setAlert('先にフォルダを選択してください。');
            return;
          }
          var name = (byId('adminTemplateName') && byId('adminTemplateName').value.trim()) || '';
          if (!name) {
            setAlert('名称を入力してください。');
            return;
          }
          var title = (byId('adminTemplateTitle') && byId('adminTemplateTitle').value) || '';
          var body = (byId('adminTemplateBody') && byId('adminTemplateBody').value) || '';
          setSaving(true);
          setAlert('');
          try {
            await apiRequest(`${API_BASE_PATH}/templates`, {
              method: 'POST',
              body: {
                folderId: state.folderId,
                name,
                titleFormat: title,
                bodyFormat: body,
              },
            });
            if (byId('adminTemplateName')) byId('adminTemplateName').value = '';
            if (byId('adminTemplateTitle')) byId('adminTemplateTitle').value = '';
            if (byId('adminTemplateBody')) byId('adminTemplateBody').value = '';
            TemplateController.clearCache();
            await loadTemplates(state.folderId);
            TemplateController.renderForFolder(state.folderId);
            notify('定型文を保存しました。', true);
          } catch (err) {
            console.warn('Failed to save template:', err);
            setAlert(err && err.message ? err.message : '定型文の保存に失敗しました。');
          } finally {
            setSaving(false);
          }
        }

        function init() {
          syncFolderOptions();
          handleFolderChange();
          var select = byId('adminTemplateFolder');
          if (select) {
            select.addEventListener('change', handleFolderChange);
          }
          var reloadBtn = byId('btnAdminTemplateReload');
          if (reloadBtn) {
            reloadBtn.addEventListener('click', function (event) {
              event.preventDefault();
              handleFolderChange();
            });
          }
          var form = byId('adminTemplateForm');
          if (form) {
            form.addEventListener('submit', handleSubmit);
          }
          addAdminSectionListener(function (section) {
            if (section === 'folders') {
              syncFolderOptions();
              if (!state.folderId) {
                handleFolderChange();
              } else {
                loadTemplates(state.folderId);
              }
            }
          });
        }

        return {
          init,
          refreshFolders: syncFolderOptions,
          refreshTemplates: function () {
            if (state.folderId) {
              loadTemplates(state.folderId);
            }
          },
        };
      })();
      globalThis.AdminTemplateController = AdminTemplateController;

      const AdminFoldersController = (function () {
        function init() {
          addAdminSectionListener(function (section) {
            if (section === 'folders') {
              renderAdminFolderList();
              AdminTemplateController.refreshFolders();
            }
          });
        }
        return { init };
      })();
      globalThis.AdminFoldersController = AdminFoldersController;

      const AdminDashboardController = (function () {
        const PENDING_LIMIT = 5;
        const AUDIT_LIMIT = 5;
        const state = {
          loading: false,
          loaded: false,
          stats: null,
          pending: [],
          audits: [],
          auditCount: 0,
          updatedAt: 0,
        };

        function setNotice(message, isError) {
          var el = byId('adminDashboardNotice');
          if (!el) return;
          if (!message) {
            el.textContent = '';
            el.setAttribute('hidden', 'hidden');
            el.classList.remove('text-danger');
            return;
          }
          el.textContent = message;
          el.classList.toggle('text-danger', !!isError);
          el.removeAttribute('hidden');
        }

        function setText(id, value) {
          var el = byId(id);
          if (!el) return;
          el.textContent = value == null ? '—' : String(value);
        }

        function setLoading(flag) {
          state.loading = !!flag;
          if (flag) {
            setText('adminDashboardPendingCount', '—');
            setText('adminDashboardActiveCount', '—');
            setText('adminDashboardSuspendedCount', '—');
            setText('adminDashboardAuditCount', '—');
            var pendingList = byId('adminDashboardPendingList');
            if (pendingList) {
              pendingList.innerHTML = '<li class="admin-dashboard-empty">読み込み中...</li>';
            }
            var auditList = byId('adminDashboardAuditList');
            if (auditList) {
              auditList.innerHTML = '<li class="admin-dashboard-empty">読み込み中...</li>';
            }
          }
        }

        function formatNumber(value) {
          if (typeof value === 'number' && Number.isFinite(value)) {
            return value;
          }
          return '—';
        }

        function renderStats(stats) {
          stats = stats || {};
          setText('adminDashboardPendingCount', formatNumber(stats.pending));
          setText('adminDashboardActiveCount', formatNumber(stats.active));
          var suspendedCount = (stats.suspended || 0) + (stats.revoked || 0);
          setText('adminDashboardSuspendedCount', formatNumber(suspendedCount));
          setText('adminDashboardSuspendedMeta', formatNumber(stats.suspended));
          setText(
            'adminDashboardAuditCount',
            state.auditCount ? state.auditCount : state.loaded ? 0 : '—'
          );
          setText(
            'adminDashboardKpiUpdated',
            state.updatedAt ? formatJst(state.updatedAt, true) : '—'
          );
        }

        function formatRoleLabel(role) {
          var normalized = String(role || '').toLowerCase();
          if (normalized === 'admin') return 'Admin';
          if (normalized === 'manager') return 'Manager';
          if (normalized === 'member') return 'Member';
          if (normalized === 'guest') return 'Guest';
          return normalized || 'member';
        }

        function renderPendingList(rows) {
          var list = byId('adminDashboardPendingList');
          if (!list) return;
          if (!rows || !rows.length) {
            list.innerHTML = '<li class="admin-dashboard-empty">承認待ちはありません。</li>';
            return;
          }
          list.innerHTML = rows
            .slice(0, PENDING_LIMIT)
            .map(function (row) {
              return (
                '<li>' +
                '<div class="title">' +
                esc(row.name || row.email || '—') +
                '<span class="ms-2 badge bg-secondary">' +
                esc(formatRoleLabel(row.role)) +
                '</span>' +
                '</div>' +
                '<div class="meta">' +
                esc(row.email || '') +
                ' / 最終: ' +
                esc(row.lastLoginLabel || '—') +
                '</div>' +
                '</li>'
              );
            })
            .join('');
        }

        function renderAuditList(rows) {
          var list = byId('adminDashboardAuditList');
          if (!list) return;
          if (!rows || !rows.length) {
            list.innerHTML = '<li class="admin-dashboard-empty">新しいログはありません。</li>';
            return;
          }
          list.innerHTML = rows
            .slice(0, AUDIT_LIMIT)
            .map(function (row) {
              return (
                '<li>' +
                '<div class="title">' +
                esc(row.eventLabel || 'イベント') +
                '</div>' +
                (row.summary ? '<div class="meta mb-1">' + esc(row.summary) + '</div>' : '') +
                '<div class="meta">' +
                esc(row.occurredLabel || '—') +
                ' / ' +
                esc(row.userLabel || 'システム') +
                '</div>' +
                '</li>'
              );
            })
            .join('');
        }

        function renderSystemCard() {
          setText('adminDashboardOrgLabel', ADMIN_STATE.orgLabel || '現在の組織');
          var orgId =
            ADMIN_STATE.orgId && ADMIN_STATE.orgId !== 'current' ? ADMIN_STATE.orgId : 'current';
          setText('adminDashboardOrgId', orgId);
          setText(
            'adminDashboardUpdatedAt',
            state.updatedAt ? formatJst(state.updatedAt, true) : '—'
          );
        }

        function fetchUserSnapshot() {
          return new Promise(function (resolve, reject) {
            if (!(globalThis.google && google.script && google.script.run)) {
              resolve(null);
              return;
            }
            var args = {
              search: '',
              status: '',
              role: '',
              orgId: ADMIN_STATE.orgId || 'current',
              page: 1,
              pageSize: 200,
            };
            google.script.run
              .withSuccessHandler(function (payload) {
                resolve(payload);
              })
              .withFailureHandler(function (err) {
                reject(err);
              })
              .adminListUsers(args);
          });
        }

        function fetchAuditSnapshot() {
          return new Promise(function (resolve, reject) {
            if (!(globalThis.google && google.script && google.script.run)) {
              resolve(null);
              return;
            }
            google.script.run
              .withSuccessHandler(function (payload) {
                resolve(payload);
              })
              .withFailureHandler(function (err) {
                reject(err);
              })
              .getAuditLogs(AUDIT_LIMIT, { range: '24h', eventType: 'all' });
          });
        }

        function fetchDashboard() {
          if (!IS_MANAGER) {
            setNotice('管理者権限が必要です。', true);
            return Promise.resolve(false);
          }
          setNotice('', false);
          setLoading(true);
          return Promise.all([fetchUserSnapshot(), fetchAuditSnapshot()])
            .then(function (results) {
              var usersPayload = results[0] || {};
              var auditPayload = results[1] || {};
              var rows = Array.isArray(usersPayload.rows) ? usersPayload.rows : [];
              var pending = rows.filter(function (row) {
                return String(row.status || '').toLowerCase() === 'pending';
              });
              state.stats = (usersPayload.meta && usersPayload.meta.stats) || {};
              state.pending = pending;
              var audits = Array.isArray(auditPayload.rows) ? auditPayload.rows : [];
              state.audits = audits;
              state.auditCount = audits.length;
              state.updatedAt = Date.now();
              state.loaded = true;
              renderStats(state.stats);
              renderPendingList(pending);
              renderAuditList(audits);
              renderSystemCard();
              return true;
            })
            .catch(function (err) {
              setNotice(
                err && err.message ? err.message : '管理トップの読み込みに失敗しました。',
                true
              );
              return false;
            })
            .finally(function () {
              setLoading(false);
            });
        }

        function ensureLoaded() {
          if (state.loaded || state.loading) return;
          fetchDashboard();
        }

        function init() {
          renderSystemCard();
          addAdminSectionListener(function (section) {
            if (section === 'dashboard') {
              ensureLoaded();
            }
          });
          addAdminOrgListener(function () {
            state.loaded = false;
            if (ADMIN_STATE.section === 'dashboard' && ADMIN_STATE.active) {
              fetchDashboard();
            } else {
              renderSystemCard();
            }
          });
        }

        return {
          init: init,
        };
      })();

      const AdminUsersController = (function () {
        const STATUS_LABELS = {
          pending: '承認待ち',
          active: '有効',
          suspended: '停止中',
          revoked: '剥奪',
        };
        const STATUS_CLASSES = {
          pending: 'badge bg-warning text-dark',
          active: 'badge bg-success',
          suspended: 'badge bg-secondary',
          revoked: 'badge bg-danger',
        };
        const ROLE_OPTIONS = [
          { value: 'admin', label: 'Admin' },
          { value: 'manager', label: 'Manager' },
          { value: 'member', label: 'Member' },
          { value: 'guest', label: 'Guest' },
        ];
        const state = {
          rows: [],
          filters: { search: '', status: '', role: '', orgId: 'current' },
          loading: false,
          loaded: false,
          managerOnly: false,
          requestToken: 0,
          searchTimer: 0,
          busyRowId: '',
          meta: {},
        };
        const detailState = {
          userId: '',
          drawer: null,
        };

        function getOrgFilter() {
          return state.filters.orgId === 'current'
            ? ADMIN_STATE.orgId || 'current'
            : state.filters.orgId;
        }

        function setNotice(message, isError) {
          var el = byId('adminUsersNotice');
          if (!el) return;
          if (!message) {
            el.textContent = '';
            el.setAttribute('hidden', 'hidden');
            el.classList.remove('text-danger');
            return;
          }
          el.textContent = message;
          el.classList.toggle('text-danger', !!isError);
          el.removeAttribute('hidden');
        }

        function setLoading(flag) {
          state.loading = !!flag;
          var body = byId('adminUsersTableBody');
          if (!body) return;
          if (flag) {
            body.innerHTML =
              '<tr><td colspan="6"><div class="admin-users-loading"><span class="material-icons-outlined align-middle">hourglass_top</span>読み込み中...</div></td></tr>';
          }
        }

        function renderSummary(meta) {
          var wrap = byId('adminUsersSummary');
          if (!wrap) return;
          var stats = meta && meta.stats ? meta.stats : null;
          if (!stats) {
            wrap.innerHTML = '';
            return;
          }
          wrap.innerHTML =
            '<div class="admin-users-summary-item"><small class="text-muted">総数</small><strong>' +
            esc(String(stats.total || 0)) +
            '</strong></div>' +
            '<div class="admin-users-summary-item"><small class="text-muted">承認待ち</small><strong>' +
            esc(String(stats.pending || 0)) +
            '</strong></div>' +
            '<div class="admin-users-summary-item"><small class="text-muted">有効</small><strong>' +
            esc(String(stats.active || 0)) +
            '</strong></div>' +
            '<div class="admin-users-summary-item"><small class="text-muted">停止中</small><strong>' +
            esc(String(stats.suspended || 0)) +
            '</strong></div>';
        }

        function renderUpdatedAt(meta) {
          var el = byId('adminUsersUpdatedAt');
          if (!el) return;
          if (meta && meta.refreshedAt) {
            el.textContent = '最終更新: ' + meta.refreshedAt;
          } else {
            el.textContent = '';
          }
        }

        function canModifyRow(row) {
          if (IS_ADMIN) return true;
          return String(row.role || '').toLowerCase() !== 'admin';
        }

        function buildStatusBadge(row) {
          var status = String(row.status || '').toLowerCase();
          var cls = STATUS_CLASSES[status] || 'badge bg-secondary';
          var label = STATUS_LABELS[status] || status || '―';
          return '<span class="' + cls + '">' + esc(label) + '</span>';
        }

        function buildRoleControl(row) {
          var normalizedRole = String(row.role || 'member');
          return (
            '<span class="admin-role-label" data-role="' +
            esc(normalizedRole) +
            '">' +
            esc(normalizedRole) +
            '</span>'
          );
        }

        function buildActionButtons(row) {
          if (!canModifyRow(row)) {
            return (
              '<button type="button" class="btn btn-link btn-sm p-0" data-admin-user-detail="' +
              esc(row.userId) +
              '">詳細</button>'
            );
          }
          var actions = [];
          var actionTemplate = function (action, label, style) {
            return (
              '<button type="button" class="btn btn-sm ' +
              style +
              '" data-admin-user-action="' +
              action +
              '" data-user-id="' +
              esc(row.userId) +
              '" data-user-email="' +
              esc(row.email) +
              '">' +
              esc(label) +
              '</button>'
            );
          };
          var status = String(row.status || '').toLowerCase();
          if (status === 'pending') {
            actions.push(actionTemplate('activate', '承認', 'btn-primary me-1'));
            actions.push(actionTemplate('suspend', '停止', 'btn-outline-secondary'));
          } else if (status === 'active') {
            actions.push(actionTemplate('suspend', '停止', 'btn-outline-secondary'));
          } else {
            actions.push(actionTemplate('resume', '再開', 'btn-outline-primary'));
          }
          actions.push(
            '<button type="button" class="btn btn-link btn-sm" data-admin-user-detail="' +
              esc(row.userId) +
              '">詳細</button>'
          );
          return actions.join('');
        }

        function findRowById(userId) {
          return state.rows.find(function (entry) {
            return entry.userId === userId;
          });
        }

        function formatStatusDisplay(status) {
          var normalized = String(status || '').toLowerCase();
          return STATUS_LABELS[normalized] || '―';
        }

        function populateDetail(row) {
          var titleEl = byId('adminUserDrawerTitle');
          if (titleEl) titleEl.textContent = row.name || row.email || 'ユーザー管理';
          var emailEl = byId('adminUserDrawerEmail');
          if (emailEl) emailEl.textContent = row.email || '';
          var orgEl = byId('adminUserDetailOrg');
          if (orgEl) orgEl.textContent = row.orgName || '現在の組織';
          var membershipEl = byId('adminUserDetailMembershipStatus');
          if (membershipEl)
            membershipEl.textContent = formatStatusDisplay(row.membershipStatus || row.status);
          var accountEl = byId('adminUserDetailAccountStatus');
          if (accountEl) accountEl.textContent = formatStatusDisplay(row.userStatus || row.status);
          var lastLoginEl = byId('adminUserDetailLastLogin');
          if (lastLoginEl) lastLoginEl.textContent = row.lastLoginLabel || '―';
          var approvedEl = byId('adminUserDetailApproved');
          if (approvedEl) {
            approvedEl.textContent = row.approvedBy
              ? row.approvedBy + (row.approvedAtLabel ? '（' + row.approvedAtLabel + '）' : '')
              : '—';
          }
          var notesEl = byId('adminUserDetailNotes');
          if (notesEl) notesEl.textContent = row.notes ? row.notes : '—';
          var roleSelect = byId('adminUserDetailRole');
          var statusSelect = byId('adminUserDetailStatus');
          var editable = canModifyRow(row);
          if (roleSelect) {
            roleSelect.value = row.role;
            roleSelect.disabled = !editable;
            var adminOption = roleSelect.querySelector('option[value="admin"]');
            if (adminOption) {
              if (!IS_ADMIN) adminOption.disabled = true;
              else adminOption.disabled = false;
            }
          }
          if (statusSelect) {
            statusSelect.value = row.status;
            statusSelect.disabled = !editable;
          }
          var restriction = byId('adminUserDetailRestriction');
          if (restriction) {
            if (editable) restriction.setAttribute('hidden', 'hidden');
            else restriction.removeAttribute('hidden');
          }
        }

        function getDrawerInstance() {
          if (detailState.drawer) return detailState.drawer;
          var drawerEl = byId('adminUserDrawer');
          if (drawerEl && window.bootstrap && typeof window.bootstrap.Offcanvas === 'function') {
            detailState.drawer = new bootstrap.Offcanvas(drawerEl, { scroll: true });
          }
          return detailState.drawer;
        }

        function openDetail(userId) {
          var row = findRowById(userId);
          if (!row) {
            notify('対象ユーザーが見つかりません。', false);
            return;
          }
          detailState.userId = row.userId;
          populateDetail(row);
          var drawer = getDrawerInstance();
          if (drawer) {
            drawer.show();
          } else {
            var el = byId('adminUserDrawer');
            if (el) el.removeAttribute('hidden');
          }
        }

        function closeDetail() {
          detailState.userId = '';
          if (detailState.drawer) {
            try {
              detailState.drawer.hide();
            } catch (_err) {}
          } else {
            var el = byId('adminUserDrawer');
            if (el) el.setAttribute('hidden', 'hidden');
          }
        }

        function refreshDetailIfNeeded() {
          if (!detailState.userId) return;
          var row = findRowById(detailState.userId);
          if (!row) {
            closeDetail();
            return;
          }
          populateDetail(row);
        }

        function renderTable() {
          var body = byId('adminUsersTableBody');
          var emptyEl = byId('adminUsersEmpty');
          if (!body) return;
          if (!state.rows.length) {
            body.innerHTML = '';
            if (emptyEl && !state.loading && !state.managerOnly) {
              emptyEl.removeAttribute('hidden');
            }
            return;
          }
          if (emptyEl) emptyEl.setAttribute('hidden', 'hidden');
          var html = state.rows
            .map(function (row) {
              var actions = buildActionButtons(row);
              return (
                '<tr data-admin-user-row="' +
                esc(row.userId) +
                '">' +
                '<td><div class="admin-user-cell"><img src="' +
                esc(row.avatarUrl || PROFILE_PLACEHOLDER_URL) +
                '" alt="" class="admin-user-avatar" /><div><strong>' +
                esc(row.name || row.email) +
                '</strong><div class="small text-muted">' +
                esc(row.orgName || '') +
                '</div></div></div></td>' +
                '<td><div class="small">' +
                esc(row.email) +
                '</div></td>' +
                '<td>' +
                buildRoleControl(row) +
                '</td>' +
                '<td>' +
                buildStatusBadge(row) +
                '</td>' +
                '<td>' +
                esc(row.lastLoginLabel || '―') +
                '</td>' +
                '<td class="text-end" data-admin-user-actions="' +
                esc(row.userId) +
                '">' +
                (actions || '<span class="text-muted">—</span>') +
                '</td>' +
                '</tr>'
              );
            })
            .join('');
          body.innerHTML = html;
        }

        function applyPayload(payload) {
          var result = payload && payload.rows ? payload.rows : [];
          var meta = (payload && payload.meta) || {};
          state.rows = result.map(function (row) {
            return {
              userId: row.userId || row.email || 'user_' + Math.random().toString(16).slice(2),
              membershipId: row.membershipId || '',
              email: row.email || '',
              name: row.name || row.email || '',
              role: (row.role || 'member').toLowerCase(),
              status: (row.status || 'pending').toLowerCase(),
              avatarUrl: row.avatarUrl || PROFILE_PLACEHOLDER_URL,
              orgName: row.orgName || '現在の組織',
              orgId: row.orgId || '',
              lastLoginLabel: row.lastLoginLabel || row.lastLogin || '―',
              membershipStatus: (row.membershipStatus || row.status || 'pending').toLowerCase(),
              userStatus: (row.userStatus || row.status || 'pending').toLowerCase(),
              approvedBy: row.approvedBy || '',
              approvedAtLabel: row.approvedAtLabel || '',
              notes: row.notes || '',
              isActive: typeof row.isActive === 'boolean' ? row.isActive : true,
            };
          });
          state.meta = meta;
          state.loaded = true;
          state.managerOnly = !!meta.managerOnly;
          if (state.managerOnly) {
            setNotice(meta.reason || '管理者権限が必要です。', false);
          } else {
            setNotice('', false);
          }
          renderTable();
          renderSummary(meta);
          renderUpdatedAt(meta);
          refreshDetailIfNeeded();
        }

        function scheduleFetch(delay) {
          if (state.searchTimer) {
            clearTimeout(state.searchTimer);
          }
          state.searchTimer = setTimeout(
            function () {
              fetchUsers();
            },
            typeof delay === 'number' ? delay : 320
          );
        }

        function buildRequestArgs() {
          return {
            search: state.filters.search,
            status: state.filters.status,
            role: state.filters.role,
            orgId: getOrgFilter(),
          };
        }

        function fetchUsers() {
          if (!IS_MANAGER) {
            setNotice('管理者権限が必要です。', true);
            return Promise.resolve(false);
          }
          var requestId = ++state.requestToken;
          setLoading(true);
          return new Promise(function (resolve) {
            google.script.run
              .withSuccessHandler(function (payload) {
                if (requestId !== state.requestToken) {
                  resolve(false);
                  return;
                }
                setLoading(false);
                applyPayload(payload);
                resolve(true);
              })
              .withFailureHandler(function (err) {
                if (requestId !== state.requestToken) {
                  resolve(false);
                  return;
                }
                setLoading(false);
                setNotice(
                  err && err.message ? err.message : 'ユーザー一覧の取得に失敗しました。',
                  true
                );
                state.rows = [];
                renderTable();
                resolve(false);
              })
              .adminListUsers(buildRequestArgs());
          });
        }

        function setRowBusy(userId, busy) {
          var row = document.querySelector(
            '[data-admin-user-row="' + cssEscapeValue(userId) + '"]'
          );
          if (!row) return;
          var controls = row.querySelectorAll('button,select');
          controls.forEach(function (el) {
            el.disabled = !!busy;
          });
          var actionsCell = row.querySelector('[data-admin-user-actions]');
          if (actionsCell) {
            actionsCell.classList.toggle('opacity-50', !!busy);
          }
        }

        function performUpdate(payload, options) {
          options = options || {};
          if (!payload || !payload.userId) return;
          if (!options.skipRowBusy) {
            setRowBusy(payload.userId, true);
          }
          google.script.run
            .withSuccessHandler(function (res) {
              if (!options.skipRowBusy) {
                setRowBusy(payload.userId, false);
              }
              notify(
                res && res.message ? res.message : '更新しました。',
                res && res.success !== false
              );
              if (typeof options.onSuccess === 'function') {
                try {
                  options.onSuccess(res);
                } catch (_err) {}
              }
              fetchUsers();
            })
            .withFailureHandler(function (err) {
              if (!options.skipRowBusy) {
                setRowBusy(payload.userId, false);
              }
              notify(err && err.message ? err.message : '更新に失敗しました。', false);
              if (typeof options.onError === 'function') {
                try {
                  options.onError(err);
                } catch (_err) {}
              }
            })
            .adminUpdateUser(payload);
        }

        function handleSearchInput(event) {
          state.filters.search = event && event.target ? event.target.value.trim() : '';
          scheduleFetch(420);
        }

        function handleStatusChange(event) {
          state.filters.status = event && event.target ? event.target.value : '';
          fetchUsers();
        }

        function handleRoleFilterChange(event) {
          state.filters.role = event && event.target ? event.target.value : '';
          fetchUsers();
        }

        function handleDetailSubmit(event) {
          if (event) event.preventDefault();
          if (!detailState.userId) return;
          var row = findRowById(detailState.userId);
          if (!row) return;
          if (!canModifyRow(row)) {
            notify('管理者ユーザーは UI から変更できません。', false);
            return;
          }
          var roleSelect = byId('adminUserDetailRole');
          var statusSelect = byId('adminUserDetailStatus');
          var requestedRole = roleSelect ? roleSelect.value : '';
          var requestedStatus = statusSelect ? statusSelect.value : '';
          if (requestedRole === row.role) requestedRole = '';
          if (requestedStatus === row.status) requestedStatus = '';
          var saveBtn = byId('adminUserDetailSave');
          if (!requestedRole && !requestedStatus) {
            setButtonLoading(saveBtn, false);
            notify('変更する内容を選択してください。', false);
            return;
          }
          var payload = {
            userId: row.userId,
            email: row.email,
            role: requestedRole,
            status: requestedStatus,
          };
          setButtonLoading(saveBtn, true);
          performUpdate(payload, {
            skipRowBusy: true,
            onSuccess: function () {
              setButtonLoading(saveBtn, false);
              closeDetail();
            },
            onError: function () {
              setButtonLoading(saveBtn, false);
            },
          });
        }

        function handleActionClick(event) {
          var detailBtn = event.target.closest('[data-admin-user-detail]');
          if (detailBtn) {
            var rowId = detailBtn.getAttribute('data-admin-user-detail');
            if (rowId) {
              openDetail(rowId);
            }
            return;
          }
          var btn = event.target.closest('[data-admin-user-action]');
          if (!btn) return;
          var action = btn.getAttribute('data-admin-user-action');
          var userId = btn.getAttribute('data-user-id');
          var email = btn.getAttribute('data-user-email');
          if (!action || !userId) return;
          var message = 'この操作を実行しますか？';
          if (action === 'activate') message = 'ユーザーを承認しますか？';
          else if (action === 'suspend') message = 'ユーザーを停止しますか？';
          else if (action === 'resume') message = 'ユーザーを再開しますか？';
          if (!window.confirm(message)) return;
          performUpdate({ userId: userId, email: email, action: action });
        }

        function ensureLoaded() {
          if (!IS_MANAGER) return;
          state.filters.orgId = ADMIN_STATE.orgId || 'current';
          if (!state.loaded && !state.loading) {
            fetchUsers();
          }
        }

        function init() {
          state.filters.orgId = ADMIN_STATE.orgId || 'current';
          var searchEl = byId('adminUsersSearch');
          if (searchEl) searchEl.addEventListener('input', handleSearchInput);
          var statusEl = byId('adminUsersStatus');
          if (statusEl) statusEl.addEventListener('change', handleStatusChange);
          var roleEl = byId('adminUsersRole');
          if (roleEl) roleEl.addEventListener('change', handleRoleFilterChange);
          var reloadBtn = byId('btnAdminUsersReload');
          if (reloadBtn)
            reloadBtn.addEventListener('click', function () {
              fetchUsers();
            });
          var table = byId('adminUsersTableBody');
          if (table) {
            table.addEventListener('click', handleActionClick);
          }
          var detailForm = byId('adminUserDetailForm');
          if (detailForm) detailForm.addEventListener('submit', handleDetailSubmit);
          var drawerEl = byId('adminUserDrawer');
          if (drawerEl) {
            drawerEl.addEventListener('hidden.bs.offcanvas', function () {
              detailState.userId = '';
              var saveBtn = byId('adminUserDetailSave');
              setButtonLoading(saveBtn, false);
            });
          }
          addAdminSectionListener(function (section) {
            if (section === 'users') {
              ensureLoaded();
            }
          });
          addAdminOrgListener(function (orgId) {
            state.filters.orgId = orgId || 'current';
            state.loaded = false;
            if (ADMIN_STATE.section === 'users' && ADMIN_STATE.active) {
              fetchUsers();
            }
          });
        }

        return {
          init: init,
          ensureLoaded: ensureLoaded,
        };
      })();

      const AdminAuditController = (function () {
        const AUDIT_LIMIT = 150;
        const SEVERITY_CLASS = {
          success: 'badge bg-success',
          info: 'badge bg-primary',
          warning: 'badge bg-warning text-dark',
          danger: 'badge bg-danger',
        };
        const state = {
          rows: [],
          loading: false,
          loaded: false,
          filters: { range: '24h', eventType: 'all', orgId: 'current' },
          requestToken: 0,
          meta: {},
        };
        let detailModal = null;

        function setNotice(message, isError) {
          var el = byId('adminAuditNotice');
          if (!el) return;
          if (!message) {
            el.textContent = '';
            el.setAttribute('hidden', 'hidden');
            el.classList.remove('text-danger');
            return;
          }
          el.textContent = message;
          el.classList.toggle('text-danger', !!isError);
          el.removeAttribute('hidden');
        }

        function setLoading(isLoading) {
          state.loading = !!isLoading;
          var wrap = byId('adminAuditTableWrap');
          if (wrap) {
            wrap.setAttribute('aria-busy', state.loading ? 'true' : 'false');
          }
          if (state.loading && !state.loaded) {
            renderTable();
          }
        }

        function severityClass(row) {
          return SEVERITY_CLASS[row.severity] || 'badge bg-secondary';
        }

        function renderSummary(meta) {
          var el = byId('adminAuditSummary');
          if (!el) return;
          if (!meta) {
            el.textContent = '—';
            return;
          }
          var stats = meta.stats || {};
          var parts = [];
          if (meta.rangeLabel) {
            parts.push(meta.rangeLabel);
          }
          parts.push('合計 ' + (meta.availableRows || 0) + ' 件');
          parts.push(
            '（管理 ' +
              (stats.admin || 0) +
              ' / ログイン ' +
              (stats.login || 0) +
              ' / API ' +
              (stats.api || 0) +
              '）'
          );
          if (meta.truncated) {
            parts.push(
              '最新 ' +
                (meta.filters && meta.filters.limit ? meta.filters.limit : AUDIT_LIMIT) +
                ' 件のみ表示'
            );
          }
          el.textContent = parts.join(' / ');
        }

        function renderUpdatedAt(meta) {
          var el = byId('adminAuditUpdatedAt');
          if (!el) return;
          if (!meta || !meta.refreshedAt) {
            el.textContent = '最終更新: —';
            return;
          }
          el.textContent = '最終更新: ' + meta.refreshedAt;
        }

        function toggleEmptyState(show) {
          var emptyEl = byId('adminAuditEmpty');
          if (!emptyEl) return;
          if (show) {
            emptyEl.removeAttribute('hidden');
          } else {
            emptyEl.setAttribute('hidden', 'hidden');
          }
        }

        function renderTable() {
          var body = byId('adminAuditTableBody');
          if (!body) return;
          if (!state.rows.length) {
            if (state.loading) {
              body.innerHTML =
                '<tr><td colspan="4"><div class="admin-users-loading">' +
                '<span class="material-icons-outlined align-middle">hourglass_top</span>' +
                '読み込み中...' +
                '</div></td></tr>';
              toggleEmptyState(false);
            } else {
              body.innerHTML =
                '<tr><td colspan="4" class="text-center text-muted">ログが見つかりません。</td></tr>';
              toggleEmptyState(true);
            }
            return;
          }
          var rowsHtml = state.rows
            .map(function (row) {
              var detailBtn = row.meta
                ? ' <button class="btn btn-link btn-sm ps-0" type="button" data-admin-audit-detail="' +
                  esc(row.id) +
                  '">詳細</button>'
                : '';
              var userMeta = row.userEmail
                ? '<div class="text-muted small">' + esc(row.userEmail) + '</div>'
                : '';
              return (
                '<tr data-admin-audit-row="' +
                esc(row.id) +
                '">' +
                '<td><div class="fw-bold">' +
                esc(row.occurredLabel || '—') +
                '</div><div class="text-muted small">' +
                esc(row.typeLabel || '') +
                '</div></td>' +
                '<td><div class="fw-bold">' +
                esc(row.userLabel || '—') +
                '</div>' +
                userMeta +
                '</td>' +
                '<td>' +
                '<span class="' +
                severityClass(row) +
                '">' +
                esc(row.eventLabel || 'イベント') +
                '</span>' +
                (row.statusLabel
                  ? '<div class="text-muted small mt-1">' + esc(row.statusLabel) + '</div>'
                  : '') +
                '</td>' +
                '<td>' +
                '<div class="text-truncate">' +
                esc(row.summary || '—') +
                '</div>' +
                '<div class="text-muted small mt-1">' +
                detailBtn +
                '</div>' +
                '</td>' +
                '</tr>'
              );
            })
            .join('');
          body.innerHTML = rowsHtml;
          toggleEmptyState(false);
        }

        function normalizeRows(rows) {
          if (!Array.isArray(rows)) return [];
          return rows.map(function (row) {
            var id = row && row.id ? String(row.id) : 'audit_' + createRequestId();
            var meta = row && row.meta && typeof row.meta === 'object' ? row.meta : {};
            return {
              id: id,
              type: row && row.type ? row.type : 'admin',
              typeLabel: row && row.typeLabel ? row.typeLabel : '監査',
              eventLabel:
                row && row.eventLabel
                  ? row.eventLabel
                  : row && row.statusLabel
                  ? row.statusLabel
                  : 'イベント',
              statusLabel: row && row.statusLabel ? row.statusLabel : '',
              severity: row && row.severity ? row.severity : 'info',
              summary: row && row.summary ? row.summary : '',
              occurredAt: row && typeof row.occurredAt === 'number' ? row.occurredAt : null,
              occurredLabel: row && row.occurredLabel ? row.occurredLabel : '',
              userLabel: row && row.userLabel ? row.userLabel : '',
              userEmail: row && row.userEmail ? row.userEmail : '',
              meta: meta,
            };
          });
        }

        function applyPayload(payload) {
          if (payload && payload.meta && payload.meta.managerOnly) {
            setNotice(payload.meta.reason || '管理者権限が必要です。', false);
          } else {
            setNotice('', false);
          }
          state.rows = normalizeRows(payload && payload.rows ? payload.rows : []);
          state.meta = payload && payload.meta ? payload.meta : {};
          state.loaded = true;
          renderTable();
          renderSummary(state.meta);
          renderUpdatedAt(state.meta);
        }

        function buildRequestArgs() {
          return {
            range: state.filters.range,
            eventType: state.filters.eventType,
            orgId: state.filters.orgId,
            limit: AUDIT_LIMIT,
          };
        }

        function fetchLogs() {
          if (!IS_MANAGER) {
            setNotice('管理者権限が必要です。', true);
            state.rows = [];
            renderTable();
            return Promise.resolve(false);
          }
          var requestId = ++state.requestToken;
          setNotice('', false);
          setLoading(true);
          return new Promise(function (resolve) {
            google.script.run
              .withSuccessHandler(function (payload) {
                if (requestId !== state.requestToken) {
                  resolve(false);
                  return;
                }
                setLoading(false);
                applyPayload(payload);
                resolve(true);
              })
              .withFailureHandler(function (err) {
                if (requestId !== state.requestToken) {
                  resolve(false);
                  return;
                }
                setLoading(false);
                setNotice(
                  err && err.message ? err.message : '監査ログの取得に失敗しました。',
                  true
                );
                state.rows = [];
                renderTable();
                resolve(false);
              })
              .getAuditLogs(AUDIT_LIMIT, buildRequestArgs());
          });
        }

        function ensureLoaded() {
          if (!IS_MANAGER) return;
          if (!state.loaded && !state.loading) {
            fetchLogs();
          }
        }

        function handleRangeChange(event) {
          state.filters.range = event && event.target ? event.target.value : '24h';
          fetchLogs();
        }

        function handleTypeChange(event) {
          state.filters.eventType = event && event.target ? event.target.value : 'all';
          fetchLogs();
        }

        function handleReload() {
          fetchLogs();
        }

        function stringifyMeta(meta) {
          try {
            return JSON.stringify(meta || {}, null, 2);
          } catch (_err) {
            return '{}';
          }
        }

        function openDetail(rowId) {
          if (!rowId) return;
          var row = state.rows.find(function (entry) {
            return entry.id === rowId;
          });
          if (!row) return;
          var title = byId('adminAuditDetailTitle');
          if (title) {
            title.textContent =
              (row.eventLabel || 'ログ詳細') + '（' + (row.typeLabel || '') + '）';
          }
          var mapping = [
            ['adminAuditDetailTime', row.occurredLabel || '—'],
            ['adminAuditDetailType', row.typeLabel || row.eventLabel || '—'],
            [
              'adminAuditDetailUser',
              row.userEmail ? row.userLabel + ' <' + row.userEmail + '>' : row.userLabel || '—',
            ],
            ['adminAuditDetailStatus', row.statusLabel || '—'],
            ['adminAuditDetailSummary', row.summary || '—'],
          ];
          mapping.forEach(function (entry) {
            var el = byId(entry[0]);
            if (el) el.textContent = entry[1] || '—';
          });
          var requestEl = byId('adminAuditDetailRequest');
          if (requestEl) {
            requestEl.textContent =
              (row.meta && row.meta.requestId) || (row.meta && row.meta.request_id) || '—';
          }
          var routeText = '';
          if (row.meta) {
            if (row.meta.route) routeText = row.meta.route;
            if (row.meta.targetType || row.meta.targetId) {
              var target =
                (row.meta.targetType || '') + (row.meta.targetId ? ' / ' + row.meta.targetId : '');
              routeText = routeText ? routeText + ' / ' + target : target;
            }
          }
          var routeEl = byId('adminAuditDetailRoute');
          if (routeEl) {
            routeEl.textContent = routeText || '—';
          }
          var metaEl = byId('adminAuditDetailMeta');
          if (metaEl) {
            metaEl.textContent = stringifyMeta(row.meta);
          }
          var modalEl = byId('adminAuditDetailModal');
          if (!modalEl) return;
          if (window.bootstrap && typeof window.bootstrap.Modal === 'function') {
            if (!detailModal) {
              detailModal = new bootstrap.Modal(modalEl, {});
            }
            detailModal.show();
          } else {
            modalEl.removeAttribute('hidden');
          }
        }

        function handleDetailClick(event) {
          var btn = event.target.closest('[data-admin-audit-detail]');
          if (!btn) return;
          var rowId = btn.getAttribute('data-admin-audit-detail');
          openDetail(rowId);
        }

        function init() {
          state.filters.orgId = ADMIN_STATE.orgId || 'current';
          var rangeEl = byId('adminAuditRange');
          if (rangeEl) rangeEl.addEventListener('change', handleRangeChange);
          var typeEl = byId('adminAuditType');
          if (typeEl) typeEl.addEventListener('change', handleTypeChange);
          var reloadBtn = byId('btnAdminAuditReload');
          if (reloadBtn) reloadBtn.addEventListener('click', handleReload);
          var table = byId('adminAuditTableBody');
          if (table) table.addEventListener('click', handleDetailClick);
          addAdminSectionListener(function (section) {
            if (section === 'audit') {
              ensureLoaded();
            }
          });
          addAdminOrgListener(function (orgId) {
            state.filters.orgId = orgId || 'current';
            state.loaded = false;
            if (ADMIN_STATE.section === 'audit' && ADMIN_STATE.active) {
              fetchLogs();
            }
          });
        }

        return {
          init: init,
          ensureLoaded: ensureLoaded,
        };
      })();

      const AdminOrgController = (function () {
        const DEFAULT_COLOR = '#517CB2';
        const TIMEZONES = [
          { value: 'Asia/Tokyo', label: 'Asia/Tokyo (JST)' },
          { value: 'Asia/Singapore', label: 'Asia/Singapore' },
          { value: 'UTC', label: 'UTC' },
          { value: 'America/Los_Angeles', label: 'America/Los_Angeles (PT)' },
          { value: 'Europe/London', label: 'Europe/London (GMT)' },
        ];
        const state = {
          orgs: [],
          activeOrgId: '',
        };
        function shouldFallbackToAppsScript() {
          return (
            globalThis.google &&
            google.script &&
            google.script.run &&
            (!google.script.run.__bridge || google.script.run.__bridge !== 'fetch')
          );
        }

        function callOrgApi(route, args) {
          var payloadArgs = Array.isArray(args) ? args : typeof args === 'undefined' ? [] : [args];
          var testState = getTestModeState();
          if (testState && typeof testState.handleRoute === 'function') {
            return Promise.resolve().then(function () {
              return testState.handleRoute(route, payloadArgs);
            });
          }
          function viaFetch() {
            if (typeof fetch !== 'function') {
              return Promise.reject(new Error('fetch_unavailable'));
            }
            return Promise.resolve()
              .then(function () {
                return syncAuthSession({ silent: true }).catch(function () {
                  return null;
                });
              })
              .then(function () {
                var requestId = createRequestId();
                return fetch(API_BASE_PATH + '/' + encodeURIComponent(route), {
                  method: 'POST',
                  credentials: 'include',
                  headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                    'X-ShiftFlow-Request-Id': requestId,
                  },
                  body: JSON.stringify({ route: route, args: payloadArgs }),
                });
              })
              .then(async function (res) {
                var body = null;
                try {
                  body = await res.json();
                } catch (_err) {}
                if (!res.ok) {
                  var message =
                    (body && body.reason) ||
                    (body && body.error) ||
                    'API request failed (' + res.status + ')';
                  var err = new Error(message);
                  err.status = res.status;
                  err.code = (body && body.code) || 'api_error';
                  throw err;
                }
                if (body && typeof body === 'object' && body.ok === false) {
                  var errMsg = body.reason || 'API error';
                  var backendErr = new Error(errMsg);
                  backendErr.code = body.code || 'api_error';
                  throw backendErr;
                }
                if (
                  body &&
                  typeof body === 'object' &&
                  Object.prototype.hasOwnProperty.call(body, 'result')
                ) {
                  return body.result;
                }
                return body;
              });
          }
          function viaGoogleScript() {
            return new Promise(function (resolve, reject) {
              if (!(globalThis.google && google.script && google.script.run)) {
                reject(new Error('apps_script_unavailable'));
                return;
              }
              var runner = google.script.run.withSuccessHandler(function (payload) {
                resolve(payload);
              });
              runner = runner.withFailureHandler(function (err) {
                reject(err instanceof Error ? err : new Error(String(err || 'API error')));
              });
              runner[route].apply(runner, payloadArgs);
            });
          }
          return viaFetch().catch(function (err) {
            if (shouldFallbackToAppsScript()) {
              return viaGoogleScript();
            }
            throw err;
          });
        }

        function renderTimezoneOptions() {
          var select = byId('adminOrgTimezone');
          if (!select) return;
          select.innerHTML = TIMEZONES.map(function (opt) {
            return '<option value="' + esc(opt.value) + '">' + esc(opt.label) + '</option>';
          }).join('');
        }

        function setNotice(message, isError) {
          var el = byId('adminOrgNotice');
          if (!el) return;
          if (!message) {
            el.textContent = '';
            el.setAttribute('hidden', 'hidden');
            el.classList.remove('text-danger');
            return;
          }
          el.textContent = message;
          el.classList.toggle('text-danger', !!isError);
          el.removeAttribute('hidden');
        }

        function updateMeta(org) {
          if (!org) return;
          var nameDisplay = byId('adminOrgNameDisplay');
          if (nameDisplay) nameDisplay.textContent = org.name || '—';
          var shortDisplay = byId('adminOrgShortDisplay');
          if (shortDisplay) shortDisplay.textContent = org.shortName || '—';
          var colorText = byId('adminOrgColorDisplay');
          var colorInput = byId('adminOrgColor');
          var colorPreview = byId('adminOrgColorPreview');
          var colorValue = org.displayColor || DEFAULT_COLOR;
          if (colorText) colorText.textContent = colorValue;
          if (colorInput) colorInput.value = colorValue;
          if (colorPreview) colorPreview.style.backgroundColor = colorValue;
          var idDisplay = byId('adminOrgIdDisplay');
          if (idDisplay) idDisplay.textContent = org.orgId || '—';
          var notifyDisplay = byId('adminOrgNotifyDisplay');
          if (notifyDisplay) notifyDisplay.textContent = org.notificationEmail || '—';
          var nameInput = byId('adminOrgName');
          if (nameInput) nameInput.value = org.name || '';
          var shortInput = byId('adminOrgShortName');
          if (shortInput) shortInput.value = org.shortName || '';
          var notifyInput = byId('adminOrgNotifyEmail');
          if (notifyInput) notifyInput.value = org.notificationEmail || '';
          var tzSelect = byId('adminOrgTimezone');
          if (tzSelect) {
            tzSelect.value = org.timezone || tzSelect.value || 'Asia/Tokyo';
          }
          var updatedLabel = byId('adminOrgUpdatedAt');
          if (updatedLabel) {
            updatedLabel.textContent = org.updatedAt || '—';
          }
        }

        function updateStats(stats) {
          stats = stats || {};
          var total = byId('adminOrgStatsTotal');
          if (total) total.textContent = String(stats.totalMembers || 0);
          var status = stats.statusCounts || {};
          var role = stats.roleCounts || {};
          var map = [
            ['adminOrgStatsPending', status.pending || 0],
            ['adminOrgStatsActive', status.active || 0],
            ['adminOrgStatsSuspended', status.suspended || 0],
            ['adminOrgStatsAdmins', role.admin || 0],
            ['adminOrgStatsManagers', role.manager || 0],
            ['adminOrgStatsMembers', role.member || 0],
            ['adminOrgStatsGuests', role.guest || 0],
          ];
          map.forEach(function (entry) {
            var el = byId(entry[0]);
            if (el) el.textContent = String(entry[1] || 0);
          });
        }

        function updateRefreshedAt(text) {
          var el = byId('adminOrgRefreshedAt');
          if (!el) return;
          if (!text) {
            el.textContent = '最終更新: —';
          } else {
            el.textContent = '最終更新: ' + text;
          }
        }

        function resolveOrgLabel(orgId) {
          var match = state.orgs.find(function (org) {
            return org.orgId === orgId;
          });
          if (!match) return '';
          return match.name || match.shortName || '選択した組織';
        }

        function highlightActiveOrg(orgId) {
          document.querySelectorAll('.admin-org-item').forEach(function (item) {
            var match = item.getAttribute('data-org-id') === orgId;
            item.classList.toggle('active', match);
          });
        }

        function closeDropdown() {
          var dropdownBtn = byId('btn-admin-org');
          if (!dropdownBtn || !window.bootstrap) return;
          try {
            var inst = bootstrap.Dropdown.getInstance(dropdownBtn);
            if (inst) inst.hide();
          } catch (_err) {}
        }

        function renderDropdown() {
          var list = byId('adminOrgList');
          if (!list) return;
          if (!state.orgs.length) {
            list.innerHTML =
              '<div class="px-3 py-2 text-muted small">アクセス可能な組織がありません。</div>';
            return;
          }
          list.innerHTML = '';
          state.orgs.forEach(function (org) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'admin-org-item';
            btn.setAttribute('data-org-id', org.orgId);
            if (org.orgId === state.activeOrgId) {
              btn.classList.add('active');
            }
            btn.innerHTML =
              '<span class="material-icons-outlined">apartment</span>' +
              '<div><strong>' +
              esc(org.name || org.shortName || '未設定の組織') +
              '</strong><small>' +
              esc(org.shortName || org.orgId || '') +
              '</small></div>';
            btn.addEventListener('click', function (event) {
              event.preventDefault();
              state.activeOrgId = org.orgId;
              setAdminOrg(org.orgId, org.name || org.shortName || '選択した組織');
              highlightActiveOrg(org.orgId);
              closeDropdown();
            });
            list.appendChild(btn);
          });
        }

        function fetchOrgList() {
          if (!IS_MANAGER) return;
          callOrgApi('adminListOrganizations')
            .then(function (payload) {
              setNotice('', false);
              state.orgs = Array.isArray(payload?.orgs) ? payload.orgs : [];
              renderDropdown();
              if (!state.activeOrgId) {
                var defaultOrgId =
                  (payload && payload.meta && payload.meta.defaultOrgId) ||
                  (state.orgs[0] && state.orgs[0].orgId) ||
                  '';
                if (defaultOrgId) {
                  var label = resolveOrgLabel(defaultOrgId) || '選択した組織';
                  setAdminOrg(defaultOrgId, label);
                }
              } else {
                highlightActiveOrg(state.activeOrgId);
              }
            })
            .catch(function (err) {
              setNotice(err && err.message ? err.message : '組織一覧の取得に失敗しました。', true);
            });
        }

        function fetchOrgDetail(orgId) {
          if (!IS_MANAGER || !orgId) return;
          callOrgApi('adminGetOrganization', { orgId: orgId })
            .then(function (payload) {
              setNotice('', false);
              if (payload && payload.org) {
                updateMeta(payload.org);
              }
              if (payload && payload.stats) {
                updateStats(payload.stats);
              }
              updateRefreshedAt(payload && payload.refreshedAt ? payload.refreshedAt : '');
            })
            .catch(function (err) {
              setNotice(err && err.message ? err.message : '組織情報の取得に失敗しました。', true);
            });
        }

        function handleColorInput(event) {
          var value = (event && event.target && event.target.value) || '';
          var color = value || DEFAULT_COLOR;
          var text = byId('adminOrgColorText');
          var preview = byId('adminOrgColorPreview');
          if (text) text.textContent = color.toUpperCase();
          if (preview) preview.style.backgroundColor = color;
        }

        function gatherPayload() {
          return {
            orgId: state.activeOrgId,
            name: (byId('adminOrgName')?.value || '').trim(),
            shortName: (byId('adminOrgShortName')?.value || '').trim(),
            displayColor: (byId('adminOrgColor')?.value || DEFAULT_COLOR).trim(),
            timezone: (byId('adminOrgTimezone')?.value || '').trim(),
            notificationEmail: (byId('adminOrgNotifyEmail')?.value || '').trim(),
          };
        }

        function handleSave(event) {
          if (event) event.preventDefault();
          if (!IS_MANAGER) {
            setNotice('管理者権限が必要です。', true);
            return;
          }
          if (!state.activeOrgId) {
            setNotice('先に管理対象の組織を選択してください。', true);
            return;
          }
          var payload = gatherPayload();
          var btn = byId('btnAdminOrgSave');
          setNotice('', false);
          setButtonLoading(btn, true);
          callOrgApi('adminUpdateOrganization', payload)
            .then(function (res) {
              setButtonLoading(btn, false);
              notify(
                res && res.message ? res.message : '組織情報を更新しました。',
                res && res.success !== false
              );
              fetchOrgDetail(state.activeOrgId);
              fetchOrgList();
            })
            .catch(function (err) {
              setButtonLoading(btn, false);
              setNotice(err && err.message ? err.message : '組織情報の更新に失敗しました。', true);
            });
        }

        function bindEvents() {
          var colorInput = byId('adminOrgColor');
          if (colorInput) {
            colorInput.addEventListener('input', handleColorInput);
            colorInput.addEventListener('change', handleColorInput);
          }
          on('btnAdminOrgSave', 'click', handleSave);
        }

        function disableFormForNonManager() {
          var form = byId('adminOrgForm');
          if (!form) return;
          form.querySelectorAll('input,select,button').forEach(function (el) {
            el.disabled = true;
          });
        }

        function init() {
          renderTimezoneOptions();
          bindEvents();
          if (!IS_MANAGER) {
            setNotice('管理者権限が必要です。', true);
            disableFormForNonManager();
            return;
          }
          addAdminOrgListener(function (orgId) {
            state.activeOrgId = orgId || '';
            highlightActiveOrg(state.activeOrgId);
            if (state.activeOrgId) {
              fetchOrgDetail(state.activeOrgId);
            }
          });
          addAdminSectionListener(function (section) {
            if (section === 'orgs' && state.activeOrgId) {
              fetchOrgDetail(state.activeOrgId);
            }
          });
          fetchOrgList();
        }

        return {
          init: init,
        };
      })();

      // ===== ビューナビゲーション・フォーム初期化 =====
      const NavigationController = (function () {
        function handleViewLinkClick(event) {
          if (!event || !event.currentTarget) return;
          event.preventDefault();
          const targetView = event.currentTarget.getAttribute('data-view');
          if (targetView) {
            navigateTo(targetView);
          }
        }

        function attachViewLinks() {
          $$('[data-view]').forEach(function (link) {
            link.addEventListener('click', handleViewLinkClick);
          });
        }

        function openNewTaskModal(event) {
          if (event) event.preventDefault();
          const hint = byId('taskFromMsgHint');
          if (hint) {
            hint.classList.add('d-none');
          }
          const modalEl = byId('newTaskModal');
          if (modalEl) {
            new bootstrap.Modal(modalEl).show();
          }
        }

        function openNewMessageModal(event) {
          if (event) event.preventDefault();
          const modalEl = byId('newMessageModal');
          if (modalEl) {
            new bootstrap.Modal(modalEl).show();
          }
        }

        function attachFabHandlers() {
          on('btn-open-new-task', 'click', openNewTaskModal);
          on('btn-open-new-msg', 'click', openNewMessageModal);
        }

        function attachHomeHeroActions() {
          on('home-quick-new-task', 'click', openNewTaskModal);
          on('home-quick-new-msg', 'click', openNewMessageModal);
        }

        function activateAdminSection(section) {
          if (!IS_MANAGER) {
            notify('管理者メニューへアクセスする権限がありません。', false);
            return;
          }
          var target = section || 'dashboard';
          if (ADMIN_STATE.active) {
            setAdminSection(target);
            scrollToTopNow();
            return;
          }
          openAdminView(target);
        }

        function handleAdminTargetClick(event) {
          if (event) event.preventDefault();
          var target =
            (event &&
              event.currentTarget &&
              event.currentTarget.getAttribute('data-admin-target')) ||
            'dashboard';
          activateAdminSection(target);
        }

        function attachAdminMenuHandler() {
          document.querySelectorAll('[data-admin-target]').forEach(function (el) {
            el.addEventListener('click', handleAdminTargetClick);
          });
          on('btn-exit-admin', 'click', function (event) {
            if (event) event.preventDefault();
            closeAdminView();
          });
        }

        function attachUserMenuHandlers() {
          var userMenuButton = byId('btn-user-menu');
          document.querySelectorAll('[data-user-menu]').forEach(function (item) {
            item.addEventListener('click', function (event) {
              event.preventDefault();
              var action = item.getAttribute('data-user-menu');
              if (userMenuButton && window.bootstrap) {
                try {
                  var inst = bootstrap.Dropdown.getInstance(userMenuButton);
                  if (inst) inst.hide();
                } catch (_err) {
                  /* noop */
                }
              }
              if (action === 'admin') {
                activateAdminSection('dashboard');
              } else if (action === 'admin-demo') {
                activateTestUserLogin({ profile: 'manager' });
              } else if (action === 'settings') {
                navigateTo('settings', { animate: true, skipScroll: false });
              } else if (action === 'logout') {
                if (!confirmLogoutAction()) return;
                performLogout();
              }
            });
          });
        }

        function init() {
          attachViewLinks();
          attachFabHandlers();
          attachHomeHeroActions();
          attachAdminMenuHandler();
          attachUserMenuHandlers();
        }

        return {
          init,
          openNewTaskModal,
          openNewMessageModal,
        };
      })();

      function resetTaskModalState() {
        var taskForm = byId('newTaskForm');
        if (taskForm) taskForm.reset();
        var fromMsgHint = byId('taskFromMsgHint');
        if (fromMsgHint) {
          fromMsgHint.classList.add('d-none');
        }
        var today = new Date();
        var y = today.getFullYear();
        var m = ('0' + (today.getMonth() + 1)).slice(-2);
        var d = ('0' + today.getDate()).slice(-2);
        var dueInput = byId('taskDueDate');
        if (dueInput) {
          dueInput.value = y + '-' + m + '-' + d;
        }
        var prioritySelect = byId('taskPriority');
        if (prioritySelect) {
          prioritySelect.value = '中';
        }
        var repeatTypeEl = byId('taskRepeatType');
        if (repeatTypeEl) {
          repeatTypeEl.value = 'none';
        }
        resetAssigneeList();
        var saveBtn = byId('saveTaskButton');
        setButtonLoading(saveBtn, false);
        setTimeout(function () {
          var titleInput = byId('taskTitle');
          if (titleInput) {
            titleInput.focus();
          }
        }, 60);
      }

      function resetMessageModalState() {
        var messageForm = byId('newMessageForm');
        if (messageForm) {
          messageForm.reset();
        }
        var folderSelect = byId('messageFolder');
        if (folderSelect) {
          var defaultFolder = getDefaultFolderId();
          folderSelect.value = defaultFolder || '';
          MessageDraftController.handleFolderChange(folderSelect.value || '');
        }
        var prioritySelect = byId('messagePriority');
        if (prioritySelect) {
          prioritySelect.value = '中';
        }
        MessageAttachmentController.reset();
        var saveBtn = byId('saveMessageButton');
        setButtonLoading(saveBtn, false);
        setTimeout(function () {
          var titleInput = byId('messageTitle');
          if (titleInput) {
            titleInput.focus();
          }
        }, 60);
      }

      function renderAuthVersionLabel() {
        var config = window.SHIFT_FLOW_CONFIG || {};
        var version = config.APP_VERSION || 'dev';
        var label = 'バージョン ' + version;
        var versionEl = byId('authVersionText');
        if (versionEl) {
          versionEl.textContent = label;
          versionEl.dataset.version = version;
          versionEl.setAttribute('title', '現在のアプリバージョン: ' + version);
        }
        document.querySelectorAll('[data-app-version-label]').forEach(function (el) {
          el.textContent = label;
          el.dataset.version = version;
          el.setAttribute('title', '現在のアプリバージョン: ' + version);
        });
      }

      function handleModalShown(event) {
        var target = event && event.target;
        if (!target) return;
        if (target.id === 'newTaskModal') {
          resetTaskModalState();
          return;
        }
        if (target.id === 'newMessageModal') {
          resetMessageModalState();
        }
      }

      document.addEventListener('shown.bs.modal', handleModalShown);

      (function () {
        if (!window.history || !window.history.pushState) {
          return;
        }
        var modalHistoryStack = [];
        var skipNextPopstate = false;
        var closingViaPopstateId = null;

        function findStackIndex(modalId) {
          for (var i = modalHistoryStack.length - 1; i >= 0; i--) {
            if (modalHistoryStack[i] && modalHistoryStack[i].modalId === modalId) {
              return i;
            }
          }
          return -1;
        }

        function pushModalState(modalId) {
          var stateObj = {
            modalLock: true,
            modalId: modalId,
            ts: Date.now(),
          };
          modalHistoryStack.push(stateObj);
          try {
            window.history.pushState(stateObj, document.title, window.location.href);
          } catch (_err) {
            /* noop */
          }
        }

        function removeModalState(modalId, isFromPopstate) {
          var idx = findStackIndex(modalId);
          if (idx === -1) return;
          modalHistoryStack.splice(idx, 1);
          if (isFromPopstate) return;
          skipNextPopstate = true;
          setTimeout(function () {
            try {
              window.history.back();
            } catch (_err) {
              skipNextPopstate = false;
            }
          }, 0);
        }

        document.addEventListener('shown.bs.modal', function (event) {
          var modalId = event && event.target && event.target.id;
          if (!modalId) return;
          pushModalState(modalId);
        });

        document.addEventListener('hidden.bs.modal', function (event) {
          var modalId = event && event.target && event.target.id;
          if (!modalId) return;
          var isFromPopstate = closingViaPopstateId === modalId;
          if (isFromPopstate) {
            closingViaPopstateId = null;
          }
          removeModalState(modalId, isFromPopstate);
        });

        window.addEventListener('popstate', function (event) {
          if (skipNextPopstate) {
            skipNextPopstate = false;
            return;
          }
          var state = event && event.state;
          if (!state || !state.modalLock) {
            return;
          }
          var modalId = state.modalId;
          var modalEl = modalId && document.getElementById(modalId);
          if (!modalEl) {
            return;
          }
          closingViaPopstateId = modalId;
          try {
            var inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            inst.hide();
          } catch (_err) {
            closingViaPopstateId = null;
          }
        });
      })();

      // ===== 初期化 =====
      window.addEventListener('load', function () {
        renderAuthVersionLabel();
        // GAS組み込み認証では、このスクリプトが実行される時点で
        // 常に認証済みのため、ログイン画面の表示切り替えは不要。

        // ナビゲーションやボタンのイベントリスナーを設定
        NavigationController.init();
        TaskViewController.init();
        MessageViewController.init();
        ProfileImageController.init();
        MessageAttachmentController.init();
        TaskFormController.init();
        MessageFormController.init();
        AdminDashboardController.init();
        AdminUsersController.init();
        AdminFoldersController.init();
        AdminTemplateController.init();
        AdminAuditController.init();
        AdminOrgController.init();

        initPullToRefresh();
        initializeAuthGateway();

        // スタンドアロン（PWA起動）では余分なヒーローを省き、一覧を優先表示
        try {
          var isStandalone =
            (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
            (window.navigator && window.navigator.standalone);
          if (isStandalone) {
            document.body.classList.add('standalone-condensed');
          }
        } catch (_err) {
          /* noop */
        }
      });
    </script>
    <script>
      (function () {
        try {
          var manifestUrl = new URL(window.location.href);
          if (manifestUrl.pathname.indexOf('/userCodeAppPanel') !== -1) {
            manifestUrl.pathname = manifestUrl.pathname.replace(/\/userCodeAppPanel$/, '/exec');
            manifestUrl.search = '';
            manifestUrl.searchParams.set('page', 'manifest');
          } else {
            manifestUrl.searchParams.set('page', 'manifest');
          }
          var linkEl = document.createElement('link');
          linkEl.rel = 'manifest';
          linkEl.href = manifestUrl.toString();
          document.head.appendChild(linkEl);
        } catch (err) {
          console.warn('Failed to attach manifest link:', err);
        }
      })();

      (function enableAdminSwipe() {
        var wrap = byId('adminPanelsWrapper');
        var track = byId('adminTrack');
        if (!wrap || !track) return;
        var state = {
          active: false,
          locked: false,
          startX: 0,
          startY: 0,
          dx: 0,
          dy: 0,
          skip: false,
        };
        var threshold = 60;
        wrap.addEventListener(
          'touchstart',
          function (e) {
            if (!ADMIN_STATE.active) return;
            if (e.touches && e.touches.length > 1) return;
            var guardTarget =
              e.target && typeof e.target.closest === 'function'
                ? e.target.closest('[data-prevent-admin-swipe="true"]')
                : null;
            state.skip = !!guardTarget;
            if (state.skip) {
              state.active = false;
              state.locked = false;
              return;
            }
            var touch = e.touches ? e.touches[0] : e;
            state.active = true;
            state.locked = false;
            state.startX = touch.clientX;
            state.startY = touch.clientY;
            state.dx = 0;
            state.dy = 0;
          },
          { passive: true }
        );
        wrap.addEventListener(
          'touchmove',
          function (e) {
            if (state.skip || !state.active || !ADMIN_STATE.active) return;
            var touch = e.touches ? e.touches[0] : e;
            state.dx = touch.clientX - state.startX;
            state.dy = touch.clientY - state.startY;
            if (!state.locked) {
              if (Math.abs(state.dx) > Math.abs(state.dy) && Math.abs(state.dx) > 8) {
                state.locked = true;
              } else if (Math.abs(state.dy) > Math.abs(state.dx)) {
                state.active = false;
              }
            } else {
              e.preventDefault();
            }
          },
          { passive: false }
        );
        wrap.addEventListener(
          'touchend',
          function () {
            if (state.skip) {
              state.skip = false;
              return;
            }
            if (!state.locked) {
              state.active = false;
              return;
            }
            var delta = state.dx;
            state.active = false;
            state.locked = false;
            if (Math.abs(delta) < threshold) return;
            if (delta < 0) {
              stepAdminSection(1);
            } else {
              stepAdminSection(-1);
            }
          },
          { passive: true }
        );
      })();
    </script>
    <!-- TODO: API デバッグ用UIは本番公開前に非表示化する -->
  </body>
</html>
